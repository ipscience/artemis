<!DOCTYPE html>
<!--
================================================================================
ARTEMIS - 迚ｹ險ｱ蛻・梵繝・・繝ｫ (PyScript迚・
================================================================================

讎りｦ・
  PyScript (Pyodide) 繧呈ｴｻ逕ｨ縺励◆繝悶Λ繧ｦ繧ｶ繝吶・繧ｹ縺ｮ迚ｹ險ｱ蛻・梵繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ縲・  繧ｵ繝ｼ繝舌・繧ｵ繧､繝峨・Python迺ｰ蠅・ｒ蠢・ｦ√→縺帙★縲√％縺ｮHTML繝輔ぃ繧､繝ｫ蜊倅ｽ薙〒蜍穂ｽ懊☆繧九・
繝吶・繧ｹ繝励Ο繧ｸ繧ｧ繧ｯ繝・
  APOLLO (Streamlit迚・ - https://github.com/shibayamalicht/apollo-patent-analysis

讖溯・荳隕ｧ:
  - ATLAS   : 邨ｱ險医メ繝｣繝ｼ繝医→譎らｳｻ蛻怜・譫・  - CORE    : 繝ｫ繝ｼ繝ｫ繝吶・繧ｹ蛻・｡・(AND/OR/NEAR/ADJ 繝悶・繝ｫ隲也炊蟇ｾ蠢・
  - Saturn V: 謚陦薙Λ繝ｳ繝峨せ繧ｱ繝ｼ繝怜庄隕門喧 (TF-IDF + PCA)
  - Explorer: 繧ｭ繝ｼ繝ｯ繝ｼ繝牙・譫舌→蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ
  - CREW    : 逋ｺ譏手・蜃ｺ鬘倅ｺｺ繝阪ャ繝医Ρ繝ｼ繧ｯ蛻・梵
  - MEGA    : 繝・く繧ｹ繝亥・譫・(繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝・ N-gram, TF-IDF)
  - VOYAGER : 繝ｬ繝昴・繝育函謌舌→繧ｨ繧ｯ繧ｹ繝昴・繝・
蜍穂ｽ懆ｦ∽ｻｶ:
  - WebAssembly蟇ｾ蠢懊ヶ繝ｩ繧ｦ繧ｶ (Chrome, Firefox, Edge, Safari)
  - 繧､繝ｳ繧ｿ繝ｼ繝阪ャ繝域磁邯・(蛻晏屓繝ｩ繧､繝悶Λ繝ｪ繝繧ｦ繝ｳ繝ｭ繝ｼ繝臥畑縲∽ｻ･髯阪・繧ｭ繝｣繝・す繝･)

繝ｩ繧､繧ｻ繝ｳ繧ｹ: MIT
菴懈・閠・ Hajime Kumami
繝舌・繧ｸ繝ｧ繝ｳ: 1.0.0
譛邨よ峩譁ｰ: 2026-01-30

================================================================================
-->
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ARTEMIS - PyScript縺ｧ蜍穂ｽ懊☆繧九ヶ繝ｩ繧ｦ繧ｶ繝吶・繧ｹ迚ｹ險ｱ蛻・梵繝・・繝ｫ">
    <meta name="author" content="Hajime Kumami">
    <title>ARTEMIS - 迚ｹ險ｱ蛻・梵繝・・繝ｫ</title>
    
    <!-- 螟夜Κ萓晏ｭ倥Λ繧､繝悶Λ繝ｪ -->
    <!-- PyScript: 繝悶Λ繧ｦ繧ｶ荳翫〒Python繧貞ｮ溯｡後☆繧九Λ繝ｳ繧ｿ繧､繝 -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    
    <!-- Plotly.js: 繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶メ繝｣繝ｼ繝医Λ繧､繝悶Λ繝ｪ -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- D3.js + 諡｡蠑ｵ繝ｩ繧､繝悶Λ繝ｪ -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.7/build/d3.layout.cloud.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    
    <!-- PapaParse: CSV隗｣譫舌Λ繧､繝悶Λ繝ｪ -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ============================================================
           CSS繧ｫ繧ｹ繧ｿ繝繝励Ο繝代ユ繧｣ (繝・じ繧､繝ｳ繝医・繧ｯ繝ｳ)
           繝｢繝繝ｳUI縺ｮ縺溘ａ縺ｮ蛹・峡逧・↑繝・じ繧､繝ｳ繧ｷ繧ｹ繝・Β
           ============================================================ */
        :root {
            /* 繝励Λ繧､繝槭Μ繧ｫ繝ｩ繝ｼ (繝｡繧､繝ｳ繧｢繧ｯ繧ｻ繝ｳ繝・ */
            --color-primary: #4fc3f7;
            --color-primary-light: #81d4fa;
            --color-primary-dark: #29b6f6;
            --color-primary-glow: rgba(79, 195, 247, 0.4);
            
            /* 繧ｻ繧ｫ繝ｳ繝繝ｪ繧ｫ繝ｩ繝ｼ (陬懷勧濶ｲ) */
            --color-secondary: #415a77;
            --color-secondary-light: #5a7a9a;
            
            /* 繧｢繧ｯ繧ｻ繝ｳ繝医き繝ｩ繝ｼ */
            --color-accent: #a855f7;
            --color-accent-light: #c084fc;
            
            /* 繧ｻ繝槭Φ繝・ぅ繝・け繧ｫ繝ｩ繝ｼ (迥ｶ諷玖｡ｨ遉ｺ逕ｨ) */
            --color-success: #22c55e;
            --color-success-light: #4ade80;
            --color-warning: #f59e0b;
            --color-warning-light: #fbbf24;
            --color-error: #ef4444;
            --color-error-light: #f87171;
            --color-danger: #dc2626;
            --color-danger-hover: #ef4444;
            
            /* 閭梧勹濶ｲ - 繧ｰ繝ｩ繧ｹ繝｢繝ｼ繝輔ぅ繧ｺ繝蟇ｾ蠢・*/
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1e293b;
            --bg-overlay: rgba(0, 0, 0, 0.4);
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --bg-input: rgba(0, 0, 0, 0.3);
            
            /* 繝・く繧ｹ繝郁牡 */
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            
            /* 繝懊・繝繝ｼ濶ｲ */
            --border-light: rgba(255, 255, 255, 0.08);
            --border-medium: rgba(255, 255, 255, 0.15);
            --border-focus: rgba(79, 195, 247, 0.5);
            
            /* 繧ｹ繝壹・繧ｷ繝ｳ繧ｰ */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* 隗剃ｸｸ */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            /* 繧ｿ繧､繝昴げ繝ｩ繝輔ぅ */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Meiryo', sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.8125rem;
            --font-size-md: 0.875rem;
            --font-size-lg: 1rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 2rem;
            
            /* 繧ｷ繝｣繝峨え */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --shadow-glow: 0 0 20px var(--color-primary-glow);
            
            /* 繝医Λ繝ｳ繧ｸ繧ｷ繝ｧ繝ｳ */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* 繝ｬ繧､繧｢繧ｦ繝・*/
            --sidebar-width: 200px;
            --header-height: 56px;
        }

        /* ============================================================
           繝吶・繧ｹ繧ｹ繧ｿ繧､繝ｫ
           ============================================================ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            background-image: 
                radial-gradient(ellipse at 20% 0%, rgba(79, 195, 247, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(168, 85, 247, 0.06) 0%, transparent 50%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ============================================================
           繝倥ャ繝繝ｼ
           ============================================================ */
        .header {
            background: rgba(10, 15, 26, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 0 var(--spacing-lg);
            height: var(--header-height);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: var(--font-size-xl);
            font-weight: 600;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .badge {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            color: #000;
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 600;
        }

        .container {
            display: flex;
            min-height: calc(100vh - var(--header-height));
        }

        /* ============================================================
           繧ｵ繧､繝峨ヰ繝ｼ繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ (繝｢繝繝ｳUI)
           繝・ヵ繧ｩ繝ｫ繝医〒螻暮幕縲∝ｸｸ縺ｫ繝ｩ繝吶Ν陦ｨ遉ｺ
           ============================================================ */
        .sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.5rem;
            border-right: 1px solid var(--border-light);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            gap: 0.3rem;
        }

        .sidebar h3 {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            padding-left: 0.5rem;
            white-space: nowrap;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            height: 44px;
            padding: 0 var(--spacing-md);
            margin-bottom: 0;
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all var(--transition-fast);
            gap: 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .nav-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 0;
            background: var(--color-primary);
            border-radius: 0 2px 2px 0;
            transition: height var(--transition-fast);
        }

        .nav-btn .nav-label {
            font-size: var(--font-size-sm);
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-btn:hover::before {
            height: 24px;
        }

        .nav-btn.active {
            background: rgba(79, 195, 247, 0.1);
            color: var(--color-primary);
            font-weight: 600;
        }

        .nav-btn.active::before {
            height: 28px;
            background: linear-gradient(180deg, var(--color-primary) 0%, var(--color-accent) 100%);
        }

        .nav-divider {
            width: calc(100% - 1rem);
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--border-light), transparent);
            margin: 0.75rem auto;
        }

        /* 繝｢繧ｸ繝･繝ｼ繝ｫ繧ｹ繝・・繧ｿ繧ｹ・医さ繝ｳ繝代け繝育沿・・*/
        .module-status {
            margin-top: auto;
            padding: var(--spacing-sm);
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
        }

        .module-status-item {
            display: flex;
            justify-content: space-between;
            gap: 0.4rem;
            padding: 0.15rem 0.3rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .module-progress {
            height: 2px;
            margin: 0.1rem 0.3rem 0.3rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px;
            overflow: hidden;
        }

        /* ============================================================
           繝｡繧､繝ｳ繧ｳ繝ｳ繝・Φ繝・お繝ｪ繧｢
           ============================================================ */
        .main {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
            background: transparent;
        }

        .card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            transition: all var(--transition-normal);
        }

        .card:hover {
            border-color: var(--border-medium);
            box-shadow: var(--shadow-md);
        }

        .card h2 {
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        /* ============================================================
           繧ｿ繝・           ============================================================ */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: var(--spacing-lg);
            flex-wrap: wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.3rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .tab-btn {
            padding: 0.6rem var(--spacing-md);
            background: transparent;
            border: none;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            background: rgba(79, 195, 247, 0.15);
            color: var(--color-primary);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================================
           繝輔か繝ｼ繝隕∫ｴ
           ============================================================ */
        input[type="file"] {
            width: 100%;
            padding: var(--spacing-lg);
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-lg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        input[type="file"]:hover {
            border-color: var(--color-primary);
            background: rgba(79, 195, 247, 0.05);
        }

        select,
        input[type="number"],
        input[type="text"] {
            width: 100%;
            padding: 0.65rem 0.75rem;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-md);
            transition: all var(--transition-fast);
        }

        /* 繝峨Ο繝・・繝繧ｦ繝ｳ縺ｮ驕ｸ謚櫁い繧ｹ繧ｿ繧､繝ｫ (隕冶ｪ肴ｧ謾ｹ蝟・ */
        select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 0.5rem;
        }

        select option:checked,
        select option:hover {
            background: var(--bg-tertiary);
            color: #ffffff;
        }

        /* 繝輔か繝ｼ繧ｫ繧ｹ譎ゅ・繧ｹ繧ｿ繧､繝ｫ */
        select:focus,
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-glow);
        }

        /* 辟｡蜉ｹ蛹匁凾縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        select:disabled,
        input:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.3);
        }

        /* ============================================================
           繝懊ち繝ｳ
           ============================================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.7rem 1.4rem;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            border: none;
            border-radius: var(--radius-md);
            color: #000;
            font-weight: 600;
            cursor: pointer;
            font-size: var(--font-size-md);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--border-medium);
            box-shadow: var(--shadow-md);
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: var(--font-size-xs);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--color-error) 0%, var(--color-danger) 100%);
            color: #fff;
        }

        .btn-danger:hover {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
        }

        /* 繝懊ち繝ｳ縺ｮ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷・*/
        .btn.loading {
            pointer-events: none;
            opacity: 0.85;
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: btn-spinner 0.8s linear infinite;
        }

        .btn.loading .btn-text {
            opacity: 0;
        }

        @keyframes btn-spinner {
            to { transform: rotate(360deg); }
        }

        /* 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｹ繝斐リ繝ｼ・域ｱ守畑・・*/
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spinner-rotate 0.8s linear infinite;
        }

        .spinner-lg {
            width: 40px;
            height: 40px;
            border-width: 3px;
        }

        @keyframes spinner-rotate {
            to { transform: rotate(360deg); }
        }

        /* 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-overlay .spinner-text {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
        }

        /* ============================================================
           繧ｰ繝ｪ繝・ラ繝ｬ繧､繧｢繧ｦ繝・           ============================================================ */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: var(--spacing-md);
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: var(--spacing-md);
        }

        /* ============================================================
           繝輔か繝ｼ繝繧ｰ繝ｫ繝ｼ繝・           ============================================================ */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.4rem;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* ============================================================
           繝√Ε繝ｼ繝医→繝・・繝悶Ν
           ============================================================ */
        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            min-height: 400px;
            position: relative;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: var(--font-size-sm);
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem var(--spacing-md);
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background: rgba(79, 195, 247, 0.1);
            color: var(--color-primary);
            font-weight: 600;
            position: sticky;
            top: 0;
            backdrop-filter: blur(10px);
        }

        .data-table tr {
            transition: background var(--transition-fast);
        }

        .data-table tr:hover {
            background: rgba(79, 195, 247, 0.05);
        }

        .data-table td {
            color: var(--text-primary);
        }

        /* ============================================================
           繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ繧ｯ繝ｩ繧ｹ
           ============================================================ */
        .hidden {
            display: none !important;
        }

        /* ============================================================
           蛻晄悄蛹悶が繝ｼ繝舌・繝ｬ繧､
           ============================================================ */
        #init-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(ellipse at 30% 20%, rgba(79, 195, 247, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #init-overlay h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: var(--spacing-lg);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ============================================================
           繝｡繝医Μ繧ｯ繧ｹ陦ｨ遉ｺ
           ============================================================ */
        .metrics {
            display: flex;
            gap: var(--spacing-md);
            margin: var(--spacing-md) 0;
            flex-wrap: wrap;
        }

        .metric {
            flex: 1;
            min-width: 100px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-light);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            text-align: center;
            transition: all var(--transition-normal);
        }

        .metric:hover {
            transform: translateY(-2px);
            border-color: rgba(79, 195, 247, 0.3);
            box-shadow: var(--shadow-md);
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* ============================================================
           繧ｹ繝・・繧ｿ繧ｹ濶ｲ
           ============================================================ */
        .status-ok {
            color: var(--color-success);
        }

        .status-err {
            color: var(--color-error);
        }

        .status-warn {
            color: var(--color-warning);
        }

        /* 隕冶ｦ夂噪縺ｫ蠑ｷ蛹悶＆繧後◆繧ｹ繝・・繧ｿ繧ｹ陦ｨ遉ｺ */
        .status-message {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            animation: status-fade-in 0.3s ease-out;
        }

        @keyframes status-fade-in {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--color-error-light);
        }

        .status-message.warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: var(--color-warning-light);
        }

        .status-message.success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: var(--color-success-light);
        }

        .status-message.info {
            background: rgba(79, 195, 247, 0.15);
            border: 1px solid rgba(79, 195, 247, 0.3);
            color: var(--color-primary-light);
        }

        .status-message .status-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .status-message .status-content {
            flex: 1;
        }

        .status-message .status-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .status-message .status-detail {
            opacity: 0.85;
            font-size: var(--font-size-xs);
        }

        /* ============================================================
           繝励Ο繧ｰ繝ｬ繧ｹ繝舌・
           ============================================================ */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 100%);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            margin: 0.5rem 0; 
        }

        .checkbox-group input[type="checkbox"] { 
            width: 18px; 
            height: 18px; 
            accent-color: var(--color-primary);
            cursor: pointer;
        }

        .checkbox-group label {
            cursor: pointer;
            user-select: none;
        }

        .status-toggle-row { 
            display: flex; 
            align-items: center; 
            gap: 0.6rem; 
            margin: 0.4rem 0 0.8rem; 
        }

        /* 繝・く繧ｹ繝医お繝ｪ繧｢縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        textarea {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            resize: vertical;
            min-height: 80px;
            transition: all var(--transition-fast);
        }

        textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-glow);
        }

        /* 繝励Ξ繝ｼ繧ｹ繝帙Ν繝繝ｼ縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        ::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        /* 繧ｹ繧ｯ繝ｭ繝ｼ繝ｫ繝舌・縺ｮ繧ｹ繧ｿ繧､繝ｫ (隕冶ｪ肴ｧ蜷台ｸ・ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(79, 195, 247, 0.4) 0%, rgba(168, 85, 247, 0.3) 100%);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(79, 195, 247, 0.6) 0%, rgba(168, 85, 247, 0.5) 100%);
        }

        /* 繝ｪ繝ｳ繧ｯ縺ｮ繧ｹ繧ｿ繧､繝ｫ */
        a {
            color: var(--color-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--color-primary-light);
        }

        .bg-progress { 
            width: 240px; 
            height: 8px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 4px; 
            overflow: hidden; 
            margin: 0.4rem auto 0.2rem; 
        }

        .bg-progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 100%); 
            width: 0%; 
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .bg-module-list { 
            margin-top: 0.4rem; 
            font-size: 0.72rem; 
            opacity: 0.75; 
            text-align: left; 
            display: inline-block; 
        }

        .bg-module-item { 
            display: flex; 
            gap: 0.6rem; 
            justify-content: space-between; 
            min-width: 220px; 
        }

        .bg-module-state { opacity: 0.8; }

        .module-status { 
            margin-top: 0.6rem; 
            font-size: 0.72rem; 
            opacity: 0.8;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .module-status-item { 
            display: flex; 
            justify-content: space-between; 
            gap: 0.6rem; 
            padding: 0.15rem 0; 
        }

        .module-status-state { opacity: 0.9; }

        .module-progress { 
            width: 100%; 
            height: 6px; 
            background: rgba(255,255,255,0.1); 
            border-radius: 3px; 
            overflow: hidden; 
            margin: 0.15rem 0 0.4rem; 
        }

        .module-progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-accent) 100%); 
            width: 0%; 
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        /* Module Loading Animation */
        .module-progress-fill.indeterminate {
            width: 30%;
            animation: module-loading 1.5s ease-in-out infinite;
        }
        
        @keyframes module-loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }

        /* ============================================================
           繝医・繧ｹ繝磯夂衍
           ============================================================ */
        .toast-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            background: rgba(27, 38, 59, 0.98);
            border: 1px solid var(--border-light);
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius-lg);
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-size: var(--font-size-sm);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
            animation: toast-slide-in 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            max-width: 420px;
        }

        .toast.toast-success { 
            border-left-color: var(--color-success); 
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, rgba(27, 38, 59, 0.98) 20%);
        }
        .toast.toast-warning { 
            border-left-color: var(--color-warning); 
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, rgba(27, 38, 59, 0.98) 20%);
        }
        .toast.toast-error { 
            border-left-color: var(--color-error); 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(27, 38, 59, 0.98) 20%);
        }

        .toast-icon { 
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .toast-message { 
            flex: 1;
            line-height: 1.4;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .toast-close:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes toast-slide-in {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================================
           繝峨Ο繝・・繧ｾ繝ｼ繝ｳ (繝繝・す繝･繝懊・繝・
           ============================================================ */
        #drop-zone {
            border: 2px dashed var(--border-medium);
            border-radius: var(--radius-xl);
            padding: 3rem;
            text-align: center;
            transition: all var(--transition-normal);
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
        }

        #drop-zone:hover {
            border-color: var(--color-primary);
            background: rgba(79, 195, 247, 0.08);
            transform: scale(1.01);
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.15);
        }

        #drop-zone.drag-over {
            border-color: var(--color-primary);
            background: rgba(79, 195, 247, 0.15);
            transform: scale(1.02);
            box-shadow: 0 0 40px rgba(79, 195, 247, 0.25);
        }

        #drop-zone .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.7;
            transition: all var(--transition-normal);
        }

        #drop-zone:hover .upload-icon {
            transform: translateY(-5px);
            opacity: 1;
        }

        /* ============================================================
           繝繝・す繝･繝懊・繝峨き繝ｼ繝・           ============================================================ */
        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            transition: all var(--transition-normal);
            backdrop-filter: blur(10px);
        }

        .dashboard-card:hover {
            border-color: rgba(79, 195, 247, 0.3);
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        /* ============================================================
           繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧ｿ繧､繝医Ν
           ============================================================ */
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 1.25em;
            background: linear-gradient(180deg, var(--color-primary) 0%, var(--color-accent) 100%);
            border-radius: 2px;
        }

        /* ============================================================
           遨ｺ縺ｮ迥ｶ諷玖｡ｨ遉ｺ
           ============================================================ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: var(--font-size-base);
            max-width: 300px;
        }

        /* ============================================================
           繝ｬ繧ｹ繝昴Φ繧ｷ繝冶ｪｿ謨ｴ
           ============================================================ */
        @media (max-width: 1200px) {
            .sidebar {
                width: 160px;
            }
            .nav-btn {
                height: 38px;
                font-size: 1rem;
            }
            .nav-btn .nav-label {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                width: 56px;
            }
            .nav-btn {
                justify-content: center;
                padding: 0;
            }
            .nav-btn .nav-label {
                display: none !important;
            }
            .sidebar .module-status {
                display: none;
            }
            .sidebar h3 {
                display: none;
            }
        }

        /* ============================================================
           D3繝・・繝ｫ繝√ャ繝怜・騾壹せ繧ｿ繧､繝ｫ
           ============================================================ */
        .wc-tooltip,
        .network-tooltip,
        .sankey-tooltip,
        .circle-tooltip {
            position: absolute !important;
            background: rgba(13, 17, 23, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            color: var(--text-primary) !important;
            padding: 12px 16px !important;
            border-radius: var(--radius-lg) !important;
            font-size: 0.85rem !important;
            font-family: var(--font-family) !important;
            pointer-events: none !important;
            box-shadow: var(--shadow-xl) !important;
            border: 1px solid var(--border-light) !important;
            z-index: 10000 !important;
            animation: tooltip-fade-in 0.15s ease;
        }

        @keyframes tooltip-fade-in {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================================
           繧ｭ繝ｼ繝懊・繝峨す繝ｧ繝ｼ繝医き繝・ヨ繝偵Φ繝・           ============================================================ */
        .kbd {
            display: inline-block;
            padding: 0.15rem 0.4rem;
            font-size: 0.7rem;
            font-family: var(--font-mono);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-light);
            border-radius: 4px;
            color: var(--text-secondary);
        }

        /* ============================================================
           繝輔ぉ繝ｼ繝峨い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
           ============================================================ */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        .fade-out {
            animation: fadeOut 0.3s ease forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ============================================================
           繝代Ν繧ｹ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ (繧｢繧ｯ繝・ぅ繝冶ｦ∫ｴ逕ｨ)
           ============================================================ */
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ============================================================
           繧ｹ繧ｱ繝ｫ繝医Φ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ
           ============================================================ */
        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.05) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.05) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ============================================================
           繝帙ヰ繝ｼ繝ｪ繝輔ヨ繧ｨ繝輔ぉ繧ｯ繝・           ============================================================ */
        .hover-lift {
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }

        .hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        /* ============================================================
           繧ｰ繝ｭ繝ｼ蜉ｹ譫・           ============================================================ */
        .glow-primary {
            box-shadow: 0 0 20px var(--color-primary-glow);
        }

        .glow-accent {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.4);
        }

        /* ============================================================
           蛻晄悄蛹悶が繝ｼ繝舌・繝ｬ繧､蠑ｷ蛹・           ============================================================ */
        #init-overlay .init-subtitle {
            font-size: 0.9rem;
            color: var(--color-primary);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        #init-overlay .init-detail {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 0.3rem;
        }

        #init-overlay .init-hint {
            font-size: 0.8rem;
            opacity: 0.5;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div id="init-overlay">
        <h1>ARTEMIS</h1>
        <div class="spinner"></div>
        <p id="init-status" style="font-size: 1rem; margin-top: 0.5rem;">Python迺ｰ蠅・ｒ蛻晄悄蛹紋ｸｭ...</p>
        <p id="init-elapsed" class="init-subtitle">邨碁℃譎る俣: 0遘・/p>
        <p id="init-detail" class="init-detail">Pyodide + pandas + numpy 繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ</p>
        <p class="init-hint">譛蟆乗ｧ区・縺ｧ襍ｷ蜍穂ｸｭ・磯㍾縺・ｩ溯・縺ｯ繝舌ャ繧ｯ繧ｰ繝ｩ繧ｦ繝ｳ繝峨〒隱ｭ縺ｿ霎ｼ縺ｿ・・/p>
        <p id="bg-load-status" style="font-size: 0.75rem; opacity: 0.5; margin-top: 0.4rem;">霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ: 譛ｪ繝ｭ繝ｼ繝・/p>
        <div class="bg-progress"><div id="bg-load-progress-fill" class="bg-progress-fill"></div></div>
        <div id="bg-load-detail" class="bg-module-list"></div>
    </div>

    <div class="header">
        <h1>ARTEMIS</h1>
        <span id="py-status" style="margin-left: 0.6rem; font-size: 0.75rem; opacity: 0.6; font-weight: 400;">Engine loading窶ｦ</span>
        <span id="file-info" style="margin-left: auto; font-size: 0.8rem; opacity: 0.8; font-weight: 500; background: rgba(79, 195, 247, 0.1); padding: 0.3rem 0.8rem; border-radius: 20px;">繝・・繧ｿ譛ｪ隱ｭ霎ｼ</span>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <button class="nav-btn active" onclick="showPage('home')" title="繝繝・す繝･繝懊・繝・><span class="nav-label">繝繝・す繝･繝懊・繝・/span></button>
            <button class="nav-btn" onclick="showPage('mission')" title="蜑榊・逅・><span class="nav-label">蜑榊・逅・/span></button>
            <div class="nav-divider"></div>
            <button class="nav-btn" onclick="showPage('atlas')" title="邨ｱ險医メ繝｣繝ｼ繝・><span class="nav-label">邨ｱ險医メ繝｣繝ｼ繝・/span></button>
            <button class="nav-btn" onclick="showPage('core')" title="隲也炊蛻・｡・><span class="nav-label">隲也炊蛻・｡・/span></button>
            <button class="nav-btn" onclick="showPage('mega')" title="繝・く繧ｹ繝亥・譫・><span class="nav-label">繝・く繧ｹ繝亥・譫・/span></button>
            <button class="nav-btn" onclick="showPage('saturn')" title="謚陦薙・繝・・"><span class="nav-label">謚陦薙・繝・・</span></button>
            <button class="nav-btn" onclick="showPage('explorer')" title="繧ｭ繝ｼ繝ｯ繝ｼ繝・><span class="nav-label">繧ｭ繝ｼ繝ｯ繝ｼ繝・/span></button>
            <button class="nav-btn" onclick="showPage('crew')" title="繝阪ャ繝医Ρ繝ｼ繧ｯ"><span class="nav-label">繝阪ャ繝医Ρ繝ｼ繧ｯ</span></button>
            <button class="nav-btn" onclick="showPage('advanced')" title="繧｢繝峨ヰ繝ｳ繧ｹ繝・><span class="nav-label">繧｢繝峨ヰ繝ｳ繧ｹ繝・/span></button>
            <div class="nav-divider"></div>
            <button class="nav-btn" onclick="showPage('export')" title="繧ｨ繧ｯ繧ｹ繝昴・繝・><span class="nav-label">繧ｨ繧ｯ繧ｹ繝昴・繝・/span></button>
            <div class="module-status">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.3rem;">
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-core-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">蛻・｡・/span>
                    </div>
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-mega-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">繝・く繧ｹ繝・/span>
                    </div>
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-saturn-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">繝槭ャ繝・/span>
                    </div>
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-explorer-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">KW</span>
                    </div>
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-crew-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">NW</span>
                    </div>
                    <div class="module-status-item" style="flex-direction: column; align-items: center; padding: 0.2rem;">
                        <span id="mod-export-status" style="font-size: 0.7rem; color: var(--color-primary);">0%</span>
                        <span style="font-size: 0.55rem;">蜃ｺ蜉・/span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main">
            <!-- 繝繝・す繝･繝懊・繝・(繝帙・繝) -->
            <div id="page-home" class="page">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <!-- 蟾ｦ蛻・ 繝輔ぃ繧､繝ｫ繧｢繝・・繝ｭ繝ｼ繝・-->
                    <div class="dashboard-card" style="grid-row: span 2;">
                        <div class="section-title">繝・・繧ｿ繧定ｪｭ縺ｿ霎ｼ繧</div>
                        <div id="drop-zone" onclick="document.getElementById('file-input-home').click()">
                            <div class="upload-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/></svg></div>
                            <div style="font-size: 1.1rem; color: var(--color-primary); margin-bottom: 0.5rem;">CSV繝輔ぃ繧､繝ｫ繧偵ラ繝ｭ繝・・</div>
                            <div style="font-size: 0.85rem; color: var(--text-muted);">縺ｾ縺溘・ 繧ｯ繝ｪ繝・け縺励※驕ｸ謚・/div>
                            <input type="file" id="file-input-home" accept=".csv" style="display: none;">
                        </div>
                        <div id="home-file-status" style="margin-top: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem;"></div>
                        
                        <!-- 繧ｯ繧､繝・け繧｢繧ｯ繧ｷ繝ｧ繝ｳ -->
                        <div style="margin-top: 1.5rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="showPage('mission')">隧ｳ邏ｰ險ｭ螳・/button>
                            <button class="btn" id="home-launch-btn" disabled onclick="quickLaunch()">蛻・梵繧帝幕蟋・/button>
                        </div>
                    </div>
                    
                    <!-- 蜿ｳ蛻嶺ｸ・ 邨ｱ險医し繝槭Μ繝ｼ -->
                    <div class="dashboard-card">
                        <div class="section-title">繝・・繧ｿ繧ｵ繝槭Μ繝ｼ</div>
                        <div id="home-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            <div class="metric hover-lift">
                                <div class="metric-value" id="home-stat-total">-</div>
                                <div class="metric-label">邱丈ｻｶ謨ｰ</div>
                            </div>
                            <div class="metric hover-lift">
                                <div class="metric-value" id="home-stat-years">-</div>
                                <div class="metric-label">譛滄俣</div>
                            </div>
                            <div class="metric hover-lift">
                                <div class="metric-value" id="home-stat-applicants">-</div>
                                <div class="metric-label">蜃ｺ鬘倅ｺｺ</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 蜿ｳ蛻嶺ｸ・ 繧ｯ繧､繝・け繧｢繧ｯ繧ｻ繧ｹ -->
                    <div class="dashboard-card">
                        <div class="section-title">繧ｯ繧､繝・け繧｢繧ｯ繧ｻ繧ｹ</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                            <button class="btn btn-secondary hover-lift" onclick="showPage('atlas'); setAtlasChart('trend');">莉ｶ謨ｰ謗ｨ遘ｻ繧定｡ｨ遉ｺ</button>
                            <button class="btn btn-secondary hover-lift" onclick="showPage('atlas'); setAtlasChart('applicant');">蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ</button>
                            <button class="btn btn-secondary hover-lift" onclick="showPage('explorer');">繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝・/button>
                            <button class="btn btn-secondary hover-lift" onclick="showPage('crew');">蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ</button>
                        </div>
                    </div>
                </div>
                
                <!-- 繝繝・す繝･繝懊・繝峨・繝ｬ繝薙Η繝ｼ -->
                <div class="dashboard-card" style="margin-top: 1.5rem;">
                    <div class="section-title">繝・・繧ｿ蛻・梵繝励Ξ繝薙Η繝ｼ</div>
                    <div id="home-preview-container" class="empty-state" style="min-height: 280px;">
                        <div class="empty-state-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3v18h18"/><path d="M18 9l-5 5-4-4-3 3"/></svg></div>
                        <div class="empty-state-text">繝・・繧ｿ繧定ｪｭ縺ｿ霎ｼ繧縺ｨ繝ｪ繧｢繝ｫ繧ｿ繧､繝蛻・梵縺瑚｡ｨ遉ｺ縺輔ｌ縺ｾ縺・/div>
                    </div>
                    <!-- 繝励Ξ繝薙Η繝ｼ繧ｰ繝ｪ繝・ラ (繝・・繧ｿ隱ｭ縺ｿ霎ｼ縺ｿ蠕後↓陦ｨ遉ｺ) -->
                    <div id="home-preview-grid" class="hidden" style="display: none;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <!-- 蟾ｦ: 蟷ｴ谺｡謗ｨ遘ｻ・医お繝ｪ繧｢繝√Ε繝ｼ繝茨ｼ・-->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">蟷ｴ谺｡謗ｨ遘ｻ</div>
                                <div id="preview-trend" style="height: 140px;"></div>
                            </div>
                            <!-- 蜿ｳ: 蜃ｺ鬘倅ｺｺ蛻・ｸ・ｼ医ラ繝ｼ繝翫ヤ + 蜃｡萓具ｼ・-->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Top 蜃ｺ鬘倅ｺｺ</div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; height: 140px;">
                                    <div id="preview-applicants" style="flex: 0 0 100px; height: 100px;"></div>
                                    <div id="preview-applicants-legend" style="flex: 1; font-size: 0.7rem; overflow: hidden;"></div>
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <!-- 蟾ｦ: IPC蛻・ｸ・-->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">IPC蛻・｡・/div>
                                <div id="preview-ipc" style="height: 100px;"></div>
                            </div>
                            <!-- 蜿ｳ: 繧ｭ繝ｼ繝ｯ繝ｼ繝峨Α繝九け繝ｩ繧ｦ繝・-->
                            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">繧ｭ繝ｼ繝ｯ繝ｼ繝・/div>
                                <div id="preview-keywords" style="height: 100px; position: relative; overflow: hidden;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 蜑榊・逅・-->
            <div id="page-mission" class="page hidden">
                <div class="card">
                    <h2>蜑榊・逅・/h2>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('mission', 'import')">繧､繝ｳ繝昴・繝・/button>
                        <button class="tab-btn" onclick="showTab('mission', 'columns')">繧ｫ繝ｩ繝險ｭ螳・/button>
                        <button class="tab-btn" onclick="showTab('mission', 'launch')">襍ｷ蜍・/button>
                    </div>
                    
                    <div id="mission-tab-import" class="tab-content active">
                        <p style="margin-bottom: 0.8rem; font-size: 0.9rem;">CSV繝輔ぃ繧､繝ｫ繧偵い繝・・繝ｭ繝ｼ繝峨＠縺ｦ縺上□縺輔＞縲・/p>
                        <input type="file" id="file-input" accept=".csv">
                        <div id="preview-area" style="margin-top: 0.8rem;"></div>
                    </div>
                    
                    <div id="mission-tab-columns" class="tab-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>繧ｿ繧､繝医Ν</label>
                                <select id="col-title"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>隕∫ｴ・/label>
                                <select id="col-abstract"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>蜃ｺ鬘俶律</label>
                                <select id="col-date"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>蜃ｺ鬘倅ｺｺ</label>
                                <select id="col-applicant"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>IPC</label>
                                <select id="col-ipc"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>逋ｺ譏手・/label>
                                <select id="col-inventor"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                            <div class="form-group">
                                <label>繧ｹ繝・・繧ｿ繧ｹ・郁牡蛻・￠逕ｨ・・/label>
                                <select id="col-status"><option>(譛ｪ驕ｸ謚・</option></select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="mission-tab-launch" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.9rem;">蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧定ｵｷ蜍輔＠縺ｦ蜑榊・逅・ｒ螳溯｡後＠縺ｾ縺吶・/p>
                        <button id="btn-launch" class="btn" style="width: 100%;">蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧定ｵｷ蜍・/button>
                        <div class="progress-bar" style="display: none;" id="launch-progress">
                            <div class="progress-fill" id="launch-progress-fill" style="width: 0%;"></div>
                        </div>
                        <div id="launch-status" style="margin-top: 0.8rem;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 邨ｱ險医メ繝｣繝ｼ繝・-->
            <div id="page-atlas" class="page hidden">
                <div class="card">
                    <h2>邨ｱ險医メ繝｣繝ｼ繝・/h2>
                    <div class="grid-4" style="margin-bottom: 0.8rem;">
                        <div class="form-group">
                            <label>髢句ｧ句ｹｴ</label>
                            <input type="number" id="year-start" value="2000">
                        </div>
                        <div class="form-group">
                            <label>邨ゆｺ・ｹｴ</label>
                            <input type="number" id="year-end" value="2025">
                        </div>
                        <div class="form-group">
                            <label>TOP N</label>
                            <input type="number" id="top-n" value="15" min="5" max="50">
                        </div>
                        <div class="form-group">
                            <label style="visibility: hidden;">_</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="use-status-breakdown">
                                <label for="use-status-breakdown" style="color: #e0e1dd;">繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ繧定｡ｨ遉ｺ</label>
                            </div>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="setAtlasChart('trend')">莉ｶ謨ｰ謗ｨ遘ｻ</button>
                        <button class="tab-btn" onclick="setAtlasChart('trend_line')">謚倥ｌ邱・/button>
                        <button class="tab-btn" onclick="setAtlasChart('applicant')">蜃ｺ鬘倅ｺｺ</button>
                        <button class="tab-btn" onclick="setAtlasChart('ipc')">IPC</button>
                        <button class="tab-btn" onclick="setAtlasChart('bubble')">蜃ｺ鬘倅ｺｺﾃ怜ｹｴ</button>
                        <button class="tab-btn" onclick="setAtlasChart('ipc_applicant')">IPCﾃ怜・鬘倅ｺｺ</button>
                        <button class="tab-btn" onclick="setAtlasChart('treemap')">Treemap</button>
                        <button class="tab-btn" onclick="setAtlasChart('lifecycle')">繝ｩ繧､繝輔し繧､繧ｯ繝ｫ</button>
                    </div>
                    <div id="atlas-status-toggle-row" class="status-toggle-row"></div>
                    <div id="atlas-control-applicant" class="grid-2" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>陦ｨ遉ｺ莠ｺ謨ｰ</label>
                            <input type="number" id="atlas-applicant-count" value="20" min="1" max="50">
                        </div>
                    </div>
                    <div id="atlas-control-ipc" class="grid-3" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>IPC繝ｬ繝吶Ν</label>
                            <select id="atlas-ipc-level">
                                <option value="1">繧ｵ繝悶け繝ｩ繧ｹ (A01B)</option>
                                <option value="2">繝｡繧､繝ｳ繧ｰ繝ｫ繝ｼ繝・(A01B 1/00)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>陦ｨ遉ｺIPC謨ｰ</label>
                            <input type="number" id="atlas-ipc-count" value="20" min="1" max="50">
                        </div>
                    </div>
                    <div id="atlas-control-bubble" class="grid-2" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>陦ｨ遉ｺ莠ｺ謨ｰ</label>
                            <input type="number" id="atlas-bubble-count" value="10" min="1" max="30">
                        </div>
                    </div>
                    <div id="atlas-control-ipc-applicant" class="grid-3" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>IPC繝ｬ繝吶Ν</label>
                            <select id="atlas-ipcapp-level">
                                <option value="1">繧ｵ繝悶け繝ｩ繧ｹ</option>
                                <option value="2">繝｡繧､繝ｳ繧ｰ繝ｫ繝ｼ繝・/option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>IPC謨ｰ (Y霆ｸ)</label>
                            <input type="number" id="atlas-ipcapp-ipc-count" value="15" min="1" max="50">
                        </div>
                        <div class="form-group">
                            <label>蜃ｺ鬘倅ｺｺ謨ｰ (X霆ｸ)</label>
                            <input type="number" id="atlas-ipcapp-app-count" value="15" min="1" max="50">
                        </div>
                    </div>
                    <div id="atlas-control-treemap" class="grid-2" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>陦ｨ遉ｺ繝｢繝ｼ繝・/label>
                            <select id="atlas-treemap-mode">
                                <option value="ipc">IPC髫主ｱ､ (謚陦灘・驥・</option>
                                <option value="applicant">蜃ｺ鬘倅ｺｺ繧ｷ繧ｧ繧｢</option>
                            </select>
                        </div>
                    </div>
                    <div id="atlas-line-controls" class="grid-2" style="margin: 0.5rem 0; display: none;">
                        <div class="form-group">
                            <label>陦ｨ遉ｺ繝｢繝ｼ繝・/label>
                            <select id="atlas-line-mode">
                                <option value="overall">蜈ｨ菴捺耳遘ｻ</option>
                                <option value="compare">蜃ｺ鬘倅ｺｺ豈碑ｼ・/option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>蜃ｺ鬘倅ｺｺ・域怙螟ｧ5遉ｾ・・/label>
                            <select id="atlas-line-applicants" multiple style="height: 110px;"></select>
                        </div>
                    </div>
                    <button id="btn-atlas" class="btn" style="margin: 0.5rem 0;">繝√Ε繝ｼ繝医ｒ謠冗判</button>
                    <div id="atlas-chart" class="chart-container"></div>
                    <button class="btn btn-secondary" onclick="saveSnapshot('atlas-chart', '邨ｱ險医メ繝｣繝ｼ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                </div>
            </div>
            
            <!-- 隲也炊蛻・｡・-->
            <div id="page-core" class="page hidden">
                <div class="card">
                    <h2>隲也炊蛻・｡・/h2>
                    <div class="form-group">
                        <label>繝輔ぉ繝ｼ繧ｺ驕ｸ謚・/label>
                        <select id="core-phase">
                            <option value="phase1">繝輔ぉ繝ｼ繧ｺ 1: AI繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝・(KMeans)</option>
                            <option value="phase2">繝輔ぉ繝ｼ繧ｺ 2: 蛻・｡槭Ν繝ｼ繝ｫ螳夂ｾｩ</option>
                            <option value="phase3">繝輔ぉ繝ｼ繧ｺ 3: 蛻・｡槫ｮ溯｡・/option>
                            <option value="phase4" selected>繝輔ぉ繝ｼ繧ｺ 4: 迚ｹ險ｱ繝槭ャ繝嶺ｽ懈・</option>
                        </select>
                    </div>

                    <div id="core-phase1" class="core-phase" style="display:none;">
                        <div class="form-group">
                            <label>蛻・梵蟇ｾ雎｡繧ｫ繝ｩ繝</label>
                            <select id="core-ai-target">
                                <option value="text">繧ｿ繧､繝医Ν・玖ｦ∫ｴ・/option>
                            </select>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>繝医ヴ繝・け謨ｰ (K)</label>
                                <input type="number" id="core-ai-k" value="8" min="2" max="20">
                            </div>
                            <div class="form-group">
                                <label>繧ｵ繝ｳ繝励Ν謨ｰ (N)</label>
                                <input type="number" id="core-ai-n" value="5" min="1" max="20">
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="core-ai-mece" checked>
                            <label for="core-ai-mece" style="color: #e0e1dd;">MECE繝｢繝ｼ繝・(閾ｪ蜍墓ｱｺ螳・</label>
                        </div>
                        <button class="btn" id="btn-core-ai" style="margin-top:0.5rem;">ｧ AI繧｢繧ｷ繧ｹ繧ｿ繝ｳ繝育畑繝励Ο繝ｳ繝励ヨ逕滓・</button>
                        <div id="core-ai-output" style="margin-top:0.8rem;"></div>
                    </div>

                    <div id="core-phase2" class="core-phase" style="display:none;">
                        <div class="grid-2" style="margin-bottom:0.6rem;">
                            <div class="form-group">
                                <label>霆ｸ縺ｮ謖・ｮ・/label>
                                <select id="core-axis-mode">
                                    <option value="new">譁ｰ隕丈ｽ懈・</option>
                                    <option value="existing" selected>譌｢蟄倥↓霑ｽ蜉</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>霑ｽ蜉/菫ｮ豁｣蜈医・霆ｸ</label>
                                <select id="core-axis-select"></select>
                            </div>
                        </div>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>譁ｰ隕剰ｻｸ蜷・/label>
                                <input type="text" id="core-axis-new" placeholder="萓・ 隱ｲ鬘悟・鬘・>
                            </div>
                            <div class="form-group">
                                <label>蛻・｡槫錐</label>
                                <input type="text" id="core-cat-name" placeholder="萓・ 閠蝉ｹ・ｧ蜷台ｸ・>
                            </div>
                            <div class="form-group">
                                <label>隲也炊蠑・/label>
                                <input type="text" id="core-cat-rule" placeholder="(閠蝉ｹ・ｧ + 蟇ｿ蜻ｽ) * 蜷台ｸ・>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>螳夂ｾｩ</label>
                            <textarea id="core-cat-def" rows="2"></textarea>
                        </div>
                        <button class="btn" id="btn-core-add">筐・繝ｫ繝ｼ繝ｫ繧定ｿｽ蜉</button>
                        <button class="btn" id="btn-core-update" style="display:none; margin-left:0.4rem;">笨・繝ｫ繝ｼ繝ｫ繧呈峩譁ｰ</button>
                        <button class="btn" id="btn-core-cancel" style="display:none; margin-left:0.4rem;">笨・邱ｨ髮・ｒ繧ｭ繝｣繝ｳ繧ｻ繝ｫ</button>
                        <div id="core-rule-list" style="margin-top:0.8rem;"></div>
                        <div class="form-group">
                            <label>JSON荳諡ｬ繧､繝ｳ繝昴・繝・/label>
                            <textarea id="core-json" rows="8" placeholder="AI縺檎函謌舌＠縺櫟SON繧定ｲｼ繧贋ｻ倥￠"></textarea>
                        </div>
                        <button class="btn" id="btn-core-import">JSON繧偵う繝ｳ繝昴・繝・/button>
                        <div id="core-rule-status" style="margin-top:0.8rem;"></div>
                    </div>

                    <div id="core-phase3" class="core-phase" style="display:none;">
                        <p style="color:#9fb3c8;">謗｢邏｢遽・峇縺ｯ縲後ち繧､繝医Ν・玖ｦ∫ｴ・阪・邨仙粋繝・く繧ｹ繝医〒縺吶・/p>
                        <button class="btn" id="btn-core-run">笆ｶ 縺吶∋縺ｦ縺ｮ蛻・｡槭ｒ螳溯｡・/button>
                        <div id="core-run-status" style="margin-top:0.8rem;"></div>
                        <div id="core-summary" style="margin-top:0.8rem;"></div>
                        <div style="margin-top:0.8rem;">
                            <label>蛻・｡樒ｵ先棡CSV・医さ繝斐・逕ｨ・・/label>
                            <textarea id="core-csv" rows="6" readonly></textarea>
                        </div>
                        <div class="grid-2" style="margin-top:0.8rem;">
                            <div class="form-group">
                                <label>蜀榊・譫舌☆繧玖ｻｸ</label>
                                <select id="core-reanalyze-axis"></select>
                            </div>
                            <div class="form-group">
                                <label>謚ｽ蜃ｺ繝医ヴ繝・け謨ｰ (K)</label>
                                <input type="number" id="core-reanalyze-k" value="5" min="1" max="10">
                            </div>
                            <div class="form-group">
                                <label>繧ｵ繝ｳ繝励Ν謨ｰ (N)</label>
                                <input type="number" id="core-reanalyze-n" value="3" min="1" max="10">
                            </div>
                        </div>
                        <div class="checkbox-group" style="margin-top:0.4rem;">
                            <input type="checkbox" id="core-reanalyze-mece" checked>
                            <label for="core-reanalyze-mece" style="color:#e0e1dd;">MECE繝｢繝ｼ繝・(閾ｪ蜍・</label>
                        </div>
                        <button class="btn" id="btn-core-reanalyze" style="margin-top:0.6rem;">煤 縲弱◎縺ｮ莉悶上ｒ蜀榊・譫・/button>
                        <div id="core-reanalyze-output" style="margin-top:0.8rem;"></div>
                    </div>

                    <div id="core-phase4" class="core-phase">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>X霆ｸ</label>
                                <select id="core-x-axis"></select>
                            </div>
                            <div class="form-group">
                                <label>Y霆ｸ</label>
                                <select id="core-y-axis"></select>
                            </div>
                            <div class="form-group">
                                <label>繧ｰ繝ｩ繝輔ち繧､繝・/label>
                                <select id="core-map-type">
                                    <option value="heatmap">繝偵・繝医・繝・・</option>
                                    <option value="bubble">繝舌ヶ繝ｫ繝√Ε繝ｼ繝・/option>
                                </select>
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="core-exclude-other" checked>
                            <label for="core-exclude-other" style="color:#e0e1dd;">縲後◎縺ｮ莉悶阪ｒ髯､螟悶☆繧・/label>
                        </div>
                        <button id="btn-core-map" class="btn">迚ｹ險ｱ繝槭ャ繝励ｒ謠冗判</button>
                        <div id="core-map" class="chart-container" style="margin-top:0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('core-map', '隲也炊蛻・｡槭・繝・・')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                        <hr style="margin:1rem 0; border-color:#2b3a4a;">
                        <div class="form-group">
                            <label>讀懃ｴ｢繧ｯ繧ｨ繝ｪ・・ND, OR, NOT, nearN, adjN蟇ｾ蠢懶ｼ・/label>
                            <input type="text" id="core-query" placeholder="萓・ (髮ｻ豎 + 繧ｻ繝ｫ) * (繝ｪ繝√え繝 + 繝翫ヨ繝ｪ繧ｦ繝)">
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>讀懃ｴ｢蟇ｾ雎｡</label>
                                <select id="core-target">
                                    <option value="all">繧ｿ繧､繝医Ν・玖ｦ∫ｴ・/option>
                                    <option value="title">繧ｿ繧､繝医Ν縺ｮ縺ｿ</option>
                                    <option value="abstract">隕∫ｴ・・縺ｿ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>譛螟ｧ邨先棡謨ｰ</label>
                                <input type="number" id="core-limit" value="100" min="10" max="500">
                            </div>
                        </div>
                        <button id="btn-core-search" class="btn">讀懃ｴ｢繧貞ｮ溯｡・/button>
                        <div id="core-results" style="margin-top: 0.8rem;"></div>
                    </div>
                </div>
            </div>
            
            <!-- 謚陦薙・繝・・ -->
            <div id="page-saturn" class="page hidden">
                <div class="card">
                    <h2>謚陦薙・繝・・</h2>
                    <div class="grid-3" style="margin-bottom: 0.8rem;">
                        <div class="form-group">
                            <label>繧ｯ繝ｩ繧ｹ繧ｿ謨ｰ</label>
                            <input type="number" id="n-clusters" value="8" min="3" max="20">
                        </div>
                        <div class="form-group">
                            <label>繧ｵ繝ｳ繝励Ν謨ｰ (0=蜈ｨ莉ｶ)</label>
                            <input type="number" id="sample-size" value="500" min="0" step="100">
                        </div>
                        <div class="form-group">
                            <label>谺｡蜈・炎貂・/label>
                            <select id="dim-method">
                                <option value="pca">PCA</option>
                                <option value="svd">TruncatedSVD</option>
                                <option value="tsne">t-SNE</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-3" style="margin-bottom: 0.8rem;">
                        <div class="checkbox-group">
                            <input type="checkbox" id="saturn-contour" checked>
                            <label for="saturn-contour" style="color: #e0e1dd;">遲蛾ｫ倡ｷ夊｡ｨ遉ｺ</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="saturn-hull">
                            <label for="saturn-hull" style="color: #e0e1dd;">繧ｯ繝ｩ繧ｹ繧ｿ蠅・阜</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="saturn-labels" checked>
                            <label for="saturn-labels" style="color: #e0e1dd;">繝ｩ繝吶Ν陦ｨ遉ｺ</label>
                        </div>
                    </div>
                    <button id="btn-saturn" class="btn" style="width: 100%;">繝槭ャ繝励ｒ逕滓・</button>
                    <div id="saturn-status" style="margin-top: 0.5rem;"></div>
                    <div id="saturn-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                    <button class="btn btn-secondary" onclick="saveSnapshot('saturn-chart', '謚陦薙・繝・・')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    <div id="saturn-summary" style="margin-top: 0.8rem;"></div>
                </div>
            </div>
            
            <!-- 繧ｭ繝ｼ繝ｯ繝ｼ繝牙・譫・-->
            <div id="page-explorer" class="page hidden">
                <div class="card">
                    <h2>繧ｭ繝ｼ繝ｯ繝ｼ繝牙・譫・/h2>
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('explorer', 'ranking')">繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ</button>
                        <button class="tab-btn" onclick="showTab('explorer', 'trend')">繝医Ξ繝ｳ繝・/button>
                        <button class="tab-btn" onclick="showTab('explorer', 'compare')">莨∵･ｭ豈碑ｼ・/button>
                        <button class="tab-btn" onclick="showTab('explorer', 'heatmap')">繝偵・繝医・繝・・</button>
                        <button class="tab-btn" onclick="showTab('explorer', 'emerging')">諤･荳頑・繝ｯ繝ｼ繝・/button>
                        <button class="tab-btn" onclick="showTab('explorer', 'kwic')">KWIC讀懃ｴ｢</button>
                        <button class="tab-btn" onclick="showTab('explorer', 'stream')">繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝・/button>
                    </div>
                    
                    <div id="explorer-tab-ranking" class="tab-content active">
                        <div class="form-group">
                            <label>TOP N</label>
                            <input type="number" id="keyword-top" value="30" min="10" max="100">
                        </div>
                        <button id="btn-keyword" class="btn">繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ繧貞・譫・/button>
                        <div id="keyword-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('keyword-chart', '繧ｭ繝ｼ繝ｯ繝ｼ繝峨Λ繝ｳ繧ｭ繝ｳ繧ｰ')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="explorer-tab-trend" class="tab-content">
                        <div class="form-group">
                            <label>繧ｭ繝ｼ繝ｯ繝ｼ繝会ｼ医き繝ｳ繝槫玄蛻・ｊ・・/label>
                            <input type="text" id="trend-keywords" placeholder="萓・ AI, 讖滓｢ｰ蟄ｦ鄙・ 繝・ぅ繝ｼ繝励Λ繝ｼ繝九Φ繧ｰ">
                        </div>
                        <button id="btn-trend" class="btn">繝医Ξ繝ｳ繝峨ｒ蛻・梵</button>
                        <div id="trend-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('trend-chart', '繝医Ξ繝ｳ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="explorer-tab-compare" class="tab-content">
                        <div class="form-group">
                            <label>豈碑ｼ・☆繧倶ｼ∵･ｭ・亥・鬘倅ｺｺ・・/label>
                            <select id="compare-companies" multiple size="5" style="height: auto;"></select>
                        </div>
                        <button id="btn-compare" class="btn">豈碑ｼ・ｒ螳溯｡・/button>
                        <div id="compare-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('compare-chart', '莨∵･ｭ豈碑ｼ・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="explorer-tab-heatmap" class="tab-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>莨∵･ｭ謨ｰ</label>
                                <input type="number" id="heatmap-companies" value="10" min="5" max="20">
                            </div>
                            <div class="form-group">
                                <label>繧ｭ繝ｼ繝ｯ繝ｼ繝画焚</label>
                                <input type="number" id="heatmap-keywords" value="15" min="5" max="30">
                            </div>
                        </div>
                        <button id="btn-heatmap" class="btn">繝偵・繝医・繝・・繧堤函謌・/button>
                        <div id="heatmap-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('heatmap-chart', '繝偵・繝医・繝・・')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="explorer-tab-emerging" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">逶ｴ霑第悄髢薙〒諤･荳頑・縺励※縺・ｋ繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ讀懷・縺励∪縺吶・/p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>蝓ｺ貅門ｹｴ・医％縺ｮ蟷ｴ莉･髯阪ｒ縲檎峩霑代阪→縺吶ｋ・・/label>
                                <input type="number" id="emerging-year" value="2020">
                            </div>
                            <div class="form-group">
                                <label>陦ｨ遉ｺ謨ｰ</label>
                                <input type="number" id="emerging-top" value="20" min="10" max="50">
                            </div>
                        </div>
                        <button id="btn-emerging" class="btn">諤･荳頑・繝ｯ繝ｼ繝峨ｒ讀懷・</button>
                        <div id="emerging-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('emerging-chart', '諤･荳頑・繝ｯ繝ｼ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="explorer-tab-kwic" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">繧ｭ繝ｼ繝ｯ繝ｼ繝峨・譁・ц繧堤｢ｺ隱阪＠縺ｾ縺呻ｼ・WIC: Keyword in Context・・/p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>讀懃ｴ｢繧ｭ繝ｼ繝ｯ繝ｼ繝・/label>
                                <input type="text" id="kwic-keyword" placeholder="萓・ 繝ｭ繝懊ャ繝・>
                            </div>
                            <div class="form-group">
                                <label>蜑榊ｾ後・譁・ｭ玲焚</label>
                                <input type="number" id="kwic-context" value="30" min="10" max="100">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.5rem;">
                            <label>讀懃ｴ｢蟇ｾ雎｡</label>
                            <select id="kwic-target">
                                <option value="title">逋ｺ譏弱・蜷咲ｧｰ</option>
                                <option value="abstract">隕∫ｴ・/option>
                                <option value="claims">隲区ｱる・/option>
                            </select>
                        </div>
                        <button id="btn-kwic" class="btn">KWIC繧呈､懃ｴ｢</button>
                        <div id="kwic-result" style="margin-top: 0.8rem; max-height: 400px; overflow-y: auto;"></div>
                    </div>
                    
                    <!-- 繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝・-->
                    <div id="explorer-tab-stream" class="tab-content">
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
                            縲ｰ・・隍・焚繧ｭ繝ｼ繝ｯ繝ｼ繝峨・譎らｳｻ蛻玲耳遘ｻ繧堤ｾ弱＠縺・せ繝医Μ繝ｼ繝繧ｰ繝ｩ繝輔〒蜿ｯ隕門喧縺励∪縺吶・                        </p>
                        <div class="grid-2" style="margin-bottom: 0.8rem;">
                            <div class="form-group">
                                <label>蛻・梵繧ｿ繧､繝・/label>
                                <select id="stream-type">
                                    <option value="keyword">繧ｭ繝ｼ繝ｯ繝ｼ繝画耳遘ｻ</option>
                                    <option value="applicant">蜃ｺ鬘倅ｺｺ謗ｨ遘ｻ</option>
                                    <option value="ipc">IPC謗ｨ遘ｻ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>陦ｨ遉ｺ謨ｰ</label>
                                <input type="number" id="stream-count" value="8" min="3" max="15">
                            </div>
                        </div>
                        <button id="btn-stream" class="btn">繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝輔ｒ逕滓・</button>
                        <div id="stream-chart" class="chart-container" style="margin-top: 0.8rem; min-height: 450px;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('stream-chart', '繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                </div>
            </div>
            
            <!-- 繝阪ャ繝医Ρ繝ｼ繧ｯ蛻・梵 -->
            <div id="page-crew" class="page hidden">
                <div class="card">
                    <h2>繝阪ャ繝医Ρ繝ｼ繧ｯ蛻・梵</h2>
                    <div class="tabs" style="margin-bottom: 0.8rem;">
                        <button class="tab-btn active" onclick="showTab('crew', 'force')">繝輔か繝ｼ繧ｹ繝ｬ繧､繧｢繧ｦ繝・/button>
                        <button class="tab-btn" onclick="showTab('crew', 'chord')">繧ｳ繝ｼ繝牙峙</button>
                    </div>
                    
                    <div id="crew-tab-force" class="tab-content active">
                    <div class="grid-2" style="margin-bottom: 0.8rem;">
                        <div class="form-group">
                            <label>繝阪ャ繝医Ρ繝ｼ繧ｯ繧ｿ繧､繝・/label>
                            <select id="network-type">
                                <option value="applicant" selected>蜃ｺ鬘倅ｺｺ繝阪ャ繝医Ρ繝ｼ繧ｯ</option>
                                <option value="inventor">逋ｺ譏手・ロ繝・ヨ繝ｯ繝ｼ繧ｯ</option>
                                <option value="ipc">IPC蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>譛蟆上お繝・ず驥阪∩</label>
                            <input type="number" id="min-edge" value="2" min="1" max="10">
                        </div>
                    </div>
                    <div class="grid-2" style="margin-bottom: 0.8rem;">
                        <div class="form-group">
                            <label>荳ｭ蠢・ｧ謖・ｨ・/label>
                            <select id="network-centrality">
                                <option value="degree">谺｡謨ｰ荳ｭ蠢・ｧ</option>
                                <option value="betweenness">蟐剃ｻ倶ｸｭ蠢・ｧ</option>
                                <option value="closeness">霑第磁荳ｭ蠢・ｧ</option>
                                <option value="eigenvector">蝗ｺ譛峨・繧ｯ繝医Ν荳ｭ蠢・ｧ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>陦ｨ遉ｺ繝弱・繝画焚</label>
                            <input type="number" id="network-max-nodes" value="50" min="10" max="200">
                        </div>
                    </div>
                    <button id="btn-network" class="btn" style="width: 100%;">繝阪ャ繝医Ρ繝ｼ繧ｯ繧堤函謌・/button>
                    <div id="network-status" style="margin-top: 0.5rem;"></div>
                    <div id="network-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                    <button class="btn btn-secondary" onclick="saveSnapshot('network-chart', '繝阪ャ繝医Ρ繝ｼ繧ｯ')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    <div id="network-stats" style="margin-top: 0.8rem;"></div>
                    </div>
                    
                    <!-- 繧ｳ繝ｼ繝牙峙・・hord Diagram・・-->
                    <div id="crew-tab-chord" class="tab-content">
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
                            七 蜈ｱ蜷悟・鬘倅ｺｺ繧・匱譏手・俣縺ｮ髢｢菫ゅｒ鄒弱＠縺・さ繝ｼ繝牙峙・・hord Diagram・峨〒蜿ｯ隕門喧縺励∪縺吶・                        </p>
                        <div class="grid-2" style="margin-bottom: 0.8rem;">
                            <div class="form-group">
                                <label>蛻・梵繧ｿ繧､繝・/label>
                                <select id="chord-type">
                                    <option value="ipc" selected>IPC蜈ｱ襍ｷ髢｢菫・/option>
                                    <option value="applicant">蜈ｱ蜷悟・鬘倅ｺｺ髢｢菫・/option>
                                    <option value="inventor">逋ｺ譏手・さ繝ｩ繝・/option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>陦ｨ遉ｺ謨ｰ</label>
                                <input type="number" id="chord-count" value="15" min="5" max="30">
                            </div>
                        </div>
                        <button id="btn-chord" class="btn">繧ｳ繝ｼ繝牙峙繧堤函謌・/button>
                        <div id="chord-chart" class="chart-container" style="margin-top: 0.8rem; min-height: 550px;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('chord-chart', '繧ｳ繝ｼ繝牙峙')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                </div>
            </div>
            
            <!-- 繝・く繧ｹ繝亥・譫・-->
            <div id="page-mega" class="page hidden">
                <div class="card">
                    <h2>繝・く繧ｹ繝亥・譫・/h2>
                    <div style="margin-bottom: 0.5rem; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">繝・く繧ｹ繝域歓蜃ｺ</div>
                    <div class="tabs" style="margin-bottom: 0.5rem;">
                        <button class="tab-btn active" onclick="showTab('mega', 'wordcloud')">繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝・/button>
                        <button class="tab-btn" onclick="showTab('mega', 'ngram')">N-gram</button>
                        <button class="tab-btn" onclick="showTab('mega', 'cooccur')">蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ</button>
                        <button class="tab-btn" onclick="showTab('mega', 'tfidf')">TF-IDF</button>
                    </div>
                    <div style="margin-bottom: 0.5rem; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">鬮伜ｺｦ縺ｪ蜿ｯ隕門喧</div>
                    <div class="tabs">
                        <button class="tab-btn" onclick="showTab('mega', 'treemap')">繝・Μ繝ｼ繝槭ャ繝・/button>
                        <button class="tab-btn" onclick="showTab('mega', 'sankey')">繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ</button>
                        <button class="tab-btn" onclick="showTab('mega', 'radar')">繝ｬ繝ｼ繝繝ｼ</button>
                        <button class="tab-btn" onclick="showTab('mega', 'sunburst')">繧ｵ繝ｳ繝舌・繧ｹ繝・/button>
                    </div>
                    
                    <div id="mega-tab-wordcloud" class="tab-content active">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>譛螟ｧ隱樊焚</label>
                                <input type="number" id="wc-max-words" value="100" min="20" max="200">
                            </div>
                            <div class="form-group">
                                <label>繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝</label>
                                <select id="wc-colorscheme">
                                    <option value="viridis" selected>Viridis</option>
                                    <option value="plasma">Plasma</option>
                                    <option value="matplotlib">Matplotlib</option>
                                    <option value="warm">Warm</option>
                                    <option value="rainbow">Rainbow</option>
                                    <option value="blues">Blues</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn-wordcloud" class="btn">繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝峨ｒ逕滓・</button>
                        <div id="wordcloud-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('wordcloud-chart', '繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="mega-tab-ngram" class="tab-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>N-gram繧ｵ繧､繧ｺ</label>
                                <select id="ngram-size">
                                    <option value="2">繝舌う繧ｰ繝ｩ繝 (2隱・</option>
                                    <option value="3">繝医Λ繧､繧ｰ繝ｩ繝 (3隱・</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>TOP N</label>
                                <input type="number" id="ngram-top" value="25" min="10" max="50">
                            </div>
                        </div>
                        <button id="btn-ngram" class="btn">N-gram繧貞・譫・/button>
                        <div id="ngram-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('ngram-chart', 'N-gram')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="mega-tab-cooccur" class="tab-content">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>繧ｭ繝ｼ繝ｯ繝ｼ繝画焚</label>
                                <input type="number" id="cooccur-nodes" value="30" min="10" max="50">
                            </div>
                            <div class="form-group">
                                <label>譛蟆丞・襍ｷ謨ｰ</label>
                                <input type="number" id="cooccur-min" value="3" min="1" max="10">
                            </div>
                        </div>
                        <button id="btn-cooccur" class="btn">蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ繧堤函謌・/button>
                        <div id="cooccur-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('cooccur-chart', '蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <div id="mega-tab-tfidf" class="tab-content">
                        <div class="form-group">
                            <label>蛻・梵蟇ｾ雎｡莨∵･ｭ・亥・鬘倅ｺｺ・・/label>
                            <select id="tfidf-company"></select>
                        </div>
                        <button id="btn-tfidf" class="btn">迚ｹ蠕ｴ隱槭ｒ謚ｽ蜃ｺ</button>
                        <div id="tfidf-result" style="margin-top: 0.8rem;"></div>
                    </div>
                    
                    <div id="mega-tab-strategy" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">蜃ｺ鬘倅ｺｺ縺ｮ謌宣聞邇・→繧ｷ繧ｧ繧｢繧貞・譫舌＠縲∵姶逡･繝昴ず繧ｷ繝ｧ繝ｳ繧貞庄隕門喧縺励∪縺吶・/p>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>蛻・梵蟇ｾ雎｡莨∵･ｭ謨ｰ</label>
                                <input type="number" id="strategy-companies" value="15" min="5" max="30">
                            </div>
                            <div class="form-group">
                                <label>蝓ｺ貅門ｹｴ・・AGR險育ｮ礼畑・・/label>
                                <input type="number" id="strategy-base-year" value="2018">
                            </div>
                            <div class="form-group">
                                <label>繝舌ヶ繝ｫ繧ｵ繧､繧ｺ</label>
                                <select id="strategy-size">
                                    <option value="total">邱丞・鬘倅ｻｶ謨ｰ</option>
                                    <option value="recent">逶ｴ霑・蟷ｴ莉ｶ謨ｰ</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn-strategy" class="btn">謌ｦ逡･繝槭ヨ繝ｪ繧ｯ繧ｹ繧貞・譫・/button>
                        <div id="strategy-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('strategy-chart', '謌ｦ逡･繝槭ヨ繝ｪ繧ｯ繧ｹ')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                        <div id="strategy-summary" style="margin-top: 0.8rem;"></div>
                    </div>
                    
                    <!-- 繝・Μ繝ｼ繝槭ャ繝・-->
                    <div id="mega-tab-treemap" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">IPC蛻・｡槭・髫主ｱ､讒矩繧偵ヤ繝ｪ繝ｼ繝槭ャ繝励〒蜿ｯ隕門喧縺励∪縺吶・/p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>陦ｨ遉ｺ髫主ｱ､</label>
                                <select id="treemap-level">
                                    <option value="section">繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ (A-H)</option>
                                    <option value="class" selected>繧ｯ繝ｩ繧ｹ (萓・ G06)</option>
                                    <option value="subclass">繧ｵ繝悶け繝ｩ繧ｹ (萓・ G06F)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝</label>
                                <select id="treemap-color">
                                    <option value="Viridis" selected>Viridis (繧ｰ繝ｪ繝ｼ繝ｳ邉ｻ)</option>
                                    <option value="Sunset">Sunset (繧ｪ繝ｬ繝ｳ繧ｸ邉ｻ)</option>
                                    <option value="Plasma">Plasma (繝代・繝励Ν邉ｻ)</option>
                                    <option value="Turbo">Turbo (繝ｬ繧､繝ｳ繝懊・)</option>
                                    <option value="Cividis">Cividis (繧､繧ｨ繝ｭ繝ｼ邉ｻ)</option>
                                    <option value="Inferno">Inferno (證冶牡邉ｻ)</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn-treemap" class="btn">繝・Μ繝ｼ繝槭ャ繝励ｒ逕滓・</button>
                        <div id="treemap-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('treemap-chart', 'IPC繝・Μ繝ｼ繝槭ャ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <!-- 繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ・・3.js迚茨ｼ・-->
                    <div id="mega-tab-sankey" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">蜃ｺ鬘倅ｺｺ縺ｨ謚陦灘・驥趣ｼ・PC/FI・峨・髢｢菫ゅｒ繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ縺ｧ蜿ｯ隕門喧縺励∪縺吶・/p>
                        <div class="grid-3">
                            <div class="form-group">
                                <label>蜃ｺ鬘倅ｺｺ謨ｰ</label>
                                <input type="number" id="sankey-applicants" value="10" min="5" max="20">
                            </div>
                            <div class="form-group">
                                <label>IPC/FI謨ｰ</label>
                                <input type="number" id="sankey-ipcs" value="10" min="5" max="20">
                            </div>
                            <div class="form-group">
                                <label>繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝</label>
                                <select id="sankey-color">
                                    <option value="category" selected>繧ｫ繝・ざ繝ｪ蛻･</option>
                                    <option value="gradient">繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn-sankey" class="btn">繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ繧堤函謌・/button>
                        <div id="sankey-chart" class="chart-container" style="margin-top: 0.8rem; min-height: 500px;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('sankey-chart', '繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <!-- 繝ｬ繝ｼ繝繝ｼ繝√Ε繝ｼ繝・-->
                    <div id="mega-tab-radar" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">驕ｸ謚槭＠縺滉ｼ∵･ｭ縺ｮ謚陦薙・繝ｼ繝医ヵ繧ｩ繝ｪ繧ｪ繧偵Ξ繝ｼ繝繝ｼ繝√Ε繝ｼ繝医〒豈碑ｼ・＠縺ｾ縺吶・/p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>豈碑ｼ・ｼ∵･ｭ1</label>
                                <select id="radar-company1"></select>
                            </div>
                            <div class="form-group">
                                <label>豈碑ｼ・ｼ∵･ｭ2</label>
                                <select id="radar-company2"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>豈碑ｼ・ｻｸ (IPC陦ｨ遉ｺ繝ｬ繝吶Ν)</label>
                            <select id="radar-axis">
                                <option value="section">繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ (A-H)</option>
                                <option value="class" selected>繧ｯ繝ｩ繧ｹ (TOP10)</option>
                            </select>
                        </div>
                        <button id="btn-radar" class="btn">繝ｬ繝ｼ繝繝ｼ繝√Ε繝ｼ繝医ｒ逕滓・</button>
                        <div id="radar-chart" class="chart-container" style="margin-top: 0.8rem;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('radar-chart', '繝ｬ繝ｼ繝繝ｼ繝√Ε繝ｼ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                    
                    <!-- 繧ｵ繝ｳ繝舌・繧ｹ繝・-->
                    <div id="mega-tab-sunburst" class="tab-content">
                        <p style="margin-bottom: 0.8rem; font-size: 0.85rem;">IPC蛻・｡槭・髫主ｱ､讒矩繧呈叛蟆・憾縺ｮ繧ｵ繝ｳ繝舌・繧ｹ繝亥峙縺ｧ蜿ｯ隕門喧縺励∪縺吶ゅけ繝ｪ繝・け縺ｧ繧ｺ繝ｼ繝繧､繝ｳ/繧｢繧ｦ繝医・/p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>繝・・繧ｿ貅・/label>
                                <select id="sunburst-source">
                                    <option value="ipc" selected>IPC蛻・｡・/option>
                                    <option value="fi">FI蛻・｡・/option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝</label>
                                <select id="sunburst-color">
                                    <option value="Spectral" selected>Spectral</option>
                                    <option value="Rainbow">Rainbow</option>
                                    <option value="Viridis">Viridis</option>
                                    <option value="Plasma">Plasma</option>
                                </select>
                            </div>
                        </div>
                        <button id="btn-sunburst" class="btn">繧ｵ繝ｳ繝舌・繧ｹ繝医ｒ逕滓・</button>
                        <div id="sunburst-chart" class="chart-container" style="margin-top: 0.8rem; min-height: 550px;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('sunburst-chart', '繧ｵ繝ｳ繝舌・繧ｹ繝・)" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Visualizations - PyScript Exclusive -->
            <div id="page-advanced" class="page hidden">
                <div class="card">
                    <h2>繧｢繝峨ヰ繝ｳ繧ｹ繝牙庄隕門喧</h2>
                    <p style="margin-bottom: 1rem; color: #4fc3f7; font-size: 0.9rem;">
                        PyScript縺ｪ繧峨〒縺ｯ縺ｮ繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑蜿ｯ隕門喧讖溯・
                    </p>
                    
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showTab('nova', 'bubble-race')">繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ</button>
                        <button class="tab-btn" onclick="showTab('nova', 'circle-pack')">繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｯ</button>
                        <button class="tab-btn" onclick="showTab('nova', 'dendro')">繝・Φ繝峨Ο繧ｰ繝ｩ繝</button>
                    </div>
                    
                    <!-- 繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ -->
                    <div id="nova-tab-bubble-race" class="tab-content active">
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
                            蟷ｴ縺斐→縺ｮ蜃ｺ鬘倅ｺｺ繧ｷ繧ｧ繧｢繧偵い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺ｧ蜀咲函縺励∪縺吶・                        </p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>陦ｨ遉ｺ莨∵･ｭ謨ｰ</label>
                                <input type="number" id="race-companies" value="10" min="5" max="15">
                            </div>
                            <div class="form-group">
                                <label>繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ騾溷ｺｦ</label>
                                <select id="race-speed">
                                    <option value="slow">繧・▲縺上ｊ (1遘・蟷ｴ)</option>
                                    <option value="normal" selected>譎ｮ騾・(0.5遘・蟷ｴ)</option>
                                    <option value="fast">鬮倬・(0.25遘・蟷ｴ)</option>
                                    <option value="ultra">雜・ｫ倬・(0.1遘・蟷ｴ)</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button id="btn-race-play" class="btn" onclick="window.bubbleRacePlay()">笆ｶ・・蜀咲函</button>
                            <button id="btn-race-pause" class="btn btn-secondary" onclick="window.bubbleRacePause()">竢ｸ・・荳譎ょ●豁｢</button>
                            <button id="btn-race-reset" class="btn btn-secondary" onclick="window.bubbleRaceReset()">竢ｮ・・繝ｪ繧ｻ繝・ヨ</button>
                        </div>
                        <div id="race-year-display" style="text-align: center; font-size: 2rem; font-weight: bold; color: #4fc3f7; margin: 1rem 0;"></div>
                        <div id="race-chart" class="chart-container" style="min-height: 450px;"></div>
                    </div>
                    
                    <!-- 繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｭ繝ｳ繧ｰ -->
                    <div id="nova-tab-circle-pack" class="tab-content">
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
                            髫主ｱ､逧・↑繝・・繧ｿ讒矩繧偵う繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑蜀・〒陦ｨ遉ｺ縺励∪縺吶ょ・繧偵け繝ｪ繝・け縺ｧ繧ｺ繝ｼ繝縲√＆繧峨↓繧ｯ繝ｪ繝・け縺ｧ譯井ｻｶ繝ｪ繧ｹ繝郁｡ｨ遉ｺ縲・                        </p>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>髫主ｱ､</label>
                                <select id="circle-hierarchy">
                                    <option value="applicant-ipc" selected>蜃ｺ鬘倅ｺｺ 竊・IPC</option>
                                    <option value="ipc-applicant">IPC 竊・蜃ｺ鬘倅ｺｺ</option>
                                    <option value="year-applicant">蟷ｴ 竊・蜃ｺ鬘倅ｺｺ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>陦ｨ遉ｺ謨ｰ</label>
                                <input type="number" id="circle-count" value="8" min="5" max="15">
                            </div>
                        </div>
                        <button id="btn-circle-pack" class="btn">繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｯ繧堤函謌・/button>
                        <div style="display: flex; gap: 1rem; margin-top: 0.8rem;">
                            <div id="circle-chart" class="chart-container" style="flex: 0 0 550px; min-height: 550px;"></div>
                            <div id="circle-detail-panel" style="flex: 1; min-width: 300px; max-height: 550px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 1rem; display: none;">
                                <h4 style="color: #4fc3f7; margin-bottom: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span id="circle-detail-title">搭 譯井ｻｶ繝ｪ繧ｹ繝・/span>
                                    <button onclick="document.getElementById('circle-detail-panel').style.display='none';" style="margin-left: auto; background: none; border: none; color: #888; cursor: pointer; font-size: 1.2rem;">笨・/button>
                                </h4>
                                <div id="circle-detail-content" style="font-size: 0.85rem;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 繝・Φ繝峨Ο繧ｰ繝ｩ繝 -->
                    <div id="nova-tab-dendro" class="tab-content">
                        <p style="color: #aaa; font-size: 0.9rem; margin-bottom: 1rem;">
                            諺 髫主ｱ､逧・け繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ縺ｮ邨先棡繧偵ョ繝ｳ繝峨Ο繧ｰ繝ｩ繝・域ｨｹ蠖｢蝗ｳ・峨〒蜿ｯ隕門喧縺励∪縺吶・                        </p>
                        <div class="grid-2" style="margin-bottom: 0.8rem;">
                            <div class="form-group">
                                <label>繧ｯ繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ蟇ｾ雎｡</label>
                                <select id="dendro-target">
                                    <option value="applicant" selected>蜃ｺ鬘倅ｺｺ・域橿陦馴｡樔ｼｼ蠎ｦ・・/option>
                                    <option value="keyword">繧ｭ繝ｼ繝ｯ繝ｼ繝会ｼ亥・襍ｷ繝代ち繝ｼ繝ｳ・・/option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>陦ｨ遉ｺ謨ｰ</label>
                                <input type="number" id="dendro-count" value="20" min="10" max="50">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0.8rem;">
                            <label>霍晞屬險育ｮ玲ｳ・/label>
                            <select id="dendro-method">
                                <option value="ward" selected>Ward豕・/option>
                                <option value="complete">Complete豕・/option>
                                <option value="average">Average豕・/option>
                            </select>
                        </div>
                        <button id="btn-dendro" class="btn">繝・Φ繝峨Ο繧ｰ繝ｩ繝繧堤函謌・/button>
                        <div id="dendro-chart" class="chart-container" style="margin-top: 0.8rem; min-height: 500px;"></div>
                        <button class="btn btn-secondary" onclick="saveSnapshot('dendro-chart', '繝・Φ繝峨Ο繧ｰ繝ｩ繝')" style="margin-top: 0.5rem;">繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ・/button>
                    </div>
                </div>
            </div>
            
            <!-- Export -->
            <div id="page-export" class="page hidden">
                <div class="card">
                    <h2>繧ｨ繧ｯ繧ｹ繝昴・繝・/h2>
                    <p style="margin-bottom: 1rem;">蛻・梵邨先棡繧偵お繧ｯ繧ｹ繝昴・繝医・繝ｬ繝昴・繝育函謌舌〒縺阪∪縺吶・/p>
                    <div class="grid-2">
                        <button id="btn-export-summary" class="btn">邨ｱ險医し繝槭Μ繝ｼ繧偵さ繝斐・</button>
                        <button id="btn-export-keywords" class="btn">繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ繧ｳ繝斐・</button>
                    </div>
                    <div class="grid-2" style="margin-top: 0.5rem;">
                        <button id="btn-generate-report" class="btn">繝ｬ繝昴・繝医ｒ逕滓・</button>
                        <button id="btn-export-all" class="btn">蜈ｨ繝・・繧ｿ繧偵お繧ｯ繧ｹ繝昴・繝・/button>
                    </div>
                    <div id="export-result" style="margin-top: 1rem;"></div>
                    
                    <div id="report-output" style="margin-top: 1rem; display: none;">
                        <h4>搭 閾ｪ蜍慕函謌舌Ξ繝昴・繝・/h4>
                        <textarea id="report-text" rows="15" style="width: 100%; background: rgba(0,0,0,0.3); color: #e0e1dd; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; padding: 0.5rem;"></textarea>
                        <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(document.getElementById('report-text').value); alert('繧ｳ繝斐・縺励∪縺励◆');" style="margin-top: 0.3rem;">搭 繝ｬ繝昴・繝医ｒ繧ｳ繝斐・</button>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <h4>萄 繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧ｮ繝｣繝ｩ繝ｪ繝ｼ</h4>
                        <p style="font-size: 0.85rem; color: #888; margin-bottom: 0.5rem;">蜷・メ繝｣繝ｼ繝医・縲後せ繝翫ャ繝励す繝ｧ繝・ヨ菫晏ｭ倥阪・繧ｿ繝ｳ縺ｧ逕ｻ蜒上ｒ菫晏ｭ倥〒縺阪∪縺・/p>
                        <div id="snapshot-gallery" style="margin-top: 0.5rem;">
                            <p style="color: #888;">菫晏ｭ倥＆繧後◆繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <h4>搭 繝・・繧ｿ繝励Ξ繝薙Η繝ｼ</h4>
                        <div id="data-preview" style="max-height: 300px; overflow-y: auto; margin-top: 0.5rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* ============================================================
           ARTEMIS - JavaScript繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ繧ｳ繧｢
           ============================================================
           
           縺薙・繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ縺ｧ邂｡逅・☆繧区ｩ溯・:
           - Python蛻晄悄蛹悶・繧ｿ繧､繝溘Φ繧ｰ縺ｨ繧ｹ繝・・繧ｿ繧ｹ陦ｨ遉ｺ
           - UI繧ｹ繝・・繝育ｮ｡逅・           - 繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ縺ｨ繝壹・繧ｸ蛻・ｊ譖ｿ縺・           - 繝｢繧ｸ繝･繝ｼ繝ｫ隱ｭ縺ｿ霎ｼ縺ｿ騾ｲ謐励ヨ繝ｩ繝・く繝ｳ繧ｰ
           - PyScript/Pyodide縺ｨ縺ｮ騾壻ｿ｡
           
           ============================================================ */
        
        // ============================================================
        // 繝・ヰ繝・げ繝｢繝ｼ繝芽ｨｭ螳・        // ============================================================
        
        /**
         * 譛ｬ逡ｪ繝｢繝ｼ繝峨ヵ繝ｩ繧ｰ縲Ｕrue縺ｮ蝣ｴ蜷医√ョ繝舌ャ繧ｰ繝ｭ繧ｰ繧呈椛蛻ｶ縺吶ｋ縲・         * 髢狗匱譎ゅ・false縺ｫ險ｭ螳壹＠縺ｦ繝・ヰ繝・げ繝ｭ繧ｰ繧呈怏蜉ｹ蛹悶☆繧九・         */
        const PRODUCTION_MODE = true;
        
        /**
         * 譚｡莉ｶ莉倥″繝ｭ繧ｰ髢｢謨ｰ縲１RODUCTION_MODE縺掲alse縺ｮ蝣ｴ蜷医・縺ｿ繝ｭ繧ｰ繧貞・蜉帙☆繧九・         * @param {...any} args - console.log縺ｫ貂｡縺吝ｼ墓焚
         */
        function debugLog(...args) {
            if (!PRODUCTION_MODE) {
                debugLog(...args);
            }
        }
        
        // ============================================================
        // 蛻晄悄蛹悶ち繧､繝槭・
        // ============================================================
        
        /**
         * Python迺ｰ蠅・・蛻晄悄蛹匁凾髢薙ｒ險域ｸｬ縺吶ｋ縲・         * 蛻晏屓繝ｭ繝ｼ繝我ｸｭ縺ｫ繝ｦ繝ｼ繧ｶ繝ｼ縺ｸ邨碁℃譎る俣繧定｡ｨ遉ｺ縺吶ｋ縺溘ａ縺ｫ菴ｿ逕ｨ縲・         */
        window.__pyInitStart = Date.now();
        window.__pyInitTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - window.__pyInitStart) / 1000);
            const min = Math.floor(elapsed / 60);
            const sec = elapsed % 60;
            const timeStr = min > 0 ? `${min}蛻・{sec}遘蛋 : `${sec}遘蛋;
            const elapsedEl = document.getElementById('init-elapsed');
            if (elapsedEl) elapsedEl.textContent = `邨碁℃譎る俣: ${timeStr}`;
            
            // Show warning if loading takes too long
            const detailEl = document.getElementById('init-detail');
            if (detailEl) {
                if (elapsed > 120) {
                    detailEl.textContent = '笞・・隱ｭ縺ｿ霎ｼ縺ｿ縺ｫ譎る俣縺後°縺九▲縺ｦ縺・∪縺吶ゅロ繝・ヨ繝ｯ繝ｼ繧ｯ謗･邯壹ｒ遒ｺ隱阪＠縺ｦ縺上□縺輔＞縲・;
                    detailEl.style.color = '#ff6b6b';
                } else if (elapsed > 60) {
                    detailEl.textContent = '繝代ャ繧ｱ繝ｼ繧ｸ縺ｮ繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ... (蛻晏屓縺ｯ譎る俣縺後°縺九ｊ縺ｾ縺・';
                    detailEl.style.color = '#ffd93d';
                } else {
                    detailEl.textContent = 'Pyodide + pandas + numpy 繧偵ム繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ...';
                }
            }
            
            // Log progress periodically
            if (elapsed % 10 === 0 && elapsed > 0) {
                debugLog(`[Init] Python蛻晄悄蛹紋ｸｭ... ${timeStr}`);
            }
        }, 1000);
        
        // ============================================================
        // 繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ迥ｶ諷狗ｮ｡逅・        // ============================================================
        
        /** PapaParse縺ｧ隗｣譫舌＆繧後◆CSV繝・・繧ｿ (Python襍ｷ蜍募燕縺ｮ繧ｯ繧､繝・け繧｢繧ｯ繧ｻ繧ｹ逕ｨ) */
        window.quickData = null;
        /** 隱ｭ縺ｿ霎ｼ繧薙□CSV縺ｮ繧ｫ繝ｩ繝蜷堺ｸ隕ｧ */
        window.quickColumns = [];
        /** 繧ｯ繧､繝・け繝・・繧ｿ縺悟茜逕ｨ蜿ｯ閭ｽ縺九←縺・°縺ｮ繝輔Λ繧ｰ */
        window.quickReady = false;
        
        /**
         * 繧ｰ繝ｭ繝ｼ繝舌Ν繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ迥ｶ諷九が繝悶ず繧ｧ繧ｯ繝医・         * UI險ｭ螳壹→繝｢繧ｸ繝･繝ｼ繝ｫ縺ｮ迥ｶ諷九ｒ霑ｽ霍｡縺吶ｋ縲・         */
        window.appState = {
            chartType: 'trend',
            statusBreakdownByType: {
                trend: false,
                trend_line: false,
                applicant: false,
                ipc: false,
                bubble: false,
                ipc_applicant: false,
                treemap: false,
                lifecycle: false
            }
        };

        // ============================================================
        // ATLAS繝｢繧ｸ繝･繝ｼ繝ｫ - UI蜷梧悄
        // ============================================================
        
        /**
         * 繝√Ε繝ｼ繝医ち繧､繝励↓蝓ｺ縺･縺・※繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ繝√ぉ繝・け繝懊ャ繧ｯ繧ｹ縺ｮ迥ｶ諷九ｒ蜷梧悄縺吶ｋ縲・         * 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ繧偵し繝昴・繝医☆繧九メ繝｣繝ｼ繝医ち繧､繝励→縺昴≧縺ｧ縺ｪ縺・ｂ縺ｮ縺後≠繧九・         */
        function syncAtlasStatusCheckbox() {
            const checkbox = document.getElementById('use-status-breakdown');
            if (!checkbox) return;
            
            const enabledTypes = ['trend', 'trend_line', 'applicant', 'bubble'];
            let enabled = enabledTypes.includes(window.appState.chartType);
            
            // 謚倥ｌ邱壹メ繝｣繝ｼ繝医・縲悟・菴薙阪Δ繝ｼ繝峨〒縺ｮ縺ｿ蜀・ｨｳ繧偵し繝昴・繝・            if (window.appState.chartType === 'trend_line') {
                const lineMode = document.getElementById('atlas-line-mode')?.value || 'overall';
                enabled = enabled && lineMode === 'overall';
            }
            
            checkbox.disabled = !enabled;
            const row = document.getElementById('atlas-status-toggle-row');
            if (row) row.style.display = enabled ? 'flex' : 'none';
            
            if (!enabled) {
                checkbox.checked = false;
                return;
            }
            
            const state = window.appState.statusBreakdownByType || {};
            checkbox.checked = !!state[window.appState.chartType];
        }

        /**
         * 驕ｸ謚槭＆繧後◆繝√Ε繝ｼ繝医ち繧､繝励↓蝓ｺ縺･縺・※繝√Ε繝ｼ繝亥崋譛峨・繧ｳ繝ｳ繝医Ο繝ｼ繝ｫ繝代ロ繝ｫ繧定｡ｨ遉ｺ/髱櫁｡ｨ遉ｺ縺ｫ縺吶ｋ縲・         */
        function syncAtlasControls() {
            const lineControls = document.getElementById('atlas-line-controls');
            if (!lineControls) return;
            lineControls.style.display = window.appState.chartType === 'trend_line' ? 'grid' : 'none';

            const applicantCtl = document.getElementById('atlas-control-applicant');
            if (applicantCtl) applicantCtl.style.display = window.appState.chartType === 'applicant' ? 'grid' : 'none';

            const ipcCtl = document.getElementById('atlas-control-ipc');
            if (ipcCtl) ipcCtl.style.display = window.appState.chartType === 'ipc' ? 'grid' : 'none';

            const bubbleCtl = document.getElementById('atlas-control-bubble');
            if (bubbleCtl) bubbleCtl.style.display = window.appState.chartType === 'bubble' ? 'grid' : 'none';

            const ipcAppCtl = document.getElementById('atlas-control-ipc-applicant');
            if (ipcAppCtl) ipcAppCtl.style.display = window.appState.chartType === 'ipc_applicant' ? 'grid' : 'none';

            const treemapCtl = document.getElementById('atlas-control-treemap');
            if (treemapCtl) treemapCtl.style.display = window.appState.chartType === 'treemap' ? 'grid' : 'none';
        }

        /**
         * ATLAS蜈･蜉帙さ繝ｳ繝医Ο繝ｼ繝ｫ縺ｫchange繧､繝吶Φ繝医Μ繧ｹ繝翫・繧偵ヰ繧､繝ｳ繝峨☆繧九・         * 險ｭ螳壼､画峩譎ゅ↓繝√Ε繝ｼ繝医・蜀肴緒逕ｻ繧偵ヨ繝ｪ繧ｬ繝ｼ縺吶ｋ縲・         */
        function bindAtlasInputs() {
            const btn = document.getElementById('btn-atlas');
            if (!btn) return;
            
            const replot = () => btn.click();
            const ids = [
                'atlas-line-mode',
                'atlas-line-applicants',
                'atlas-applicant-count',
                'atlas-ipc-level',
                'atlas-ipc-count',
                'atlas-bubble-count',
                'atlas-ipcapp-level',
                'atlas-ipcapp-ipc-count',
                'atlas-ipcapp-app-count',
                'atlas-treemap-mode'
            ];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('change', replot);
            });
            
            const lineMode = document.getElementById('atlas-line-mode');
            if (lineMode) {
                lineMode.addEventListener('change', syncAtlasStatusCheckbox);
            }
        }

        // ============================================================
        // CORE繝｢繧ｸ繝･繝ｼ繝ｫ - 繝輔ぉ繝ｼ繧ｺ邂｡逅・        // ============================================================
        
        /**
         * CORE繝｢繧ｸ繝･繝ｼ繝ｫ縺ｮ繝輔ぉ繝ｼ繧ｺ繧貞・繧頑崛縺医ｋ (繝ｫ繝ｼ繝ｫ菴懈・ / 繝ｫ繝ｼ繝ｫ驕ｩ逕ｨ)縲・         */
        function syncCorePhase() {
            const sel = document.getElementById('core-phase');
            if (!sel) return;
            
            document.querySelectorAll('.core-phase').forEach(p => p.style.display = 'none');
            const target = document.getElementById('core-' + sel.value);
            if (target) target.style.display = 'block';
            
            // Sync axis selections
            if (window.pyodide_globals && window.pyodide_globals.update_core_axis_selects) {
                window.pyodide_globals.update_core_axis_selects();
            }
            
            // Render rules if in phase 2
            if (sel.value === 'phase2' && window.pyodide_globals && window.pyodide_globals.render_core_rules) {
                window.pyodide_globals.render_core_rules();
            }
            
            // Reset button visibility in phase 2
            if (sel.value === 'phase2') {
                const addBtn = document.getElementById('btn-core-add');
                const updBtn = document.getElementById('btn-core-update');
                const cancelBtn = document.getElementById('btn-core-cancel');
                if (addBtn && updBtn && cancelBtn) {
                    addBtn.style.display = 'inline-block';
                    updBtn.style.display = 'none';
                    cancelBtn.style.display = 'none';
                }
            }
        }

        // ============================================================
        // Python/Pyodide 迥ｶ諷狗ｮ｡逅・        // ============================================================
        
        /** Python迺ｰ蠅・′貅門ｙ螳御ｺ・°縺ｩ縺・°縺ｮ繝輔Λ繧ｰ */
        window.__pyReady = false;
        /** 繝・・繧ｿ繧｢繝・・繝ｭ繝ｼ繝牙ｾ後・菫晉蕗荳ｭ縺ｮ襍ｷ蜍輔い繧ｯ繧ｷ繝ｧ繝ｳ縺ｮ繝輔Λ繧ｰ */
        window.__pendingLaunch = false;

        /**
         * Python迺ｰ蠅・・蛻晄悄蛹門ｮ御ｺ・凾縺ｫ蜻ｼ縺ｳ蜃ｺ縺輔ｌ繧九・         * 蛻晄悄蛹悶ち繧､繝槭・繧貞●豁｢縺励・㍾驥上ヱ繝・こ繝ｼ繧ｸ縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ繧帝幕蟋九☆繧九・         * @param {boolean} isReady - Python縺梧ｺ門ｙ螳御ｺ・°縺ｩ縺・°
         */
        function setPyReady(isReady) {
            debugLog('[Init] setPyReady called with:', isReady);
            
            // Stop timer when Python initialization completes
            if (isReady && window.__pyInitTimer) {
                clearInterval(window.__pyInitTimer);
                const elapsed = Math.floor((Date.now() - window.__pyInitStart) / 1000);
                debugLog(`[Init] Python蛻晄悄蛹門ｮ御ｺ・ ${elapsed}遘蛋);
            }
            
            const status = document.getElementById('py-status');
            if (status) status.textContent = isReady ? 'Engine ready' : 'Engine loading窶ｦ';
            updateModuleProgress('export', isReady ? '貅門ｙ螳御ｺ・ : '貅門ｙ荳ｭ', isReady ? 100 : 0);
            
            const baseIds = [];
            baseIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = !isReady;
            });
            
            if (!isReady) {
                setHeavyReady(false);
            }
            
            window.__pyReady = isReady;
            
            // Execute pending launch if data was uploaded before Python was ready
            if (isReady && window.__pendingLaunch) {
                const launchBtn = document.getElementById('btn-launch');
                if (launchBtn) launchBtn.click();
                window.__pendingLaunch = false;
            }
            
            // Start loading heavy packages (scikit-learn, networkx)
            if (isReady) {
                requestHeavyPackages();
            }
        }

        /**
         * 驥埼㍼繝代ャ繧ｱ繝ｼ繧ｸ (scikit-learn, networkx) 縺ｮ隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・凾縺ｫ蜻ｼ縺ｳ蜃ｺ縺輔ｌ繧九・         * 縺薙ｌ繧峨・繝代ャ繧ｱ繝ｼ繧ｸ縺ｫ萓晏ｭ倥☆繧句・繝｢繧ｸ繝･繝ｼ繝ｫ繝懊ち繝ｳ繧呈怏蜉ｹ蛹悶☆繧九・         * @param {boolean} isReady - 驥埼㍼繝代ャ繧ｱ繝ｼ繧ｸ縺瑚ｪｭ縺ｿ霎ｼ縺ｿ貂医∩縺九←縺・°
         */
        function setHeavyReady(isReady) {
            debugLog('[Heavy] setHeavyReady called with:', isReady);
            
            // Stop elapsed time timer
            if (isReady && window.__heavyElapsedTimer) {
                clearInterval(window.__heavyElapsedTimer);
            }
            
            const status = document.getElementById('bg-load-status');
            if (status && isReady) status.textContent = '霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ: 隱ｭ縺ｿ霎ｼ縺ｿ螳御ｺ・笨・;
            
            if (isReady) {
                updateHeavyProgress('螳御ｺ・, { 'scikit-learn': '螳御ｺ・笨・, 'networkx': '螳御ｺ・笨・ });
            }
            
            const phaseText = isReady ? '貅門ｙ螳御ｺ・ : '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ';
            const phasePct = isReady ? 100 : null;
            
            if (!isReady) {
                ['core','mega','saturn','explorer','crew'].forEach(key => {
                    updateModuleProgress(key, phaseText, phasePct);
                });
            }
            
            // Button IDs that require heavy packages
            const ids = [
                'btn-core-search','btn-core-ai','btn-core-import','btn-core-add','btn-core-update','btn-core-cancel',
                'btn-core-run','btn-core-reanalyze','btn-core-map',
                'btn-saturn','btn-keyword','btn-trend','btn-compare','btn-heatmap','btn-emerging',
                'btn-network','btn-wordcloud','btn-ngram','btn-cooccur','btn-tfidf',
                'btn-export-summary','btn-export-keywords'
            ];
            
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = !isReady;
            });
            
            if (isReady) {
                startModuleSequence();
            }
        }

        /**
         * 繝｢繧ｸ繝･繝ｼ繝ｫ繧ｹ繝・・繧ｿ繧ｹ繧､繝ｳ繧ｸ繧ｱ繝ｼ繧ｿ繝ｼ繧帝・分縺ｫ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺輔○繧九・         * 繝｢繧ｸ繝･繝ｼ繝ｫ縺御ｸ縺､縺壹▽隱ｭ縺ｿ霎ｼ縺ｾ繧後ｋ隕冶ｦ夂噪蜉ｹ譫懊ｒ菴懈・縺吶ｋ縲・         */
        function startModuleSequence() {
            if (window.__moduleSeqRunning) return;
            window.__moduleSeqRunning = true;
            
            const plan = [
                { key: 'core', buttons: ['btn-core-search','btn-core-ai','btn-core-import','btn-core-add','btn-core-update','btn-core-cancel','btn-core-run','btn-core-reanalyze','btn-core-map'] },
                { key: 'mega', buttons: ['btn-keyword','btn-trend','btn-compare','btn-heatmap','btn-emerging'] },
                { key: 'saturn', buttons: ['btn-saturn'] },
                { key: 'explorer', buttons: ['btn-network','btn-wordcloud','btn-ngram','btn-cooccur'] },
                { key: 'crew', buttons: ['btn-tfidf'] }
            ];
            plan.forEach((item, idx) => {
                const delay = idx * 700;
                setTimeout(() => {
                    updateModuleProgress(item.key, '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ', null);
                    setTimeout(() => {
                        updateModuleProgress(item.key, '貅門ｙ螳御ｺ・, 100);
                        item.buttons.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) el.disabled = false;
                        });
                    }, 500);
                }, delay);
            });
        }

        function updateHeavyProgress(phaseText, states, elapsedSec) {
            const status = document.getElementById('bg-load-status');
            const detail = document.getElementById('bg-load-detail');
            const fill = document.getElementById('bg-load-progress-fill');
            let elapsed = '';
            if (elapsedSec !== undefined && elapsedSec > 0) {
                const min = Math.floor(elapsedSec / 60);
                const sec = Math.floor(elapsedSec % 60);
                elapsed = min > 0 ? ` (${min}蛻・{sec}遘・` : ` (${sec}遘・`;
            }
            if (status && phaseText) status.textContent = `霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ: ${phaseText}${elapsed}`;
            const modules = ['scikit-learn', 'networkx'];
            const stateMap = states || {};
            if (detail) {
                detail.innerHTML = modules.map(m => {
                    const s = stateMap[m] || '蠕・ｩ・;
                    return `<div class="bg-module-item"><span>${m}</span><span class="bg-module-state">${s}</span></div>`;
                }).join('');
            }
            if (fill) {
                const done = modules.filter(m => stateMap[m] === '螳御ｺ・).length;
                const pct = Math.round((done / modules.length) * 100);
                fill.style.width = `${pct}%`;
            }
        }

        function updateModuleProgress(key, label, pct) {
            const statusEl = document.getElementById(`mod-${key}-status`);
            const progEl = document.getElementById(`mod-${key}-progress`);
            if (statusEl) {
                // 繝溘ル繝槭Ν陦ｨ遉ｺ: 繝代・繧ｻ繝ｳ繝・・繧ｸ縺ｮ縺ｿ
                statusEl.textContent = pct === null ? '...' : `${pct}%`;
            }
            if (progEl) {
                if (pct === null) {
                    progEl.classList.add('indeterminate');
                } else {
                    progEl.classList.remove('indeterminate');
                    progEl.style.width = `${pct}%`;
                }
            }
        }

        function syncCoreAxisMode() {
            const mode = document.getElementById('core-axis-mode').value;
            const axisSelect = document.getElementById('core-axis-select');
            const axisNew = document.getElementById('core-axis-new');
            if (axisSelect && axisSelect.value === '') {
                document.getElementById('core-axis-mode').value = 'new';
            }
            if (mode === 'new') {
                axisSelect.disabled = true;
                axisNew.disabled = false;
            } else {
                axisSelect.disabled = false;
                axisNew.disabled = true;
            }
        }

        async function requestHeavyPackages() {
            debugLog('[Heavy] requestHeavyPackages called, loading:', window.__heavyPackagesLoading);
            if (window.__heavyPackagesLoading) return;
            window.__heavyPackagesLoading = true;
            window.__heavyLoadStart = Date.now();
            
            const status = document.getElementById('bg-load-status');
            
            // 邨碁℃譎る俣繧定ｿｽ霍｡・亥ｸｸ縺ｫ髢句ｧ具ｼ・            const startTime = Date.now();
            
            const updateElapsed = () => {
                const sec = Math.floor((Date.now() - startTime) / 1000);
                const min = Math.floor(sec / 60);
                const s = sec % 60;
                const timeStr = min > 0 ? `${min}蛻・{s}遘蛋 : `${s}遘蛋;
                
                // Python髢｢謨ｰ縺悟茜逕ｨ蜿ｯ閭ｽ縺九メ繧ｧ繝・け
                const pyFuncReady = typeof window.pyLoadHeavyPackages === 'function';
                if (!pyFuncReady) {
                    if (status) status.textContent = `Python襍ｷ蜍募ｾ・■... (${timeStr})`;
                    updateHeavyProgress(`Python襍ｷ蜍募ｾ・■ (${timeStr})`, { 'scikit-learn': '蠕・ｩ・, 'networkx': '蠕・ｩ・ });
                    updateModuleProgress('core', `Python襍ｷ蜍募ｾ・■ (${timeStr})`, null);
                }
            };
            
            // 邨碁℃譎る俣繧ｿ繧､繝槭・繧貞叉蠎ｧ縺ｫ髢句ｧ・            updateElapsed();
            window.__heavyElapsedTimer = setInterval(updateElapsed, 1000);
            
            updateModuleProgress('core', 'Python襍ｷ蜍募ｾ・■', null);
            ['mega','saturn','explorer','crew'].forEach(key => {
                updateModuleProgress(key, '貅門ｙ荳ｭ', 0);
            });
            
            try {
                // Python蛛ｴ縺ｮ繝代ャ繧ｱ繝ｼ繧ｸ繝ｭ繝ｼ繝蛾未謨ｰ縺悟茜逕ｨ蜿ｯ閭ｽ縺九メ繧ｧ繝・け
                if (typeof window.pyLoadHeavyPackages === 'function') {
                    debugLog('[Heavy] Python function available, calling pyLoadHeavyPackages...');
                    clearInterval(window.__heavyElapsedTimer);
                    
                    // 邨碁℃譎る俣繧ｿ繧､繝槭・繧貞・髢具ｼ医ヱ繝・こ繝ｼ繧ｸ繝ｭ繝ｼ繝臥畑・・                    const pkgStartTime = Date.now();
                    window.__heavyElapsedTimer = setInterval(() => {
                        const sec = Math.floor((Date.now() - pkgStartTime) / 1000);
                        const min = Math.floor(sec / 60);
                        const s = sec % 60;
                        const timeStr = min > 0 ? `${min}蛻・{s}遘蛋 : `${s}遘蛋;
                        if (status) status.textContent = `繝代ャ繧ｱ繝ｼ繧ｸ隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ... (${timeStr})`;
                    }, 1000);
                    
                    // Python髢｢謨ｰ繧貞他縺ｳ蜃ｺ縺励※繝代ャ繧ｱ繝ｼ繧ｸ繧偵Ο繝ｼ繝・                    window.pyLoadHeavyPackages();
                    // 豕ｨ: 髱槫酔譛溘↑縺ｮ縺ｧ螳御ｺ・・Python蛛ｴ縺九ｉsetHeavyReady(true)縺悟他縺ｰ繧後ｋ
                    
                } else {
                    debugLog('[Heavy] Python function not ready, retrying... count:', window.__heavyRetryCount);
                    window.__heavyPackagesLoading = false;
                    window.__heavyRetryCount = (window.__heavyRetryCount || 0) + 1;
                    if (window.__heavyRetryCount < 60) {
                        // Python髢｢謨ｰ縺ｮ逋ｻ骭ｲ繧貞ｾ・▽・域怙螟ｧ60遘抵ｼ・                        setTimeout(() => {
                            window.__heavyPackagesLoading = false;
                            requestHeavyPackages();
                        }, 1000);
                    } else {
                        clearInterval(window.__heavyElapsedTimer);
                        if (status) status.textContent = '霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ: 繧ｿ繧､繝繧｢繧ｦ繝・- 繝壹・繧ｸ繧貞・隱ｭ縺ｿ霎ｼ縺ｿ縺励※縺上□縺輔＞';
                        updateHeavyProgress('繧ｿ繧､繝繧｢繧ｦ繝・(Python髢｢謨ｰ譛ｪ逋ｻ骭ｲ)', { 'scikit-learn': '繧ｨ繝ｩ繝ｼ', 'networkx': '繧ｨ繝ｩ繝ｼ' });
                        updateModuleProgress('core', '繧ｿ繧､繝繧｢繧ｦ繝・, 0);
                    }
                }
            } catch (e) {
                console.error('[Heavy] Error:', e);
                clearInterval(window.__heavyElapsedTimer);
                if (status) status.textContent = `霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ: 繧ｨ繝ｩ繝ｼ`;
                updateHeavyProgress('繧ｨ繝ｩ繝ｼ', { 'scikit-learn': '繧ｨ繝ｩ繝ｼ', 'networkx': '繧ｨ繝ｩ繝ｼ' });
                updateModuleProgress('core', `繧ｨ繝ｩ繝ｼ: ${e.message || e}`, 0);
            }
        }

        function setupQuickFileParse() {
            if (!window.Papa) return;
            const input = document.getElementById('file-input');
            if (!input) return;
            input.addEventListener('change', (e) => {
                if (window.__pyReady) return;
                const file = e.target.files && e.target.files[0];
                if (!file) return;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (res) => {
                        window.quickData = res.data || [];
                        window.quickColumns = res.meta && res.meta.fields ? res.meta.fields : [];
                        window.quickReady = window.quickData.length > 0;
                        const info = document.getElementById('file-info');
                        if (info) info.textContent = `唐 ${file.name} (${window.quickData.length.toLocaleString()}莉ｶ)`;

                        const cols = ['(譛ｪ驕ｸ謚・', ...window.quickColumns];
                        ['col-title','col-abstract','col-date','col-applicant','col-ipc','col-inventor','col-status'].forEach(id => {
                            const sel = document.getElementById(id);
                            if (sel) sel.innerHTML = cols.map(c => `<option value="${c}">${c}</option>`).join('');
                        });

                        const autoMap = {
                            'col-title': ['逋ｺ譏弱・蜷咲ｧｰ','Title','title','蜷咲ｧｰ'],
                            'col-abstract': ['隕∫ｴ・,'Abstract','abstract','隕∫ｴ・謚・鹸'],
                            'col-date': ['蜃ｺ鬘俶律','Date','applicationDate','蜃ｺ鬘伜ｹｴ'],
                            'col-applicant': ['蜃ｺ鬘倅ｺｺ','Applicant','applicant','蜃ｺ鬘倅ｺｺ/讓ｩ蛻ｩ閠・],
                            'col-ipc': ['IPC','FI','ipc','F繧ｿ繝ｼ繝'],
                            'col-inventor': ['逋ｺ譏手・,'Inventor','inventor'],
                            'col-status': ['IPC','FI','繧ｹ繝・・繧ｿ繧ｹ','Status','status','豕慕噪迥ｶ豕・,'蟇ｩ譟ｻ迥ｶ豕・]
                        };
                        Object.keys(autoMap).forEach(selId => {
                            const sel = document.getElementById(selId);
                            if (!sel) return;
                            const keys = autoMap[selId];
                            const match = window.quickColumns.find(c => keys.some(k => String(c).toLowerCase().includes(k.toLowerCase())));
                            if (match) sel.value = match;
                        });

                        const preview = document.getElementById('preview-area');
                        if (preview) {
                            const head = window.quickColumns.slice(0, 6);
                            let html = `<div class="status-ok">笨・${window.quickData.length.toLocaleString()} 陦瑚ｪｭ縺ｿ霎ｼ縺ｿ・育ｰ｡譏難ｼ・/div>`;
                            html += '<div style="overflow-x: auto; margin-top: 0.5rem;"><table class="data-table"><tr>';
                            head.forEach(c => { html += `<th>${c}</th>`; });
                            html += '</tr>';
                            window.quickData.slice(0, 3).forEach(row => {
                                html += '<tr>';
                                head.forEach(c => { html += `<td>${String(row[c] || '').slice(0, 25)}</td>`; });
                                html += '</tr>';
                            });
                            html += '</table></div>';
                            preview.innerHTML = html;
                        }
                    }
                });
            });
        }

        function ensureAtlasStatusVisible() {
            const checkbox = document.getElementById('use-status-breakdown');
            const row = document.getElementById('atlas-status-toggle-row');
            if (!checkbox || !row) return;
            const group = checkbox.closest('.checkbox-group');
            if (group && row.children.length === 0) {
                row.appendChild(group);
            }
        }

        function quickParseYear(val) {
            const m = String(val || '').match(/(\d{4})/);
            return m ? parseInt(m[1], 10) : null;
        }

        function quickSplitList(val) {
            if (!val) return [];
            return String(val).split(/[;・・縲－\n]/).map(s => s.trim()).filter(Boolean);
        }

        function quickNormalizeStatus(val) {
            const parts = quickSplitList(val);
            return parts.length ? parts[0] : '譛ｪ險ｭ螳・;
        }

        function quickStatusMap(statuses) {
            const palette = [
                '#AEC6CF','#779ECB','#B39EB5','#FFB7B2','#CFCFC4',
                '#B0E0E6','#FFDAC1','#E2F0CB','#FDFD96','#FF6961'
            ];
            const map = {};
            statuses.forEach((s, i) => { map[s] = palette[i % palette.length]; });
            return map;
        }

        function applyStatusLegend(layout, extraBottom = 80) {
            layout.legend = Object.assign({
                orientation: 'h',
                y: -0.25,
                x: 0,
                xanchor: 'left'
            }, layout.legend || {});
            layout.margin = layout.margin || {};
            layout.margin.b = Math.max(layout.margin.b || 0, extraBottom);
        }

        function truncateApplicantName(name, maxLen = 25) {
            if (!name) return '';
            const s = String(name).trim();
            if (s.length <= maxLen) return s;
            return s.slice(0, maxLen - 1) + '窶ｦ';
        }

        function quickDrawAtlas() {
            if (!window.quickReady) {
                document.getElementById('atlas-chart').innerHTML = '<div class="status-warn">繝・・繧ｿ縺後≠繧翫∪縺帙ｓ・・ython襍ｷ蜍募ｾ後↓蛻ｩ逕ｨ・・/div>';
                return;
            }
            const chartType = window.appState.chartType;
            const start = parseInt(document.getElementById('year-start').value, 10);
            const end = parseInt(document.getElementById('year-end').value, 10);
            const topN = parseInt(document.getElementById('top-n').value, 10);
            let useStatus = document.getElementById('use-status-breakdown').checked;
            if (!['trend', 'trend_line', 'applicant', 'bubble'].includes(chartType)) {
                useStatus = false;
            }

            const colDate = document.getElementById('col-date').value;
            const colApplicant = document.getElementById('col-applicant').value;
            const colIpc = document.getElementById('col-ipc').value;
            const colStatus = document.getElementById('col-status').value;

            if (useStatus && colStatus === '(譛ｪ驕ｸ謚・') {
                document.getElementById('atlas-chart').innerHTML = '<div class="status-warn">繧ｹ繝・・繧ｿ繧ｹ蛻励′譛ｪ驕ｸ謚槭〒縺・/div>';
                return;
            }

            const rows = window.quickData.map(r => {
                const year = quickParseYear(r[colDate]);
                return {
                    year,
                    applicant_list: quickSplitList(r[colApplicant]),
                    ipc_list: quickSplitList(r[colIpc]).map(v => String(v).toUpperCase()),
                    status: quickNormalizeStatus(r[colStatus])
                };
            }).filter(r => r.year && r.year >= start && r.year <= end);


            if (chartType === 'trend') {
                if (useStatus && colStatus !== '(譛ｪ驕ｸ謚・') {
                    const statuses = Array.from(new Set(rows.map(r => r.status))).sort();
                    const statusMap = quickStatusMap(statuses);
                    const years = Array.from({length: end - start + 1}, (_, i) => start + i);
                    const traces = statuses.map(st => ({
                        x: years,
                        y: years.map(y => rows.filter(r => r.year === y && r.status === st).length),
                        type: 'bar',
                        name: st,
                        marker: {color: statusMap[st]}
                    }));
                    const layout = {title: `蜃ｺ鬘倅ｻｶ謨ｰ謗ｨ遘ｻ (${start}-${end}) - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ`, barmode:'stack', height: 450};
                    applyStatusLegend(layout, 80);
                    drawChart('atlas-chart', JSON.stringify(traces), JSON.stringify(layout));
                } else {
                    const yearCounts = {};
                    rows.forEach(r => { yearCounts[r.year] = (yearCounts[r.year] || 0) + 1; });
                    const years = Object.keys(yearCounts).sort();
                    const counts = years.map(y => yearCounts[y]);
                    drawChart('atlas-chart', JSON.stringify([{x: years, y: counts, type:'bar', marker:{color:'#4fc3f7'}}]), JSON.stringify({title:`蜃ｺ鬘倅ｻｶ謨ｰ謗ｨ遘ｻ (${start}-${end})`, height:450}));
                }
                return;
            }

            if (chartType === 'applicant') {
                const applicantCount = parseInt(document.getElementById('atlas-applicant-count').value, 10) || topN;
                debugLog('[QuickAtlas] applicantCount:', applicantCount);
                const allApps = rows.flatMap(r => r.applicant_list);
                const counts = {};
                allApps.forEach(a => { if (a) counts[a] = (counts[a] || 0) + 1; });
                const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, applicantCount);
                const names = top.map(t => t[0]);
                const displayNames = names.map(n => truncateApplicantName(n, 30));
                const displayNamesReversed = [...displayNames].reverse();
                // 譛髟ｷ蜷阪↓蠢懊§縺溘・繝ｼ繧ｸ繝ｳ險育ｮ・                const maxNameLen = Math.max(...displayNames.map(n => n.length), 10);
                const leftMargin = Math.min(350, Math.max(150, maxNameLen * 9));
                debugLog('[QuickAtlas] names count:', names.length, 'leftMargin:', leftMargin);
                
                if (useStatus && colStatus !== '(譛ｪ驕ｸ謚・') {
                    const statuses = Array.from(new Set(rows.map(r => r.status))).sort();
                    debugLog('[QuickAtlas] statuses:', statuses);
                    const statusMap = quickStatusMap(statuses);
                    const traces = statuses.map(st => ({
                        x: names.map(n => rows.filter(r => r.status === st && r.applicant_list.includes(n)).length),
                        y: displayNames,
                        customdata: names,
                        hovertemplate: '%{customdata}<br>%{x}莉ｶ<extra>%{fullData.name}</extra>',
                        textposition: 'none',
                        type:'bar',
                        orientation:'h',
                        name: st,
                        marker:{color: statusMap[st]}
                    }));
                    const layout = {
                        title:`蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP${applicantCount} - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ`, 
                        barmode:'stack', 
                        height: Math.max(500, applicantCount * 30 + 100), 
                        margin:{l: leftMargin, b: 100, t: 50},
                        yaxis: {
                            categoryorder: 'array',
                            categoryarray: displayNamesReversed,
                            automargin: true
                        }
                    };
                    applyStatusLegend(layout, 100);
                    drawChart('atlas-chart', JSON.stringify(traces), JSON.stringify(layout));
                } else {
                    const traces = [{
                        x: top.map(t=>t[1]), 
                        y: displayNames, 
                        customdata: names,
                        hovertemplate: '%{customdata}<br>%{x}莉ｶ<extra></extra>',
                        textposition: 'none',
                        type:'bar', 
                        orientation:'h', 
                        marker:{color:'#81c784'}
                    }];
                    const layout = {
                        title:`蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP${applicantCount}`, 
                        height: Math.max(450, applicantCount*28), 
                        margin:{l: leftMargin}, 
                        yaxis: {categoryorder: 'array', categoryarray: displayNamesReversed, automargin: true}
                    };
                    drawChart('atlas-chart', JSON.stringify(traces), JSON.stringify(layout));
                }
                return;
            }

            if (chartType === 'ipc') {
                const ipcLevel = parseInt(document.getElementById('atlas-ipc-level').value, 10);
                const ipcs = rows.flatMap(r => r.ipc_list.map(v => ipcLevel === 1 ? v.slice(0,4) : v));
                const counts = {};
                ipcs.forEach(i => { if (i) counts[i] = (counts[i] || 0) + 1; });
                const top = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0, topN);
                const names = top.map(t=>t[0]);
                if (useStatus && colStatus !== '(譛ｪ驕ｸ謚・') {
                    const statuses = Array.from(new Set(rows.map(r => r.status))).sort();
                    const statusMap = quickStatusMap(statuses);
                    const traces = statuses.map(st => ({
                        x: names.map(n => rows.filter(r => r.status === st && r.ipc_list.some(v => (ipcLevel === 1 ? v.slice(0,4) : v) === n)).length),
                        y: names,
                        type:'bar',
                        orientation:'h',
                        name: st,
                        marker:{color: statusMap[st]}
                    }));
                    const layout = {title:`IPC繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP${topN} - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ`, barmode:'stack', height: Math.max(450, topN*28), margin:{l:120}};
                    applyStatusLegend(layout, 80);
                    drawChart('atlas-chart', JSON.stringify(traces), JSON.stringify(layout));
                } else {
                    drawChart('atlas-chart', JSON.stringify([{x: top.map(t=>t[1]), y: names, type:'bar', orientation:'h', marker:{color:'#ffb74d'}}]), JSON.stringify({title:`IPC繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP${topN}`, height: Math.max(450, topN*28), margin:{l:120}}));
                }
                return;
            }

            document.getElementById('atlas-chart').innerHTML = '<div class="status-warn">縺薙・繝√Ε繝ｼ繝医・Python襍ｷ蜍募ｾ後↓蛻ｩ逕ｨ縺ｧ縺阪∪縺・/div>';
        }

        /**
         * 繝医・繧ｹ繝磯夂衍繧定｡ｨ遉ｺ
         * @param {string} message - 騾夂衍繝｡繝・そ繝ｼ繧ｸ
         * @param {string} type - 騾夂衍繧ｿ繧､繝・('success', 'warning', 'error', 'info')
         * @param {number} duration - 陦ｨ遉ｺ譎る俣 (ms)
         */
        function showToast(message, type = 'info', duration = 3000) {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            const icons = {
                success: '笨・,
                warning: '笞・・,
                error: '笶・,
                info: '邃ｹ・・
            };

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">ﾃ・/button>
            `;

            container.appendChild(toast);

            // 閾ｪ蜍募炎髯､
            setTimeout(() => {
                toast.style.animation = 'toast-slide-in 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // 繧ｰ繝ｭ繝ｼ繝舌Ν縺ｫ蜈ｬ髢・        window.showToast = showToast;

        window.coreDeleteRule = function (event) {
            const axis = event.target.getAttribute('data-axis');
            const name = event.target.getAttribute('data-name');
            if (axis && name) {
                window.pyodide_globals.core_delete_rule(axis, name);
            }
        }

        window.coreEditRule = function (event) {
            const axis = event.target.getAttribute('data-axis');
            const name = event.target.getAttribute('data-name');
            if (axis && name) {
                window.pyodide_globals.core_edit_rule(axis, name);
            }
            const addBtn = document.getElementById('btn-core-add');
            const updBtn = document.getElementById('btn-core-update');
            const cancelBtn = document.getElementById('btn-core-cancel');
            if (addBtn && updBtn) {
                addBtn.style.display = 'none';
                updBtn.style.display = 'inline-block';
            }
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
        }
        
        function showPage(page) {
            // 迴ｾ蝨ｨ縺ｮ繝壹・繧ｸ繧偵ヵ繧ｧ繝ｼ繝峨い繧ｦ繝・            const currentPage = document.querySelector('.page:not(.hidden)');
            if (currentPage && currentPage.id !== 'page-' + page) {
                currentPage.classList.add('fade-out');
                setTimeout(() => {
                    currentPage.classList.add('hidden');
                    currentPage.classList.remove('fade-out');
                }, 150);
            }
            
            // 繝翫ン繧ｲ繝ｼ繧ｷ繝ｧ繝ｳ繝懊ち繝ｳ縺ｮ譖ｴ譁ｰ
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // 譁ｰ縺励＞繝壹・繧ｸ繧偵ヵ繧ｧ繝ｼ繝峨う繝ｳ
            setTimeout(() => {
                const targetPage = document.getElementById('page-' + page);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    targetPage.classList.add('fade-in');
                    // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ邨ゆｺ・ｾ後↓繧ｯ繝ｩ繧ｹ繧貞炎髯､
                    setTimeout(() => targetPage.classList.remove('fade-in'), 300);
                }
            }, currentPage && currentPage.id !== 'page-' + page ? 150 : 0);
            
            // 繧｢繧､繧ｳ繝ｳ繝舌・縺ｮ繝懊ち繝ｳ繧偵い繧ｯ繝・ぅ繝悶↓縺吶ｋ
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.getAttribute('onclick')?.includes("'" + page + "'")) {
                    btn.classList.add('active');
                }
            });
        }
        
        /**
         * 繝帙・繝逕ｻ髱｢縺九ｉ縺ｮ繧ｯ繧､繝・け襍ｷ蜍・         */
        function quickLaunch() {
            const btn = document.getElementById('btn-launch');
            if (btn) btn.click();
        }
        
        /**
         * 繝繝・す繝･繝懊・繝峨・邨ｱ險医ｒ譖ｴ譁ｰ
         */
        function updateDashboardStats(total, years, applicants) {
            const elTotal = document.getElementById('home-stat-total');
            const elYears = document.getElementById('home-stat-years');
            const elApplicants = document.getElementById('home-stat-applicants');
            
            // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″繧ｫ繧ｦ繝ｳ繝医い繝・・
            if (elTotal) animateValue(elTotal, 0, total, 1000);
            if (elYears) elYears.textContent = years || '-';
            if (elApplicants) animateValue(elApplicants, 0, applicants, 800);
        }
        
        /**
         * 謨ｰ蛟､縺ｮ繧ｫ繧ｦ繝ｳ繝医い繝・・繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
         */
        function animateValue(el, start, end, duration) {
            if (!el || typeof end !== 'number') {
                el.textContent = end?.toLocaleString() || '-';
                return;
            }
            const startTime = performance.now();
            const update = (currentTime) => {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // 繧､繝ｼ繧ｸ繝ｳ繧ｰ (ease-out)
                const eased = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (end - start) * eased);
                el.textContent = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            };
            requestAnimationFrame(update);
        }
        
        /**
         * 繝繝・す繝･繝懊・繝峨・繝励Ξ繝薙Η繝ｼ繧呈峩譁ｰ・・縺､縺ｮ繝溘ル繝√Ε繝ｼ繝茨ｼ・         */
        function updateDashboardPreview(dataJson) {
            const emptyState = document.getElementById('home-preview-container');
            const grid = document.getElementById('home-preview-grid');
            
            if (!dataJson) return;
            
            let data;
            try {
                data = typeof dataJson === 'string' ? JSON.parse(dataJson) : dataJson;
            } catch(e) {
                console.error('Failed to parse preview data:', e);
                return;
            }
            
            // 遨ｺ縺ｮ迥ｶ諷九ｒ髱櫁｡ｨ遉ｺ縲√げ繝ｪ繝・ラ繧定｡ｨ遉ｺ
            if (emptyState) emptyState.style.display = 'none';
            if (grid) {
                grid.classList.remove('hidden');
                grid.style.display = 'block';
            }
            
            // 蜈ｨ縺ｦD3.js縺ｧ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″謠冗判
            setTimeout(() => drawPreviewTrendD3(data.yearCounts), 0);
            setTimeout(() => drawPreviewApplicantsD3(data.topApplicants), 100);
            setTimeout(() => drawPreviewIPCD3(data.topIPC), 200);
            setTimeout(() => drawPreviewKeywords(data.topKeywords), 300);
        }
        
        /**
         * 蟷ｴ谺｡謗ｨ遘ｻ繝励Ξ繝薙Η繝ｼ・・3.js 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″繧ｨ繝ｪ繧｢繝√Ε繝ｼ繝茨ｼ・         */
        function drawPreviewTrendD3(yearCounts) {
            const container = document.getElementById('preview-trend');
            if (!container || !yearCounts || !d3) return;
            
            container.innerHTML = '';
            
            const margin = { top: 10, right: 15, bottom: 25, left: 35 };
            const width = (container.clientWidth || 250) - margin.left - margin.right;
            const height = (container.clientHeight || 140) - margin.top - margin.bottom;
            
            const years = Object.keys(yearCounts).map(Number).sort((a, b) => a - b);
            const data = years.map(y => ({ year: y, count: yearCounts[y] }));
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // 繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ螳夂ｾｩ
            const defs = svg.append('defs');
            const gradient = defs.append('linearGradient')
                .attr('id', 'areaGradient')
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '0%').attr('y2', '100%');
            gradient.append('stop').attr('offset', '0%').attr('stop-color', '#4fc3f7').attr('stop-opacity', 0.6);
            gradient.append('stop').attr('offset', '100%').attr('stop-color', '#4fc3f7').attr('stop-opacity', 0.05);
            
            // 繧ｹ繧ｱ繝ｼ繝ｫ
            const x = d3.scaleLinear()
                .domain(d3.extent(years))
                .range([0, width]);
            
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count) * 1.1])
                .range([height, 0]);
            
            // 霆ｸ
            svg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d')))
                .attr('color', '#5a6f85')
                .selectAll('text').attr('fill', '#9fb3c8').style('font-size', '9px');
            
            svg.append('g')
                .call(d3.axisLeft(y).ticks(4).tickFormat(d => d >= 1000 ? (d/1000)+'k' : d))
                .attr('color', '#5a6f85')
                .selectAll('text').attr('fill', '#9fb3c8').style('font-size', '9px');
            
            // 繧ｨ繝ｪ繧｢
            const area = d3.area()
                .x(d => x(d.year))
                .y0(height)
                .y1(d => y(d.count))
                .curve(d3.curveMonotoneX);
            
            const areaPath = svg.append('path')
                .datum(data)
                .attr('fill', 'url(#areaGradient)')
                .attr('d', area)
                .attr('opacity', 0);
            
            // 繝ｩ繧､繝ｳ
            const line = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.count))
                .curve(d3.curveMonotoneX);
            
            const linePath = svg.append('path')
                .datum(data)
                .attr('fill', 'none')
                .attr('stroke', '#4fc3f7')
                .attr('stroke-width', 2.5)
                .attr('d', line);
            
            // 繝ｩ繧､繝ｳ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
            const totalLength = linePath.node().getTotalLength();
            linePath
                .attr('stroke-dasharray', totalLength)
                .attr('stroke-dashoffset', totalLength)
                .transition()
                .duration(1200)
                .ease(d3.easeCubicOut)
                .attr('stroke-dashoffset', 0);
            
            // 繧ｨ繝ｪ繧｢繝輔ぉ繝ｼ繝峨う繝ｳ
            areaPath.transition()
                .delay(400)
                .duration(800)
                .attr('opacity', 1);
            
            // 繝峨ャ繝・            svg.selectAll('.dot')
                .data(data)
                .enter()
                .append('circle')
                .attr('cx', d => x(d.year))
                .attr('cy', d => y(d.count))
                .attr('r', 0)
                .attr('fill', '#4fc3f7')
                .attr('stroke', '#0d1117')
                .attr('stroke-width', 2)
                .transition()
                .delay((_, i) => 800 + i * 50)
                .duration(300)
                .attr('r', 4);
        }
        
        /**
         * 蜃ｺ鬘倅ｺｺ繝励Ξ繝薙Η繝ｼ・・3.js 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″繝峨・繝翫ヤ繝√Ε繝ｼ繝・+ 蜃｡萓具ｼ・         */
        function drawPreviewApplicantsD3(topApplicants) {
            const container = document.getElementById('preview-applicants');
            const legendContainer = document.getElementById('preview-applicants-legend');
            if (!container || !topApplicants || !d3) return;
            
            container.innerHTML = '';
            if (legendContainer) legendContainer.innerHTML = '';
            
            const width = container.clientWidth || 100;
            const height = container.clientHeight || 100;
            const radius = Math.min(width, height) / 2 - 3;
            
            const entries = Object.entries(topApplicants).slice(0, 5);
            const data = entries.map(([name, value]) => ({ name, value }));
            const total = d3.sum(data, d => d.value);
            
            const colors = ['#4fc3f7', '#a855f7', '#10b981', '#f59e0b', '#ef4444'];
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width/2},${height/2})`);
            
            const pie = d3.pie()
                .value(d => d.value)
                .sort(null)
                .padAngle(0.02);
            
            const arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius);
            
            const arcHover = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius + 4);
            
            // 繝代せ謠冗判
            const paths = svg.selectAll('path')
                .data(pie(data))
                .enter()
                .append('path')
                .attr('fill', (_, i) => colors[i])
                .attr('stroke', '#0d1117')
                .attr('stroke-width', 1.5)
                .style('cursor', 'pointer')
                .each(function(d) { this._current = { startAngle: 0, endAngle: 0 }; });
            
            // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
            paths.transition()
                .duration(1000)
                .ease(d3.easeCubicOut)
                .attrTween('d', function(d) {
                    const interpolate = d3.interpolate(this._current, d);
                    this._current = interpolate(1);
                    return t => arc(interpolate(t));
                });
            
            // 繝帙ヰ繝ｼ繧ｨ繝輔ぉ繧ｯ繝・            paths.on('mouseover', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('d', arcHover);
            })
            .on('mouseout', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('d', arc);
            });
            
            // 荳ｭ螟ｮ繝・く繧ｹ繝茨ｼ亥粋險井ｻｶ謨ｰ・・            svg.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.1em')
                .attr('fill', '#e0e6ed')
                .style('font-size', '11px')
                .style('font-weight', '600')
                .text(total >= 1000 ? (total/1000).toFixed(1) + 'k' : total)
                .style('opacity', 0)
                .transition()
                .delay(600)
                .duration(500)
                .style('opacity', 1);
            
            // 蜃｡萓九ｒ霑ｽ蜉
            if (legendContainer) {
                data.forEach((d, i) => {
                    const item = document.createElement('div');
                    item.style.cssText = 'display: flex; align-items: center; gap: 0.4rem; margin-bottom: 0.35rem; opacity: 0; transition: opacity 0.3s;';
                    
                    const colorBox = document.createElement('span');
                    colorBox.style.cssText = `width: 10px; height: 10px; border-radius: 2px; background: ${colors[i]}; flex-shrink: 0;`;
                    
                    const label = document.createElement('span');
                    label.style.cssText = 'color: #9fb3c8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90px;';
                    const shortName = d.name.length > 12 ? d.name.slice(0, 12) + '窶ｦ' : d.name;
                    label.textContent = shortName;
                    label.title = d.name;  // 繝輔Ν繝阪・繝繧偵ヤ繝ｼ繝ｫ繝√ャ繝励〒陦ｨ遉ｺ
                    
                    const value = document.createElement('span');
                    value.style.cssText = 'color: #e0e6ed; margin-left: auto; font-weight: 500;';
                    value.textContent = d.value.toLocaleString();
                    
                    item.appendChild(colorBox);
                    item.appendChild(label);
                    item.appendChild(value);
                    legendContainer.appendChild(item);
                    
                    // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                    setTimeout(() => { item.style.opacity = '1'; }, 700 + i * 100);
                });
            }
        }
        
        /**
         * IPC繝励Ξ繝薙Η繝ｼ・・3.js 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″讓ｪ譽偵げ繝ｩ繝包ｼ・         */
        function drawPreviewIPCD3(topIPC) {
            const container = document.getElementById('preview-ipc');
            if (!container || !topIPC || !d3) return;
            
            container.innerHTML = '';
            
            const margin = { top: 5, right: 40, bottom: 5, left: 55 };
            const width = (container.clientWidth || 250) - margin.left - margin.right;
            const height = (container.clientHeight || 100) - margin.top - margin.bottom;
            
            // 莉ｶ謨ｰ縺悟､壹＞鬆・↓繧ｽ繝ｼ繝茨ｼ井ｸ翫′螟壹＞・・            const entries = Object.entries(topIPC)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const data = entries.map(([name, value]) => ({ name, value }));
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            // 繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ螳夂ｾｩ
            const defs = svg.append('defs');
            data.forEach((d, i) => {
                const grad = defs.append('linearGradient')
                    .attr('id', `barGrad${i}`)
                    .attr('x1', '0%').attr('y1', '0%')
                    .attr('x2', '100%').attr('y2', '0%');
                const hue = 190 + i * 25;
                grad.append('stop').attr('offset', '0%').attr('stop-color', `hsl(${hue}, 70%, 45%)`);
                grad.append('stop').attr('offset', '100%').attr('stop-color', `hsl(${hue}, 70%, 60%)`);
            });
            
            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.value) * 1.1])
                .range([0, width]);
            
            const y = d3.scaleBand()
                .domain(data.map(d => d.name))
                .range([0, height])
                .padding(0.3);
            
            // 繝ｩ繝吶Ν
            svg.selectAll('.label')
                .data(data)
                .enter()
                .append('text')
                .attr('x', -5)
                .attr('y', d => y(d.name) + y.bandwidth() / 2)
                .attr('dy', '0.35em')
                .attr('text-anchor', 'end')
                .attr('fill', '#9fb3c8')
                .style('font-size', '9px')
                .text(d => d.name.length > 7 ? d.name.slice(0, 7) : d.name);
            
            // 繝舌・
            const bars = svg.selectAll('.bar')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', 0)
                .attr('y', d => y(d.name))
                .attr('height', y.bandwidth())
                .attr('fill', (_, i) => `url(#barGrad${i})`)
                .attr('rx', 3)
                .attr('width', 0);
            
            // 繝舌・繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
            bars.transition()
                .duration(800)
                .delay((_, i) => i * 100)
                .ease(d3.easeCubicOut)
                .attr('width', d => x(d.value));
            
            // 蛟､繝ｩ繝吶Ν
            svg.selectAll('.value')
                .data(data)
                .enter()
                .append('text')
                .attr('x', d => x(d.value) + 5)
                .attr('y', d => y(d.name) + y.bandwidth() / 2)
                .attr('dy', '0.35em')
                .attr('fill', '#e0e6ed')
                .style('font-size', '9px')
                .style('font-weight', '500')
                .style('opacity', 0)
                .text(d => d.value.toLocaleString())
                .transition()
                .delay((_, i) => 600 + i * 100)
                .duration(300)
                .style('opacity', 1);
        }
        
        /**
         * 繧ｭ繝ｼ繝ｯ繝ｼ繝峨・繝ｬ繝薙Η繝ｼ・・3.js 繝溘ル繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝会ｼ・         */
        function drawPreviewKeywords(topKeywords) {
            const container = document.getElementById('preview-keywords');
            if (!container || !topKeywords || !d3 || !d3.layout?.cloud) return;
            
            container.innerHTML = '';
            
            const width = container.clientWidth || 200;
            const height = container.clientHeight || 100;
            
            const words = Object.entries(topKeywords).slice(0, 15).map(([text, score]) => ({
                text: text,
                size: 10 + Math.sqrt(score) * 8
            }));
            
            const colors = ['#4fc3f7', '#81d4fa', '#b3e5fc', '#a855f7', '#c084fc'];
            
            d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(2)
                .rotate(() => (Math.random() > 0.7 ? 90 : 0))
                .fontSize(d => Math.min(d.size, 18))
                .on('end', (drawnWords) => {
                    const svg = d3.select(container)
                        .append('svg')
                        .attr('width', width)
                        .attr('height', height);
                    
                    svg.append('g')
                        .attr('transform', `translate(${width/2},${height/2})`)
                        .selectAll('text')
                        .data(drawnWords)
                        .enter()
                        .append('text')
                        .style('font-size', d => `${d.size}px`)
                        .style('font-family', 'Meiryo, sans-serif')
                        .style('fill', (_, i) => colors[i % colors.length])
                        .style('cursor', 'default')
                        .attr('text-anchor', 'middle')
                        .attr('transform', d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
                        .text(d => d.text)
                        .style('opacity', 0)
                        .transition()
                        .duration(500)
                        .delay((_, i) => i * 50)
                        .style('opacity', 1);
                })
                .start();
        }
        
        /**
         * 繝峨Ο繝・・繧ｾ繝ｼ繝ｳ縺ｮ繧ｻ繝・ヨ繧｢繝・・
         */
        function setupDropZone() {
            const dropZone = document.getElementById('drop-zone');
            const fileInputHome = document.getElementById('file-input-home');
            const fileInput = document.getElementById('file-input');
            
            if (!dropZone) return;
            
            // 繝峨Λ繝・げ繧ｪ繝ｼ繝舌・
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            // 繝峨Λ繝・げ繝ｪ繝ｼ繝・            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });
            
            // 繝峨Ο繝・・
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.csv')) {
                    // 荳｡譁ｹ縺ｮ file input 縺ｫ險ｭ螳・                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    if (fileInputHome) fileInputHome.files = dataTransfer.files;
                    if (fileInput) {
                        fileInput.files = dataTransfer.files;
                        fileInput.dispatchEvent(new Event('change'));
                    }
                    updateHomeFileStatus(files[0].name);
                    showToast('success', `塘 ${files[0].name} 繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆`);
                } else {
                    showToast('error', 'CSV繝輔ぃ繧､繝ｫ縺ｮ縺ｿ蟇ｾ蠢懊＠縺ｦ縺・∪縺・);
                }
            });
            
            // 繝帙・繝逕ｻ髱｢縺ｮ繝輔ぃ繧､繝ｫ蜈･蜉・            if (fileInputHome) {
                fileInputHome.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        // 繝｡繧､繝ｳ縺ｮfile-input縺ｫ繧ょ酔譛・                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        if (fileInput) {
                            fileInput.files = dataTransfer.files;
                            fileInput.dispatchEvent(new Event('change'));
                        }
                        updateHomeFileStatus(file.name);
                    }
                });
            }
        }
        
        /**
         * 繝帙・繝逕ｻ髱｢縺ｮ繝輔ぃ繧､繝ｫ繧ｹ繝・・繧ｿ繧ｹ譖ｴ譁ｰ
         */
        function updateHomeFileStatus(filename) {
            const status = document.getElementById('home-file-status');
            const launchBtn = document.getElementById('home-launch-btn');
            if (status) {
                status.innerHTML = `<span style="color: #81c784;">笨・/span> ${filename} 繧定ｪｭ縺ｿ霎ｼ縺ｿ縺ｾ縺励◆`;
            }
            if (launchBtn) {
                launchBtn.disabled = false;
            }
        }
        
        // 繝峨Ο繝・・繧ｾ繝ｼ繝ｳ縺ｮ繧ｻ繝・ヨ繧｢繝・・繧貞ｮ溯｡・        document.addEventListener('DOMContentLoaded', setupDropZone);
        
        function showTab(page, tab) {
            // nova縺ｯadvanced繝壹・繧ｸ蜀・〒菴ｿ逕ｨ
            const pageId = page === 'nova' ? 'advanced' : page;
            document.querySelectorAll('#page-' + pageId + ' .tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('#page-' + pageId + ' .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(page + '-tab-' + tab).classList.add('active');
            event.target.classList.add('active');
        }
        
        function setAtlasChart(type) {
            const checkbox = document.getElementById('use-status-breakdown');
            if (checkbox && window.appState.statusBreakdownByType) {
                window.appState.statusBreakdownByType[window.appState.chartType] = checkbox.checked;
            }
            window.appState.chartType = type;
            document.querySelectorAll('#page-atlas .tabs .tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            syncAtlasStatusCheckbox();
            syncAtlasControls();
            const btn = document.getElementById('btn-atlas');
            if (btn) btn.click();
        }
        
        function drawChart(divId, dataJson, layoutJson) {
            try {
                const data = JSON.parse(dataJson);
                const layout = JSON.parse(layoutJson);
                
                // 蜈ｱ騾壹せ繧ｿ繧､繝ｫ險ｭ螳・                layout.paper_bgcolor = 'rgba(0,0,0,0)';
                layout.plot_bgcolor = 'rgba(0,0,0,0.2)';
                layout.font = { color: '#e0e1dd', family: 'Meiryo, Segoe UI, sans-serif' };
                
                // 蜃｡萓九・謾ｹ蝟・                layout.legend = Object.assign({
                    font: { size: 11, color: '#e0e1dd' },
                    bgcolor: 'rgba(0,0,0,0.3)',
                    bordercolor: 'rgba(255,255,255,0.1)',
                    borderwidth: 1,
                    itemsizing: 'constant',
                    itemwidth: 30
                }, layout.legend || {});
                
                // 繝・・繝ｫ繝√ャ繝暦ｼ・overmode・峨・謾ｹ蝟・                layout.hovermode = layout.hovermode || 'closest';
                layout.hoverlabel = Object.assign({
                    bgcolor: 'rgba(30, 41, 59, 0.95)',
                    bordercolor: 'rgba(79, 195, 247, 0.5)',
                    font: { color: '#f1f5f9', size: 12, family: 'Meiryo, sans-serif' }
                }, layout.hoverlabel || {});
                
                // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ險ｭ螳・                const config = {
                    responsive: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'artemis_chart',
                        height: 600,
                        width: 900,
                        scale: 2
                    }
                };
                
                // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″縺ｧ謠冗判
                Plotly.newPlot(divId, data, layout, config).then(() => {
                    // 繝輔ぉ繝ｼ繝峨う繝ｳ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                    const container = document.getElementById(divId);
                    if (container) {
                        container.style.opacity = '0';
                        container.style.transform = 'translateY(10px)';
                        container.style.transition = 'opacity 0.4s ease-out, transform 0.4s ease-out';
                        requestAnimationFrame(() => {
                            container.style.opacity = '1';
                            container.style.transform = 'translateY(0)';
                        });
                    }
                });
            } catch(e) {
                console.error('Chart error:', e);
                const container = document.getElementById(divId);
                if (container) {
                    container.innerHTML = `
                        <div class="status-message error">
                            <span class="status-icon">笞・・/span>
                            <div class="status-content">
                                <div class="status-title">繧ｰ繝ｩ繝墓緒逕ｻ繧ｨ繝ｩ繝ｼ</div>
                                <div class="status-detail">${e.message}</div>
                            </div>
                        </div>`;
                }
            }
        }
        
        /**
         * 繝懊ち繝ｳ縺ｮ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷九ｒ險ｭ螳・         * @param {string} buttonId - 繝懊ち繝ｳ縺ｮID
         * @param {boolean} loading - 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷・         * @param {string} loadingText - 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ荳ｭ縺ｮ繝・く繧ｹ繝茨ｼ医が繝励す繝ｧ繝ｳ・・         */
        function setButtonLoading(buttonId, loading, loadingText = '') {
            const btn = document.getElementById(buttonId);
            if (!btn) return;
            
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
                btn.dataset.originalText = btn.innerHTML;
                if (loadingText) {
                    btn.innerHTML = `<span class="btn-text">${loadingText}</span>`;
                }
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
                if (btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                    delete btn.dataset.originalText;
                }
            }
        }
        
        /**
         * 繝√Ε繝ｼ繝医さ繝ｳ繝・リ縺ｫ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､繧定｡ｨ遉ｺ
         * @param {string} containerId - 繧ｳ繝ｳ繝・リ縺ｮID
         * @param {boolean} show - 陦ｨ遉ｺ/髱櫁｡ｨ遉ｺ
         * @param {string} message - 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繝｡繝・そ繝ｼ繧ｸ
         */
        function showChartLoading(containerId, show, message = '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let overlay = container.querySelector('.loading-overlay');
            
            if (show) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'loading-overlay';
                    overlay.innerHTML = `
                        <div class="spinner spinner-lg"></div>
                        <span class="spinner-text">${message}</span>
                    `;
                    container.style.position = 'relative';
                    container.appendChild(overlay);
                }
                requestAnimationFrame(() => overlay.classList.add('active'));
            } else if (overlay) {
                overlay.classList.remove('active');
                setTimeout(() => overlay.remove(), 300);
            }
        }
        
        /**
         * 謾ｹ蝟・＆繧後◆繧ｹ繝・・繧ｿ繧ｹ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ
         * @param {string} containerId - 繧ｳ繝ｳ繝・リ縺ｮID
         * @param {string} type - 'error', 'warning', 'success', 'info'
         * @param {string} title - 繧ｿ繧､繝医Ν
         * @param {string} detail - 隧ｳ邏ｰ繝｡繝・そ繝ｼ繧ｸ・医が繝励す繝ｧ繝ｳ・・         */
        function showStatusMessage(containerId, type, title, detail = '') {
            const icons = { error: '笶・, warning: '笞・・, success: '笨・, info: '邃ｹ・・ };
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="status-message ${type}">
                    <span class="status-icon">${icons[type] || '邃ｹ・・}</span>
                    <div class="status-content">
                        <div class="status-title">${title}</div>
                        ${detail ? `<div class="status-detail">${detail}</div>` : ''}
                    </div>
                </div>`;
        }
        
        /**
         * d3-cloud繧剃ｽｿ逕ｨ縺励◆繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝画緒逕ｻ
         * Python wordcloud繝ｩ繧､繝悶Λ繝ｪ縺ｫ霑代＞隕九◆逶ｮ繧貞ｮ溽樟
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} wordsJson - 蜊倩ｪ槭ョ繝ｼ繧ｿ縺ｮJSON [{text, score}, ...]
         * @param {string} colorScheme - 繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝蜷・         */
        function drawWordCloud(divId, wordsJson, colorScheme) {
            try {
                const container = document.getElementById(divId);
                if (!container) return;
                
                // 譌｢蟄倥・蜀・ｮｹ繧偵け繝ｪ繧｢
                container.innerHTML = '';
                
                const words = JSON.parse(wordsJson);
                if (!words || words.length === 0) {
                    container.innerHTML = '<div class="status-warn">陦ｨ遉ｺ縺吶ｋ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>';
                    return;
                }
                
                // 繧ｳ繝ｳ繝・リ繧ｵ繧､繧ｺ・・ython wordcloud縺ｮ繝・ヵ繧ｩ繝ｫ繝医い繧ｹ繝壹け繝域ｯ斐↓霑代▼縺代ｋ・・                const width = container.clientWidth || 800;
                const height = 500;
                
                // Python wordcloud鬚ｨ縺ｮ繧ｫ繝ｩ繝ｼ繝代Ξ繝・ヨ
                const colorPalettes = {
                    'viridis': ['#440154', '#482878', '#3e4989', '#31688e', '#26828e', '#1f9e89', '#35b779', '#6ece58', '#b5de2b', '#fde725'],
                    'plasma': ['#0d0887', '#46039f', '#7201a8', '#9c179e', '#bd3786', '#d8576b', '#ed7953', '#fb9f3a', '#fdca26', '#f0f921'],
                    'warm': ['#6e40aa', '#bf3caf', '#fe4b83', '#ff7847', '#e2b72f', '#aff05b'],
                    'rainbow': ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe'],
                    'blues': ['#08306b', '#08519c', '#2171b5', '#4292c6', '#6baed6', '#9ecae1', '#c6dbef', '#deebf7'],
                    'matplotlib': ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf']
                };
                const palette = colorPalettes[colorScheme] || colorPalettes['viridis'];
                
                // SVG菴懈・・域ｿ・＞閭梧勹縺ｧPython縺ｫ霑代▼縺代ｋ・・                const svg = d3.select(container)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .attr('viewBox', `0 0 ${width} ${height}`)
                    .style('background', '#1a1a2e')
                    .style('border-radius', '6px');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${width/2}, ${height/2})`);
                
                // TF-IDF繧ｹ繧ｳ繧｢縺九ｉ繧ｵ繧､繧ｺ繧ｹ繧ｱ繝ｼ繝ｫ繧定ｨ育ｮ・                const maxScore = d3.max(words, d => d.score);
                const minScore = d3.min(words, d => d.score);
                
                // Python wordcloud鬚ｨ縺ｮ繧ｵ繧､繧ｺ遽・峇・亥､ｧ縺阪↑蟾ｮ繧偵▽縺代ｋ・・                const sizeScale = d3.scaleSqrt()
                    .domain([minScore, maxScore])
                    .range([12, 90]);
                
                // d3-cloud繝ｬ繧､繧｢繧ｦ繝郁ｨｭ螳・                const layout = d3.layout.cloud()
                    .size([width - 10, height - 10])
                    .words(words.map((d, i) => ({
                        text: d.text,
                        size: sizeScale(d.score),
                        score: d.score,
                        originalIndex: i
                    })))
                    .padding(2)  // 蟇・ｺｦ繧帝ｫ倥￥
                    .rotate(() => {
                        // Python鬚ｨ・・蠎ｦ縺悟､壹ａ縲∵凾縲・0蠎ｦ縲∫ｨ縺ｫ譁懊ａ
                        const r = Math.random();
                        if (r < 0.65) return 0;
                        if (r < 0.85) return 90;
                        if (r < 0.92) return -90;
                        return (Math.random() > 0.5 ? 45 : -45);
                    })
                    .font('Impact, Arial Black, sans-serif')  // Python鬚ｨ縺ｮ繝輔か繝ｳ繝・                    .fontSize(d => d.size)
                    .spiral('archimedean')
                    .on('end', draw);
                
                layout.start();
                
                function draw(words) {
                    // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″縺ｧ謠冗判
                    const texts = g.selectAll('text')
                        .data(words)
                        .enter()
                        .append('text')
                        .style('font-size', '0px')
                        .style('font-family', 'Impact, Arial Black, sans-serif')
                        .style('fill', (d, i) => palette[i % palette.length])
                        .style('cursor', 'pointer')
                        .attr('text-anchor', 'middle')
                        .attr('transform', d => `translate(${d.x}, ${d.y}) rotate(${d.rotate})`)
                        .text(d => d.text);
                    
                    // 繝輔ぉ繝ｼ繝峨う繝ｳ繝ｻ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                    texts.transition()
                        .duration(600)
                        .delay((d, i) => i * 8)
                        .style('font-size', d => `${d.size}px`);
                    
                    // 繧､繝ｳ繧ｿ繝ｩ繧ｯ繧ｷ繝ｧ繝ｳ
                    texts
                        .on('mouseover', function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(150)
                                .style('font-size', `${d.size * 1.15}px`)
                                .style('filter', 'brightness(1.3)');
                            
                            // 繝・・繝ｫ繝√ャ繝・                            d3.select(container)
                                .append('div')
                                .attr('class', 'wc-tooltip')
                                .style('position', 'absolute')
                                .style('background', 'rgba(20,20,40,0.95)')
                                .style('color', '#fff')
                                .style('padding', '10px 14px')
                                .style('border-radius', '6px')
                                .style('font-size', '14px')
                                .style('font-family', 'Meiryo, sans-serif')
                                .style('pointer-events', 'none')
                                .style('box-shadow', '0 4px 12px rgba(0,0,0,0.4)')
                                .style('left', `${event.offsetX + 15}px`)
                                .style('top', `${event.offsetY - 35}px`)
                                .style('z-index', '1000')
                                .html(`<strong style="font-size:16px;">${d.text}</strong><br><span style="color:#aaa;">TF-IDF:</span> ${d.score.toFixed(4)}`);
                        })
                        .on('mouseout', function(event, d) {
                            d3.select(this)
                                .transition()
                                .duration(150)
                                .style('font-size', `${d.size}px`)
                                .style('filter', 'none');
                            d3.select(container).selectAll('.wc-tooltip').remove();
                        });
                    
                    debugLog(`[drawWordCloud] Rendered ${words.length} words with ${colorScheme} palette`);
                }
                
            } catch(e) {
                console.error('WordCloud error:', e);
                document.getElementById(divId).innerHTML = '<div class="status-err">繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝峨お繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * D3.js Force Simulation繧剃ｽｿ縺｣縺溘ロ繝・ヨ繝ｯ繝ｼ繧ｯ謠冗判
         * 繝峨Λ繝・げ蜿ｯ閭ｽ縺ｧ繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑繝阪ャ繝医Ρ繝ｼ繧ｯ蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} nodesJson - 繝弱・繝峨ョ繝ｼ繧ｿ [{id, label, size, color, group}, ...]
         * @param {string} linksJson - 繝ｪ繝ｳ繧ｯ繝・・繧ｿ [{source, target, weight}, ...]
         * @param {string} title - 繧ｰ繝ｩ繝輔ち繧､繝医Ν
         */
        function drawForceNetwork(divId, nodesJson, linksJson, title) {
            try {
                const container = document.getElementById(divId);
                if (!container) return;
                container.innerHTML = '';
                
                const nodes = JSON.parse(nodesJson);
                const links = JSON.parse(linksJson);
                
                if (!nodes.length) {
                    container.innerHTML = '<div class="status-warn">陦ｨ遉ｺ縺吶ｋ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>';
                    return;
                }
                
                const width = container.clientWidth || 800;
                const height = 550;
                
                // 繧ｫ繝ｩ繝ｼ繝代Ξ繝・ヨ
                const colors = ['#4fc3f7', '#81c784', '#ffb74d', '#f06292', '#ba68c8', '#4db6ac', '#ff8a65', '#aed581', '#7986cb', '#e57373'];
                
                // SVG菴懈・
                const svg = d3.select(container)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', 'linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%)')
                    .style('border-radius', '8px');
                
                // 繧ｿ繧､繝医Ν
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', 25)
                    .attr('text-anchor', 'middle')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '16px')
                    .style('font-weight', 'bold')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(title);
                
                const g = svg.append('g').attr('transform', 'translate(0, 30)');
                
                // Force Simulation・医ヮ繝ｼ繝蛾俣縺ｮ霍晞屬繧貞ｺ・￡繧玖ｨｭ螳夲ｼ・                const simulation = d3.forceSimulation(nodes)
                    .force('link', d3.forceLink(links).id(d => d.id).distance(120).strength(0.3))
                    .force('charge', d3.forceManyBody().strength(-400))
                    .force('center', d3.forceCenter(width / 2, (height - 30) / 2))
                    .force('collision', d3.forceCollide().radius(d => d.size + 25))
                    .force('x', d3.forceX(width / 2).strength(0.05))
                    .force('y', d3.forceY((height - 30) / 2).strength(0.05));
                
                // 繝ｪ繝ｳ繧ｯ謠冗判
                const link = g.append('g')
                    .selectAll('line')
                    .data(links)
                    .enter()
                    .append('line')
                    .style('stroke', 'rgba(255,255,255,0.2)')
                    .style('stroke-width', d => Math.sqrt(d.weight) * 0.5 + 0.5);
                
                // 繝弱・繝画緒逕ｻ
                const node = g.append('g')
                    .selectAll('g')
                    .data(nodes)
                    .enter()
                    .append('g')
                    .style('cursor', 'grab')
                    .call(d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended));
                
                // 繝弱・繝牙・
                node.append('circle')
                    .attr('r', d => d.size)
                    .style('fill', (d, i) => colors[d.group % colors.length])
                    .style('stroke', '#fff')
                    .style('stroke-width', 1.5)
                    .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))');
                
                // 繝弱・繝峨Λ繝吶Ν・郁ｦ九ｄ縺吶＆蜷台ｸ奇ｼ・                node.append('text')
                    .text(d => d.label.length > 12 ? d.label.slice(0, 12) + '窶ｦ' : d.label)
                    .attr('dy', 4)
                    .attr('text-anchor', 'middle')
                    .style('fill', '#fff')
                    .style('font-size', '10px')
                    .style('font-weight', 'bold')
                    .style('font-family', 'Meiryo, sans-serif')
                    .style('text-shadow', '0 1px 3px rgba(0,0,0,0.8), 0 0 8px rgba(0,0,0,0.6)')
                    .style('pointer-events', 'none');
                
                // 繝帙ヰ繝ｼ蜉ｹ譫・                node.on('mouseover', function(event, d) {
                    d3.select(this).select('circle')
                        .transition().duration(150)
                        .attr('r', d.size * 1.3)
                        .style('filter', 'drop-shadow(0 4px 8px rgba(79,195,247,0.5))');
                    
                    d3.select(container)
                        .append('div')
                        .attr('class', 'network-tooltip')
                        .style('position', 'absolute')
                        .style('background', 'rgba(20,20,40,0.95)')
                        .style('color', '#fff')
                        .style('padding', '12px 16px')
                        .style('border-radius', '8px')
                        .style('font-size', '13px')
                        .style('font-family', 'Meiryo, sans-serif')
                        .style('pointer-events', 'none')
                        .style('box-shadow', '0 4px 16px rgba(0,0,0,0.4)')
                        .style('left', `${event.offsetX + 15}px`)
                        .style('top', `${event.offsetY - 40}px`)
                        .style('z-index', '1000')
                        .html(`<strong style="font-size:15px;color:#4fc3f7;">${d.label}</strong><br>
                               <span style="color:#aaa;">谺｡謨ｰ:</span> ${d.degree}<br>
                               <span style="color:#aaa;">荳ｭ蠢・ｧ:</span> ${d.centrality.toFixed(3)}`);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this).select('circle')
                        .transition().duration(150)
                        .attr('r', d.size)
                        .style('filter', 'drop-shadow(0 2px 4px rgba(0,0,0,0.3))');
                    d3.select(container).selectAll('.network-tooltip').remove();
                });
                
                // 繧ｷ繝溘Η繝ｬ繝ｼ繧ｷ繝ｧ繝ｳ譖ｴ譁ｰ
                simulation.on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);
                    
                    node.attr('transform', d => `translate(${d.x}, ${d.y})`);
                });
                
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                    d3.select(this).style('cursor', 'grabbing');
                }
                
                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }
                
                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                    d3.select(this).style('cursor', 'grab');
                }
                
                debugLog(`[drawForceNetwork] Rendered ${nodes.length} nodes, ${links.length} links`);
                
            } catch(e) {
                console.error('Network error:', e);
                document.getElementById(divId).innerHTML = '<div class="status-err">繝阪ャ繝医Ρ繝ｼ繧ｯ繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″讓ｪ譽偵げ繝ｩ繝墓緒逕ｻ・・-gram縲ゝF-IDF逕ｨ・・         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - 繝・・繧ｿ [{label, value}, ...]
         * @param {string} title - 繧ｰ繝ｩ繝輔ち繧､繝医Ν
         * @param {string} colorScheme - 繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝
         */
        function drawAnimatedBarChart(divId, dataJson, title, colorScheme) {
            try {
                const container = document.getElementById(divId);
                if (!container) return;
                container.innerHTML = '';
                
                const data = JSON.parse(dataJson);
                if (!data.length) {
                    container.innerHTML = '<div class="status-warn">陦ｨ遉ｺ縺吶ｋ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>';
                    return;
                }
                
                const margin = {top: 40, right: 30, bottom: 20, left: 120};
                const width = (container.clientWidth || 800) - margin.left - margin.right;
                const height = Math.max(400, data.length * 28) - margin.top - margin.bottom;
                
                // 繧ｫ繝ｩ繝ｼ繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ
                const gradients = {
                    'viridis': ['#440154', '#21918c', '#fde725'],
                    'plasma': ['#0d0887', '#cc4778', '#f0f921'],
                    'warm': ['#6e40aa', '#ff7847', '#aff05b'],
                    'cool': ['#4fc3f7', '#81c784', '#ffb74d']
                };
                const gradient = gradients[colorScheme] || gradients['viridis'];
                
                const svg = d3.select(container)
                    .append('svg')
                    .attr('width', width + margin.left + margin.right)
                    .attr('height', height + margin.top + margin.bottom)
                    .style('background', 'linear-gradient(180deg, #0d1b2a 0%, #1b263b 100%)')
                    .style('border-radius', '8px');
                
                // 繧ｿ繧､繝医Ν
                svg.append('text')
                    .attr('x', (width + margin.left + margin.right) / 2)
                    .attr('y', 25)
                    .attr('text-anchor', 'middle')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '16px')
                    .style('font-weight', 'bold')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(title);
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                // 繧ｹ繧ｱ繝ｼ繝ｫ
                const x = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.value)])
                    .range([0, width]);
                
                const y = d3.scaleBand()
                    .domain(data.map(d => d.label))
                    .range([0, height])
                    .padding(0.25);
                
                const colorScale = d3.scaleLinear()
                    .domain([0, data.length / 2, data.length])
                    .range(gradient);
                
                // 繝舌・
                const bars = g.selectAll('.bar')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('class', 'bar')
                    .attr('x', 0)
                    .attr('y', d => y(d.label))
                    .attr('width', 0)
                    .attr('height', y.bandwidth())
                    .attr('rx', 4)
                    .attr('ry', 4)
                    .style('fill', (d, i) => colorScale(i))
                    .style('cursor', 'pointer');
                
                // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                bars.transition()
                    .duration(800)
                    .delay((d, i) => i * 30)
                    .attr('width', d => x(d.value));
                
                // 繝帙ヰ繝ｼ蜉ｹ譫・                bars.on('mouseover', function(event, d) {
                    d3.select(this)
                        .transition().duration(100)
                        .style('filter', 'brightness(1.3)')
                        .attr('height', y.bandwidth() * 1.1)
                        .attr('y', y(d.label) - y.bandwidth() * 0.05);
                })
                .on('mouseout', function(event, d) {
                    d3.select(this)
                        .transition().duration(100)
                        .style('filter', 'none')
                        .attr('height', y.bandwidth())
                        .attr('y', y(d.label));
                });
                
                // 蛟､繝ｩ繝吶Ν
                g.selectAll('.value-label')
                    .data(data)
                    .enter()
                    .append('text')
                    .attr('class', 'value-label')
                    .attr('x', d => x(d.value) + 5)
                    .attr('y', d => y(d.label) + y.bandwidth() / 2)
                    .attr('dy', '0.35em')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '11px')
                    .style('font-family', 'Meiryo, sans-serif')
                    .style('opacity', 0)
                    .text(d => d.value.toFixed ? d.value.toFixed(2) : d.value)
                    .transition()
                    .duration(800)
                    .delay((d, i) => i * 30 + 400)
                    .style('opacity', 1);
                
                // Y霆ｸ繝ｩ繝吶Ν
                g.selectAll('.y-label')
                    .data(data)
                    .enter()
                    .append('text')
                    .attr('class', 'y-label')
                    .attr('x', -8)
                    .attr('y', d => y(d.label) + y.bandwidth() / 2)
                    .attr('dy', '0.35em')
                    .attr('text-anchor', 'end')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '12px')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(d => d.label.length > 15 ? d.label.slice(0, 15) + '窶ｦ' : d.label);
                
                debugLog(`[drawAnimatedBarChart] Rendered ${data.length} bars`);
                
            } catch(e) {
                console.error('BarChart error:', e);
                document.getElementById(divId).innerHTML = '<div class="status-err">繧ｰ繝ｩ繝輔お繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧ｵ繝ｳ繧ｭ繝ｼ繝繧､繧｢繧ｰ繝ｩ繝繧呈緒逕ｻ縺吶ｋ
         * 蜃ｺ鬘倅ｺｺ縺ｨ謚陦灘・驥趣ｼ・PC・峨・髢｢菫ゅｒ繝輔Ο繝ｼ蝗ｳ縺ｧ蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・繧ｵ繝ｳ繧ｭ繝ｼ繝・・繧ｿ・・odes, links・・         * @param {string} colorScheme - 繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝・・ategory/gradient・・         */
        function drawSankeyDiagram(divId, dataJson, colorScheme) {
            const container = document.getElementById(divId);
            if (!container) {
                console.error('Sankey container not found:', divId);
                return;
            }
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const width = container.clientWidth || 900;
                const height = 500;
                const margin = {top: 20, right: 200, bottom: 20, left: 200};
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;
                
                // 繧ｵ繝ｳ繧ｭ繝ｼ繝ｬ繧､繧｢繧ｦ繝・                const sankey = d3.sankey()
                    .nodeWidth(20)
                    .nodePadding(12)
                    .extent([[0, 0], [innerWidth, innerHeight]]);
                
                const graph = sankey({
                    nodes: data.nodes.map(d => Object.assign({}, d)),
                    links: data.links.map(d => Object.assign({}, d))
                });
                
                // 繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ螳夂ｾｩ
                const defs = svg.append('defs');
                
                // 繝ｪ繝ｳ繧ｯ縺ｮ繧ｰ繝ｩ繝・・繧ｷ繝ｧ繝ｳ
                graph.links.forEach((link, i) => {
                    const gradientId = `link-gradient-${i}`;
                    const gradient = defs.append('linearGradient')
                        .attr('id', gradientId)
                        .attr('gradientUnits', 'userSpaceOnUse')
                        .attr('x1', link.source.x1)
                        .attr('x2', link.target.x0);
                    
                    gradient.append('stop')
                        .attr('offset', '0%')
                        .attr('stop-color', d3.schemeTableau10[link.source.index % 10])
                        .attr('stop-opacity', 0.7);
                    gradient.append('stop')
                        .attr('offset', '100%')
                        .attr('stop-color', d3.schemeTableau10[link.target.index % 10])
                        .attr('stop-opacity', 0.7);
                    
                    link.gradientId = gradientId;
                });
                
                // 繝ｪ繝ｳ繧ｯ謠冗判
                const links = g.append('g')
                    .attr('fill', 'none')
                    .selectAll('path')
                    .data(graph.links)
                    .enter()
                    .append('path')
                    .attr('d', d3.sankeyLinkHorizontal())
                    .attr('stroke', d => colorScheme === 'gradient' 
                        ? `url(#${d.gradientId})` 
                        : d3.schemeTableau10[d.source.index % 10])
                    .attr('stroke-width', d => Math.max(2, d.width))
                    .attr('stroke-opacity', 0.5)
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .attr('stroke-opacity', 0.9)
                            .attr('stroke-width', d.width + 2);
                        
                        // 繝・・繝ｫ繝√ャ繝・                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'sankey-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '10px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .html(`<strong>${d.source.name}</strong> 竊・<strong>${d.target.name}</strong><br/>莉ｶ謨ｰ: ${d.value}`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this)
                            .attr('stroke-opacity', 0.5)
                            .attr('stroke-width', d.width);
                        d3.selectAll('.sankey-tooltip').remove();
                    });
                
                // 繝弱・繝画緒逕ｻ
                const nodes = g.append('g')
                    .selectAll('rect')
                    .data(graph.nodes)
                    .enter()
                    .append('rect')
                    .attr('x', d => d.x0)
                    .attr('y', d => d.y0)
                    .attr('width', d => d.x1 - d.x0)
                    .attr('height', d => Math.max(1, d.y1 - d.y0))
                    .attr('fill', (d, i) => d3.schemeTableau10[i % 10])
                    .attr('rx', 3)
                    .attr('ry', 3)
                    .attr('opacity', 0)
                    .transition()
                    .duration(600)
                    .delay((d, i) => i * 30)
                    .attr('opacity', 1);
                
                // 繝弱・繝峨Λ繝吶Ν
                g.append('g')
                    .selectAll('text')
                    .data(graph.nodes)
                    .enter()
                    .append('text')
                    .attr('x', d => d.x0 < innerWidth / 2 ? d.x0 - 8 : d.x1 + 8)
                    .attr('y', d => (d.y0 + d.y1) / 2)
                    .attr('dy', '0.35em')
                    .attr('text-anchor', d => d.x0 < innerWidth / 2 ? 'end' : 'start')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '11px')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(d => d.name.length > 20 ? d.name.slice(0, 20) + '窶ｦ' : d.name);
                
                debugLog(`[drawSankeyDiagram] Rendered ${graph.nodes.length} nodes, ${graph.links.length} links`);
                
            } catch(e) {
                console.error('Sankey error:', e);
                container.innerHTML = '<div class="status-err">繧ｵ繝ｳ繧ｭ繝ｼ蝗ｳ繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ繧呈緒逕ｻ繝ｻ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺吶ｋ
         * 蟷ｴ縺斐→縺ｮ蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ繧偵い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺ｧ陦ｨ遉ｺ
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID  
         * @param {string} dataJson - JSON蠖｢蠑上・譎らｳｻ蛻励ョ繝ｼ繧ｿ
         * @param {number} speed - 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ騾溷ｺｦ・医Α繝ｪ遘・蟷ｴ・・         */
        window.bubbleRaceState = { running: false, timer: null, yearIndex: 0, initialized: false };
        
        // 蛻晄悄縺ｮ繝繝溘・髢｢謨ｰ・・rawBubbleRace螳溯｡悟ｾ後↓荳頑嶌縺阪＆繧後ｋ・・        window.bubbleRacePlay = function() {
            // 縺ｾ縺蛻晄悄蛹悶＆繧後※縺・↑縺・ｴ蜷医￣ython蛛ｴ縺ｧ繝・・繧ｿ貅門ｙ繧貞ｮ溯｡・            if (!window.bubbleRaceState.initialized) {
                debugLog('BubbleRace: Initializing data first...');
                // Python縺ｮshow_bubble_race繧貞他縺ｳ蜃ｺ縺励√◎縺ｮ蠕悟・逕・                const btn = document.getElementById('btn-race-play');
                if (btn) btn.textContent = '貅門ｙ荳ｭ...';
                if (window.pyShowBubbleRace) {
                    window.pyShowBubbleRace();
                } else {
                    console.error('Python function not available');
                }
                return;
            }
            window._bubbleRacePlayInternal();
        };
        window.bubbleRacePause = function() { debugLog('BubbleRace not initialized yet'); };
        window.bubbleRaceReset = function() { debugLog('BubbleRace not initialized yet'); };
        
        function drawBubbleRace(divId, dataJson, speed) {
            const container = document.getElementById(divId);
            const yearDisplay = document.getElementById('race-year-display');
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const years = Object.keys(data).sort();
                const companies = [...new Set(Object.values(data).flatMap(y => y.map(d => d.name)))];
                const colorMap = {};
                companies.forEach((c, i) => colorMap[c] = d3.schemeCategory10[i % 10]);
                
                const width = container.clientWidth || 800;
                const height = 450;
                const margin = {top: 30, right: 80, bottom: 30, left: 140};
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;
                
                // 譛螟ｧ蛟､繧貞叙蠕暦ｼ亥・譛滄俣・・                const maxVal = d3.max(Object.values(data).flat(), d => d.value);
                
                const x = d3.scaleLinear()
                    .domain([0, maxVal * 1.1])
                    .range([0, innerWidth]);
                
                const y = d3.scaleBand()
                    .domain(d3.range(10))
                    .range([0, innerHeight])
                    .padding(0.15);
                
                // X霆ｸ
                g.append('g')
                    .attr('class', 'x-axis')
                    .attr('transform', `translate(0, ${innerHeight})`)
                    .call(d3.axisBottom(x).ticks(5))
                    .selectAll('text, line, path')
                    .style('stroke', '#4fc3f7')
                    .style('fill', '#4fc3f7');
                
                function update(yearIdx) {
                    const year = years[yearIdx];
                    const yearData = data[year].slice(0, 10);
                    
                    if (yearDisplay) {
                        yearDisplay.innerHTML = `套 ${year}`;
                    }
                    
                    // 繝舌・譖ｴ譁ｰ
                    const bars = g.selectAll('.race-bar')
                        .data(yearData, d => d.name);
                    
                    bars.exit()
                        .transition().duration(speed * 0.3)
                        .attr('width', 0)
                        .remove();
                    
                    const barsEnter = bars.enter()
                        .append('rect')
                        .attr('class', 'race-bar')
                        .attr('x', 0)
                        .attr('width', 0)
                        .attr('rx', 4)
                        .attr('ry', 4);
                    
                    bars.merge(barsEnter)
                        .transition().duration(speed * 0.8)
                        .attr('y', (d, i) => y(i))
                        .attr('width', d => x(d.value))
                        .attr('height', y.bandwidth())
                        .attr('fill', d => colorMap[d.name]);
                    
                    // 繝ｩ繝吶Ν譖ｴ譁ｰ
                    const labels = g.selectAll('.race-label')
                        .data(yearData, d => d.name);
                    
                    labels.exit().remove();
                    
                    const labelsEnter = labels.enter()
                        .append('text')
                        .attr('class', 'race-label')
                        .style('fill', '#e0e1dd')
                        .style('font-size', '11px')
                        .style('font-family', 'Meiryo, sans-serif');
                    
                    labels.merge(labelsEnter)
                        .transition().duration(speed * 0.8)
                        .attr('x', -8)
                        .attr('y', (d, i) => y(i) + y.bandwidth() / 2)
                        .attr('dy', '0.35em')
                        .attr('text-anchor', 'end')
                        .text(d => d.name.length > 12 ? d.name.slice(0, 12) + '窶ｦ' : d.name);
                    
                    // 蛟､繝ｩ繝吶Ν譖ｴ譁ｰ
                    const values = g.selectAll('.race-value')
                        .data(yearData, d => d.name);
                    
                    values.exit().remove();
                    
                    const valuesEnter = values.enter()
                        .append('text')
                        .attr('class', 'race-value')
                        .style('fill', '#4fc3f7')
                        .style('font-size', '11px')
                        .style('font-weight', 'bold');
                    
                    values.merge(valuesEnter)
                        .transition().duration(speed * 0.8)
                        .attr('x', d => x(d.value) + 5)
                        .attr('y', (d, i) => y(i) + y.bandwidth() / 2)
                        .attr('dy', '0.35em')
                        .text(d => d.value);
                }
                
                // 蛻晄悄謠冗判
                update(0);
                window.bubbleRaceState.yearIndex = 0;
                window.bubbleRaceState.initialized = true;
                
                // 繝懊ち繝ｳ繝・く繧ｹ繝医ｒ謌ｻ縺・                const btn = document.getElementById('btn-race-play');
                if (btn) btn.textContent = '笆ｶ・・蜀咲函';
                
                // 蜀・Κ蜀咲函髢｢謨ｰ
                window._bubbleRacePlayInternal = function() {
                    if (window.bubbleRaceState.running) return;
                    window.bubbleRaceState.running = true;
                    
                    function step() {
                        if (!window.bubbleRaceState.running) return;
                        
                        window.bubbleRaceState.yearIndex++;
                        if (window.bubbleRaceState.yearIndex >= years.length) {
                            // 譛蠕後∪縺ｧ陦後▲縺溘ｉ蛛懈ｭ｢
                            window.bubbleRaceState.running = false;
                            window.bubbleRaceState.yearIndex = years.length - 1;
                            const btn = document.getElementById('btn-race-play');
                            if (btn) btn.textContent = '売 譛蛻昴°繧・;
                            return;
                        }
                        update(window.bubbleRaceState.yearIndex);
                        window.bubbleRaceState.timer = setTimeout(step, speed);
                    }
                    step();
                };
                
                // 蜀咲函繧ｳ繝ｳ繝医Ο繝ｼ繝ｫ・亥・譛溷喧貂医∩縺ｪ縺ｮ縺ｧ逶ｴ謗･蜀・Κ髢｢謨ｰ繧貞他縺ｶ・・                window.bubbleRacePlay = function() {
                    // 譛蠕後∪縺ｧ陦後▲縺ｦ縺・◆蝣ｴ蜷医・繝ｪ繧ｻ繝・ヨ縺励※蜀埼幕
                    if (window.bubbleRaceState.yearIndex >= years.length - 1) {
                        window.bubbleRaceState.yearIndex = 0;
                        update(0);
                        const btn = document.getElementById('btn-race-play');
                        if (btn) btn.textContent = '笆ｶ・・蜀咲函';
                    }
                    window._bubbleRacePlayInternal();
                };
                
                window.bubbleRacePause = function() {
                    window.bubbleRaceState.running = false;
                    if (window.bubbleRaceState.timer) {
                        clearTimeout(window.bubbleRaceState.timer);
                    }
                };
                
                window.bubbleRaceReset = function() {
                    window.bubbleRacePause();
                    window.bubbleRaceState.yearIndex = 0;
                    update(0);
                };
                
                debugLog(`[drawBubbleRace] Ready with ${years.length} years of data`);
                
                // 閾ｪ蜍募・逕滄幕蟋・                setTimeout(() => window._bubbleRacePlayInternal(), 300);
                
            } catch(e) {
                console.error('BubbleRace error:', e);
                container.innerHTML = '<div class="status-err">繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧ｺ繝ｼ繝蜿ｯ閭ｽ縺ｪ繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｭ繝ｳ繧ｰ繧呈緒逕ｻ縺吶ｋ
         * 髫主ｱ､逧・↑繝・・繧ｿ讒矩繧偵う繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↓蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・髫主ｱ､繝・・繧ｿ
         */
        function drawCirclePacking(divId, dataJson) {
            const container = document.getElementById(divId);
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                // 繝・・繧ｿ繧偵げ繝ｭ繝ｼ繝舌Ν縺ｫ菫晏ｭ假ｼ域｡井ｻｶ繝ｪ繧ｹ繝郁｡ｨ遉ｺ逕ｨ・・                window.circlePackData = data;
                
                const size = Math.min(container.clientWidth || 600, 550);
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', size)
                    .attr('height', size)
                    .style('background', '#0d1b2a')
                    .style('cursor', 'pointer');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${size/2}, ${size/2})`);
                
                const color = d3.scaleSequential([0, 3], d3.interpolatePlasma);
                
                const pack = d3.pack()
                    .size([size - 4, size - 4])
                    .padding(3);
                
                const root = pack(d3.hierarchy(data)
                    .sum(d => d.value || 0)
                    .sort((a, b) => b.value - a.value));
                
                let focus = root;
                let view;
                
                const nodes = g.selectAll('circle')
                    .data(root.descendants())
                    .enter()
                    .append('circle')
                    .attr('class', d => d.children ? 'circle-parent' : 'circle-leaf')
                    .attr('fill', d => d.children ? color(d.depth) : 'rgba(79, 195, 247, 0.7)')
                    .attr('stroke', d => d.children ? 'rgba(255,255,255,0.2)' : 'none')
                    .attr('stroke-width', 1)
                    .style('opacity', 0)
                    .on('click', (event, d) => {
                        // 繧ｷ繝ｳ繧ｰ繝ｫ繧ｯ繝ｪ繝・け: 繧ｺ繝ｼ繝 + 譯井ｻｶ繝ｪ繧ｹ繝郁｡ｨ遉ｺ
                        if (focus !== d) {
                            zoom(event, d);
                        }
                        // 蟶ｸ縺ｫ譯井ｻｶ繝ｪ繧ｹ繝医ｒ陦ｨ遉ｺ
                        showCircleDetail(d);
                        event.stopPropagation();
                    })
                    .on('mouseover', function(event, d) {
                        d3.select(this)
                            .attr('stroke', '#4fc3f7')
                            .attr('stroke-width', 2);
                        
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'circle-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '8px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .html(`<strong>${d.data.name}</strong><br/>莉ｶ謨ｰ: ${d.value}`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function(event, d) {
                        d3.select(this)
                            .attr('stroke', d.children ? 'rgba(255,255,255,0.2)' : 'none')
                            .attr('stroke-width', 1);
                        d3.selectAll('.circle-tooltip').remove();
                    });
                
                // 繝・く繧ｹ繝医Λ繝吶Ν
                const labels = g.selectAll('text')
                    .data(root.descendants().filter(d => !d.children || d.depth <= 1))
                    .enter()
                    .append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '0.35em')
                    .style('fill', d => d.children ? '#fff' : '#0d1b2a')
                    .style('font-size', d => d.children ? '12px' : '10px')
                    .style('font-weight', d => d.children ? 'bold' : 'normal')
                    .style('font-family', 'Meiryo, sans-serif')
                    .style('pointer-events', 'none')
                    .style('opacity', 0)
                    .text(d => {
                        const name = d.data.name || '';
                        const maxLen = d.children ? 15 : 10;
                        return name.length > maxLen ? name.slice(0, maxLen) + '窶ｦ' : name;
                    });
                
                // 繧ｺ繝ｼ繝髢｢謨ｰ
                function zoomTo(v) {
                    const k = size / v[2];
                    view = v;
                    
                    nodes.attr('transform', d => `translate(${(d.x - v[0]) * k}, ${(d.y - v[1]) * k})`)
                        .attr('r', d => d.r * k);
                    
                    labels.attr('transform', d => `translate(${(d.x - v[0]) * k}, ${(d.y - v[1]) * k})`)
                        .style('font-size', d => Math.min(12, d.r * k / 3) + 'px')
                        .style('opacity', d => d.r * k > 20 ? 1 : 0);
                }
                
                function zoom(event, d) {
                    focus = d;
                    
                    g.transition()
                        .duration(750)
                        .tween('zoom', () => {
                            const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
                            return t => zoomTo(i(t));
                        });
                }
                
                // 蛻晄悄陦ｨ遉ｺ
                zoomTo([root.x, root.y, root.r * 2]);
                
                // 繝輔ぉ繝ｼ繝峨う繝ｳ
                nodes.transition()
                    .duration(800)
                    .delay((d, i) => i * 5)
                    .style('opacity', 1);
                
                labels.transition()
                    .duration(800)
                    .delay(500)
                    .style('opacity', d => d.r * view[2] / (root.r * 2) > 20 ? 1 : 0);
                
                // 繝ｫ繝ｼ繝医け繝ｪ繝・け縺ｧ繝ｪ繧ｻ繝・ヨ
                svg.on('click', (event) => {
                    zoom(event, root);
                    showCircleDetail(root);
                });
                
                // 繝・ヵ繧ｩ繝ｫ繝医〒繝ｫ繝ｼ繝医ヮ繝ｼ繝峨・隧ｳ邏ｰ繧定｡ｨ遉ｺ
                setTimeout(() => showCircleDetail(root), 900);
                
                debugLog(`[drawCirclePacking] Rendered ${root.descendants().length} nodes`);
                
            } catch(e) {
                console.error('CirclePacking error:', e);
                container.innerHTML = '<div class="status-err">繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｯ繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｭ繝ｳ繧ｰ縺ｮ蜀・↓蟇ｾ蠢懊☆繧区｡井ｻｶ繝ｪ繧ｹ繝医ｒ陦ｨ遉ｺ縺吶ｋ
         * @param {Object} node - D3繝弱・繝峨ョ繝ｼ繧ｿ
         */
        function showCircleDetail(node) {
            const panel = document.getElementById('circle-detail-panel');
            const title = document.getElementById('circle-detail-title');
            const content = document.getElementById('circle-detail-content');
            
            if (!panel || !content) return;
            
            // 繝弱・繝牙錐蜿門ｾ・            const nodeName = node.data.name || 'Unknown';
            const nodeValue = node.value || 0;
            
            title.innerHTML = `搭 ${nodeName} <span style="font-weight: normal; font-size: 0.85rem;">(${nodeValue}莉ｶ)</span>`;
            
            // Python蛛ｴ縺九ｉ蜿門ｾ励＠縺滓｡井ｻｶ繝・・繧ｿ縺後≠繧後・菴ｿ縺・            if (window.circlePackPatents && window.circlePackPatents[nodeName]) {
                const patents = window.circlePackPatents[nodeName];
                let html = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
                
                patents.slice(0, 50).forEach((p, i) => {
                    html += `
                        <div style="background: rgba(79, 195, 247, 0.1); border-left: 3px solid #4fc3f7; padding: 0.5rem; border-radius: 4px;">
                            <div style="font-weight: bold; color: #4fc3f7; font-size: 0.8rem;">${p.app_number || ''}</div>
                            <div style="color: #e0e1dd; margin-top: 0.2rem;">${(p.title || '').slice(0, 60)}${(p.title || '').length > 60 ? '...' : ''}</div>
                            <div style="color: #888; font-size: 0.75rem; margin-top: 0.2rem;">
                                ${p.year || ''} | ${(p.applicant || '').slice(0, 25)}${(p.applicant || '').length > 25 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                
                if (patents.length > 50) {
                    html += `<div style="color: #888; text-align: center; padding: 0.5rem;">...莉・${patents.length - 50} 莉ｶ</div>`;
                }
                html += '</div>';
                content.innerHTML = html;
            } else {
                // 蟄舌ヮ繝ｼ繝峨・諠・ｱ繧定｡ｨ遉ｺ
                if (node.children && node.children.length > 0) {
                    let html = '<div style="display: flex; flex-direction: column; gap: 0.4rem;">';
                    node.children.forEach(child => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(79, 195, 247, 0.1); padding: 0.4rem 0.6rem; border-radius: 4px;">
                                <span style="color: #e0e1dd;">${child.data.name}</span>
                                <span style="color: #4fc3f7; font-weight: bold;">${child.value}莉ｶ</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += `<div style="color: #888; font-size: 0.8rem; margin-top: 1rem; text-align: center;">庁 蛟句挨譯井ｻｶ繧定ｦ九ｋ縺ｫ縺ｯ荳倶ｽ埼嚴螻､繧偵ム繝悶Ν繧ｯ繝ｪ繝・け</div>`;
                    content.innerHTML = html;
                } else {
                    // 繝ｪ繝ｼ繝輔ヮ繝ｼ繝会ｼ域｡井ｻｶ繝・・繧ｿ縺後↑縺・ｴ蜷茨ｼ・                    content.innerHTML = `
                        <div style="color: #888; text-align: center; padding: 2rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">投</div>
                            <div>${nodeName}: ${nodeValue}莉ｶ</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem;">隧ｳ邏ｰ縺ｪ譯井ｻｶ繝・・繧ｿ縺ｯ髫主ｱ､險ｭ螳壹〒蜿門ｾ励＆繧後∪縺・/div>
                        </div>
                    `;
                }
            }
            
            panel.style.display = 'block';
        }
        
        /**
         * 繧ｵ繝ｳ繝舌・繧ｹ繝亥峙・・unburst Chart・峨ｒ謠冗判縺吶ｋ
         * IPC/FI蛻・｡槭・髫主ｱ､讒矩繧呈叛蟆・憾縺ｫ蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・髫主ｱ､繝・・繧ｿ
         * @param {string} colorScheme - 繧ｫ繝ｩ繝ｼ繧ｹ繧ｭ繝ｼ繝蜷・         */
        function drawSunburst(divId, dataJson, colorScheme) {
            const container = document.getElementById(divId);
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const width = container.clientWidth || 600;
                const height = 550;
                const radius = Math.min(width, height) / 2 - 10;
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${width/2}, ${height/2})`);
                
                // 髫主ｱ､繝・・繧ｿ菴懈・
                const root = d3.hierarchy(data)
                    .sum(d => d.value || 0)
                    .sort((a, b) => b.value - a.value);
                
                const partition = d3.partition()
                    .size([2 * Math.PI, radius]);
                
                partition(root);
                
                // 繧ｫ繝ｩ繝ｼ繧ｹ繧ｱ繝ｼ繝ｫ
                const colorScale = d3[`interpolate${colorScheme}`] || d3.interpolateSpectral;
                const colorFn = (d) => {
                    if (!d.parent) return '#0d1b2a';
                    // 譛荳贋ｽ阪ヮ繝ｼ繝峨・繧､繝ｳ繝・ャ繧ｯ繧ｹ縺ｫ蝓ｺ縺･縺・※濶ｲ繧呈ｱｺ螳・                    let ancestor = d;
                    while (ancestor.parent && ancestor.parent.parent) ancestor = ancestor.parent;
                    const siblings = ancestor.parent.children;
                    const idx = siblings.indexOf(ancestor);
                    const baseHue = idx / siblings.length;
                    const depth = d.depth;
                    return d3.hsl(baseHue * 360, 0.7, 0.3 + depth * 0.15).toString();
                };
                
                // 繧｢繝ｼ繧ｯ逕滓・蝎ｨ
                const arc = d3.arc()
                    .startAngle(d => d.x0)
                    .endAngle(d => d.x1)
                    .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
                    .padRadius(radius / 2)
                    .innerRadius(d => d.y0)
                    .outerRadius(d => d.y1 - 1);
                
                // 繧｢繝ｼ繧ｯ謠冗判・医い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″・・                const paths = g.selectAll('path')
                    .data(root.descendants().filter(d => d.depth))
                    .enter()
                    .append('path')
                    .attr('fill', colorFn)
                    .attr('stroke', '#0d1b2a')
                    .attr('stroke-width', 0.5)
                    .style('cursor', 'pointer')
                    .each(function(d) { d.current = d; })
                    .on('click', clicked)
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 0.8);
                        
                        // 繝・・繝ｫ繝√ャ繝・                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'd3-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '10px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .html(`<strong>${d.data.name}</strong><br/>莉ｶ謨ｰ: ${d.value}`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 1);
                        d3.selectAll('.d3-tooltip').remove();
                    });
                
                // 蛻晄悄繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                paths.transition()
                    .duration(800)
                    .delay((d, i) => i * 5)
                    .attrTween('d', function(d) {
                        const i = d3.interpolate({x0: 0, x1: 0, y0: d.y0, y1: d.y1}, d);
                        return t => arc(i(t));
                    });
                
                // 繧ｺ繝ｼ繝讖溯・
                function clicked(event, p) {
                    root.each(d => {
                        d.target = {
                            x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                            x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
                            y0: Math.max(0, d.y0 - p.y0),
                            y1: Math.max(0, d.y1 - p.y0)
                        };
                    });
                    
                    paths.transition()
                        .duration(750)
                        .tween('data', d => {
                            const i = d3.interpolate(d.current, d.target);
                            return t => d.current = i(t);
                        })
                        .attrTween('d', d => () => arc(d.current));
                }
                
                // 荳ｭ螟ｮ縺ｮ繝ｩ繝吶Ν
                g.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '-0.3em')
                    .style('fill', '#4fc3f7')
                    .style('font-size', '14px')
                    .style('font-weight', 'bold')
                    .text('IPC蛻・｡・);
                
                g.append('text')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '1em')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '12px')
                    .text(`蜈ｨ${root.value}莉ｶ`);
                
                debugLog(`[drawSunburst] Rendered ${root.descendants().length} nodes`);
                
            } catch(e) {
                console.error('Sunburst error:', e);
                container.innerHTML = '<div class="status-err">繧ｵ繝ｳ繝舌・繧ｹ繝医お繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧ｳ繝ｼ繝牙峙・・hord Diagram・峨ｒ謠冗判縺吶ｋ
         * 蜈ｱ蜷悟・鬘倅ｺｺ繧・匱譏手・俣縺ｮ髢｢菫ゅｒ蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・繝槭ヨ繝ｪ繝・け繧ｹ繝・・繧ｿ
         */
        function drawChordDiagram(divId, dataJson) {
            const container = document.getElementById(divId);
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const width = container.clientWidth || 600;
                const height = 550;
                const margin = 100; // 繝ｩ繝吶Ν逕ｨ縺ｮ繝槭・繧ｸ繝ｳ
                const innerRadius = Math.min(width - margin * 2, height - margin * 2) * 0.38;
                const outerRadius = innerRadius + 16;
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${width/2}, ${height/2})`);
                
                const names = data.names;
                const matrix = data.matrix;
                
                // 繧ｳ繝ｼ繝峨Ξ繧､繧｢繧ｦ繝・                const chord = d3.chord()
                    .padAngle(0.05)
                    .sortSubgroups(d3.descending);
                
                const chords = chord(matrix);
                
                // 繧ｫ繝ｩ繝ｼ繧ｹ繧ｱ繝ｼ繝ｫ
                const color = d3.scaleOrdinal()
                    .domain(d3.range(names.length))
                    .range(d3.schemeTableau10);
                
                // 繧｢繝ｼ繧ｯ・亥､門・縺ｮ蜀・ｼｧ・・                const arc = d3.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(outerRadius);
                
                const groups = g.append('g')
                    .selectAll('g')
                    .data(chords.groups)
                    .enter()
                    .append('g');
                
                groups.append('path')
                    .attr('fill', d => color(d.index))
                    .attr('stroke', '#0d1b2a')
                    .attr('d', arc)
                    .attr('opacity', 0)
                    .transition()
                    .duration(600)
                    .delay((d, i) => i * 50)
                    .attr('opacity', 1);
                
                // 繝ｩ繝吶Ν・育洒邵ｮ縺励※陦ｨ遉ｺ・・                const maxLabelLength = 8; // 譛螟ｧ8譁・ｭ励↓蛻ｶ髯・                groups.append('text')
                    .each(d => { d.angle = (d.startAngle + d.endAngle) / 2; })
                    .attr('dy', '0.35em')
                    .attr('transform', d => `
                        rotate(${(d.angle * 180 / Math.PI - 90)})
                        translate(${outerRadius + 6})
                        ${d.angle > Math.PI ? 'rotate(180)' : ''}
                    `)
                    .attr('text-anchor', d => d.angle > Math.PI ? 'end' : 'start')
                    .style('fill', '#e0e1dd')
                    .style('font-size', '9px')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(d => {
                        const name = names[d.index];
                        return name.length > maxLabelLength ? name.slice(0, maxLabelLength) + '窶ｦ' : name;
                    })
                    .style('cursor', 'pointer')
                    .on('mouseover', function(event, d) {
                        // 繝輔Ν繝阪・繝繧偵ヤ繝ｼ繝ｫ繝√ャ繝励〒陦ｨ遉ｺ
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'd3-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '8px 12px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .style('white-space', 'nowrap')
                            .text(names[d.index])
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.selectAll('.d3-tooltip').remove();
                    });
                
                // 繝ｪ繝懊Φ・域磁邯夂ｷ夲ｼ・                const ribbon = d3.ribbon()
                    .radius(innerRadius);
                
                g.append('g')
                    .attr('fill-opacity', 0.7)
                    .selectAll('path')
                    .data(chords)
                    .enter()
                    .append('path')
                    .attr('d', ribbon)
                    .attr('fill', d => color(d.source.index))
                    .attr('stroke', d => d3.rgb(color(d.source.index)).darker())
                    .style('cursor', 'pointer')
                    .attr('opacity', 0)
                    .transition()
                    .duration(800)
                    .delay((d, i) => 300 + i * 20)
                    .attr('opacity', 0.7)
                    .selection()
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 1);
                        
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'd3-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '10px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .html(`<strong>${names[d.source.index]}</strong> 竊・<strong>${names[d.target.index]}</strong><br/>蜈ｱ襍ｷ: ${d.source.value}莉ｶ`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        d3.select(this).attr('opacity', 0.7);
                        d3.selectAll('.d3-tooltip').remove();
                    });
                
                debugLog(`[drawChordDiagram] Rendered ${names.length} nodes, ${chords.length} chords`);
                
            } catch(e) {
                console.error('ChordDiagram error:', e);
                container.innerHTML = '<div class="status-err">繧ｳ繝ｼ繝牙峙繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝輔ｒ謠冗判縺吶ｋ
         * 譎らｳｻ蛻励ョ繝ｼ繧ｿ繧呈ｵ√ｌ繧九ｈ縺・↓蜿ｯ隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・譎らｳｻ蛻励ョ繝ｼ繧ｿ
         */
        function drawStreamgraph(divId, dataJson) {
            const container = document.getElementById(divId);
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const width = container.clientWidth || 800;
                const height = 450;
                const margin = {top: 20, right: 150, bottom: 40, left: 50};
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;
                
                const keys = data.keys;
                const series = data.series;
                
                // 繧ｹ繧ｱ繝ｼ繝ｫ
                const x = d3.scaleLinear()
                    .domain(d3.extent(series, d => d.year))
                    .range([0, innerWidth]);
                
                // 繧ｹ繧ｿ繝・け
                const stack = d3.stack()
                    .keys(keys)
                    .offset(d3.stackOffsetWiggle)
                    .order(d3.stackOrderInsideOut);
                
                const stacked = stack(series);
                
                const y = d3.scaleLinear()
                    .domain([
                        d3.min(stacked, layer => d3.min(layer, d => d[0])),
                        d3.max(stacked, layer => d3.max(layer, d => d[1]))
                    ])
                    .range([innerHeight, 0]);
                
                const color = d3.scaleOrdinal()
                    .domain(keys)
                    .range(d3.schemeTableau10);
                
                // 繧ｨ繝ｪ繧｢逕滓・蝎ｨ
                const area = d3.area()
                    .curve(d3.curveBasis)
                    .x(d => x(d.data.year))
                    .y0(d => y(d[0]))
                    .y1(d => y(d[1]));
                
                // 繧ｹ繝医Μ繝ｼ繝謠冗判
                g.selectAll('path')
                    .data(stacked)
                    .enter()
                    .append('path')
                    .attr('fill', d => color(d.key))
                    .attr('stroke', '#0d1b2a')
                    .attr('stroke-width', 0.5)
                    .style('cursor', 'pointer')
                    .attr('d', area)
                    .attr('opacity', 0)
                    .on('mouseover', function(event, d) {
                        d3.select(this).attr('opacity', 1);
                        g.selectAll('path').filter(p => p !== d).attr('opacity', 0.3);
                        
                        const tooltip = d3.select('body').append('div')
                            .attr('class', 'd3-tooltip')
                            .style('position', 'absolute')
                            .style('background', 'rgba(13, 27, 42, 0.95)')
                            .style('border', '1px solid #4fc3f7')
                            .style('border-radius', '6px')
                            .style('padding', '10px')
                            .style('color', '#e0e1dd')
                            .style('font-size', '12px')
                            .style('pointer-events', 'none')
                            .style('z-index', '9999')
                            .html(`<strong>${d.key}</strong>`)
                            .style('left', (event.pageX + 15) + 'px')
                            .style('top', (event.pageY - 10) + 'px');
                    })
                    .on('mouseout', function() {
                        g.selectAll('path').attr('opacity', 0.85);
                        d3.selectAll('.d3-tooltip').remove();
                    })
                    .transition()
                    .duration(1000)
                    .delay((d, i) => i * 100)
                    .attr('opacity', 0.85);
                
                // X霆ｸ
                g.append('g')
                    .attr('transform', `translate(0, ${innerHeight})`)
                    .call(d3.axisBottom(x).tickFormat(d3.format('d')).ticks(10))
                    .selectAll('text, line, path')
                    .style('stroke', '#666')
                    .style('fill', '#888');
                
                // 蜃｡萓・                const legend = svg.append('g')
                    .attr('transform', `translate(${width - margin.right + 10}, 30)`);
                
                keys.forEach((key, i) => {
                    const lg = legend.append('g')
                        .attr('transform', `translate(0, ${i * 22})`);
                    
                    lg.append('rect')
                        .attr('width', 14)
                        .attr('height', 14)
                        .attr('fill', color(key))
                        .attr('rx', 2);
                    
                    lg.append('text')
                        .attr('x', 20)
                        .attr('y', 11)
                        .style('fill', '#e0e1dd')
                        .style('font-size', '11px')
                        .style('font-family', 'Meiryo, sans-serif')
                        .text(key.length > 12 ? key.slice(0, 12) + '窶ｦ' : key);
                });
                
                debugLog(`[drawStreamgraph] Rendered ${keys.length} streams`);
                
            } catch(e) {
                console.error('Streamgraph error:', e);
                container.innerHTML = '<div class="status-err">繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝輔お繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        /**
         * 繝・Φ繝峨Ο繧ｰ繝ｩ繝・域ｨｹ蠖｢蝗ｳ・峨ｒ謠冗判縺吶ｋ
         * 髫主ｱ､逧・け繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ邨先棡繧貞庄隕門喧
         * @param {string} divId - 謠冗判蜈医・div隕∫ｴID
         * @param {string} dataJson - JSON蠖｢蠑上・髫主ｱ､繝・・繧ｿ
         */
        function drawDendrogram(divId, dataJson) {
            const container = document.getElementById(divId);
            if (!container) return;
            
            try {
                const data = JSON.parse(dataJson);
                container.innerHTML = '';
                
                const width = container.clientWidth || 800;
                const height = 500;
                const margin = {top: 20, right: 150, bottom: 20, left: 50};
                
                const svg = d3.select('#' + divId)
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .style('background', '#0d1b2a');
                
                const g = svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`);
                
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;
                
                // 髫主ｱ､繝・・繧ｿ菴懈・
                const root = d3.hierarchy(data);
                
                // 繧ｯ繝ｩ繧ｹ繧ｿ繝ｼ繝ｬ繧､繧｢繧ｦ繝・                const cluster = d3.cluster()
                    .size([innerHeight, innerWidth - 100]);
                
                cluster(root);
                
                // 繝ｪ繝ｳ繧ｯ・医お繝ｫ繝懊・謗･邯夲ｼ・                const link = g.selectAll('.link')
                    .data(root.links())
                    .enter()
                    .append('path')
                    .attr('class', 'link')
                    .attr('fill', 'none')
                    .attr('stroke', '#4fc3f7')
                    .attr('stroke-opacity', 0.5)
                    .attr('stroke-width', 1.5)
                    .attr('d', d => `
                        M${d.source.y},${d.source.x}
                        H${(d.source.y + d.target.y) / 2}
                        V${d.target.x}
                        H${d.target.y}
                    `);
                
                // 繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ
                const totalLength = link.node().getTotalLength();
                link.attr('stroke-dasharray', totalLength)
                    .attr('stroke-dashoffset', totalLength)
                    .transition()
                    .duration(1500)
                    .delay((d, i) => i * 20)
                    .attr('stroke-dashoffset', 0);
                
                // 繝弱・繝・                const node = g.selectAll('.node')
                    .data(root.descendants())
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y}, ${d.x})`);
                
                node.append('circle')
                    .attr('r', 4)
                    .attr('fill', d => d.children ? '#4fc3f7' : '#e91e63')
                    .attr('stroke', '#0d1b2a')
                    .attr('stroke-width', 1)
                    .attr('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => 800 + i * 30)
                    .attr('opacity', 1);
                
                // 繝ｩ繝吶Ν・医Μ繝ｼ繝輔ヮ繝ｼ繝峨・縺ｿ・・                node.filter(d => !d.children)
                    .append('text')
                    .attr('dy', '0.35em')
                    .attr('x', 10)
                    .style('fill', '#e0e1dd')
                    .style('font-size', '11px')
                    .style('font-family', 'Meiryo, sans-serif')
                    .text(d => d.data.name.length > 20 ? d.data.name.slice(0, 20) + '窶ｦ' : d.data.name)
                    .attr('opacity', 0)
                    .transition()
                    .duration(500)
                    .delay((d, i) => 1200 + i * 30)
                    .attr('opacity', 1);
                
                debugLog(`[drawDendrogram] Rendered ${root.descendants().length} nodes`);
                
            } catch(e) {
                console.error('Dendrogram error:', e);
                container.innerHTML = '<div class="status-err">繝・Φ繝峨Ο繧ｰ繝ｩ繝繧ｨ繝ｩ繝ｼ: ' + e.message + '</div>';
            }
        }
        
        // 繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ菫晏ｭ俶ｩ溯・
        window.snapshotList = [];
        
        /**
         * 繝√Ε繝ｼ繝医・繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ倥☆繧・         * Plotly.js繝√Ε繝ｼ繝医→SVG・医Ρ繝ｼ繝峨け繝ｩ繧ｦ繝会ｼ峨・荳｡譁ｹ縺ｫ蟇ｾ蠢・         * @param {string} chartId - 繝√Ε繝ｼ繝郁ｦ∫ｴ縺ｮID
         * @param {string} chartName - 菫晏ｭ伜錐
         */
        function saveSnapshot(chartId, chartName) {
            const chartDiv = document.getElementById(chartId);
            if (!chartDiv) {
                alert('菫晏ｭ倥☆繧九メ繝｣繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ');
                return;
            }
            
            // Plotly.js繝√Ε繝ｼ繝医・蝣ｴ蜷・            if (chartDiv.querySelector('.plotly')) {
                Plotly.toImage(chartDiv, {format: 'png', width: 1200, height: 800})
                    .then(dataUrl => {
                        addSnapshotToGallery(chartName, dataUrl);
                    })
                    .catch(err => {
                        console.error('Snapshot error:', err);
                        alert('繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆');
                    });
                return;
            }
            
            // SVG・医Ρ繝ｼ繝峨け繝ｩ繧ｦ繝臥ｭ会ｼ峨・蝣ｴ蜷・            const svg = chartDiv.querySelector('svg');
            if (svg) {
                try {
                    // SVG繧偵す繝ｪ繧｢繝ｩ繧､繧ｺ
                    const serializer = new XMLSerializer();
                    const svgStr = serializer.serializeToString(svg);
                    const svgBlob = new Blob([svgStr], {type: 'image/svg+xml;charset=utf-8'});
                    
                    // Canvas縺ｫ謠冗判縺励※PNG縺ｫ螟画鋤
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width || 1200;
                        canvas.height = img.height || 800;
                        
                        // 閭梧勹繧呈緒逕ｻ
                        ctx.fillStyle = '#0d1b2a';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        const dataUrl = canvas.toDataURL('image/png');
                        addSnapshotToGallery(chartName, dataUrl);
                        URL.revokeObjectURL(img.src);
                    };
                    
                    img.onerror = function() {
                        console.error('SVG to PNG conversion failed');
                        alert('繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆');
                    };
                    
                    img.src = URL.createObjectURL(svgBlob);
                } catch(e) {
                    console.error('SVG snapshot error:', e);
                    alert('繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ菫晏ｭ倥↓螟ｱ謨励＠縺ｾ縺励◆');
                }
                return;
            }
            
            alert('菫晏ｭ倥☆繧九メ繝｣繝ｼ繝医′縺ゅｊ縺ｾ縺帙ｓ');
        }
        
        /**
         * 繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧偵ぐ繝｣繝ｩ繝ｪ繝ｼ縺ｫ霑ｽ蜉
         * @param {string} chartName - 繝√Ε繝ｼ繝亥錐
         * @param {string} dataUrl - 逕ｻ蜒上・Data URL
         */
        function addSnapshotToGallery(chartName, dataUrl) {
            const timestamp = new Date().toLocaleString('ja-JP');
            const snapshot = {
                id: Date.now(),
                name: chartName,
                timestamp: timestamp,
                dataUrl: dataUrl
            };
            window.snapshotList.push(snapshot);
            updateSnapshotGallery();
            alert(`笨・繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ繧剃ｿ晏ｭ倥＠縺ｾ縺励◆: ${chartName}`);
        }
        
        function updateSnapshotGallery() {
            const gallery = document.getElementById('snapshot-gallery');
            if (!gallery) return;
            
            if (window.snapshotList.length === 0) {
                gallery.innerHTML = '<p style="color: #888;">菫晏ｭ倥＆繧後◆繧ｹ繝翫ャ繝励す繝ｧ繝・ヨ縺ｯ縺ゅｊ縺ｾ縺帙ｓ</p>';
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">';
            window.snapshotList.forEach((snap, idx) => {
                html += `
                    <div class="snapshot-item" style="background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 8px;">
                        <img src="${snap.dataUrl}" style="width: 100%; border-radius: 4px; cursor: pointer;" onclick="downloadSnapshot(${snap.id})">
                        <div style="margin-top: 0.3rem; font-size: 0.8rem;">
                            <div style="font-weight: bold;">${snap.name}</div>
                            <div style="color: #888;">${snap.timestamp}</div>
                            <button class="btn btn-small" onclick="downloadSnapshot(${snap.id})" style="margin-top: 0.3rem; font-size: 0.75rem; padding: 0.2rem 0.5rem;">繝繧ｦ繝ｳ繝ｭ繝ｼ繝・/button>
                            <button class="btn btn-small btn-danger" onclick="deleteSnapshot(${snap.id})" style="margin-top: 0.3rem; font-size: 0.75rem; padding: 0.2rem 0.5rem;">蜑企勁</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            gallery.innerHTML = html;
        }
        
        function downloadSnapshot(id) {
            const snap = window.snapshotList.find(s => s.id === id);
            if (!snap) return;
            
            const link = document.createElement('a');
            link.href = snap.dataUrl;
            link.download = `ARTEMIS_${snap.name}_${new Date().toISOString().slice(0,10)}.png`;
            link.click();
        }
        
        function deleteSnapshot(id) {
            window.snapshotList = window.snapshotList.filter(s => s.id !== id);
            updateSnapshotGallery();
        }
        
        function updateProgress(pct) {
            document.getElementById('launch-progress-fill').style.width = pct + '%';
        }

        bindAtlasInputs();
        setTimeout(requestHeavyPackages, 500);
        setPyReady(false);
        setupQuickFileParse();
        ensureAtlasStatusVisible();
        syncAtlasStatusCheckbox();
        syncAtlasControls();
        setTimeout(() => {
            const overlay = document.getElementById('init-overlay');
            if (overlay) overlay.style.display = 'none';
        }, 1200);

        const launchBtn = document.getElementById('btn-launch');
        if (launchBtn) {
            launchBtn.addEventListener('click', () => {
                if (!window.__pyReady) {
                    window.__pendingLaunch = true;
                    const status = document.getElementById('launch-status');
                    if (status) status.innerHTML = '<div class="status-warn">Python襍ｷ蜍穂ｸｭ縺ｧ縺吶りｵｷ蜍募ｾ後↓閾ｪ蜍輔〒蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧帝幕蟋九＠縺ｾ縺吶・/div>';
                }
            });
        }

        const atlasBtn = document.getElementById('btn-atlas');
        if (atlasBtn) {
            atlasBtn.addEventListener('click', () => {
                if (!window.__pyReady) {
                    quickDrawAtlas();
                }
            });
        }

        const statusToggle = document.getElementById('use-status-breakdown');
        if (statusToggle) {
            statusToggle.addEventListener('change', () => {
                if (window.appState && window.appState.statusBreakdownByType) {
                    window.appState.statusBreakdownByType[window.appState.chartType] = statusToggle.checked;
                }
                if (!window.__pyReady) {
                    quickDrawAtlas();
                    return;
                }
                const btn = document.getElementById('btn-atlas');
                if (btn) btn.click();
            });
        }

        const corePhaseSel = document.getElementById('core-phase');
        if (corePhaseSel) {
            corePhaseSel.addEventListener('change', syncCorePhase);
            syncCorePhase();
        }
        const coreAxisMode = document.getElementById('core-axis-mode');
        if (coreAxisMode) {
            coreAxisMode.addEventListener('change', syncCoreAxisMode);
            syncCoreAxisMode();
        }
    </script>

    <script type="py" config='{"packages": ["pandas", "numpy"]}'>
"""
================================================================================
ARTEMIS - Python蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ
================================================================================

讎りｦ・
    PyScript (Pyodide WebAssembly繝ｩ繝ｳ繧ｿ繧､繝) 縺ｧ繝悶Λ繧ｦ繧ｶ荳翫〒螳溯｡後＆繧後ｋ
    迚ｹ險ｱ蛻・梵縺ｮ繧ｳ繧｢繝ｭ繧ｸ繝・け縲・
繧｢繝ｼ繧ｭ繝・け繝√Ε:
    - 繧ｳ繧｢繝代ャ繧ｱ繝ｼ繧ｸ (pandas, numpy) 縺ｯ蜊ｳ蠎ｧ縺ｫ隱ｭ縺ｿ霎ｼ縺ｿ
    - 驥埼㍼繝代ャ繧ｱ繝ｼ繧ｸ (scikit-learn, networkx) 縺ｯ髱槫酔譛溘〒隱ｭ縺ｿ霎ｼ縺ｿ
    - 蜈ｨ縺ｦ縺ｮ蜿ｯ隕門喧縺ｯJavaScript騾｣謳ｺ縺ｧPlotly.js繧剃ｽｿ逕ｨ

繝｢繧ｸ繝･繝ｼ繝ｫ:
    - ATLAS: 邨ｱ險医メ繝｣繝ｼ繝・(繝医Ξ繝ｳ繝峨∝・縲∵｣偵√ヤ繝ｪ繝ｼ繝槭ャ繝礼ｭ・
    - CORE: 繝ｫ繝ｼ繝ｫ繝吶・繧ｹ蛻・｡槭お繝ｳ繧ｸ繝ｳ (AND/OR/NEAR/ADJ貍皮ｮ怜ｭ仙ｯｾ蠢・
    - Saturn V: TF-IDF + PCA/t-SNE繝ｩ繝ｳ繝峨せ繧ｱ繝ｼ繝怜庄隕門喧
    - Explorer: 繧ｭ繝ｼ繝ｯ繝ｼ繝牙・譫舌→蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ
    - CREW: 逋ｺ譏手・蜃ｺ鬘倅ｺｺ繝阪ャ繝医Ρ繝ｼ繧ｯ蛻・梵
    - MEGA: 繝・く繧ｹ繝亥・譫・(繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝峨¨-gram縲ゝF-IDF)

繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚:
    g_df: CSV縺九ｉ隱ｭ縺ｿ霎ｼ繧薙□逕溘・DataFrame
    g_df_processed: 繝輔ぅ繝ｼ繝ｫ繝芽ｧ｣譫先ｸ医∩縺ｮDataFrame
    g_col_map: 繧ｫ繝ｩ繝繝槭ャ繝斐Φ繧ｰ險ｭ螳・    g_core_rules: CORE蛻・｡槭Ν繝ｼ繝ｫ

================================================================================
"""

# Pyodide縺ｮ譌｢遏･縺ｮ隴ｦ蜻翫ｒ謚大宛
import warnings
warnings.filterwarnings('ignore', message='libc not found')
warnings.filterwarnings('ignore', category=RuntimeWarning)

# ============================================================
# 讓呎ｺ悶Λ繧､繝悶Λ繝ｪ繧､繝ｳ繝昴・繝・# ============================================================
import re
import json
import unicodedata
from collections import Counter

# ============================================================
# 繝・・繧ｿ蜃ｦ逅・Λ繧､繝悶Λ繝ｪ
# ============================================================
import pandas as pd
import numpy as np

# ============================================================
# PyScript/Pyodide騾｣謳ｺ
# ============================================================
from js import document, console, window, drawChart, updateProgress
from pyodide.ffi import create_proxy
import asyncio


# ============================================================
# 驕・ｻｶ隱ｭ縺ｿ霎ｼ縺ｿ縺ｮ驥埼㍼繝代ャ繧ｱ繝ｼ繧ｸ (scikit-learn, networkx)
# ============================================================

# micropip邨檎罰縺ｧ髱槫酔譛溘↓隱ｭ縺ｿ霎ｼ縺ｾ繧後ｋ縺溘ａ縲∝・譛溷､縺ｯNone
TfidfVectorizer = None
PCA = None
TruncatedSVD = None
TSNE = None
KMeans = None
cosine_similarity = None
euclidean_distances = None
nx = None  # networkx


async def load_heavy_packages():
    """
    scikit-learn縺ｨnetworkx繧知icropip邨檎罰縺ｧ髱槫酔譛溘↓隱ｭ縺ｿ霎ｼ繧縲・    
    縺薙ｌ繧峨・繝代ャ繧ｱ繝ｼ繧ｸ縺ｯ蛻晏屓繝舌Φ繝峨Ν縺ｫ蜷ｫ繧√ｋ縺ｫ縺ｯ螟ｧ縺阪☆縺弱ｋ縺溘ａ縲・    蝓ｺ譛ｬUI縺梧ｺ門ｙ縺ｧ縺阪◆蠕後↓繝舌ャ繧ｯ繧ｰ繝ｩ繧ｦ繝ｳ繝峨〒隱ｭ縺ｿ霎ｼ繧縲・    
    Returns:
        bool: 謌仙粥縺励◆蝣ｴ蜷医・True縲√◎繧御ｻ･螟悶・False
    """
    import micropip
    
    try:
        # 騾ｲ謐誘I繧呈峩譁ｰ
        window.updateHeavyProgress('scikit-learn 繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ...', 
            {'scikit-learn': '繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ...', 'networkx': '蠕・ｩ・})
        window.updateModuleProgress('core', 'scikit-learn 繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ', None)
        debugLog('[Heavy-Py] Installing scikit-learn...')
        
        await micropip.install('scikit-learn')
        debugLog('[Heavy-Py] scikit-learn installed')
        
        window.updateHeavyProgress('networkx 繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ...', 
            {'scikit-learn': '螳御ｺ・笨・, 'networkx': '繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ...'})
        window.updateModuleProgress('core', 'networkx 繝繧ｦ繝ｳ繝ｭ繝ｼ繝我ｸｭ', None)
        debugLog('[Heavy-Py] Installing networkx...')
        
        await micropip.install('networkx')
        debugLog('[Heavy-Py] networkx installed')
        
        # 繧ｰ繝ｭ繝ｼ繝舌Ν蜿ら・繧貞・譛溷喧
        global TfidfVectorizer, PCA, TruncatedSVD, TSNE, KMeans
        global cosine_similarity, euclidean_distances, nx
        
        from sklearn.feature_extraction.text import TfidfVectorizer as _TfidfVectorizer
        from sklearn.decomposition import PCA as _PCA, TruncatedSVD as _TruncatedSVD
        from sklearn.manifold import TSNE as _TSNE
        from sklearn.cluster import KMeans as _KMeans
        from sklearn.metrics.pairwise import (
            cosine_similarity as _cosine_similarity,
            euclidean_distances as _euclidean_distances
        )
        import networkx as _nx
        
        TfidfVectorizer = _TfidfVectorizer
        PCA = _PCA
        TruncatedSVD = _TruncatedSVD
        TSNE = _TSNE
        KMeans = _KMeans
        cosine_similarity = _cosine_similarity
        euclidean_distances = _euclidean_distances
        nx = _nx
        
        debugLog('[Heavy-Py] All heavy packages initialized')
        window.updateHeavyProgress('螳御ｺ・, {'scikit-learn': '螳御ｺ・笨・, 'networkx': '螳御ｺ・笨・})
        window.setHeavyReady(True)
        
        return True
        
    except Exception as e:
        console.error(f'[Heavy-Py] Error loading packages: {e}')
        window.updateHeavyProgress('隱ｭ縺ｿ霎ｼ縺ｿ螟ｱ謨・, {'scikit-learn': '繧ｨ繝ｩ繝ｼ', 'networkx': '繧ｨ繝ｩ繝ｼ'})
        window.updateModuleProgress('core', f'繧ｨ繝ｩ繝ｼ: {str(e)[:50]}', 0)
        return False


def start_heavy_load():
    """JavaScript縺九ｉ髱槫酔譛溘ヱ繝・こ繝ｼ繧ｸ隱ｭ縺ｿ霎ｼ縺ｿ繧偵ヨ繝ｪ繧ｬ繝ｼ縺吶ｋ繧ｨ繝ｳ繝医Μ繝昴う繝ｳ繝医・""
    debugLog('[Heavy-Py] start_heavy_load called')
    asyncio.ensure_future(load_heavy_packages())


# JavaScript繧｢繧ｯ繧ｻ繧ｹ逕ｨ縺ｫ髢｢謨ｰ繧堤匳骭ｲ
window.pyLoadHeavyPackages = create_proxy(start_heavy_load)


# ============================================================
# 繧ｫ繝ｩ繝ｼ繝代Ξ繝・ヨ
# ============================================================

# 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ繝√Ε繝ｼ繝育畑縺ｮ繝代せ繝・Ν繝代Ξ繝・ヨ
PASTEL_PALETTE = [
    "#AEC6CF",  # 繝代せ繝・Ν繝悶Ν繝ｼ
    "#779ECB",  # 豼・＞繝代せ繝・Ν繝悶Ν繝ｼ
    "#B39EB5",  # 繝代せ繝・Ν繝代・繝励Ν
    "#FFB7B2",  # 繝代せ繝・Ν繝ｬ繝・ラ (繧ｽ繝輔ヨ)
    "#CFCFC4",  # 繝代せ繝・Ν繧ｰ繝ｬ繝ｼ
    "#B0E0E6",  # 繝代え繝繝ｼ繝悶Ν繝ｼ
    "#FFDAC1",  # 繝代せ繝・Ν繝斐・繝・    "#E2F0CB",  # 繝代せ繝・Ν繧ｰ繝ｪ繝ｼ繝ｳ
    "#FDFD96",  # 繝代せ繝・Ν繧､繧ｨ繝ｭ繝ｼ
    "#FF6961",  # 繝代せ繝・Ν繝ｬ繝・ラ (豼・＞)
]

# 繝√Ε繝ｼ繝育畑縺ｮ繝｡繧､繝ｳ繧ｫ繝ｩ繝ｼ繧ｷ繝ｼ繧ｱ繝ｳ繧ｹ
COLOR_SEQUENCE = [
    "#4fc3f7",  # Cyan
    "#81c784",  # Green
    "#ffb74d",  # Orange
    "#ce93d8",  # Purple
    "#ef5350",  # Red
    "#26a69a",  # Teal
    "#ffa726",  # Amber
    "#42a5f5",  # Blue
    "#ab47bc",  # Deep Purple
    "#ec407a",  # Pink
    "#7e57c2",  # Violet
    "#5c6bc0",  # Indigo
    "#29b6f6",  # Light Blue
    "#26c6da",  # Cyan Light
    "#66bb6a",  # Light Green
]


# ============================================================
# 譌･譛ｬ隱槭せ繝医ャ繝励Ρ繝ｼ繝・# ============================================================

STOPWORDS = frozenset({
    # Japanese common words
    '蜑崎ｨ・, '荳願ｨ・, '譛ｬ逋ｺ譏・, '螳滓命蠖｢諷・, '譁ｹ豕・, '陬・ｽｮ', '謇区ｮｵ', '縺薙ｌ', '縺昴ｌ', '縺溘ａ', '縺薙→',
    '蝣ｴ蜷・, '遲・, '繧ゅ・', '逋ｺ譏・, '謚陦・, '讒区・', '譛ｬ螳滓命', '荳螳滓命', '隍・焚', '謇螳・, '迚ｹ螳・,
    # English common words
    'the', 'a', 'an', 'and', 'or', 'of', 'to', 'in', 'for', 'with', 'on', 'is', 'are', 'be',
    # Japanese functional words
    '縺吶ｋ', '縺輔ｌ繧・, '縺ｧ縺阪ｋ', '縺ｪ繧・, '縺ゅｋ', '縺・ｋ', '縺ｫ縺､縺・※', '縺ｫ縺翫￠繧・, '縺ｨ縺励※', '縺ｫ繧医▲縺ｦ',
    '縺ｫ蟇ｾ縺励※', '縺翫ｈ縺ｳ', '縺ｪ繧峨・縺ｫ', '縺ｾ縺溘・', '縺九▽', '繧ゅ＠縺上・', '縺薙ｌ繧・, '縺昴ｌ繧・, '蠖楢ｩｲ', '隧ｲ',
})


# ============================================================
# 繝ｦ繝ｼ繝・ぅ繝ｪ繝・ぅ髢｢謨ｰ
# ============================================================

def ensure_sklearn() -> bool:
    """
    scikit-learn縺瑚ｪｭ縺ｿ霎ｼ縺ｿ貂医∩縺ｧ蛻ｩ逕ｨ蜿ｯ閭ｽ縺狗｢ｺ隱阪☆繧九・    
    Returns:
        scikit-learn縺梧ｺ門ｙ螳御ｺ・↑繧欝rue縲√◎繧御ｻ･螟悶・False
    """
    global TfidfVectorizer, PCA, TruncatedSVD, TSNE, KMeans
    global cosine_similarity, euclidean_distances
    
    if TfidfVectorizer is not None:
        return True
    
    try:
        from sklearn.feature_extraction.text import TfidfVectorizer as _TF
        from sklearn.decomposition import PCA as _PCA, TruncatedSVD as _SVD
        from sklearn.manifold import TSNE as _TSNE
        from sklearn.cluster import KMeans as _KMeans
        from sklearn.metrics.pairwise import cosine_similarity as _cos, euclidean_distances as _euc
        
        TfidfVectorizer = _TF
        PCA = _PCA
        TruncatedSVD = _SVD
        TSNE = _TSNE
        KMeans = _KMeans
        cosine_similarity = _cos
        euclidean_distances = _euc
        return True
    except Exception:
        try:
            import js
            js.window.requestHeavyPackages()
        except Exception:
            pass
        return False


def ensure_networkx() -> bool:
    """
    networkx縺瑚ｪｭ縺ｿ霎ｼ縺ｿ貂医∩縺ｧ蛻ｩ逕ｨ蜿ｯ閭ｽ縺狗｢ｺ隱阪☆繧九・    
    Returns:
        networkx縺梧ｺ門ｙ螳御ｺ・↑繧欝rue縲√◎繧御ｻ･螟悶・False
    """
    global nx
    
    if nx is not None:
        return True
    
    try:
        import networkx as _nx
        nx = _nx
        return True
    except Exception:
        try:
            import js
            js.window.requestHeavyPackages()
        except Exception:
            pass
        return False


def tokenize(text: str) -> list[str]:
    """
    譌･譛ｬ隱・闍ｱ隱槭ユ繧ｭ繧ｹ繝医ｒ蛻・梵逕ｨ縺ｫ繝医・繧ｯ繝ｳ蛹悶☆繧九・    
    Args:
        text: 蜈･蜉帙ユ繧ｭ繧ｹ繝域枚蟄怜・
        
    Returns:
        繝医・繧ｯ繝ｳ譁・ｭ怜・縺ｮ繝ｪ繧ｹ繝・    """
    if not isinstance(text, str):
        return []
    
    # Normalize unicode
    text = unicodedata.normalize('NFKC', text).lower()
    
    # Remove punctuation and numbers
    text = re.sub(r'[!"#$%&\'()*+,-./:;<=>?@\[\]^_`{|}~縲舌代後阪弱擾ｼ茨ｼ噂d]', ' ', text)
    
    # Extract Japanese and English tokens
    jp_tokens = re.findall(r'[荳-鮴･繧｡-繝ｴ繝ｼ]{2,8}', text)
    en_tokens = re.findall(r'[a-z]{3,}', text)
    
    return [w for w in jp_tokens + en_tokens if w not in STOPWORDS and len(w) >= 2]


def tokenize_text(text: str) -> str:
    """繝・く繧ｹ繝医ｒ繝医・繧ｯ繝ｳ蛹悶＠縺ｦ繧ｹ繝壹・繧ｹ蛹ｺ蛻・ｊ譁・ｭ怜・縺ｧ霑斐☆縲・""
    return ' '.join(tokenize(text))


def parse_date(series: pd.Series) -> pd.Series:
    """
    隍・焚繝輔か繝ｼ繝槭ャ繝亥ｯｾ蠢懊〒譌･莉倥き繝ｩ繝繧定ｧ｣譫舌☆繧九・    
    Args:
        series: 譌･莉伜､繧貞性繧pandas Series
        
    Returns:
        隗｣譫舌＆繧後◆datetime蛟､縺ｮpandas Series
    """
    # Try ISO format first
    parsed = pd.to_datetime(series, errors='coerce')
    if parsed.notna().mean() > 0.5:
        return parsed
    
    # Try YYYYMMDD format
    parsed = pd.to_datetime(series, format='%Y%m%d', errors='coerce')
    if parsed.notna().mean() > 0.5:
        return parsed
    
    # Fall back to year-only
    return pd.to_datetime(series, format='%Y', errors='coerce')


def extract_ipc(text: str) -> list[str]:
    """
    繝・く繧ｹ繝医°繧迂PC繧ｳ繝ｼ繝峨ｒ謚ｽ蜃ｺ縺吶ｋ縲・    
    Args:
        text: IPC繧ｳ繝ｼ繝峨ｒ蜷ｫ繧繝・く繧ｹ繝・        
    Returns:
        隕九▽縺九▲縺溘Θ繝九・繧ｯ縺ｪIPC繧ｳ繝ｼ繝峨・繝ｪ繧ｹ繝・    """
    if not isinstance(text, str):
        return []
    text = unicodedata.normalize('NFKC', text).upper()
    return list(set(re.findall(r'[A-H]\d{2}[A-Z]', text)))


def parse_ipc_atlas(ipc: str, level: int) -> str:
    """
    IPC繧ｳ繝ｼ繝峨ｒ謖・ｮ壹＆繧後◆髫主ｱ､繝ｬ繝吶Ν縺ｫ隗｣譫舌☆繧九・    
    Args:
        ipc: IPC繧ｳ繝ｼ繝画枚蟄怜・
        level: 1=繧ｯ繝ｩ繧ｹ縲・=繧ｵ繝悶け繝ｩ繧ｹ+繧ｰ繝ｫ繝ｼ繝・        
    Returns:
        謖・ｮ壹Ξ繝吶Ν縺ｧ隗｣譫舌＆繧後◆IPC繧ｳ繝ｼ繝・    """
    if not isinstance(ipc, str):
        return ""
    
    ipc = ipc.strip().upper()
    
    if level == 1:
        return ipc[:4]
    elif level == 2:
        match = re.match(r'([A-H][0-9]{2}[A-Z]\s*[0-9]+)', ipc)
        return f"{match.group(1).strip()}/00" if match else ipc
    
    return ipc


def truncate_applicant_name(name: str, max_len: int = 25) -> str:
    """
    髟ｷ縺・・鬘倅ｺｺ蜷阪ｒ陦ｨ遉ｺ逕ｨ縺ｫ蛻・ｊ隧ｰ繧√ｋ縲・    
    Args:
        name: 蜃ｺ鬘倅ｺｺ蜷肴枚蟄怜・
        max_len: 譛螟ｧ陦ｨ遉ｺ髟ｷ
        
    Returns:
        蠢・ｦ√↓蠢懊§縺ｦ逵∫払險伜捷莉倥″縺ｧ蛻・ｊ隧ｰ繧√ｉ繧後◆蜷榊燕
    """
    if not isinstance(name, str):
        return str(name)
    
    name = name.strip()
    if len(name) <= max_len:
        return name
    
    return name[:max_len - 1] + '窶ｦ'


def create_treemap_data(df: pd.DataFrame, mode: str = "ipc") -> pd.DataFrame:
    """
    繝・Μ繝ｼ繝槭ャ繝怜庄隕門喧逕ｨ縺ｮ髫主ｱ､繝・・繧ｿ繧剃ｽ懈・縺吶ｋ縲・    
    Args:
        df: ipc_list縺ｾ縺溘・applicant_list繧ｫ繝ｩ繝繧呈戟縺､DataFrame
        mode: 'ipc'縺ｾ縺溘・'applicant'
        
    Returns:
        Plotly繝・Μ繝ｼ繝槭ャ繝礼畑縺ｮDataFrame
    """
    if mode == "ipc":
        df_exploded = df['ipc_list'].explode().dropna().astype(str).str.upper()
        data = []
        for ipc in df_exploded:
            if len(ipc) >= 4:
                section = ipc[0]
                ipc_class = ipc[:3]
                subclass = ipc[:4]
                data.append([section, ipc_class, subclass])
        df_tree = pd.DataFrame(data, columns=['Section', 'Class', 'Subclass'])
        if df_tree.empty:
            return df_tree
        df_tree['count'] = 1
        return df_tree
    elif mode == "applicant":
        df_exploded = df['applicant_list'].explode().dropna()
        df_tree = df_exploded.value_counts().reset_index()
        df_tree.columns = ['Applicant', 'count']
        df_tree = df_tree.head(50)
        df_tree['Root'] = 'Total'
        return df_tree
    return pd.DataFrame()

def split_list(text: str, delim: str = ';') -> list[str]:
    """繝・く繧ｹ繝医ｒ蛹ｺ蛻・ｊ譁・ｭ励〒蛻・牡縺励※繝ｪ繧ｹ繝医↓縺吶ｋ縲・""
    if not isinstance(text, str) or pd.isna(text): return []
    for d in [';', '・・, ',', '縲・, '|', '\n']:
        if d in text:
            return [s.strip() for s in text.split(d) if s.strip()]
    return [text.strip()] if text.strip() else []

def normalize_status(value: str | None) -> str:
    """繧ｹ繝・・繧ｿ繧ｹ蛟､繧呈ｭ｣隕丞喧縺吶ｋ縲・""
    if value is None or (isinstance(value, float) and pd.isna(value)):
        return '譛ｪ險ｭ螳・
    if isinstance(value, str):
        parts = split_list(value)
        return parts[0] if parts else '譛ｪ險ｭ螳・
    text = str(value).strip()
    return text if text else '譛ｪ險ｭ螳・


# ============================================================
# 繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ迥ｶ諷狗ｮ｡逅・け繝ｩ繧ｹ
# ============================================================

class AppState:
    """
    繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ蜈ｨ菴薙・迥ｶ諷九ｒ邂｡逅・☆繧九す繝ｳ繧ｰ繝ｫ繝医Φ繧ｯ繝ｩ繧ｹ縲・    
    繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚繧貞錐蜑咲ｩｺ髢灘・縺ｫ繧ｫ繝励そ繝ｫ蛹悶＠縲・    迥ｶ諷狗ｮ｡逅・ｒ荳蜈・喧縺吶ｋ縲・    """
    
    # 繝・・繧ｿ髢｢騾｣
    df: pd.DataFrame = None                # CSV繧､繝ｳ繝昴・繝医°繧峨・逕溘・DataFrame
    df_processed: pd.DataFrame = None      # 繝輔ぅ繝ｼ繝ｫ繝芽ｧ｣譫先ｸ医∩縺ｮDataFrame
    col_map: dict = {}                     # 繧ｫ繝ｩ繝繝槭ャ繝斐Φ繧ｰ險ｭ螳・    
    # TF-IDF髢｢騾｣
    tfidf_matrix = None                    # TF-IDF陦悟・ (繧ｹ繝代・繧ｹ)
    vectorizer = None                      # TfidfVectorizer繧､繝ｳ繧ｹ繧ｿ繝ｳ繧ｹ
    feature_names: list = []               # 隱槫ｽ吶Μ繧ｹ繝・    
    # 繧ｹ繝・・繧ｿ繧ｹ髢｢騾｣
    status_colors: dict = {}               # {繧ｹ繝・・繧ｿ繧ｹ蜷・ 16騾ｲ謨ｰ濶ｲ}
    status_order: list = []                # 繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝・ざ繝ｪ縺ｮ鬆・ｺ・    
    # PyScript繝励Ο繧ｭ繧ｷ (GC髦ｲ豁｢)
    proxies: list = []
    
    # CORE蛻・｡槭Δ繧ｸ繝･繝ｼ繝ｫ
    core_rules: dict = {}                  # {霆ｸ蜷・ [繝ｫ繝ｼ繝ｫ]}
    core_df_classified: pd.DataFrame = None
    core_reanalyze_prompt: str = ""
    
    @classmethod
    def reset(cls):
        """蜈ｨ迥ｶ諷九ｒ繝ｪ繧ｻ繝・ヨ"""
        cls.df = None
        cls.df_processed = None
        cls.col_map = {}
        cls.tfidf_matrix = None
        cls.vectorizer = None
        cls.feature_names = []
        cls.status_colors = {}
        cls.status_order = []
        cls.core_rules = {}
        cls.core_df_classified = None
        cls.core_reanalyze_prompt = ""
    
    @classmethod
    def has_data(cls) -> bool:
        """蛻・梵繝・・繧ｿ縺瑚ｪｭ縺ｿ霎ｼ縺ｾ繧後※縺・ｋ縺・""
        return cls.df_processed is not None and len(cls.df_processed) > 0
    
    @classmethod
    def has_tfidf(cls) -> bool:
        """TF-IDF陦悟・縺瑚ｨ育ｮ玲ｸ医∩縺・""
        return cls.tfidf_matrix is not None


# ============================================================
# 繝√Ε繝ｼ繝域緒逕ｻ繝倥Ν繝代・
# ============================================================

class ChartHelper:
    """
    Plotly/D3.js繝√Ε繝ｼ繝域緒逕ｻ縺ｮ縺溘ａ縺ｮ繝倥Ν繝代・繧ｯ繝ｩ繧ｹ縲・    蜈ｱ騾壹・繝ｬ繧､繧｢繧ｦ繝郁ｨｭ螳壹→繝医Ξ繝ｼ繧ｹ逕滓・繧堤ｵｱ荳蛹悶☆繧九・    """
    
    # 繝・ヵ繧ｩ繝ｫ繝医・繝ｬ繧､繧｢繧ｦ繝郁ｨｭ螳・    DEFAULT_LAYOUT = {
        "height": 450,
        "margin": {"l": 60, "r": 40, "t": 50, "b": 60},
        "paper_bgcolor": "rgba(0,0,0,0)",
        "plot_bgcolor": "rgba(0,0,0,0.1)",
        "font": {"color": "#e0e1dd", "family": "-apple-system, BlinkMacSystemFont, sans-serif"},
        "xaxis": {"gridcolor": "rgba(255,255,255,0.1)", "linecolor": "rgba(255,255,255,0.2)"},
        "yaxis": {"gridcolor": "rgba(255,255,255,0.1)", "linecolor": "rgba(255,255,255,0.2)"},
    }
    
    @classmethod
    def create_layout(cls, title: str = "", **kwargs) -> dict:
        """
        繝・ヵ繧ｩ繝ｫ繝郁ｨｭ螳壹ｒ繝吶・繧ｹ縺ｫ繝ｬ繧､繧｢繧ｦ繝医ｒ菴懈・縲・        
        Args:
            title: 繝√Ε繝ｼ繝医ち繧､繝医Ν
            **kwargs: 霑ｽ蜉/荳頑嶌縺阪☆繧九Ξ繧､繧｢繧ｦ繝医・繝ｭ繝代ユ繧｣
        
        Returns:
            繝槭・繧ｸ縺輔ｌ縺溘Ξ繧､繧｢繧ｦ繝郁ｾ樊嶌
        """
        layout = cls.DEFAULT_LAYOUT.copy()
        if title:
            layout["title"] = title
        
        # xaxis/yaxis縺ｯ豺ｱ縺・・繝ｼ繧ｸ縺悟ｿ・ｦ・        for key in ["xaxis", "yaxis"]:
            if key in kwargs:
                base = layout.get(key, {}).copy()
                base.update(kwargs.pop(key))
                layout[key] = base
        
        layout.update(kwargs)
        return layout
    
    @classmethod
    def create_bar_trace(cls, x: list, y: list, name: str = None, 
                         color: str = None, orientation: str = "v") -> dict:
        """
        譽偵げ繝ｩ繝輔ヨ繝ｬ繝ｼ繧ｹ繧堤函謌・        
        Args:
            x: 讓ｪ譽偵げ繝ｩ繝輔・蝣ｴ蜷医・蛟､・井ｻｶ謨ｰ・峨∫ｸｦ譽偵げ繝ｩ繝輔・蝣ｴ蜷医・繧ｫ繝・ざ繝ｪ
            y: 讓ｪ譽偵げ繝ｩ繝輔・蝣ｴ蜷医・繧ｫ繝・ざ繝ｪ縲∫ｸｦ譽偵げ繝ｩ繝輔・蝣ｴ蜷医・蛟､・井ｻｶ謨ｰ・・            name: 繝医Ξ繝ｼ繧ｹ蜷・            color: 譽偵・濶ｲ
            orientation: 'v'・育ｸｦ・峨∪縺溘・ 'h'・域ｨｪ・・        
        Returns:
            Plotly繝医Ξ繝ｼ繧ｹ霎樊嶌
        """
        trace = {
            "x": x,
            "y": y,
            "type": "bar",
            "orientation": orientation,
        }
        if name:
            trace["name"] = name
        if color:
            trace["marker"] = {"color": color}
        return trace
    
    @classmethod
    def create_line_trace(cls, x: list, y: list, name: str = None,
                          color: str = None, mode: str = "lines+markers") -> dict:
        """謚倥ｌ邱壹げ繝ｩ繝輔ヨ繝ｬ繝ｼ繧ｹ繧堤函謌・""
        trace = {
            "x": x,
            "y": y,
            "type": "scatter",
            "mode": mode,
        }
        if name:
            trace["name"] = name
        if color:
            trace["line"] = {"color": color, "width": 2}
            trace["marker"] = {"color": color, "size": 6}
        return trace
    
    @classmethod
    def create_stacked_bar_layout(cls, title: str, x_title: str = "", 
                                   y_title: str = "", **kwargs) -> dict:
        """遨阪∩荳翫￡譽偵げ繝ｩ繝慕畑繝ｬ繧､繧｢繧ｦ繝医ｒ逕滓・"""
        layout = cls.create_layout(
            title=title,
            barmode="stack",
            xaxis={"title": x_title},
            yaxis={"title": y_title},
            legend={"orientation": "h", "y": -0.25, "x": 0, "xanchor": "left"},
            margin={"b": 100},
            **kwargs
        )
        return layout
    
    @classmethod
    def create_horizontal_bar_layout(cls, title: str, x_title: str = "",
                                      y_title: str = "", left_margin: int = 200, 
                                      **kwargs) -> dict:
        """讓ｪ譽偵げ繝ｩ繝慕畑繝ｬ繧､繧｢繧ｦ繝医ｒ逕滓・"""
        layout = cls.create_layout(
            title=title,
            xaxis={"title": x_title},
            yaxis={"title": y_title, "automargin": True},
            margin={"l": left_margin},
            **kwargs
        )
        return layout
    
    @classmethod
    def draw(cls, container_id: str, traces: list, layout: dict, hide_loading: bool = True):
        """
        繝√Ε繝ｼ繝医ｒ謠冗判・・SON繧ｷ繝ｪ繧｢繝ｩ繧､繧ｺ莉倥″・・        
        Args:
            container_id: 謠冗判蜈医・繧ｳ繝ｳ繝・リID
            traces: Plotly繝医Ξ繝ｼ繧ｹ縺ｮ繝ｪ繧ｹ繝・            layout: Plotly繝ｬ繧､繧｢繧ｦ繝郁ｾ樊嶌
            hide_loading: 謠冗判蠕後↓繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ陦ｨ遉ｺ繧定・蜍戊ｧ｣髯､縺吶ｋ縺・        """
        # 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ隗｣髯､縺ｯ謠冗判螳御ｺ・ｾ後↓JS蛛ｴ縺ｧ陦後ｏ繧後ｋ
        if hide_loading:
            js.showChartLoading(container_id, False, '')
        drawChart(container_id, json.dumps(traces), json.dumps(layout))


# ============================================================
# UI 繝倥Ν繝代・髢｢謨ｰ
# ============================================================

class UIHelper:
    """
    繝懊ち繝ｳ縺ｮ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷九√せ繝・・繧ｿ繧ｹ繝｡繝・そ繝ｼ繧ｸ陦ｨ遉ｺ縺ｪ縺ｩ繧堤ｮ｡逅・☆繧・    UI繝倥Ν繝代・繧ｯ繝ｩ繧ｹ縲・    """
    
    @staticmethod
    def set_button_loading(button_id: str, loading: bool, loading_text: str = ''):
        """繝懊ち繝ｳ縺ｮ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷九ｒ險ｭ螳・""
        js.setButtonLoading(button_id, loading, loading_text)
    
    @staticmethod
    def show_chart_loading(container_id: str, show: bool, message: str = '隱ｭ縺ｿ霎ｼ縺ｿ荳ｭ...'):
        """繝√Ε繝ｼ繝医さ繝ｳ繝・リ縺ｫ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ繧ｪ繝ｼ繝舌・繝ｬ繧､繧定｡ｨ遉ｺ"""
        js.showChartLoading(container_id, show, message)
    
    @staticmethod
    def show_status(container_id: str, status_type: str, title: str, detail: str = ''):
        """
        謾ｹ蝟・＆繧後◆繧ｹ繝・・繧ｿ繧ｹ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ
        
        Args:
            container_id: 繧ｳ繝ｳ繝・リ縺ｮID
            status_type: 'error', 'warning', 'success', 'info'
            title: 繧ｿ繧､繝医Ν
            detail: 隧ｳ邏ｰ繝｡繝・そ繝ｼ繧ｸ
        """
        js.showStatusMessage(container_id, status_type, title, detail)
    
    @staticmethod
    def show_error(container_id: str, title: str, detail: str = ''):
        """繧ｨ繝ｩ繝ｼ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ"""
        UIHelper.show_status(container_id, 'error', title, detail)
    
    @staticmethod
    def show_warning(container_id: str, title: str, detail: str = ''):
        """隴ｦ蜻翫Γ繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ"""
        UIHelper.show_status(container_id, 'warning', title, detail)
    
    @staticmethod
    def show_success(container_id: str, title: str, detail: str = ''):
        """謌仙粥繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ"""
        UIHelper.show_status(container_id, 'success', title, detail)
    
    @staticmethod
    def show_info(container_id: str, title: str, detail: str = ''):
        """諠・ｱ繝｡繝・そ繝ｼ繧ｸ繧定｡ｨ遉ｺ"""
        UIHelper.show_status(container_id, 'info', title, detail)


# ============================================================
# 繝・・繧ｿ蜃ｦ逅・・繝ｫ繝代・髢｢謨ｰ
# ============================================================

def get_filtered_df(year_filter: bool = True) -> pd.DataFrame | None:
    """
    繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ貂医∩DataFrame繧貞叙蠕励☆繧句・騾夐未謨ｰ
    
    Args:
        year_filter: 蟷ｴ繝輔ぅ繝ｫ繧ｿ繧帝←逕ｨ縺吶ｋ縺九←縺・°
        
    Returns:
        繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ貂医∩DataFrame縲√∪縺溘・繝・・繧ｿ縺後↑縺・ｴ蜷・one
    """
    global g_df_processed
    if g_df_processed is None:
        return None
    df = g_df_processed
    if year_filter:
        start = int(document.getElementById('year-start').value)
        end = int(document.getElementById('year-end').value)
        df = df[(df['year'] >= start) & (df['year'] <= end)]
    return df

def require_data(chart_id: str = None, message: str = '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ') -> bool:
    """
    繝・・繧ｿ縺ｮ蟄伜惠繧堤｢ｺ隱阪＠縲√↑縺代ｌ縺ｰ隴ｦ蜻翫ｒ陦ｨ遉ｺ
    
    Args:
        chart_id: 隴ｦ蜻翫ｒ陦ｨ遉ｺ縺吶ｋ繝√Ε繝ｼ繝医さ繝ｳ繝・リID
        message: 陦ｨ遉ｺ縺吶ｋ繝｡繝・そ繝ｼ繧ｸ
        
    Returns:
        繝・・繧ｿ縺悟ｭ伜惠縺吶ｌ縺ｰTrue縲√↑縺代ｌ縺ｰFalse
    """
    global g_df_processed
    if g_df_processed is None:
        if chart_id:
            UIHelper.show_warning(chart_id, message, '蜈医↓繝・・繧ｿ繧偵う繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞')
        return False
    return True

def require_tfidf(chart_id: str = None) -> bool:
    """TF-IDF蜃ｦ逅・・螳御ｺ・ｒ遒ｺ隱・""
    global g_df_processed, g_tfidf_matrix
    if g_df_processed is None or g_tfidf_matrix is None:
        if chart_id:
            UIHelper.show_warning(chart_id, 'TF-IDF譛ｪ蜃ｦ逅・, '蜈医↓繝・・繧ｿ繧偵う繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞')
        return False
    return True

def get_top_applicants(df: pd.DataFrame, n: int = 10) -> list:
    """荳贋ｽ康蜃ｺ鬘倅ｺｺ繧貞叙蠕・""
    return df.explode('applicant_list')['applicant_list'].value_counts().head(n).index.tolist()

def get_top_ipcs(df: pd.DataFrame, n: int = 10, level: int = 4) -> list:
    """荳贋ｽ康蛟九・IPC繧貞叙蠕・""
    exp = df.explode('ipc_list')
    exp['ipc_parsed'] = exp['ipc_list'].apply(lambda x: parse_ipc_atlas(x, level))
    return exp['ipc_parsed'].value_counts().head(n).index.tolist()


# ============================================================
# 蠕梧婿莠呈鋤諤ｧ縺ｮ縺溘ａ縺ｮ繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚繧ｨ繧､繝ｪ繧｢繧ｹ
# ============================================================
# 譌｢蟄倥さ繝ｼ繝峨→縺ｮ莠呈鋤諤ｧ繧堤ｶｭ謖√＠縺､縺､縲、ppState縺ｸ遘ｻ陦後ｒ菫・ｲ

g_df = None
g_df_processed = None
g_col_map = {}
g_tfidf_matrix = None
g_vectorizer = None
g_feature_names = []
g_status_colors = {}
g_status_order = []
g_proxies = []
g_core_rules = {}
g_core_df_classified = None
g_core_reanalyze_prompt = ""


def sync_globals_to_appstate():
    """繧ｰ繝ｭ繝ｼ繝舌Ν螟画焚繧但ppState縺ｫ蜷梧悄・育ｧｻ陦檎畑繝倥Ν繝代・・・""
    AppState.df = g_df
    AppState.df_processed = g_df_processed
    AppState.col_map = g_col_map
    AppState.tfidf_matrix = g_tfidf_matrix
    AppState.vectorizer = g_vectorizer
    AppState.feature_names = g_feature_names
    AppState.status_colors = g_status_colors
    AppState.status_order = g_status_order
    AppState.core_rules = g_core_rules
    AppState.core_df_classified = g_core_df_classified


def sync_appstate_to_globals():
    """AppState繧偵げ繝ｭ繝ｼ繝舌Ν螟画焚縺ｫ蜷梧悄・育ｧｻ陦檎畑繝倥Ν繝代・・・""
    global g_df, g_df_processed, g_col_map, g_tfidf_matrix, g_vectorizer
    global g_feature_names, g_status_colors, g_status_order
    global g_core_rules, g_core_df_classified
    
    g_df = AppState.df
    g_df_processed = AppState.df_processed
    g_col_map = AppState.col_map
    g_tfidf_matrix = AppState.tfidf_matrix
    g_vectorizer = AppState.vectorizer
    g_feature_names = AppState.feature_names
    g_status_colors = AppState.status_colors
    g_status_order = AppState.status_order
    g_core_rules = AppState.core_rules
    g_core_df_classified = AppState.core_df_classified


# ============================================================
# 繝輔ぃ繧､繝ｫ隱ｭ縺ｿ霎ｼ縺ｿ
# ============================================================

async def on_file_change(event):
    """
    CSV繝輔ぃ繧､繝ｫ驕ｸ謚槭ｒ蜃ｦ逅・＠縲∝・螳ｹ繧定ｧ｣譫舌☆繧九・    
    驕ｸ謚槭＆繧後◆繝輔ぃ繧､繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ縲，SV縺ｨ縺励※隗｣譫舌＠縲・    閾ｪ蜍墓､懷・縺ｧ繧ｫ繝ｩ繝繝槭ャ繝斐Φ繧ｰ繝峨Ο繝・・繝繧ｦ繝ｳ繧定ｨｭ螳壹☆繧九・    
    Args:
        event: JavaScript縺ｮ繝輔ぃ繧､繝ｫ蜈･蜉嫩hange繧､繝吶Φ繝・    """
    global g_df
    files = event.target.files
    if files.length == 0:
        return
    
    file = files.item(0)
    content = await file.text()
    
    try:
        from io import StringIO
        
        # Try UTF-8 first, then Shift-JIS for Japanese files
        try:
            df = pd.read_csv(StringIO(content), dtype=str)
        except:
            df = pd.read_csv(StringIO(content), dtype=str, encoding='shift_jis')
        
        g_df = df
        
        # Show preview table
        preview = document.getElementById('preview-area')
        html = f'<div class="status-ok">笨・{len(df):,} 陦瑚ｪｭ縺ｿ霎ｼ縺ｿ</div>'
        html += '<div style="overflow-x: auto; margin-top: 0.5rem;"><table class="data-table"><tr>'
        for c in list(df.columns)[:6]:
            html += f'<th>{c}</th>'
        html += '</tr>'
        for _, row in df.head(3).iterrows():
            html += '<tr>'
            for c in list(df.columns)[:6]:
                html += f'<td>{str(row[c])[:25]}</td>'
            html += '</tr>'
        html += '</table></div>'
        preview.innerHTML = html
        
        # Populate column selectors
        cols = ['(譛ｪ驕ｸ謚・'] + list(df.columns)
        for sel_id in ['col-title', 'col-abstract', 'col-date', 'col-applicant', 'col-ipc', 'col-inventor', 'col-status']:
            sel = document.getElementById(sel_id)
            sel.innerHTML = ''.join(f'<option value="{c}">{c}</option>' for c in cols)
        
        # Auto-map columns based on common naming patterns
        auto_map = {
            'col-title': ['逋ｺ譏弱・蜷咲ｧｰ', 'Title', 'title', '蜷咲ｧｰ'],
            'col-abstract': ['隕∫ｴ・, 'Abstract', 'abstract', '隕∫ｴ・謚・鹸'],
            'col-date': ['蜃ｺ鬘俶律', 'Date', 'applicationDate', '蜃ｺ鬘伜ｹｴ'],
            'col-applicant': ['蜃ｺ鬘倅ｺｺ', 'Applicant', 'applicant', '蜃ｺ鬘倅ｺｺ/讓ｩ蛻ｩ閠・],
            'col-ipc': ['IPC', 'FI', 'ipc', 'F繧ｿ繝ｼ繝'],
            'col-inventor': ['逋ｺ譏手・, 'Inventor', 'inventor'],
            'col-status': ['IPC', 'FI', '繧ｹ繝・・繧ｿ繧ｹ', 'Status', 'status', '豕慕噪迥ｶ豕・, '蟇ｩ譟ｻ迥ｶ豕・]
        }
        
        for sel_id, keywords in auto_map.items():
            sel = document.getElementById(sel_id)
            for kw in keywords:
                for i, c in enumerate(cols):
                    if kw.lower() in str(c).lower():
                        sel.selectedIndex = i
                        break
                else:
                    continue
                break
        
        document.getElementById('file-info').textContent = f'唐 {file.name} ({len(df):,}莉ｶ)'
        
    except Exception as e:
        document.getElementById('preview-area').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'


# ============================================================
# 蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ蛻晄悄蛹・# ============================================================

def launch_engine(event):
    """
    隱ｭ縺ｿ霎ｼ繧薙□繝・・繧ｿ縺ｧ蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧貞・譛溷喧縺吶ｋ縲・    
    逕溘・DataFrame繧貞・逅・
    - 譌･莉倥ｒ隗｣譫舌＠蟷ｴ繧呈歓蜃ｺ
    - 蜃ｺ鬘倅ｺｺ/逋ｺ譏手・Μ繧ｹ繝医ｒ蛻・牡
    - IPC繧ｳ繝ｼ繝峨ｒ謚ｽ蜃ｺ
    - 繝・く繧ｹ繝亥・譫千畑縺ｮTF-IDF陦悟・繧呈ｧ狗ｯ・    - 繧ｹ繝・・繧ｿ繧ｹ濶ｲ蛻・￠繧定ｨｭ螳・    
    Args:
        event: 繝懊ち繝ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・    """
    global g_df, g_df_processed, g_col_map, g_tfidf_matrix
    global g_vectorizer, g_feature_names, g_status_colors
    
    if g_df is None:
        document.getElementById('launch-status').innerHTML = (
            '<div class="status-err">蜈医↓繝・・繧ｿ繧偵う繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞</div>'
        )
        return
    
    document.getElementById('launch-progress').style.display = 'block'
    status = document.getElementById('launch-status')
    
    try:
        df = g_df.copy()
        updateProgress(5)
        
        # Read column mapping from UI
        g_col_map = {
            'title': document.getElementById('col-title').value,
            'abstract': document.getElementById('col-abstract').value,
            'date': document.getElementById('col-date').value,
            'applicant': document.getElementById('col-applicant').value,
            'ipc': document.getElementById('col-ipc').value,
            'inventor': document.getElementById('col-inventor').value,
            'status': document.getElementById('col-status').value
        }
        cm = g_col_map
        
        status.innerHTML = '<div>套 譌･莉倥ｒ蜃ｦ逅・ｸｭ...</div>'
        updateProgress(15)
        
        if cm['date'] and cm['date'] != '(譛ｪ驕ｸ謚・':
            df['parsed_date'] = parse_date(df[cm['date']])
            df['year'] = df['parsed_date'].dt.year.fillna(0).astype(int)
        else:
            df['year'] = 0
        
        status.innerHTML = '<div>側 蜃ｺ鬘倅ｺｺ繧貞・逅・ｸｭ...</div>'
        updateProgress(25)
        
        if cm['applicant'] and cm['applicant'] != '(譛ｪ驕ｸ謚・':
            df['applicant_list'] = df[cm['applicant']].apply(split_list)
        else:
            df['applicant_list'] = [[] for _ in range(len(df))]
        
        status.innerHTML = '<div>捷・・IPC繧貞・逅・ｸｭ...</div>'
        updateProgress(35)
        
        if cm['ipc'] and cm['ipc'] != '(譛ｪ驕ｸ謚・':
            df['ipc_list'] = df[cm['ipc']].apply(extract_ipc)
        else:
            df['ipc_list'] = [[] for _ in range(len(df))]
        
        status.innerHTML = '<div>捉窶昨沐ｬ 逋ｺ譏手・ｒ蜃ｦ逅・ｸｭ...</div>'
        updateProgress(45)
        
        if cm['inventor'] and cm['inventor'] != '(譛ｪ驕ｸ謚・':
            df['inventor_list'] = df[cm['inventor']].apply(split_list)
        else:
            df['inventor_list'] = [[] for _ in range(len(df))]
        
        status.innerHTML = '<div>耳 繧ｹ繝・・繧ｿ繧ｹ濶ｲ繧定ｨｭ螳壻ｸｭ...</div>'
        updateProgress(50)
        
        if cm['status'] and cm['status'] != '(譛ｪ驕ｸ謚・':
            status_series = df[cm['status']].apply(normalize_status)
            df['_status'] = status_series
            g_col_map['status_norm'] = '_status'
            unique_statuses = sorted(status_series.unique())
            g_status_colors = {
                s: PASTEL_PALETTE[i % len(PASTEL_PALETTE)]
                for i, s in enumerate(unique_statuses)
            }
            g_status_order = unique_statuses
        else:
            g_status_colors = {}
            g_col_map['status_norm'] = None
            g_status_order = []
        
        status.innerHTML = '<div>統 繝・く繧ｹ繝医ｒ繝吶け繝医Ν蛹紋ｸｭ...</div>'
        updateProgress(55)
        
        # Combine title and abstract for text analysis
        title_col = cm['title'] if cm['title'] != '(譛ｪ驕ｸ謚・' else ''
        abstract_col = cm['abstract'] if cm['abstract'] != '(譛ｪ驕ｸ謚・' else ''
        df['text'] = df.apply(
            lambda r: str(r.get(title_col, '')) + ' ' + str(r.get(abstract_col, '')),
            axis=1
        )
        df['tokenized'] = df['text'].apply(tokenize_text)

        # CORE繝｢繧ｸ繝･繝ｼ繝ｫ縺ｮ繧ｿ繝ｼ繧ｲ繝・ヨ繧ｫ繝ｩ繝繧ｻ繝ｬ繧ｯ繧ｿ繝ｼ繧呈峩譁ｰ
        core_target = document.getElementById('core-ai-target')
        if core_target:
            options = ["text"]
            labels = {
                "text": "繧ｿ繧､繝医Ν・玖ｦ∫ｴ・,
                "title": "繧ｿ繧､繝医Ν縺ｮ縺ｿ",
                "abstract": "隕∫ｴ・・縺ｿ"
            }
            if cm['title'] and cm['title'] != '(譛ｪ驕ｸ謚・':
                options.append("title")
            if cm['abstract'] and cm['abstract'] != '(譛ｪ驕ｸ謚・':
                options.append("abstract")
            core_target.innerHTML = ''.join(
                f'<option value="{v}">{labels[v]}</option>' for v in options
            )
        
        status.innerHTML = '<div>箸 TF-IDF陦悟・繧定ｨ育ｮ嶺ｸｭ...</div>'
        updateProgress(70)
        
        if ensure_sklearn():
            g_vectorizer = TfidfVectorizer(max_features=2000, min_df=2, max_df=0.95)
            g_tfidf_matrix = g_vectorizer.fit_transform(df['tokenized'].fillna(''))
            g_feature_names = g_vectorizer.get_feature_names_out().tolist()
        else:
            g_vectorizer = None
            g_tfidf_matrix = None
            g_feature_names = []
        
        updateProgress(90)

        g_df_processed = df
        
        # 蟷ｴ遽・峇繧ｳ繝ｳ繝医Ο繝ｼ繝ｫ繧定ｨｭ螳・        if df['year'].max() > 0:
            valid_years = df[df['year'] > 0]['year']
            document.getElementById('year-start').value = str(int(valid_years.min()))
            document.getElementById('year-end').value = str(int(valid_years.max()))
        
        # 蜃ｺ鬘倅ｺｺ驕ｸ謚槭Μ繧ｹ繝医ｒ險ｭ螳・        top_applicants = (
            df.explode('applicant_list')['applicant_list']
            .value_counts()
            .head(30)
            .index.tolist()
        )
        top_applicant_counts = (
            df.explode('applicant_list')['applicant_list']
            .value_counts()
            .to_dict()
        )
        
        # 莨∵･ｭ豈碑ｼ・そ繝ｬ繧ｯ繧ｿ繝ｼ
        sel = document.getElementById('compare-companies')
        sel.innerHTML = ''.join(
            f'<option value="{a}">{a}</option>' for a in top_applicants if a
        )
        
        # TF-IDF隧ｳ邏ｰ繧ｻ繝ｬ繧ｯ繧ｿ繝ｼ
        sel_tfidf = document.getElementById('tfidf-company')
        sel_tfidf.innerHTML = '<option value="(譛ｪ驕ｸ謚・">(譛ｪ驕ｸ謚・</option>' + ''.join(
            f'<option value="{a}">{a}</option>' for a in top_applicants if a
        )

        # 繝ｬ繝ｼ繝繝ｼ繝√Ε繝ｼ繝医そ繝ｬ繧ｯ繧ｿ繝ｼ
        sel_radar1 = document.getElementById('radar-company1')
        sel_radar2 = document.getElementById('radar-company2')
        radar_opts = '<option value="">(驕ｸ謚槭＠縺ｦ縺上□縺輔＞)</option>' + ''.join(
            f'<option value="{a}">{a}</option>' for a in top_applicants if a
        )
        sel_radar1.innerHTML = radar_opts
        sel_radar2.innerHTML = radar_opts

        # 謚倥ｌ邱壹メ繝｣繝ｼ繝医・蜃ｺ鬘倅ｺｺ繧ｻ繝ｬ繧ｯ繧ｿ繝ｼ
        sel_line = document.getElementById('atlas-line-applicants')
        sel_line.innerHTML = ''.join(
            f'<option value="{a}">{a} ({top_applicant_counts.get(a, 0)})</option>'
            for a in top_applicants if a
        )
        
        updateProgress(100)
        
        # 繝繝・す繝･繝懊・繝峨・邨ｱ險医ｒ譖ｴ譁ｰ
        valid_years = df[df['year'] > 0]['year']
        year_range = f"{int(valid_years.min())}-{int(valid_years.max())}" if len(valid_years) > 0 else "-"
        unique_applicants = df.explode('applicant_list')['applicant_list'].nunique()
        js.updateDashboardStats(len(df), year_range, unique_applicants)
        
        # 繝繝・す繝･繝懊・繝峨・繝励Ξ繝薙Η繝ｼ繝・・繧ｿ繧呈ｺ門ｙ
        import json
        
        # 蟷ｴ谺｡謗ｨ遘ｻ
        year_counts = df[df['year'] > 0]['year'].value_counts().to_dict()
        year_counts_js = {str(int(k)): int(v) for k, v in year_counts.items()}
        
        # Top蜃ｺ鬘倅ｺｺ
        top_applicant_preview = dict(
            df.explode('applicant_list')['applicant_list']
            .value_counts()
            .head(5)
            .items()
        )
        top_applicant_js = {str(k): int(v) for k, v in top_applicant_preview.items()}
        
        # Top IPC
        top_ipc_preview = dict(
            df.explode('ipc_list')['ipc_list']
            .value_counts()
            .head(5)
            .items()
        )
        top_ipc_js = {str(k): int(v) for k, v in top_ipc_preview.items() if k}
        
        # Top 繧ｭ繝ｼ繝ｯ繝ｼ繝会ｼ・F-IDF繧ｹ繧ｳ繧｢・・        top_keywords_js = {}
        if g_tfidf_matrix is not None and len(g_feature_names) > 0:
            mean_scores = g_tfidf_matrix.mean(axis=0).A1
            top_indices = mean_scores.argsort()[-15:][::-1]
            top_keywords_js = {
                g_feature_names[i]: float(mean_scores[i]) 
                for i in top_indices
            }
        
        # 縺吶∋縺ｦ縺ｮ繝励Ξ繝薙Η繝ｼ繝・・繧ｿ繧偵∪縺ｨ繧√※騾∽ｿ｡
        preview_data = {
            'yearCounts': year_counts_js,
            'topApplicants': top_applicant_js,
            'topIPC': top_ipc_js,
            'topKeywords': top_keywords_js
        }
        js.updateDashboardPreview(json.dumps(preview_data))
        
        # 繝医・繧ｹ繝磯夂衍
        js.showToast(f'蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ襍ｷ蜍募ｮ御ｺ・ｼ・{len(df):,}莉ｶ縺ｮ繝・・繧ｿ繧貞・逅・＠縺ｾ縺励◆', 'success', 4000)
        
        # Display completion status
        status_info = (
            f"繧ｹ繝・・繧ｿ繧ｹ: {len(g_status_colors)}遞ｮ鬘・
            if g_status_colors else "繧ｹ繝・・繧ｿ繧ｹ: 譛ｪ險ｭ螳・
        )
        tfidf_info = f"{g_tfidf_matrix.nnz:,}" if g_tfidf_matrix is not None else "-"
        vocab_info = f"{len(g_feature_names):,}" if g_feature_names else "-"

        status.innerHTML = f'''
            <div class="status-ok" style="font-size: 1.1rem;">脂 蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ襍ｷ蜍募ｮ御ｺ・ｼ・/div>
            <div class="metrics">
                <div class="metric"><div class="metric-value">{len(df):,}</div><div class="metric-label">邱丈ｻｶ謨ｰ</div></div>
                <div class="metric"><div class="metric-value">{vocab_info}</div><div class="metric-label">隱槫ｽ呎焚</div></div>
                <div class="metric"><div class="metric-value">{tfidf_info}</div><div class="metric-label">髱槭ぞ繝ｭ隕∫ｴ</div></div>
            </div>
            <div style="font-size: 0.85rem; margin-top: 0.5rem; color: #778da9;">{status_info}</div>
            <div style="font-size: 0.8rem; margin-top: 0.3rem; color: #9fb3c8;">驥阪＞讖溯・縺ｯ繝舌ャ繧ｯ繧ｰ繝ｩ繧ｦ繝ｳ繝峨〒襍ｷ蜍輔＠縺ｾ縺・/div>
        '''
        
    except Exception as e:
        import traceback
        status.innerHTML = (
            f'<div class="status-err">笶・{str(e)}</div>'
            f'<pre style="font-size:0.7rem;">{traceback.format_exc()}</pre>'
        )


# ============================================================
# ATLAS繝｢繧ｸ繝･繝ｼ繝ｫ - 邨ｱ險医メ繝｣繝ｼ繝・# ============================================================

def draw_atlas(event):
    """
    繝ｦ繝ｼ繧ｶ繝ｼ縺ｮ驕ｸ謚槭↓蝓ｺ縺･縺・※邨ｱ險医メ繝｣繝ｼ繝医ｒ謠冗判縺吶ｋ縲・    
    8遞ｮ鬘槭・繝√Ε繝ｼ繝医ち繧､繝励ｒ繧ｵ繝昴・繝・
    - trend: 蟷ｴ谺｡蜃ｺ鬘倅ｻｶ謨ｰ縺ｮ譽偵げ繝ｩ繝・    - trend_line: 繧ｹ繧ｿ繝・く繝ｳ繧ｰ繧ｪ繝励す繝ｧ繝ｳ莉倥″謚倥ｌ邱壹げ繝ｩ繝・    - applicant: 荳贋ｽ榊・鬘倅ｺｺ縺ｮ讓ｪ譽偵げ繝ｩ繝・    - ipc: 荳贋ｽ巧PC繧ｳ繝ｼ繝峨・讓ｪ譽偵げ繝ｩ繝・    - bubble: 繝舌ヶ繝ｫ繝√Ε繝ｼ繝・(蜃ｺ鬘倅ｺｺ ﾃ・蟷ｴ繝槭ヨ繝ｪ繝・け繧ｹ)
    - ipc_applicant: 繝偵・繝医・繝・・ (IPC ﾃ・蜃ｺ鬘倅ｺｺ)
    - treemap: 髫主ｱ､繝・Μ繝ｼ繝槭ャ繝・(IPC縺ｾ縺溘・蜃ｺ鬘倅ｺｺ)
    - lifecycle: 蜃ｺ鬘倥Λ繧､繝輔し繧､繧ｯ繝ｫ蛻・梵
    
    蜷・メ繝｣繝ｼ繝医ち繧､繝励・繧ｪ繝励す繝ｧ繝ｳ縺ｧ繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ縺ｮ濶ｲ蛻・￠繧偵し繝昴・繝医・    
    Args:
        event: 繝懊ち繝ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・    """
    global g_df_processed, g_status_colors, g_col_map, g_status_order
    
    # 繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ陦ｨ遉ｺ髢句ｧ・    UIHelper.show_chart_loading('atlas-chart', True, '繝√Ε繝ｼ繝育函謌蝉ｸｭ...')
    
    try:
        if g_df_processed is None:
            UIHelper.show_chart_loading('atlas-chart', False)
            UIHelper.show_warning('atlas-chart', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ', '蜈医↓繝・・繧ｿ繧偵う繝ｳ繝昴・繝医＠縺ｦ縺上□縺輔＞')
            return
        
        df = g_df_processed
        start = int(document.getElementById('year-start').value)
        end = int(document.getElementById('year-end').value)
        top_n = int(document.getElementById('top-n').value)
        chart_type = window.appState.chartType
        use_status = document.getElementById('use-status-breakdown').checked
        
        # Status breakdown only supported for specific chart types
        if chart_type not in ['trend', 'trend_line', 'applicant', 'bubble']:
            use_status = False
        
        dff = df[(df['year'] >= start) & (df['year'] <= end)]
        status_col = g_col_map.get('status_norm') or g_col_map.get('status')
        has_status = bool(
            status_col and status_col != '(譛ｪ驕ｸ謚・'
            and use_status and status_col in df.columns
        )
        status_colors = dict(g_status_colors) if g_status_colors else {}
        status_order = list(g_status_order) if g_status_order else []
        
        # 繝√Ε繝ｼ繝磯℃雋闕ｷ髦ｲ豁｢縺ｮ縺溘ａ繧ｹ繝・・繧ｿ繧ｹ繧ｫ繝・ざ繝ｪ謨ｰ繧貞宛髯・        MAX_STATUS_CATEGORIES = 15
        if has_status:
            dff = dff.copy()
            dff[status_col] = dff[status_col].fillna('譛ｪ險ｭ螳・).astype(str).replace({'': '譛ｪ險ｭ螳・})
            statuses_in_view = sorted(dff[status_col].unique().tolist())
            
            # 莉ｶ謨ｰ荳贋ｽ康繧ｫ繝・ざ繝ｪ縺ｫ蛻ｶ髯・            if len(statuses_in_view) > MAX_STATUS_CATEGORIES:
                debugLog(
                    f'[draw_atlas] Warning: {len(statuses_in_view)} status categories found, '
                    f'limiting to top {MAX_STATUS_CATEGORIES}'
                )
                status_counts = dff[status_col].value_counts().head(MAX_STATUS_CATEGORIES)
                statuses_in_view = status_counts.index.tolist()
                
                # 縲後◎縺ｮ莉悶阪き繝・ざ繝ｪ繧定ｿｽ蜉
                other_count = dff[~dff[status_col].isin(statuses_in_view)].shape[0]
                if other_count > 0:
                    statuses_in_view.append('縺昴・莉・)
            
                status_colors = {
                    s: PASTEL_PALETTE[i % len(PASTEL_PALETTE)]
                    for i, s in enumerate(statuses_in_view)
                }
                status_order = statuses_in_view
            
            if len(status_colors) == 0:
                has_status = False

        if chart_type == 'trend':
            if has_status:
                # 縲後◎縺ｮ莉悶阪き繝・ざ繝ｪ繧貞・逅・                dff_status = dff.copy()
                if '縺昴・莉・ in status_order:
                    top_statuses = [s for s in status_order if s != '縺昴・莉・]
                    dff_status.loc[~dff_status[status_col].isin(top_statuses), status_col] = '縺昴・莉・
                
                plot_data = dff_status.groupby(['year', status_col]).size().reset_index(name='count')
                years_full = list(range(start, end + 1))
                traces = []
                for status in status_order:
                    sub = plot_data[plot_data[status_col] == status].set_index('year')['count']
                    sub = sub.reindex(years_full, fill_value=0)
                    traces.append(ChartHelper.create_bar_trace(
                        x=[int(x) for x in years_full],
                        y=[int(y) for y in sub.values],
                        name=str(status),
                        color=status_colors.get(str(status), "#888")
                    ))
                layout = ChartHelper.create_stacked_bar_layout(
                    title=f"蜃ｺ鬘倅ｻｶ謨ｰ謗ｨ遘ｻ ({start}-{end}) - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ",
                    x_title="蜃ｺ鬘伜ｹｴ",
                    y_title="莉ｶ謨ｰ"
                )
            else:
                cnt = dff['year'].value_counts().sort_index()
                cnt = cnt[cnt.index > 0]
                traces = [ChartHelper.create_bar_trace(
                    x=[int(x) for x in cnt.index],
                    y=[int(y) for y in cnt.values],
                    color=COLOR_SEQUENCE[0]
                )]
                layout = ChartHelper.create_layout(
                    title=f"蜃ｺ鬘倅ｻｶ謨ｰ謗ｨ遘ｻ ({start}-{end})",
                    xaxis={"title": "蜃ｺ鬘伜ｹｴ"},
                    yaxis={"title": "莉ｶ謨ｰ"}
                )
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'trend_line':
            line_mode = document.getElementById('atlas-line-mode').value
            if line_mode != 'overall':
                use_status = False
            if line_mode == 'overall':
                if has_status:
                    # Handle "Other" category
                    dff_status = dff.copy()
                    if '縺昴・莉・ in status_order:
                        top_statuses = [s for s in status_order if s != '縺昴・莉・]
                        dff_status.loc[~dff_status[status_col].isin(top_statuses), status_col] = '縺昴・莉・
                    
                    plot_data = dff_status.groupby(['year', status_col]).size().reset_index(name='count')
                    years_full = list(range(start, end + 1))
                    traces = []
                    for status in status_order:
                        sub = plot_data[plot_data[status_col] == status].set_index('year')['count']
                        sub = sub.reindex(years_full, fill_value=0)
                        trace = ChartHelper.create_line_trace(
                            x=[int(x) for x in years_full],
                            y=[int(y) for y in sub.values],
                            name=str(status),
                            color=status_colors.get(str(status), "#888")
                        )
                        trace["stackgroup"] = "one"  # 遨阪∩荳翫￡髱｢逕ｨ
                        traces.append(trace)
                    layout = ChartHelper.create_layout(
                        title=f"莉ｶ謨ｰ謗ｨ遘ｻ・育ｩ阪∩荳翫￡髱｢・・{start}-{end})",
                        xaxis={"title": "蜃ｺ鬘伜ｹｴ"},
                        yaxis={"title": "莉ｶ謨ｰ", "rangemode": "tozero"},
                        legend={"orientation": "h", "y": -0.25, "x": 0, "xanchor": "left"},
                        margin={"b": 100}
                    )
                else:
                    cnt = dff['year'].value_counts().sort_index()
                    cnt = cnt[cnt.index > 0]
                    traces = [ChartHelper.create_line_trace(
                        x=[int(x) for x in cnt.index],
                        y=[int(y) for y in cnt.values],
                        color=COLOR_SEQUENCE[0]
                    )]
                    layout = ChartHelper.create_layout(
                        title=f"莉ｶ謨ｰ謗ｨ遘ｻ・域釜繧檎ｷ夲ｼ・{start}-{end})",
                        xaxis={"title": "蜃ｺ鬘伜ｹｴ"},
                        yaxis={"title": "莉ｶ謨ｰ", "rangemode": "tozero"}
                    )
            else:
                sel = document.getElementById('atlas-line-applicants')
                selected = [opt.value for opt in sel.selectedOptions]
                if len(selected) == 0:
                    document.getElementById('atlas-chart').innerHTML = (
                        '<div class="status-warn">蜃ｺ鬘倅ｺｺ繧帝∈謚槭＠縺ｦ縺上□縺輔＞</div>'
                    )
                    return
                selected = selected[:5]
                exp = dff.explode('applicant_list')
                exp['applicant_list'] = exp['applicant_list'].astype(str)
                exp = exp[exp['applicant_list'].isin(selected)]
                if exp.empty:
                    document.getElementById('atlas-chart').innerHTML = (
                        '<div class="status-warn">驕ｸ謚槭＠縺溷・鬘倅ｺｺ縺ｮ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
                    )
                    return
                
                traces = []
                for i, app in enumerate(selected):
                    sub = exp[exp['applicant_list'] == app]
                    yearly = sub['year'].value_counts().sort_index()
                    yearly = yearly.reindex(range(start, end + 1), fill_value=0)
                    traces.append(ChartHelper.create_line_trace(
                        x=[int(x) for x in yearly.index],
                        y=[int(y) for y in yearly.values],
                        name=app,
                        color=COLOR_SEQUENCE[i % len(COLOR_SEQUENCE)]
                    ))
                layout = ChartHelper.create_layout(
                    title="荳ｻ隕∝・鬘倅ｺｺ縺ｮ莉ｶ謨ｰ謗ｨ遘ｻ豈碑ｼ・,
                    xaxis={"title": "蜃ｺ鬘伜ｹｴ"},
                    yaxis={"title": "莉ｶ謨ｰ", "rangemode": "tozero"}
                )
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'applicant':
            exp = dff.explode('applicant_list')
            num_to_display = int(document.getElementById('atlas-applicant-count').value)
            top_applicants = exp['applicant_list'].value_counts().head(num_to_display).index.tolist()
            
            # Create truncated display names
            display_names = [truncate_applicant_name(a, 30) for a in top_applicants]
            
            # Calculate left margin based on longest name
            max_name_len = max((len(n) for n in display_names), default=10)
            left_margin = min(350, max(150, max_name_len * 9))
            debugLog(
                f'[draw_atlas] applicant: num_to_display={num_to_display}, '
                f'top_applicants count={len(top_applicants)}, left_margin={left_margin}'
            )
            
            if has_status:
                exp_top = exp[exp['applicant_list'].isin(top_applicants)].copy()
                
                # Handle "Other" category
                if '縺昴・莉・ in status_order:
                    top_statuses = [s for s in status_order if s != '縺昴・莉・]
                    exp_top.loc[~exp_top[status_col].isin(top_statuses), status_col] = '縺昴・莉・
                
                plot_data = exp_top.groupby(['applicant_list', status_col]).size().reset_index(name='count')
                debugLog(
                    f'[draw_atlas] has_status=True, status_order count={len(status_order)}, '
                    f'plot_data rows={len(plot_data)}'
                )
                
                traces = []
                for status in status_order:
                    sub = plot_data[plot_data[status_col] == status]
                    sub_sorted = pd.DataFrame({'applicant_list': top_applicants}).merge(
                        sub, on='applicant_list', how='left'
                    ).fillna(0)
                    trace = ChartHelper.create_bar_trace(
                        x=[int(x) for x in sub_sorted['count']],
                        y=display_names,
                        name=str(status),
                        color=status_colors.get(str(status), "#888"),
                        orientation="h"
                    )
                    trace["customdata"] = top_applicants
                    trace["hovertemplate"] = "%{customdata}<br>%{x}莉ｶ<extra>%{fullData.name}</extra>"
                    traces.append(trace)
                layout = ChartHelper.create_horizontal_bar_layout(
                    title=f"蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP{num_to_display} - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ",
                    x_title="",
                    y_title="",
                    left_margin=left_margin
                )
                layout["barmode"] = "stack"
                layout["yaxis"]["categoryorder"] = "array"
                layout["yaxis"]["categoryarray"] = display_names[::-1]
                layout["height"] = max(500, num_to_display * 30 + 100)
            else:
                cnt = exp['applicant_list'].value_counts().head(num_to_display).sort_values(ascending=True)
                y_display = [truncate_applicant_name(a, 30) for a in cnt.index.tolist()]
                trace = ChartHelper.create_bar_trace(
                    x=[int(x) for x in cnt.values],
                    y=y_display,
                    color=COLOR_SEQUENCE[1],
                    orientation="h"
                )
                trace["customdata"] = cnt.index.tolist()
                trace["hovertemplate"] = "%{customdata}<br>%{x}莉ｶ<extra></extra>"
                traces = [trace]
                layout = ChartHelper.create_horizontal_bar_layout(
                    title=f"蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP{num_to_display}",
                    x_title="",
                    y_title="",
                    left_margin=left_margin
                )
                layout["yaxis"]["categoryorder"] = "array"
                layout["yaxis"]["categoryarray"] = y_display
                layout["height"] = max(450, num_to_display * 28)
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'ipc':
            exp = dff.explode('ipc_list')
            exp = exp[exp['ipc_list'].notna() & (exp['ipc_list'] != '')]
            ipc_level = int(document.getElementById('atlas-ipc-level').value)
            num_to_display = int(document.getElementById('atlas-ipc-count').value)
            exp = exp.copy()
            exp['ipc_parsed'] = exp['ipc_list'].apply(lambda x: parse_ipc_atlas(x, ipc_level))
            top_ipcs = exp['ipc_parsed'].value_counts().head(num_to_display).index.tolist()
            
            if has_status:
                exp_top = exp[exp['ipc_parsed'].isin(top_ipcs)].copy()
                
                # Handle "Other" category
                if '縺昴・莉・ in status_order:
                    top_statuses = [s for s in status_order if s != '縺昴・莉・]
                    exp_top.loc[~exp_top[status_col].isin(top_statuses), status_col] = '縺昴・莉・
                
                plot_data = exp_top.groupby(['ipc_parsed', status_col]).size().reset_index(name='count')
                
                traces = []
                for status in status_order:
                    sub = plot_data[plot_data[status_col] == status]
                    sub_sorted = pd.DataFrame({'ipc_parsed': top_ipcs}).merge(
                        sub, on='ipc_parsed', how='left'
                    ).fillna(0)
                    traces.append(ChartHelper.create_bar_trace(
                        x=[int(x) for x in sub_sorted['count']],
                        y=sub_sorted['ipc_parsed'].tolist(),
                        name=str(status),
                        color=status_colors.get(str(status), "#888"),
                        orientation="h"
                    ))
                layout = ChartHelper.create_horizontal_bar_layout(
                    title=f"IPC繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP{num_to_display} - 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ",
                    x_title="",
                    y_title="",
                    left_margin=100
                )
                layout["barmode"] = "stack"
                layout["yaxis"]["categoryorder"] = "array"
                layout["yaxis"]["categoryarray"] = top_ipcs[::-1]
                layout["height"] = max(450, num_to_display * 28)
            else:
                cnt = exp['ipc_parsed'].value_counts().head(num_to_display).sort_values(ascending=True)
                traces = [ChartHelper.create_bar_trace(
                    x=[int(x) for x in cnt.values],
                    y=cnt.index.tolist(),
                    color=COLOR_SEQUENCE[2],
                    orientation="h"
                )]
                layout = ChartHelper.create_horizontal_bar_layout(
                    title=f"IPC繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ TOP{num_to_display}",
                    x_title="",
                    y_title="",
                    left_margin=100
                )
                layout["yaxis"]["categoryorder"] = "array"
                layout["yaxis"]["categoryarray"] = cnt.index.tolist()
                layout["height"] = max(450, num_to_display * 28)
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'bubble':
            exp = dff.explode('applicant_list')
            num_to_display = int(document.getElementById('atlas-bubble-count').value)
            top_apps = exp['applicant_list'].value_counts().head(num_to_display).index.tolist()
            exp_top = exp[exp['applicant_list'].isin(top_apps)]
            
            if has_status:
                # Bubble chart with status breakdown (grid pie charts)
                plot_data = exp_top.groupby(
                    ['year', 'applicant_list', status_col]
                ).size().reset_index(name='count')
                years = list(range(start, end + 1))
                plot_data = plot_data[plot_data['year'].isin(years)]
                
                traces = []
                statuses_in_view = [
                    s for s in status_order if s in plot_data[status_col].unique()
                ]
                
                # Legend traces
                for status in statuses_in_view:
                    traces.append({
                        "x": [None],
                        "y": [None],
                        "type": "scatter",
                        "mode": "markers",
                        "name": str(status),
                        "marker": {"size": 10, "color": status_colors.get(str(status), "#888")},
                        "showlegend": True
                    })
                
                n_rows = len(top_apps)
                n_cols = len(years)
                if n_rows == 0 or n_cols == 0:
                    document.getElementById('atlas-chart').innerHTML = (
                        '<div class="status-warn">繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
                    )
                    return
                
                # Layout calculations for pie chart grid
                x_margin_l = 0.20
                x_margin_r = 0.02
                y_margin_b = 0.10
                y_margin_t = 0.05
                plot_width = 1.0 - (x_margin_l + x_margin_r)
                plot_height = 1.0 - (y_margin_b + y_margin_t)
                cell_w = plot_width / n_cols
                cell_h = plot_height / n_rows
                
                total_counts = exp_top.groupby(
                    ['applicant_list', 'year']
                ).size().reset_index(name='total')
                max_total = total_counts['total'].max() if not total_counts.empty else 1
                
                for i, app in enumerate(top_apps):
                    for j, year in enumerate(years):
                        cell_df = plot_data[(plot_data['applicant_list'] == app) & (plot_data['year'] == year)]
                        if not cell_df.empty:
                            total = cell_df['count'].sum()
                            scale_factor = (total / max_total) ** 0.5
                            y_center = (1.0 - y_margin_t) - (i * cell_h) - (cell_h / 2)
                            x_center = x_margin_l + (j * cell_w) + (cell_w / 2)
                            d_w = cell_w * scale_factor
                            x0 = x_center - (d_w / 2)
                            x1 = x_center + (d_w / 2)
                            y0 = y_center - (scale_factor * cell_h / 2)
                            y1 = y_center + (scale_factor * cell_h / 2)
                            labels = cell_df[status_col].astype(str).tolist()
                            values = cell_df['count'].tolist()
                            colors = [status_colors.get(l, '#ccc') for l in labels]
                            traces.append({
                                "type": "pie",
                                "labels": labels,
                                "values": values,
                                "marker": {"colors": colors},
                                "domain": {"x": [x0, x1], "y": [y0, y1]},
                                "showlegend": False,
                                "textinfo": "none",
                                "hoverinfo": "label+value",
                                "sort": False
                            })
                
                layout = {
                    "title": "蜃ｺ鬘倅ｺｺﾃ怜ｹｴ 繝舌ヶ繝ｫ・医せ繝・・繧ｿ繧ｹ蜀・ｨｳ・・,
                    "height": max(700, n_rows * 50),
                    "showlegend": True,
                    "legend": {"orientation": "h", "y": -0.25, "x": 0, "xanchor": "left"},
                    "xaxis": {
                        "visible": True,
                        "domain": [x_margin_l, 1.0 - x_margin_r],
                        "range": [years[0] - 0.5, years[-1] + 0.5],
                        "tickmode": "array",
                        "tickvals": years,
                        "side": "bottom",
                        "fixedrange": True,
                        "showgrid": False,
                        "zeroline": False,
                        "showline": False
                    },
                    "yaxis": {
                        "visible": True,
                        "domain": [y_margin_b, 1.0 - y_margin_t],
                        "range": [-0.5, n_rows - 0.5],
                        "tickmode": "array",
                        "tickvals": list(range(n_rows)),
                        "ticktext": top_apps[::-1],
                        "fixedrange": True,
                        "showgrid": True,
                        "gridcolor": "#eee",
                        "zeroline": False,
                        "showline": False
                    },
                    "margin": {"l": 0, "r": 0, "t": 40, "b": 80}
                }
            else:
                pivot = exp_top.groupby(['year', 'applicant_list']).size().reset_index(name='count')
                
                traces = []
                for i, app in enumerate(top_apps):
                    sub = pivot[pivot['applicant_list'] == app]
                    traces.append({
                        "x": [int(x) for x in sub['year']],
                        "y": [app] * len(sub),
                        "mode": "markers",
                        "name": app[:20],
                        "marker": {"size": [max(10, int(c)*4) for c in sub['count']], "color": COLOR_SEQUENCE[i % len(COLOR_SEQUENCE)], "opacity": 0.7, "line": {"width": 1, "color": "#fff"}},
                        "text": [f"{app}<br>{y}蟷ｴ: {c}莉ｶ" for y, c in zip(sub['year'], sub['count'])],
                        "hoverinfo": "text"
                    })
                layout = ChartHelper.create_layout(
                    title="蜃ｺ鬘倅ｺｺﾃ怜ｹｴ 繝舌ヶ繝ｫ繝√Ε繝ｼ繝・,
                    height=500,
                    showlegend=True,
                    legend={"orientation": "v", "x": 1.02, "y": 1, "xanchor": "left"},
                    xaxis={"title": "蜃ｺ鬘伜ｹｴ"},
                    yaxis={
                        "categoryorder": "array", 
                        "categoryarray": top_apps[::-1],
                        "showticklabels": False  # 蜃｡萓九′縺ゅｋ縺ｮ縺ｧy霆ｸ繝ｩ繝吶Ν縺ｯ髱櫁｡ｨ遉ｺ
                    },
                    margin={"r": 150}  # 蜿ｳ蛛ｴ縺ｮ蜃｡萓狗畑繧ｹ繝壹・繧ｹ
                )
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'treemap':
            mode = document.getElementById('atlas-treemap-mode').value
            if mode == 'ipc':
                tree_df = create_treemap_data(dff, mode='ipc')
                if tree_df.empty:
                    traces = []
                    layout = {"title": "IPC繝・・繧ｿ縺後≠繧翫∪縺帙ｓ", "height": 300}
                else:
                    labels = []
                    parents = []
                    values = []
                    sections_used = set()
                    classes_used = set()
                    subclass_counts = tree_df['Subclass'].value_counts().head(50)
                    for subclass, count in subclass_counts.items():
                        section = subclass[0]
                        ipc_class = subclass[:3]
                        if section not in sections_used:
                            labels.append(section)
                            parents.append('')
                            values.append(0)
                            sections_used.add(section)
                        if ipc_class not in classes_used:
                            labels.append(ipc_class)
                            parents.append(section)
                            values.append(0)
                            classes_used.add(ipc_class)
                        labels.append(subclass)
                        parents.append(ipc_class)
                        values.append(int(count))
                    traces = [{"type": "treemap", "labels": labels, "parents": parents, "values": values, "textinfo": "label+value", "marker": {"colors": values, "colorscale": "Viridis", "line": {"color": "#1b263b", "width": 2}}, "textfont": {"color": "white", "size": 14}}]
                    layout = ChartHelper.create_layout(title="IPC髫主ｱ､讒矩繝槭ャ繝・, height=700, paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)")
            else:
                tree_df = create_treemap_data(dff, mode='applicant')
                if tree_df.empty:
                    traces = []
                    layout = ChartHelper.create_layout(title="蜃ｺ鬘倅ｺｺ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ", height=300)
                else:
                    traces = [{"type": "treemap", "labels": tree_df['Applicant'].tolist(), "parents": tree_df['Root'].tolist(), "values": tree_df['count'].tolist(), "textinfo": "label+value", "marker": {"colors": tree_df['count'].tolist(), "colorscale": "Sunset", "line": {"color": "#1b263b", "width": 2}}, "textfont": {"color": "white", "size": 12}}]
                    layout = ChartHelper.create_layout(title="蜃ｺ鬘倅ｺｺ繧ｷ繧ｧ繧｢繝槭ャ繝・, height=700, paper_bgcolor="rgba(0,0,0,0)", plot_bgcolor="rgba(0,0,0,0)")
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'lifecycle':
            exp = dff.copy()
            exp_apps = dff.explode('applicant_list')
            exp_apps['applicant_list'] = exp_apps['applicant_list'].astype(str)
            exp_apps = exp_apps[exp_apps['applicant_list'] != '']
            apps_count = exp.groupby('year').size()
            applicants_count = exp_apps.groupby('year')['applicant_list'].nunique().reindex(apps_count.index, fill_value=0)
            lifecycle_df = pd.DataFrame({
                'year': apps_count.index,
                'applications': apps_count.values,
                'applicants': applicants_count.values
            })
            if lifecycle_df.empty or len(lifecycle_df) < 2:
                document.getElementById('atlas-chart').innerHTML = '<div class="status-warn">繝・・繧ｿ荳崎ｶｳ縺ｮ縺溘ａ謠冗判縺ｧ縺阪∪縺帙ｓ・域悄髢薙ｒ蠎・￡縺ｦ縺上□縺輔＞・・/div>'
                return
            lifecycle_df['year_label'] = lifecycle_df['year'].apply(lambda y: f"'{str(int(y))[-2:]}")
            traces = [
                {
                    "x": [int(x) for x in lifecycle_df['applications']],
                    "y": [int(y) for y in lifecycle_df['applicants']],
                    "type": "scatter",
                    "mode": "lines",
                    "line": {"shape": "spline", "smoothing": 1.3, "width": 3, "color": "#aaaaaa"},
                    "opacity": 0.5,
                    "showlegend": False,
                    "hoverinfo": "skip"
                },
                {
                    "x": [int(x) for x in lifecycle_df['applications']],
                    "y": [int(y) for y in lifecycle_df['applicants']],
                    "type": "scatter",
                    "mode": "markers+text",
                    "text": lifecycle_df['year_label'].tolist(),
                    "textposition": "top center",
                    "marker": {
                        "size": 12,
                        "color": lifecycle_df['year'].tolist(),
                        "colorscale": "Viridis",
                        "showscale": True,
                        "colorbar": {"title": "蜃ｺ鬘伜ｹｴ"}
                    },
                    "showlegend": False,
                    "hovertemplate": "<b>%{text}</b><br>莉ｶ謨ｰ: %{x}<br>莠ｺ謨ｰ: %{y}<extra></extra>"
                }
            ]
            layout = ChartHelper.create_layout(
                title="謚陦薙Λ繧､繝輔し繧､繧ｯ繝ｫ (蜃ｺ鬘倅ｺｺ謨ｰ vs 蜃ｺ鬘倅ｻｶ謨ｰ)",
                xaxis={"title": "蜃ｺ鬘倅ｻｶ謨ｰ (謚陦捺ｴｻ蜍暮㍼)"},
                yaxis={"title": "蜃ｺ鬘倅ｺｺ謨ｰ (蜿ょ・繝励Ξ繧､繝､繝ｼ謨ｰ)"},
                height=700
            )
            ChartHelper.draw("atlas-chart", traces, layout)
        
        elif chart_type == 'ipc_applicant':
            # IPC ﾃ・蜃ｺ鬘倅ｺｺ 繝舌ヶ繝ｫ繝√Ε繝ｼ繝茨ｼ医が繝ｪ繧ｸ繝翫Ν縺ｮtab5・・            exp = dff.explode('applicant_list').explode('ipc_list')
            exp = exp[exp['applicant_list'].notna() & exp['ipc_list'].notna()]
            exp = exp[(exp['applicant_list'] != '') & (exp['ipc_list'] != '')]
            ipc_level = int(document.getElementById('atlas-ipcapp-level').value)
            num_ipcs = int(document.getElementById('atlas-ipcapp-ipc-count').value)
            num_apps = int(document.getElementById('atlas-ipcapp-app-count').value)
            exp = exp.copy()
            exp['ipc_parsed'] = exp['ipc_list'].apply(lambda x: parse_ipc_atlas(x, ipc_level))
            
            # TOP蜃ｺ鬘倅ｺｺ縺ｨTOP IPC繧貞叙蠕・            top_apps = exp['applicant_list'].value_counts().head(num_apps).index.tolist()
            top_ipcs = exp['ipc_parsed'].value_counts().head(num_ipcs).index.tolist()
            
            exp_filtered = exp[exp['applicant_list'].isin(top_apps) & exp['ipc_parsed'].isin(top_ipcs)]
            
            if exp_filtered.empty:
                document.getElementById('atlas-chart').innerHTML = '<div class="status-warn">IPCﾃ怜・鬘倅ｺｺ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
                return
            
            if has_status:
                # 繧ｹ繝・・繧ｿ繧ｹ蜀・ｨｳ莉倥″ - 濶ｲ繧偵せ繝・・繧ｿ繧ｹ縺ｧ蛻・￠繧・                plot_data = exp_filtered.groupby(['applicant_list', 'ipc_parsed', status_col]).size().reset_index(name='count')
                statuses_in_view = [s for s in status_order if s in plot_data[status_col].unique()]
                
                traces = []
                for status in statuses_in_view:
                    sub = plot_data[plot_data[status_col] == status]
                    if not sub.empty:
                        traces.append({
                            "x": sub['applicant_list'].tolist(),
                            "y": sub['ipc_parsed'].tolist(),
                            "mode": "markers",
                            "name": str(status),
                            "marker": {
                                "size": [max(10, int(c) * 2.5) for c in sub['count']],
                                "color": status_colors.get(str(status), "#888"),
                                "opacity": 0.75,
                                "line": {"width": 1, "color": "#fff"}
                            },
                            "text": [f"{app}<br>{ipc}: {c}莉ｶ<br>繧ｹ繝・・繧ｿ繧ｹ: {status}" for app, ipc, c in zip(sub['applicant_list'], sub['ipc_parsed'], sub['count'])],
                            "hoverinfo": "text"
                        })
                
                layout = {
                    "title": f"IPC ﾃ・蜃ｺ鬘倅ｺｺ 繝昴・繝医ヵ繧ｩ繝ｪ繧ｪ・医せ繝・・繧ｿ繧ｹ蜀・ｨｳ・・,
                    "height": max(600, num_apps * 35),
                    "showlegend": True,
                    "legend": {"orientation": "h", "y": -0.25, "x": 0, "xanchor": "left"},
                    "xaxis": {"title": "蜃ｺ鬘倅ｺｺ", "tickangle": -45, "categoryorder": "array", "categoryarray": top_apps},
                    "yaxis": {"title": "IPC", "categoryorder": "array", "categoryarray": top_ipcs[::-1]},
                    "margin": {"l": 100, "b": 200}
                }
            else:
                plot_data = exp_filtered.groupby(['applicant_list', 'ipc_parsed']).size().reset_index(name='count')
                
                traces = []
                for i, ipc in enumerate(top_ipcs):
                    sub = plot_data[plot_data['ipc_parsed'] == ipc]
                    if not sub.empty:
                        traces.append({
                            "x": sub['applicant_list'].tolist(),
                            "y": sub['ipc_parsed'].tolist(),
                            "mode": "markers",
                            "name": ipc,
                            "marker": {
                                "size": [max(12, int(c) * 3) for c in sub['count']],
                                "color": COLOR_SEQUENCE[i % len(COLOR_SEQUENCE)],
                                "opacity": 0.7,
                                "line": {"width": 1, "color": "#fff"}
                            },
                            "text": [f"{app}<br>{ipc}: {c}莉ｶ" for app, c in zip(sub['applicant_list'], sub['count'])],
                            "hoverinfo": "text"
                        })
                
                layout = ChartHelper.create_layout(
                    title=f"IPC ﾃ・蜃ｺ鬘倅ｺｺ 繝昴・繝医ヵ繧ｩ繝ｪ繧ｪ・・OP{num_apps}・・,
                    height=max(600, num_apps * 35),
                    showlegend=True,
                    xaxis={"title": "蜃ｺ鬘倅ｺｺ", "tickangle": -45, "categoryorder": "array", "categoryarray": top_apps},
                    yaxis={"title": "IPC", "categoryorder": "array", "categoryarray": top_ipcs[::-1]},
                    margin={"l": 100, "b": 150}
                )
            ChartHelper.draw("atlas-chart", traces, layout)
    
    except Exception as e:
        UIHelper.show_chart_loading('atlas-chart', False)
        UIHelper.show_error('atlas-chart', '繝√Ε繝ｼ繝域緒逕ｻ繧ｨ繝ｩ繝ｼ', str(e))
        console.error(f'[draw_atlas] Error: {e}')

# =====================================================
# CORE - 隲也炊讀懃ｴ｢
# =====================================================
def _core_text_preprocessor(text):
    if not isinstance(text, str): return ""
    text = unicodedata.normalize('NFKC', text).lower()
    text = re.sub(r'[・・][^・・]{1,80}[・・]', ' ', text)
    text = re.sub(r'(?:蝗ｳ|Fig|FIG|fig)[. 縲]*\d+', ' ', text)
    text = re.sub(r'[!・・"窶懌・$%・・\'()・茨ｼ・・・,\-・・:・・・・=>?・檗\[\]・ｻ・ｽ\\^_`{|}~縲懊懶ｼ・]', ' ', text)
    return text

class LogicNode:
    def evaluate(self, text):
        raise NotImplementedError

class AndNode(LogicNode):
    def __init__(self, children): self.children = children
    def evaluate(self, text): return all(c.evaluate(text) for c in self.children)

class OrNode(LogicNode):
    def __init__(self, children): self.children = children
    def evaluate(self, text): return any(c.evaluate(text) for c in self.children)

class RegexNode(LogicNode):
    def __init__(self, pattern):
        self.source = pattern
        try:
            self.pattern = re.compile(pattern, re.IGNORECASE | re.DOTALL)
        except Exception:
            self.pattern = None
    def evaluate(self, text):
        return bool(self.pattern.search(text)) if self.pattern else False

class CoreLogicParser:
    def __init__(self):
        self.tokens = []
        self.pos = 0

    def tokenize(self, rule_str):
        raw_tokens = re.findall(r'\(|\)|' r'\bnear\d+\b|' r'\badj\d+\b|' r'[\+\*]' r'|' r'[^\(\)\+\*\s]+', rule_str, re.IGNORECASE)
        self.tokens = [t.strip() for t in raw_tokens if t.strip()]
        self.pos = 0

    def parse(self, rule_str):
        self.tokenize(rule_str)
        if not self.tokens: return None
        node = self.expression()
        if self.pos < len(self.tokens):
            raise ValueError(f"Unexpected token at end: {self.tokens[self.pos]}")
        return node

    def expression(self):
        nodes = [self.term()]
        while self.pos < len(self.tokens) and self.tokens[self.pos] == '+':
            self.pos += 1
            nodes.append(self.term())
        return OrNode(nodes) if len(nodes) > 1 else nodes[0]

    def term(self):
        nodes = [self.factor()]
        while self.pos < len(self.tokens) and self.tokens[self.pos] == '*':
            self.pos += 1
            nodes.append(self.factor())
        return AndNode(nodes) if len(nodes) > 1 else nodes[0]

    def factor(self):
        left = self.atom()
        while self.pos < len(self.tokens) and re.match(r'^(near|adj)\d+$', self.tokens[self.pos], re.IGNORECASE):
            op = self.tokens[self.pos].lower()
            self.pos += 1
            right = self.atom()
            l_rex = self.to_regex_string(left)
            r_rex = self.to_regex_string(right)
            n = int(re.findall(r'\d+', op)[0])
            if op.startswith('near'):
                pattern = r'(?:{}.{{0,{}}}?{}|{}.{{0,{}}}?{})'.format(l_rex, n, r_rex, r_rex, n, l_rex)
            else:
                pattern = r'{}.{{0,{}}}?{}'.format(l_rex, n, r_rex)
            left = RegexNode(pattern)
        return left

    def atom(self):
        if self.pos < len(self.tokens) and self.tokens[self.pos] == '(':
            self.pos += 1
            node = self.expression()
            if self.pos < len(self.tokens) and self.tokens[self.pos] == ')':
                self.pos += 1
                return node
            raise ValueError("Missing closing parenthesis")
        elif self.pos < len(self.tokens):
            t = self.tokens[self.pos]
            self.pos += 1
            norm = unicodedata.normalize('NFKC', t).lower()
            return RegexNode(re.escape(norm))
        else:
            raise ValueError("Unexpected end of rule")

    def to_regex_string(self, node):
        if isinstance(node, RegexNode):
            return node.source
        if isinstance(node, OrNode):
            parts = [self.to_regex_string(c) for c in node.children]
            return r'(?:' + '|'.join(parts) + r')'
        if isinstance(node, AndNode):
            raise ValueError("Cannot use AND (*) inside a NEAR/ADJ condition. Use OR (+) only.")
        return ""

def parse_core_rule(rule_str):
    parser = CoreLogicParser()
    return parser.parse(rule_str)

def _core_combined_text(df, cm):
    cols = []
    if cm.get('title') and cm.get('title') != '(譛ｪ驕ｸ謚・' and cm['title'] in df.columns:
        cols.append(df[cm['title']].fillna(''))
    if cm.get('abstract') and cm.get('abstract') != '(譛ｪ驕ｸ謚・' and cm['abstract'] in df.columns:
        cols.append(df[cm['abstract']].fillna(''))
    if not cols:
        return df['text'].fillna('') if 'text' in df.columns else pd.Series([''] * len(df))
    text = cols[0]
    for s in cols[1:]:
        text = text + " " + s
    return text

def update_core_axis_selects():
    axes = list(g_core_rules.keys())
    meta_axes = []
    if g_df_processed is not None and 'year' in g_df_processed.columns:
        meta_axes.append('蜃ｺ鬘伜ｹｴ')
    if g_col_map.get('applicant') and g_col_map.get('applicant') != '(譛ｪ驕ｸ謚・':
        meta_axes.append('蜃ｺ鬘倅ｺｺ')
    all_axes = axes + meta_axes
    x_sel = document.getElementById('core-x-axis')
    y_sel = document.getElementById('core-y-axis')
    re_sel = document.getElementById('core-reanalyze-axis')
    if x_sel:
        x_sel.innerHTML = ''.join([f'<option value="{a}">{a}</option>' for a in all_axes])
    if y_sel:
        y_sel.innerHTML = ''.join([f'<option value="{a}">{a}</option>' for a in all_axes])
    if re_sel:
        re_sel.innerHTML = ''.join([f'<option value="{a}">{a}</option>' for a in axes])

    axis_sel = document.getElementById('core-axis-select')
    if axis_sel:
        if axes:
            axis_sel.innerHTML = ''.join([f'<option value="{a}">{a}</option>' for a in axes])
        else:
            axis_sel.innerHTML = '<option value="">(霆ｸ縺後≠繧翫∪縺帙ｓ)</option>'

def render_core_rules():
    if not g_core_rules:
        document.getElementById('core-rule-list').innerHTML = '<div class="status-warn">繝ｫ繝ｼ繝ｫ縺後≠繧翫∪縺帙ｓ</div>'
        return
    html = ''
    for ax, cats in g_core_rules.items():
        html += f'<h4 style="margin-top:0.6rem;">霆ｸ: {ax} ({len(cats)}莉ｶ)</h4>'
        html += '<table class="data-table"><tr><th>蛻・｡・/th><th>繝ｫ繝ｼ繝ｫ</th><th>謫堺ｽ・/th></tr>'
        for name, cd in cats.items():
            rule = cd['rule'] if isinstance(cd, dict) else cd
            html += (
                f'<tr><td>{name}</td><td>{rule}</td><td>'
                f'<button class="btn" data-axis="{ax}" data-name="{name}" onclick="window.coreEditRule(event)">邱ｨ髮・/button> '
                f'<button class="btn" data-axis="{ax}" data-name="{name}" onclick="window.coreDeleteRule(event)">蜑企勁</button>'
                f'</td></tr>'
            )
        html += '</table>'
    document.getElementById('core-rule-list').innerHTML = html

def core_add_rule(event):
    global g_core_rules
    mode = document.getElementById('core-axis-mode').value
    axis = document.getElementById('core-axis-new').value.strip() if mode == 'new' else document.getElementById('core-axis-select').value
    name = document.getElementById('core-cat-name').value.strip()
    rule = document.getElementById('core-cat-rule').value.strip()
    definition = document.getElementById('core-cat-def').value.strip()
    if not axis or not name or not rule:
        document.getElementById('core-rule-status').innerHTML = '<div class="status-warn">霆ｸ/蛻・｡槫錐/隲也炊蠑上ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    try:
        parse_core_rule(rule)
    except Exception as e:
        document.getElementById('core-rule-status').innerHTML = f'<div class="status-err">笶・譁・ｳ輔お繝ｩ繝ｼ: {str(e)}</div>'
        return
    if axis not in g_core_rules:
        g_core_rules[axis] = {}
    g_core_rules[axis][name] = {'rule': rule, 'definition': definition}
    document.getElementById('core-rule-status').innerHTML = '<div class="status-ok">笨・繝ｫ繝ｼ繝ｫ繧定ｿｽ蜉縺励∪縺励◆</div>'
    update_core_axis_selects()
    render_core_rules()
    document.getElementById('core-cat-name').value = ''
    document.getElementById('core-cat-rule').value = ''
    document.getElementById('core-cat-def').value = ''
    js.document.getElementById('btn-core-add').style.display = 'inline-block'
    js.document.getElementById('btn-core-update').style.display = 'none'
    js.document.getElementById('btn-core-cancel').style.display = 'none'

def core_update_rule(event):
    global g_core_rules
    axis = document.getElementById('core-axis-select').value
    name = document.getElementById('core-cat-name').value.strip()
    rule = document.getElementById('core-cat-rule').value.strip()
    definition = document.getElementById('core-cat-def').value.strip()
    if not axis or not name or not rule:
        document.getElementById('core-rule-status').innerHTML = '<div class="status-warn">霆ｸ/蛻・｡槫錐/隲也炊蠑上ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    try:
        parse_core_rule(rule)
    except Exception as e:
        document.getElementById('core-rule-status').innerHTML = f'<div class="status-err">笶・譁・ｳ輔お繝ｩ繝ｼ: {str(e)}</div>'
        return
    if axis not in g_core_rules:
        g_core_rules[axis] = {}
    g_core_rules[axis][name] = {'rule': rule, 'definition': definition}
    document.getElementById('core-rule-status').innerHTML = '<div class="status-ok">笨・繝ｫ繝ｼ繝ｫ繧呈峩譁ｰ縺励∪縺励◆</div>'
    render_core_rules()
    document.getElementById('core-cat-name').value = ''
    document.getElementById('core-cat-rule').value = ''
    document.getElementById('core-cat-def').value = ''
    js.document.getElementById('btn-core-add').style.display = 'inline-block'
    js.document.getElementById('btn-core-update').style.display = 'none'
    js.document.getElementById('btn-core-cancel').style.display = 'none'

def core_delete_rule(axis, name):
    global g_core_rules
    if axis in g_core_rules and name in g_core_rules[axis]:
        del g_core_rules[axis][name]
        if not g_core_rules[axis]:
            del g_core_rules[axis]
    update_core_axis_selects()
    render_core_rules()

def core_edit_rule(axis, name):
    cd = g_core_rules.get(axis, {}).get(name)
    if not cd:
        return
    document.getElementById('core-axis-mode').value = 'existing'
    document.getElementById('core-axis-select').value = axis
    document.getElementById('core-cat-name').value = name
    document.getElementById('core-cat-rule').value = cd['rule'] if isinstance(cd, dict) else cd
    document.getElementById('core-cat-def').value = cd.get('definition', '') if isinstance(cd, dict) else ''
    js.document.getElementById('core-axis-new').value = ''
    js.document.getElementById('core-axis-select').disabled = False
    js.document.getElementById('core-axis-new').disabled = True

def core_cancel_edit(event):
    document.getElementById('core-cat-name').value = ''
    document.getElementById('core-cat-rule').value = ''
    document.getElementById('core-cat-def').value = ''
    js.document.getElementById('btn-core-add').style.display = 'inline-block'
    js.document.getElementById('btn-core-update').style.display = 'none'
    js.document.getElementById('btn-core-cancel').style.display = 'none'
    syncCoreAxisMode()

# JS蜻ｼ縺ｳ蜃ｺ縺礼畑縺ｫ蜈ｬ髢・import js
js.eval("window.pyodide_globals = window.pyodide_globals || {}")

def core_ai_generate(event):
    global g_df_processed, g_col_map
    if g_df_processed is None:
        document.getElementById('core-ai-output').innerHTML = '<div class="status-warn">蜈医↓蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧定ｵｷ蜍輔＠縺ｦ縺上□縺輔＞</div>'
        return
    if not ensure_sklearn():
        document.getElementById('core-ai-output').innerHTML = '<div class="status-warn">霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺吶ゅ＠縺ｰ繧峨￥蠕・▲縺ｦ蜀榊ｮ溯｡後＠縺ｦ縺上□縺輔＞縲・/div>'
        return
    df = g_df_processed
    target = document.getElementById('core-ai-target').value
    k = int(document.getElementById('core-ai-k').value)
    n = int(document.getElementById('core-ai-n').value)
    use_mece = document.getElementById('core-ai-mece').checked

    if target == 'title':
        col = g_col_map.get('title', df.columns[0])
    elif target == 'abstract':
        col = g_col_map.get('abstract', df.columns[0])
    else:
        col = 'text'
    if col == '(譛ｪ驕ｸ謚・':
        col = 'text'

    try:
        texts_raw = df[col].astype(str).fillna('')
        tokenized = texts_raw.apply(tokenize_text)
        vec = TfidfVectorizer(min_df=1, max_df=0.9, token_pattern=r"(?u)\b\w+\b")
        tfidf = vec.fit_transform(tokenized)
        km = KMeans(n_clusters=k, random_state=42, n_init=10).fit(tfidf)

        sampled_docs = []
        for i in range(k):
            c_idx = np.where(km.labels_ == i)[0]
            if len(c_idx) == 0:
                continue
            dists = euclidean_distances(tfidf[c_idx], km.cluster_centers_[i].reshape(1, -1))
            top_idx = c_idx[dists.flatten().argsort()[:n]]
            sampled_docs.append("\n--- Cluster {} ---\n".format(i) + "\n".join(["繝ｻ" + _core_text_preprocessor(texts_raw.iloc[idx]) for idx in top_idx]))

        instruction_text = (
            "縺薙・迚ｹ險ｱ豈埼寔蝗｣蜈ｨ菴薙ｒ邯ｲ鄒・噪縺ｫ蛻・｡槭☆繧九◆繧√・縲・*縲梧橿陦灘・鬘槭阪瑚ｪｲ鬘悟・鬘槭阪瑚ｧ｣豎ｺ謇区ｮｵ蛻・｡槭・*縺ｮ3縺､縺ｮ蛻・｡櫁ｻｸ縺ｫ縺､縺・※縲・*蛻・｡槫ｮ夂ｾｩ**・亥・鬘槫錐縲∝ｮ夂ｾｩ縲，ORE隲也炊蠑上・繧ｻ繝・ヨ・峨ｒ險ｭ險医＠縺ｦ縺上□縺輔＞縲・n"
            "\n# 驥崎ｦ・ MECE (Mutually Exclusive, Collectively Exhaustive) 縺ｮ蜴溷援\n"
            "- 逕滓・縺吶ｋ蜷・・鬘櫁ｻｸ蜀・・繧ｫ繝・ざ繝ｪ縺ｯ縲∫嶌莠偵↓謗剃ｻ也噪・医ム繝悶ｊ縺後↑縺・ｼ峨〒縺ゅｊ縲√°縺､蜈ｨ菴薙→縺励※邯ｲ鄒・噪・医Δ繝ｬ縺後↑縺・ｼ峨〒縺ゅｋ繧医≧縺ｫ險ｭ險医＠縺ｦ縺上□縺輔＞縲・n"
            "- 蜷・ｻｸ縺ｮ繧ｫ繝・ざ繝ｪ謨ｰ縺ｯ縲｀ECE繧呈ｺ縺溘☆縺ｮ縺ｫ譛驕ｩ縺縺ｨ縺ゅ↑縺溘′蛻､譁ｭ縺吶ｋ謨ｰ・育岼螳峨→縺励※5縲・0蛟狗ｨ句ｺｦ・峨↓縺励※縺上□縺輔＞縲・
        )
        if not use_mece:
            instruction_text = (
                "縺薙・迚ｹ險ｱ豈埼寔蝗｣蜈ｨ菴薙ｒ邯ｲ鄒・噪縺ｫ蛻・｡槭☆繧九◆繧√・縲∽ｻ･荳九・3縺､縺ｮ蛻・｡櫁ｻｸ縺ｫ縺､縺・※**蛻・｡槫ｮ夂ｾｩ**繧定ｨｭ險医＠縺ｦ縺上□縺輔＞縲・n"
                "- **謚陦灘・鬘・*: 6蛟欺n"
                "- **隱ｲ鬘悟・鬘・*: 6蛟欺n"
                "- **隗｣豎ｺ謇区ｮｵ蛻・｡・*: 6蛟・
            )

        sampled_docs_str = "".join(sampled_docs)
        prompt = f"""
縺ゅ↑縺溘・蜆ｪ遘縺ｪ迚ｹ險ｱ諠・ｱ繧ｹ繝医Λ繝・ず繧ｹ繝医〒縺吶・莉･荳九・縲御ｻ｣陦ｨ譁・鍵繧ｵ繝ｳ繝励Ν縲阪・縲√≠繧狗音險ｱ豈埼寔蝗｣・・len(df)}莉ｶ・峨ｒK-Means豕輔〒{k}蛟九・繧ｯ繝ｩ繧ｹ繧ｿ縺ｫ蛻・｡槭＠縲∝推繧ｯ繝ｩ繧ｹ繧ｿ縺九ｉ莉｣陦ｨ逧・↑譁・鍵縺ｮ縲鶏col}縲阪ｒ{n}莉ｶ縺壹▽謚ｽ蜃ｺ縺励◆繧ゅ・縺ｧ縺吶・
# 萓晞ｼ蜀・ｮｹ
{instruction_text}

莉･荳九・蠖｢蠑上・ **JSON繝・・繧ｿ縺ｮ縺ｿ** 繧貞・蜉帙＠縺ｦ縺上□縺輔＞縲りｧ｣隱ｬ縺ｯ荳崎ｦ√〒縺吶・JSON繧偵さ繝斐・縺励※繧ｷ繧ｹ繝・Β縺ｫ縺昴・縺ｾ縺ｾ繧､繝ｳ繝昴・繝医＠縺ｾ縺吶・
# JSON繝輔か繝ｼ繝槭ャ繝・(蜴ｳ螳・
{{
  "謚陦灘・鬘・: [
    {{
      "name": "繧ｫ繝・ざ繝ｪ蜷・(萓・ CO2蛻・屬閹・",
      "definition": "繧ｫ繝・ざ繝ｪ縺ｮ螳夂ｾｩ...",
      "rule": "CORE隲也炊蠑・(萓・ (CO2 + 莠碁・蛹也く邏) * (閹・+ 繝｡繝ｳ繝悶Ξ繝ｳ))"
    }}
  ],
  "隱ｲ鬘悟・鬘・: [ ... ],
  "隗｣豎ｺ謇区ｮｵ蛻・｡・: [ ... ]
}}

# CORE隲也炊蠑乗枚豕・(蜴ｳ螳・
- `A + B` (OR): A 縺ｾ縺溘・ B
- `A * B` (AND): A 縺九▽ B (鬆・ｺ丞撫繧上★)
- `()`: 諡ｬ蠑ｧ繧剃ｽｿ縺｣縺ｦ蜆ｪ蜈磯・ｽ阪ｒ蛻ｶ蠕｡縺ｧ縺阪∪縺吶ょ・繧悟ｭ舌ｂ蜿ｯ閭ｽ縺ｧ縺吶・- `A nearN B`: A縺ｨB縺君譁・ｭ嶺ｻ･蜀・(鬆・ｺ丈ｸ榊撫)
- `A adjN B`: A竊達縺君譁・ｭ嶺ｻ･蜀・- **驥崎ｦ・** `near` 繧・`adj` 縺ｮ譚｡莉ｶ縺ｮ蜀・Κ縺ｫ縺ｯ `*` (AND) 繧貞性繧√↑縺・〒縺上□縺輔＞・・+` (OR) 縺ｯ蜿ｯ・峨・
# 莉｣陦ｨ譁・鍵繧ｵ繝ｳ繝励Ν
{sampled_docs_str}
"""

        document.getElementById('core-ai-output').innerHTML = '<div class="status-ok">笨・繝励Ο繝ｳ繝励ヨ繧堤函謌舌＠縺ｾ縺励◆</div><pre style="white-space: pre-wrap; font-size: 0.8rem;">' + prompt + '</pre>'
    except Exception as e:
        document.getElementById('core-ai-output').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'

def core_import_json(event):
    global g_core_rules
    raw = document.getElementById('core-json').value.strip()
    if not raw:
        document.getElementById('core-rule-status').innerHTML = '<div class="status-warn">JSON繧貞・蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    try:
        data = json.loads(raw)
        if not isinstance(data, dict):
            raise ValueError('JSON縺ｮ蠖｢蠑上′豁｣縺励￥縺ゅｊ縺ｾ縺帙ｓ')
        for axis, items in data.items():
            if axis not in g_core_rules:
                g_core_rules[axis] = {}
            if isinstance(items, list):
                for item in items:
                    name = item.get('name') or item.get('繧ｫ繝・ざ繝ｪ蜷・)
                    rule = item.get('rule') or item.get('繝ｫ繝ｼ繝ｫ')
                    definition = item.get('definition') or item.get('螳夂ｾｩ', '')
                    if name and rule:
                        g_core_rules[axis][name] = {'rule': rule, 'definition': definition}
        document.getElementById('core-rule-status').innerHTML = '<div class="status-ok">笨・繝ｫ繝ｼ繝ｫ繧偵う繝ｳ繝昴・繝医＠縺ｾ縺励◆</div>'
        update_core_axis_selects()
        render_core_rules()
    except Exception as e:
        document.getElementById('core-rule-status').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'

def core_run_classification(event):
    global g_df_processed, g_col_map, g_core_rules, g_core_df_classified
    if g_df_processed is None:
        document.getElementById('core-run-status').innerHTML = '<div class="status-err">笶・蜈医↓蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧定ｵｷ蜍輔＠縺ｦ縺上□縺輔＞</div>'
        return
    if not g_core_rules:
        document.getElementById('core-run-status').innerHTML = '<div class="status-warn">繝ｫ繝ｼ繝ｫ縺後≠繧翫∪縺帙ｓ</div>'
        return
    df = g_df_processed.copy()
    try:
        combined_text = _core_combined_text(df, g_col_map)
        compiled = {}
        for ax, cats in g_core_rules.items():
            compiled[ax] = []
            for name, cd in cats.items():
                rule = cd['rule'] if isinstance(cd, dict) else cd
                node = parse_core_rule(rule)
                if node:
                    compiled[ax].append((name, node))

        def apply_rules(text, ax_nodes):
            t = _core_text_preprocessor(str(text))
            hits = []
            for c_name, node in ax_nodes:
                if node.evaluate(t):
                    hits.append(c_name)
            return ";".join(hits) if hits else "縺昴・莉・

        for ax in compiled.keys():
            df[ax] = combined_text.apply(lambda x: apply_rules(x, compiled[ax]))

        g_core_df_classified = df
        document.getElementById('core-run-status').innerHTML = '<div class="status-ok">笨・蛻・｡槭′螳御ｺ・＠縺ｾ縺励◆</div>'

        # Summary
        summary_html = ''
        for ax in compiled.keys():
            counts = df[ax].str.split(';').explode().value_counts().head(20)
            summary_html += f'<h4 style="margin-top:0.6rem;">{ax}</h4>'
            summary_html += '<table class="data-table"><tr><th>繧ｫ繝・ざ繝ｪ</th><th>莉ｶ謨ｰ</th></tr>'
            for name, cnt in counts.items():
                summary_html += f'<tr><td>{name}</td><td>{int(cnt)}</td></tr>'
            summary_html += '</table>'
        document.getElementById('core-summary').innerHTML = summary_html

        # CSV
        csv_text = df.to_csv(index=False)
        document.getElementById('core-csv').value = csv_text

        update_core_axis_selects()
    except Exception as e:
        document.getElementById('core-run-status').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'

def core_reanalyze(event):
    global g_core_df_classified, g_core_rules, g_core_reanalyze_prompt
    if g_core_df_classified is None:
        document.getElementById('core-reanalyze-output').innerHTML = '<div class="status-warn">蛻・｡樒ｵ先棡縺後≠繧翫∪縺帙ｓ</div>'
        return
    if not ensure_sklearn():
        document.getElementById('core-reanalyze-output').innerHTML = '<div class="status-warn">霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺吶ゅ＠縺ｰ繧峨￥蠕・▲縺ｦ蜀榊ｮ溯｡後＠縺ｦ縺上□縺輔＞縲・/div>'
        return
    axis = document.getElementById('core-reanalyze-axis').value
    if not axis:
        document.getElementById('core-reanalyze-output').innerHTML = '<div class="status-warn">霆ｸ繧帝∈謚槭＠縺ｦ縺上□縺輔＞</div>'
        return
    df = g_core_df_classified
    others = df[df[axis] == '縺昴・莉・]
    if others.empty:
        document.getElementById('core-reanalyze-output').innerHTML = '<div class="status-ok">笨・縲弱◎縺ｮ莉悶上・縺ゅｊ縺ｾ縺帙ｓ</div>'
        return
    k = int(document.getElementById('core-reanalyze-k').value)
    n = int(document.getElementById('core-reanalyze-n').value)
    use_mece = document.getElementById('core-reanalyze-mece').checked
    try:
        texts = _core_combined_text(others, g_col_map)
        toks = texts.apply(tokenize_text)
        vec = TfidfVectorizer(min_df=1, max_df=0.9, token_pattern=r"(?u)\b\w+\b")
        tfidf = vec.fit_transform(toks)
        actual_k = min(k, len(others))
        if actual_k < 1: actual_k = 1
        km = KMeans(n_clusters=actual_k, random_state=42, n_init=10).fit(tfidf)
        samples = []
        for i in range(actual_k):
            c_idx = np.where(km.labels_ == i)[0]
            if len(c_idx) == 0: continue
            dists = euclidean_distances(tfidf[c_idx], km.cluster_centers_[i].reshape(1, -1))
            top_idx = c_idx[dists.flatten().argsort()[:n]]
            samples.append("\n--- 縺昴・莉悶げ繝ｫ繝ｼ繝・{} ---\n".format(i) + "\n".join(["繝ｻ" + _core_text_preprocessor(texts.iloc[idx]) for idx in top_idx]))

        exist_rules = [f"- {cat}: {d['rule']}" for cat, d in g_core_rules.get(axis, {}).items()]
        exist_rules_str = "\n".join(exist_rules)
        instruction_part = "MECE繧呈э隴倥＠縲√き繝・ざ繝ｪ謨ｰ縺ｯ閾ｪ蜍輔〒譛驕ｩ蛹悶＠縺ｦ縺上□縺輔＞縲・ if use_mece else "**3蛟・* 縺ｮ譁ｰ縺励＞繧ｫ繝・ざ繝ｪ繧定ｿｽ蜉縺励※縺上□縺輔＞縲・
        g_core_reanalyze_prompt = f"""
縺ゅ↑縺溘・迚ｹ險ｱ諠・ｱ繧ｹ繝医Λ繝・ず繧ｹ繝医〒縺吶・蛻・｡櫁ｻｸ縲鶏axis}縲阪〒縲弱◎縺ｮ莉悶上↓谿九▲縺溽音險ｱ繧貞・譫舌＠縲∵眠縺励＞繧ｫ繝・ざ繝ｪ繧呈署譯医＠縺ｦ縺上□縺輔＞縲・
# 譌｢蟄倥・蛻・｡槭Μ繧ｹ繝・{exist_rules_str}

# 萓晞ｼ蜀・ｮｹ
莉･荳九・譛ｪ蛻・｡槭し繝ｳ繝励Ν繧貞・譫舌＠縲∵里蟄伜・鬘槭→驥崎､・＠縺ｪ縺・眠繧ｫ繝・ざ繝ｪ繧呈署譯医＠縺ｦ縺上□縺輔＞縲・{instruction_part}

# JSON繝輔か繝ｼ繝槭ャ繝・{{
  "{axis}": [
    {{"name": "譁ｰ繧ｫ繝・ざ繝ｪ蜷・, "definition": "...", "rule": "隲也炊蠑・}}
  ]
}}

# 譛ｪ蛻・｡樒音險ｱ縺ｮ繧ｵ繝ｳ繝励Ν
{''.join(samples)}
"""
        document.getElementById('core-reanalyze-output').innerHTML = '<div class="status-ok">笨・蜀榊・譫舌・繝ｭ繝ｳ繝励ヨ繧堤函謌舌＠縺ｾ縺励◆</div><pre style="white-space: pre-wrap; font-size: 0.8rem;">' + g_core_reanalyze_prompt + '</pre>'
    except Exception as e:
        document.getElementById('core-reanalyze-output').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'

def core_draw_map(event):
    global g_core_df_classified, g_core_rules, g_col_map
    if g_core_df_classified is None:
        document.getElementById('core-map').innerHTML = '<div class="status-warn">蜈医↓蛻・｡槭ｒ螳溯｡後＠縺ｦ縺上□縺輔＞</div>'
        return
    df = g_core_df_classified.copy()
    x_ax = document.getElementById('core-x-axis').value
    y_ax = document.getElementById('core-y-axis').value
    chart_type = document.getElementById('core-map-type').value
    exclude_other = document.getElementById('core-exclude-other').checked

    def get_axis_series(ax):
        if ax == '蜃ｺ鬘伜ｹｴ':
            return df['year'].fillna(0).astype(int).astype(str), None
        if ax == '蜃ｺ鬘倅ｺｺ':
            col = g_col_map.get('applicant')
            if col and col in df.columns:
                return df[col].fillna('Unknown'), ';'
            return pd.Series(['Unknown'] * len(df)), None
        if ax in df.columns:
            return df[ax].fillna('縺昴・莉・), ';'
        return pd.Series(['縺昴・莉・] * len(df)), None

    x_series, x_sep = get_axis_series(x_ax)
    y_series, y_sep = get_axis_series(y_ax)
    temp = pd.DataFrame({'X': x_series, 'Y': y_series})

    def explode_col(series, sep):
        if sep is None:
            return series.astype(str)
        return series.astype(str).str.split(sep).explode().str.strip()

    temp['X'] = explode_col(temp['X'], x_sep)
    temp['Y'] = explode_col(temp['Y'], y_sep)
    temp = temp[(temp['X'] != '') & (temp['Y'] != '')]
    if exclude_other:
        temp = temp[(temp['X'] != '縺昴・莉・) & (temp['Y'] != '縺昴・莉・)]

    if temp.empty:
        document.getElementById('core-map').innerHTML = '<div class="status-warn">繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return

    pivot = temp.groupby(['X', 'Y']).size().reset_index(name='count')

    if chart_type == 'heatmap':
        x_vals = sorted(pivot['X'].unique())
        y_vals = sorted(pivot['Y'].unique())
        z = pd.pivot_table(pivot, index='Y', columns='X', values='count', fill_value=0).reindex(index=y_vals, columns=x_vals).values
        traces = [{"type": "heatmap", "x": x_vals, "y": y_vals, "z": z, "colorscale": "Blues"}]
        layout = ChartHelper.create_layout(title=f"迚ｹ險ｱ繝槭ャ繝・({x_ax} ﾃ・{y_ax})", height=600)
    else:
        traces = [{
            "type": "scatter",
            "mode": "markers",
            "x": pivot['X'].tolist(),
            "y": pivot['Y'].tolist(),
            "marker": {"size": [max(8, int(c) * 3) for c in pivot['count']], "color": pivot['count'].tolist(), "colorscale": "Blues", "showscale": True},
            "text": [f"{x}<br>{y}<br>{c}莉ｶ" for x, y, c in zip(pivot['X'], pivot['Y'], pivot['count'])],
            "hoverinfo": "text"
        }]
        layout = ChartHelper.create_layout(title=f"迚ｹ險ｱ繝槭ャ繝・({x_ax} ﾃ・{y_ax})", height=600)

    ChartHelper.draw("core-map", traces, layout)

def finish_heavy_init():
    global g_df_processed, g_vectorizer, g_tfidf_matrix, g_feature_names
    if g_df_processed is None or g_tfidf_matrix is not None:
        return
    if not ensure_sklearn():
        return
    try:
        df = g_df_processed
        g_vectorizer = TfidfVectorizer(max_features=2000, min_df=2, max_df=0.95)
        g_tfidf_matrix = g_vectorizer.fit_transform(df['tokenized'].fillna(''))
        g_feature_names = g_vectorizer.get_feature_names_out().tolist()
        try:
            document.getElementById('launch-status').innerHTML += '<div class="status-ok">笨・霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ縺ｮ貅門ｙ縺悟ｮ御ｺ・＠縺ｾ縺励◆</div>'
        except Exception:
            pass
    except Exception:
        pass

def core_search(event):
    global g_df_processed, g_tfidf_matrix, g_vectorizer, g_col_map
    if not require_data(): return
    
    query = document.getElementById('core-query').value.strip()
    if not query:
        document.getElementById('core-results').innerHTML = '<div class="status-warn">繧ｯ繧ｨ繝ｪ繧貞・蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    
    target = document.getElementById('core-target').value
    limit = int(document.getElementById('core-limit').value)
    df = g_df_processed
    cm = g_col_map
    
    try:
        def evaluate_query(text, query):
            text = str(text).lower()
            query = query.strip()
            
            while '(' in query:
                match = re.search(r'\(([^()]+)\)', query)
                if match:
                    inner = match.group(1)
                    result = evaluate_query(text, inner)
                    query = query[:match.start()] + ('TRUE' if result else 'FALSE') + query[match.end():]
                else:
                    break
            
            query = re.sub(r'\bNOT\s+(\S+)', lambda m: 'FALSE' if m.group(1).lower() in text else 'TRUE', query, flags=re.IGNORECASE)
            
            parts = re.split(r'\s+AND\s+', query, flags=re.IGNORECASE)
            for part in parts:
                or_parts = re.split(r'\s+OR\s+', part, flags=re.IGNORECASE)
                or_result = False
                for op in or_parts:
                    op = op.strip()
                    if op == 'TRUE':
                        or_result = True
                    elif op == 'FALSE':
                        pass
                    elif op.lower() in text:
                        or_result = True
                if not or_result:
                    return False
            return True
        
        if target == 'title':
            search_col = cm.get('title', df.columns[0])
        elif target == 'abstract':
            search_col = cm.get('abstract', df.columns[0])
        else:
            search_col = 'text'
        
        if search_col == '(譛ｪ驕ｸ謚・': search_col = 'text'
        
        q_norm = query.replace('AND', '*').replace('and', '*').replace('OR', '+').replace('or', '+')
        use_parser = any(tok in q_norm for tok in ['+', '*', 'near', 'adj', 'NEAR', 'ADJ'])
        if use_parser:
            node = parse_core_rule(q_norm)
            if not node:
                document.getElementById('core-results').innerHTML = '<div class="status-warn">繧ｯ繧ｨ繝ｪ繧定ｧ｣譫舌〒縺阪∪縺帙ｓ</div>'
                return
            mask = df[search_col].apply(lambda x: node.evaluate(_core_text_preprocessor(str(x))))
        else:
            mask = df[search_col].apply(lambda x: evaluate_query(str(x), query))
        results = df[mask].head(limit)
        
        title_col = cm.get('title', df.columns[0])
        if title_col == '(譛ｪ驕ｸ謚・': title_col = df.columns[0]
        
        html = f'<div class="status-ok">剥 {len(results)} 莉ｶ繝偵ャ繝茨ｼ亥・{int(mask.sum())}莉ｶ荳ｭ・・/div>'
        if len(results) > 0:
            html += '<table class="data-table"><tr><th>No.</th><th>繧ｿ繧､繝医Ν</th><th>蟷ｴ</th><th>蜃ｺ鬘倅ｺｺ</th></tr>'
            for i, (_, row) in enumerate(results.iterrows(), 1):
                apps = row.get('applicant_list', [])
                app_str = apps[0][:15] if apps else '-'
                html += f'<tr><td>{i}</td><td>{str(row.get(title_col, ""))[:50]}</td><td>{row.get("year", "-")}</td><td>{app_str}</td></tr>'
            html += '</table>'
        
        document.getElementById('core-results').innerHTML = html
        
    except Exception as e:
        document.getElementById('core-results').innerHTML = f'<div class="status-err">笶・{str(e)}</div>'

# =====================================================
# Saturn V
# =====================================================
def run_saturn(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names, g_col_map
    
    # 繝懊ち繝ｳ縺ｮ繝ｭ繝ｼ繝・ぅ繝ｳ繧ｰ迥ｶ諷九ｒ險ｭ螳・    UIHelper.set_button_loading('btn-saturn-run', True)
    UIHelper.show_chart_loading('saturn-chart', True, '謚陦薙Λ繝ｳ繝峨せ繧ｱ繝ｼ繝励ｒ逕滓・荳ｭ...')
    
    try:
        if g_df_processed is None or g_tfidf_matrix is None:
            UIHelper.show_warning('saturn-status', '繝・・繧ｿ縺瑚ｪｭ縺ｿ霎ｼ縺ｾ繧後※縺・∪縺帙ｓ', '蜈医↓蛻・梵繧ｨ繝ｳ繧ｸ繝ｳ繧定ｵｷ蜍輔＠縺ｦ縺上□縺輔＞')
            return
        if not ensure_sklearn():
            UIHelper.show_info('saturn-status', '霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ', '縺励・繧峨￥蠕・▲縺ｦ蜀榊ｮ溯｡後＠縺ｦ縺上□縺輔＞')
            return
        
        document.getElementById('saturn-status').innerHTML = '<span class="spinner"></span> 險育ｮ嶺ｸｭ...'
        
        df = g_df_processed
        n_clusters = int(document.getElementById('n-clusters').value)
        sample_size = int(document.getElementById('sample-size').value)
        dim_method = document.getElementById('dim-method').value
        
        if sample_size > 0 and sample_size < len(df):
            idx = np.random.choice(len(df), sample_size, replace=False)
            X = g_tfidf_matrix[idx].toarray()
            dfs = df.iloc[idx].copy().reset_index(drop=True)
        else:
            X = g_tfidf_matrix.toarray()
            dfs = df.copy().reset_index(drop=True)
            idx = np.arange(len(df))
        
        if dim_method == 'pca':
            reducer = PCA(n_components=min(50, X.shape[1]))
            X_reduced = reducer.fit_transform(X)
            reducer2d = PCA(n_components=2)
            coords = reducer2d.fit_transform(X_reduced)
        elif dim_method == 'svd':
            reducer = TruncatedSVD(n_components=min(50, X.shape[1]-1))
            X_reduced = reducer.fit_transform(X)
            reducer2d = TruncatedSVD(n_components=2)
            coords = reducer2d.fit_transform(X_reduced)
        else:
            reducer = PCA(n_components=min(30, X.shape[1]))
            X_reduced = reducer.fit_transform(X)
            tsne = TSNE(n_components=2, perplexity=min(30, len(X_reduced)-1), random_state=42, n_iter=300)
            coords = tsne.fit_transform(X_reduced)
        
        kmeans = KMeans(n_clusters=n_clusters, random_state=42, n_init=10)
        labels = kmeans.fit_predict(X_reduced if dim_method != 'tsne' else coords)
        
        dfs['x'] = coords[:, 0]
        dfs['y'] = coords[:, 1]
        dfs['cluster'] = labels
        
        def get_top_words(row_idx, n=3):
            row = g_tfidf_matrix[idx[row_idx]].toarray().flatten()
            top_indices = np.argsort(row)[::-1][:n]
            return ', '.join([g_feature_names[i] for i in top_indices if row[i] > 0][:n])
        
        title_col = g_col_map.get('title', df.columns[0])
        if title_col == '(譛ｪ驕ｸ謚・': title_col = df.columns[0]
        
        # EAGLE繧ｪ繝励す繝ｧ繝ｳ蜿門ｾ・        show_contour = document.getElementById('saturn-contour').checked
        show_hull = document.getElementById('saturn-hull').checked
        show_labels = document.getElementById('saturn-labels').checked
        
        traces = []
        
        # 遲蛾ｫ倡ｷ夊｡ｨ遉ｺ・・istogram2dcontour - 蜈・・Apollo縺ｨ蜷梧ｧ假ｼ・        if show_contour:
            x_all = [float(c) for c in coords[:, 0]]
            y_all = [float(c) for c in coords[:, 1]]
            
            # Plotly.js 縺ｮ histogram2dcontour 繧剃ｽｿ逕ｨ
            debugLog(f'Contour data: {len(x_all)} points')
            traces.append({
                "type": "histogram2dcontour",
                "x": x_all,
                "y": y_all,
                "colorscale": "Blues",
                "reversescale": False,
                "showscale": False,
                "autocontour": True,
                "ncontours": 20,
                "contours": {"coloring": "heatmap", "showlines": True},
                "line": {"width": 0.5, "color": "rgba(255,255,255,0.3)"},
                "hoverinfo": "skip",
                "name": "蟇・ｺｦ遲蛾ｫ倡ｷ・
            })
        
        # 繧ｯ繝ｩ繧ｹ繧ｿ蠅・阜・亥・蛹・ｼ・        if show_hull:
            for k in range(n_clusters):
                cluster_mask = dfs['cluster'] == k
                if cluster_mask.sum() < 3:
                    continue
                cluster_points = coords[cluster_mask]
                
                # 蜃ｸ蛹・ｒ險育ｮ暦ｼ育ｰ｡譏鍋沿・夂せ繧定ｧ貞ｺｦ縺ｧ繧ｽ繝ｼ繝茨ｼ・                # scipy 縺後↑縺・ｴ蜷医〒繧ょ虚菴懊☆繧狗ｰ｡譏鍋噪縺ｪ螟門捉險育ｮ・                center = cluster_points.mean(axis=0)
                angles = np.arctan2(cluster_points[:, 1] - center[1], 
                                   cluster_points[:, 0] - center[0])
                sorted_idx = np.argsort(angles)
                # 螟門捉縺ｮ轤ｹ縺ｮ縺ｿ繧呈歓蜃ｺ・亥・轤ｹ縺ｮ20%縺ｾ縺溘・譛菴・轤ｹ・・                n_hull = max(8, len(sorted_idx) // 5)
                step = max(1, len(sorted_idx) // n_hull)
                hull_idx = sorted_idx[::step]
                sorted_points = cluster_points[hull_idx]
                hull_x = list(sorted_points[:, 0]) + [sorted_points[0, 0]]
                hull_y = list(sorted_points[:, 1]) + [sorted_points[0, 1]]
                
                # 濶ｲ繧定ｧ｣譫・                color = COLOR_SEQUENCE[k % len(COLOR_SEQUENCE)]
                r = int(color[1:3], 16)
                g = int(color[3:5], 16)
                b = int(color[5:7], 16)
                
                traces.append({
                    "type": "scatter",
                    "mode": "lines",
                    "x": [float(x) for x in hull_x],
                    "y": [float(y) for y in hull_y],
                    "line": {"color": color, "width": 2, "dash": "dot"},
                    "fill": "toself",
                    "fillcolor": f"rgba({r},{g},{b},0.1)",
                    "showlegend": False,
                    "hoverinfo": "skip",
                    "name": f"C{k+1}蠅・阜"
                })
        
        # 繧ｯ繝ｩ繧ｹ繧ｿ謨｣蟶・峙
        for k in range(n_clusters):
            mask = dfs['cluster'] == k
            if mask.sum() == 0: continue
            subset = dfs[mask]
            subset_idx = np.where(mask)[0]
            
            # 繝帙ヰ繝ｼ繝・く繧ｹ繝茨ｼ亥ｸｸ譎り｡ｨ遉ｺ縺ｧ縺ｯ縺ｪ縺上√・繝舌・譎ゅ・縺ｿ・・            hover_texts = []
            for i in subset_idx:
                title = str(dfs.iloc[i].get(title_col, ''))[:40]
                apps = dfs.iloc[i].get('applicant_list', [])
                app = apps[0][:20] if apps else '-'
                kw = get_top_words(i)
                hover_texts.append(f'<b>{title}...</b><br>蜃ｺ鬘倅ｺｺ: {app}<br>KW: {kw}')
            
            trace = {
                "x": [float(x) for x in subset['x']],
                "y": [float(y) for y in subset['y']],
                "mode": "markers",
                "type": "scatter",
                "name": f"C{k+1} ({len(subset)}莉ｶ)",
                "text": hover_texts,
                "hoverinfo": "text",
                "marker": {"size": 8, "color": COLOR_SEQUENCE[k % len(COLOR_SEQUENCE)], "opacity": 0.75, "line": {"width": 0.5, "color": "#fff"}}
            }
            
            traces.append(trace)
        
        # 繧ｯ繝ｩ繧ｹ繧ｿ荳ｭ蠢・Λ繝吶Ν
        if show_labels:
            center_x = []
            center_y = []
            center_text = []
            for k in range(n_clusters):
                mask = dfs['cluster'] == k
                if mask.sum() == 0: continue
                cx = dfs.loc[mask, 'x'].mean()
                cy = dfs.loc[mask, 'y'].mean()
                center_x.append(float(cx))
                center_y.append(float(cy))
                
                # 繧ｯ繝ｩ繧ｹ繧ｿ縺ｮ荳ｻ隕√く繝ｼ繝ｯ繝ｼ繝峨ｒ蜿門ｾ・                cluster_indices = np.where(mask)[0]
                cluster_tfidf = g_tfidf_matrix[idx[cluster_indices]].mean(axis=0).A1
                top_idx = np.argsort(cluster_tfidf)[::-1][:2]
                top_kw = ', '.join([g_feature_names[i] for i in top_idx])
                center_text.append(f"<b>C{k+1}</b><br>{top_kw}")
            
            traces.append({
                "x": center_x,
                "y": center_y,
                "mode": "text",
                "type": "scatter",
                "text": center_text,
                "textfont": {"size": 11, "color": "#fff"},
                "showlegend": False,
                "hoverinfo": "skip"
            })
        
        layout = ChartHelper.create_layout(
            title=f"謚陦薙Λ繝ｳ繝峨せ繧ｱ繝ｼ繝・({dim_method.upper()} + K-Means)",
            height=600,
            showlegend=True,
            legend={"orientation": "h", "y": -0.1}
        )
        ChartHelper.draw("saturn-chart", traces, layout)
        
        html = '<h4 style="margin-top: 0.5rem;">繧ｯ繝ｩ繧ｹ繧ｿ繧ｵ繝槭Μ繝ｼ</h4><table class="data-table"><tr><th>繧ｯ繝ｩ繧ｹ繧ｿ</th><th>莉ｶ謨ｰ</th><th>荳ｻ隕√く繝ｼ繝ｯ繝ｼ繝・/th></tr>'
        for k in range(n_clusters):
            mask = dfs['cluster'] == k
            cnt = int(mask.sum())
            if cnt > 0:
                cluster_indices = np.where(mask)[0]
                cluster_tfidf = g_tfidf_matrix[idx[cluster_indices]].mean(axis=0).A1
                top_indices = np.argsort(cluster_tfidf)[::-1][:5]
                top_words = ', '.join([g_feature_names[i] for i in top_indices])
                html += f'<tr><td style="color:{COLOR_SEQUENCE[k % len(COLOR_SEQUENCE)]}; font-weight:bold;">C{k+1}</td><td>{cnt}</td><td style="font-size:0.75rem;">{top_words}</td></tr>'
        html += '</table>'
        document.getElementById('saturn-summary').innerHTML = html
        UIHelper.show_success('saturn-status', '蛻・梵螳御ｺ・, f'{n_clusters}繧ｯ繝ｩ繧ｹ繧ｿ繧呈､懷・縺励∪縺励◆')
        
    except Exception as e:
        import traceback
        UIHelper.show_error('saturn-status', '繧ｨ繝ｩ繝ｼ縺檎匱逕溘＠縺ｾ縺励◆', str(e))
        debugLog(traceback.format_exc())
    finally:
        UIHelper.set_button_loading('btn-saturn-run', False)
        UIHelper.show_chart_loading('saturn-chart', False)

# =====================================================
# Explorer
# =====================================================
def show_keywords(event):
    global g_tfidf_matrix, g_feature_names
    if not require_tfidf(): return
    
    top_n = int(document.getElementById('keyword-top').value)
    
    sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
    top_indices = np.argsort(sums)[::-1][:top_n]
    
    words = [g_feature_names[i] for i in top_indices]
    scores = [float(sums[i]) for i in top_indices]
    
    colors = [f'rgba(79, 195, 247, {0.4 + 0.6 * (1 - i/top_n)})' for i in range(top_n)]
    
    traces = [ChartHelper.create_bar_trace(
        x=scores[::-1],
        y=words[::-1],
        orientation="h"
    )]
    traces[0]["marker"]["color"] = colors[::-1]
    layout = ChartHelper.create_horizontal_bar_layout(
        title=f"繧ｭ繝ｼ繝ｯ繝ｼ繝峨Λ繝ｳ繧ｭ繝ｳ繧ｰ TOP{top_n}",
        x_title="",
        y_title="",
        left_margin=150
    )
    layout["yaxis"]["categoryorder"] = "total ascending"
    layout["height"] = max(450, top_n * 20)
    ChartHelper.draw("keyword-chart", traces, layout)

def show_trend(event):
    global g_df_processed
    if not require_data(): return
    
    keywords = [k.strip() for k in document.getElementById('trend-keywords').value.split(',') if k.strip()]
    if not keywords:
        document.getElementById('trend-chart').innerHTML = '<div class="status-warn">繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    
    df = g_df_processed
    
    traces = []
    for i, kw in enumerate(keywords[:5]):
        mask = df['tokenized'].str.contains(kw.lower(), na=False)
        trend = df[mask].groupby('year').size()
        trend = trend[trend.index > 0].sort_index()
        
        traces.append(ChartHelper.create_line_trace(
            x=[int(x) for x in trend.index],
            y=[int(y) for y in trend.values],
            name=kw,
            color=COLOR_SEQUENCE[i % len(COLOR_SEQUENCE)]
        ))
    
    layout = ChartHelper.create_layout(
        title="繧ｭ繝ｼ繝ｯ繝ｼ繝峨ヨ繝ｬ繝ｳ繝・,
        height=450,
        xaxis={"title": "蟷ｴ"},
        yaxis={"title": "蜃ｺ迴ｾ莉ｶ謨ｰ", "rangemode": "tozero"}
    )
    ChartHelper.draw("trend-chart", traces, layout)

def compare_companies(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data(): return
    
    sel = document.getElementById('compare-companies')
    companies = [sel.options.item(i).value for i in range(sel.options.length) if sel.options.item(i).selected]
    
    if len(companies) < 2:
        document.getElementById('compare-chart').innerHTML = '<div class="status-warn">2遉ｾ莉･荳企∈謚槭＠縺ｦ縺上□縺輔＞</div>'
        return
    
    df = g_df_processed
    
    traces = []
    for i, company in enumerate(companies[:6]):
        mask = df['applicant_list'].apply(lambda x: company in x if x else False)
        company_indices = np.where(mask)[0]
        
        if len(company_indices) > 0:
            company_tfidf = g_tfidf_matrix[company_indices].mean(axis=0).A1
            top_indices = np.argsort(company_tfidf)[::-1][:10]
            words = [g_feature_names[j] for j in top_indices]
            scores = [float(company_tfidf[j]) for j in top_indices]
            
            traces.append({
                "type": "scatterpolar",
                "r": scores + [scores[0]],
                "theta": words + [words[0]],
                "fill": "toself",
                "name": company[:20],
                "line": {"color": COLOR_SEQUENCE[i % len(COLOR_SEQUENCE)]},
                "opacity": 0.7
            })
    
    layout = ChartHelper.create_layout(
        title="莨∵･ｭ繧ｭ繝ｼ繝ｯ繝ｼ繝峨・繝ｭ繝輔ぃ繧､繝ｫ豈碑ｼ・,
        polar={"radialaxis": {"visible": True, "range": [0, max([max(t['r']) for t in traces]) * 1.1]}},
        height=550,
        showlegend=True
    )
    ChartHelper.draw("compare-chart", traces, layout)

def show_heatmap(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data(): return
    
    n_companies = int(document.getElementById('heatmap-companies').value)
    n_keywords = int(document.getElementById('heatmap-keywords').value)
    
    df = g_df_processed
    
    top_companies = df.explode('applicant_list')['applicant_list'].value_counts().head(n_companies).index.tolist()
    
    sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
    top_kw_indices = np.argsort(sums)[::-1][:n_keywords]
    top_keywords = [g_feature_names[i] for i in top_kw_indices]
    
    z = []
    for company in top_companies:
        mask = df['applicant_list'].apply(lambda x: company in x if x else False)
        company_indices = np.where(mask)[0]
        if len(company_indices) > 0:
            company_tfidf = g_tfidf_matrix[company_indices].mean(axis=0).A1
            row = [float(company_tfidf[i]) for i in top_kw_indices]
        else:
            row = [0] * n_keywords
        z.append(row)
    
    traces = [{
        "type": "heatmap",
        "z": z,
        "x": top_keywords,
        "y": [c[:15] for c in top_companies],
        "colorscale": "Blues",
        "showscale": True
    }]
    layout = ChartHelper.create_layout(
        title="莨∵･ｭﾃ励く繝ｼ繝ｯ繝ｼ繝・繝偵・繝医・繝・・",
        height=max(450, n_companies * 30),
        margin={"l": 150, "b": 120},
        xaxis={"tickangle": -45}
    )
    ChartHelper.draw("heatmap-chart", traces, layout)

# =====================================================
# Explorer - 諤･荳頑・繝ｯ繝ｼ繝画､懷・
# =====================================================
def show_emerging(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names, g_vectorizer
    if not require_data(): return
    
    base_year = int(document.getElementById('emerging-year').value)
    top_n = int(document.getElementById('emerging-top').value)
    
    df = g_df_processed
    
    # 譛滄俣蛻・牡
    df_old = df[df['year'] < base_year]
    df_new = df[df['year'] >= base_year]
    
    if len(df_old) < 10 or len(df_new) < 10:
        document.getElementById('emerging-chart').innerHTML = '<div class="status-warn">繝・・繧ｿ縺御ｸ崎ｶｳ縺励※縺・∪縺呻ｼ域悄髢薙ｒ隱ｿ謨ｴ縺励※縺上□縺輔＞・・/div>'
        return
    
    # 蜷・悄髢薙・繧ｭ繝ｼ繝ｯ繝ｼ繝蛾ｻ蠎ｦ繧定ｨ育ｮ・    old_indices = df_old.index.tolist()
    new_indices = df_new.index.tolist()
    
    # 繧､繝ｳ繝・ャ繧ｯ繧ｹ繧偵・繝・ヴ繝ｳ繧ｰ
    old_mask = df.index.isin(old_indices)
    new_mask = df.index.isin(new_indices)
    
    old_idx = np.where(old_mask)[0]
    new_idx = np.where(new_mask)[0]
    
    if len(old_idx) == 0 or len(new_idx) == 0:
        document.getElementById('emerging-chart').innerHTML = '<div class="status-warn">譛滄俣繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # TF-IDF蜷郁ｨ医ｒ險育ｮ・    old_tfidf = np.array(g_tfidf_matrix[old_idx].sum(axis=0)).flatten() / len(old_idx)
    new_tfidf = np.array(g_tfidf_matrix[new_idx].sum(axis=0)).flatten() / len(new_idx)
    
    # 謌宣聞邇・ｒ險育ｮ暦ｼ域眠譛滄俣/譌ｧ譛滄俣 - 1・・    growth = np.zeros(len(g_feature_names))
    for i in range(len(g_feature_names)):
        if old_tfidf[i] > 0.001:
            growth[i] = (new_tfidf[i] - old_tfidf[i]) / old_tfidf[i]
        elif new_tfidf[i] > 0.01:
            growth[i] = 10  # 譁ｰ蜃ｺ繧ｭ繝ｼ繝ｯ繝ｼ繝・    
    # 譁ｰ譛滄俣縺ｧ荳螳壻ｻ･荳翫・鬆ｻ蠎ｦ縺後≠繧九ｂ縺ｮ縺ｮ縺ｿ
    valid_mask = new_tfidf > 0.005
    growth[~valid_mask] = -999
    
    top_indices = np.argsort(growth)[::-1][:top_n]
    
    words = [g_feature_names[i] for i in top_indices]
    growth_rates = [float(growth[i]) * 100 for i in top_indices]  # 繝代・繧ｻ繝ｳ繝・・繧ｸ
    
    # D3繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ譽偵げ繝ｩ繝慕畑縺ｮ繝・・繧ｿ貅門ｙ
    bar_data = [{"label": f"{w} (+{g:.0f}%)" if g > 0 else f"{w} ({g:.0f}%)", "value": g} 
                for w, g in zip(words, growth_rates)]
    title = f"諤･荳頑・繧ｭ繝ｼ繝ｯ繝ｼ繝・TOP{top_n}・・base_year}蟷ｴ莉･髯・vs 莉･蜑搾ｼ・
    
    # D3.js縺ｧ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″譽偵げ繝ｩ繝輔ｒ謠冗判
    js.drawAnimatedBarChart("emerging-chart", json.dumps(bar_data), title, "viridis")

# =====================================================
# KWIC讀懃ｴ｢ (Keyword in Context)
# =====================================================
def kwic_search(event):
    global g_df_processed
    if g_df_processed is None:
        document.getElementById('kwic-result').innerHTML = '<div class="status-warn">繝・・繧ｿ縺瑚ｪｭ縺ｿ霎ｼ縺ｾ繧後※縺・∪縺帙ｓ</div>'
        return
    
    keyword = document.getElementById('kwic-keyword').value.strip()
    if not keyword:
        document.getElementById('kwic-result').innerHTML = '<div class="status-warn">繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ蜈･蜉帙＠縺ｦ縺上□縺輔＞</div>'
        return
    
    context_len = int(document.getElementById('kwic-context').value)
    target = document.getElementById('kwic-target').value
    
    df = g_df_processed
    
    # 讀懃ｴ｢蟇ｾ雎｡蛻励ｒ豎ｺ螳・    target_col = None
    target_cols = {
        'title': ['逋ｺ譏弱・蜷咲ｧｰ', 'title', 'Title', '蜷咲ｧｰ'],
        'abstract': ['隕∫ｴ・, 'abstract', 'Abstract', '讎りｦ・],
        'claims': ['隲区ｱる・, 'claims', 'Claims', '隲区ｱゅ・遽・峇']
    }
    
    for col_name in target_cols.get(target, []):
        if col_name in df.columns:
            target_col = col_name
            break
    
    if target_col is None:
        document.getElementById('kwic-result').innerHTML = f'<div class="status-warn">蟇ｾ雎｡蛻励′隕九▽縺九ｊ縺ｾ縺帙ｓ・・target}・・/div>'
        return
    
    results = []
    keyword_lower = keyword.lower()
    
    for idx, row in df.iterrows():
        text = str(row.get(target_col, ''))
        if not text:
            continue
        
        text_lower = text.lower()
        pos = 0
        while True:
            pos = text_lower.find(keyword_lower, pos)
            if pos == -1:
                break
            
            start = max(0, pos - context_len)
            end = min(len(text), pos + len(keyword) + context_len)
            
            before = text[start:pos]
            match = text[pos:pos + len(keyword)]
            after = text[pos + len(keyword):end]
            
            prefix = '...' if start > 0 else ''
            suffix = '...' if end < len(text) else ''
            
            doc_id = str(row.get('publication_number', row.get('蜃ｺ鬘倡分蜿ｷ', idx)))[:20]
            applicant = str(row.get('applicant_list', [''])[0] if isinstance(row.get('applicant_list'), list) else row.get('蜃ｺ鬘倅ｺｺ', ''))[:20]
            
            results.append({
                'doc_id': doc_id,
                'applicant': applicant,
                'context': f'{prefix}{before}<mark style="background:#ffd93d;color:#000;font-weight:bold;">{match}</mark>{after}{suffix}'
            })
            
            pos += len(keyword)
            
            if len(results) >= 100:  # 譛螟ｧ100莉ｶ
                break
        
        if len(results) >= 100:
            break
    
    if not results:
        document.getElementById('kwic-result').innerHTML = f'<div class="status-warn">縲鶏keyword}縲阪′隕九▽縺九ｊ縺ｾ縺帙ｓ縺ｧ縺励◆</div>'
        return
    
    html = f'''
        <div style="margin-bottom: 0.5rem; color: #4fc3f7;">
            <strong>讀懃ｴ｢邨先棡: {len(results)}莉ｶ</strong>・域怙螟ｧ100莉ｶ陦ｨ遉ｺ・・        </div>
        <table class="data-table" style="font-size: 0.85rem;">
            <tr><th style="width:15%;">譁・嶌ID</th><th style="width:15%;">蜃ｺ鬘倅ｺｺ</th><th>繧ｳ繝ｳ繝・く繧ｹ繝・/th></tr>
    '''
    
    for r in results:
        html += f'<tr><td>{r["doc_id"]}</td><td>{r["applicant"]}</td><td style="text-align:left;">{r["context"]}</td></tr>'
    
    html += '</table>'
    document.getElementById('kwic-result').innerHTML = html

# =====================================================
# CREW - 繝阪ャ繝医Ρ繝ｼ繧ｯ蛻・梵
# =====================================================
def build_network(event):
    global g_df_processed
    if not require_data(): return
    if not ensure_networkx():
        document.getElementById('network-status').innerHTML = '<div class="status-warn">霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺吶ゅ＠縺ｰ繧峨￥蠕・▲縺ｦ蜀榊ｮ溯｡後＠縺ｦ縺上□縺輔＞縲・/div>'
        return
    
    document.getElementById('network-status').innerHTML = '<div class="spinner" style="width:25px;height:25px;display:inline-block;"></div> 讒狗ｯ我ｸｭ...'
    
    try:
        df = g_df_processed
        network_type = document.getElementById('network-type').value
        min_edge = int(document.getElementById('min-edge').value)
        
        G = nx.Graph()
        
        if network_type == 'inventor':
            col = 'inventor_list'
        elif network_type == 'applicant':
            col = 'applicant_list'
        else:
            col = 'ipc_list'
        
        edge_counts = Counter()
        for items in df[col]:
            if len(items) >= 2:
                for i in range(len(items)):
                    for j in range(i+1, len(items)):
                        edge = tuple(sorted([items[i], items[j]]))
                        edge_counts[edge] += 1
        
        for (n1, n2), weight in edge_counts.items():
            if weight >= min_edge:
                G.add_edge(n1, n2, weight=weight)
        
        if len(G.nodes()) == 0:
            document.getElementById('network-status').innerHTML = '<div class="status-warn">繝弱・繝峨′縺ゅｊ縺ｾ縺帙ｓ・域怙蟆上お繝・ず驥阪∩繧剃ｸ九￡縺ｦ縺上□縺輔＞・・/div>'
            return
        
        # 繝弱・繝画焚蛻ｶ髯・        max_nodes = int(document.getElementById('network-max-nodes').value)
        if len(G.nodes()) > max_nodes:
            # 谺｡謨ｰ荳贋ｽ阪・繝弱・繝峨・縺ｿ繧呈ｮ九☆
            degrees_all = dict(G.degree())
            top_nodes_list = sorted(degrees_all.items(), key=lambda x: -x[1])[:max_nodes]
            keep_nodes = set([n for n, _ in top_nodes_list])
            G = G.subgraph(keep_nodes).copy()
        
        pos = nx.spring_layout(G, k=2/np.sqrt(len(G.nodes())), iterations=50, seed=42)
        
        # 荳ｭ蠢・ｧ謖・ｨ吶ｒ驕ｸ謚・        centrality_type = document.getElementById('network-centrality').value
        
        if centrality_type == 'betweenness':
            centrality = nx.betweenness_centrality(G)
            centrality_name = '蟐剃ｻ倶ｸｭ蠢・ｧ'
        elif centrality_type == 'closeness':
            centrality = nx.closeness_centrality(G)
            centrality_name = '霑第磁荳ｭ蠢・ｧ'
        elif centrality_type == 'eigenvector':
            try:
                centrality = nx.eigenvector_centrality(G, max_iter=100)
            except:
                centrality = nx.degree_centrality(G)
            centrality_name = '蝗ｺ譛峨・繧ｯ繝医Ν荳ｭ蠢・ｧ'
        else:
            centrality = nx.degree_centrality(G)
            centrality_name = '谺｡謨ｰ荳ｭ蠢・ｧ'
        
        degrees = dict(G.degree())
        max_degree = max(degrees.values()) if degrees else 1
        max_centrality = max(centrality.values()) if centrality else 1
        
        # D3 Force逕ｨ縺ｮ繝弱・繝峨ョ繝ｼ繧ｿ繧呈ｺ門ｙ
        nodes_data = []
        for i, n in enumerate(G.nodes()):
            nodes_data.append({
                "id": n,
                "label": str(n),
                "size": 8 + 20 * (degrees[n] / max_degree),
                "degree": degrees[n],
                "centrality": centrality[n],
                "group": i % 10
            })
        
        # D3 Force逕ｨ縺ｮ繝ｪ繝ｳ繧ｯ繝・・繧ｿ繧呈ｺ門ｙ
        links_data = []
        for edge in G.edges(data=True):
            links_data.append({
                "source": edge[0],
                "target": edge[1],
                "weight": edge[2].get('weight', 1)
            })
        
        type_name = {'inventor': '逋ｺ譏手・, 'applicant': '蜃ｺ鬘倅ｺｺ', 'ipc': 'IPC'}[network_type]
        title = f"{type_name}繝阪ャ繝医Ρ繝ｼ繧ｯ・・len(G.nodes())}繝弱・繝・ {centrality_name}・・
        
        # D3.js縺ｧ繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑繝阪ャ繝医Ρ繝ｼ繧ｯ繧呈緒逕ｻ
        js.drawForceNetwork("network-chart", json.dumps(nodes_data), json.dumps(links_data), title)
        
        html = f'''
            <div class="metrics">
                <div class="metric"><div class="metric-value">{len(G.nodes())}</div><div class="metric-label">繝弱・繝画焚</div></div>
                <div class="metric"><div class="metric-value">{len(G.edges())}</div><div class="metric-label">繧ｨ繝・ず謨ｰ</div></div>
                <div class="metric"><div class="metric-value">{nx.number_connected_components(G)}</div><div class="metric-label">騾｣邨先・蛻・/div></div>
                <div class="metric"><div class="metric-value">{nx.density(G):.3f}</div><div class="metric-label">蟇・ｺｦ</div></div>
            </div>
            <p style="color:#4fc3f7; margin:0.5rem 0; font-size:0.9rem;">庁 繝弱・繝峨ｒ繝峨Λ繝・げ縺励※蜍輔°縺帙∪縺・/p>
            <h4>{centrality_name} TOP10</h4>
            <table class="data-table"><tr><th>繝弱・繝・/th><th>谺｡謨ｰ</th><th>{centrality_name}</th></tr>
        '''
        top_nodes = sorted(centrality.items(), key=lambda x: -x[1])[:10]
        for node, cent in top_nodes:
            html += f'<tr><td>{str(node)[:30]}</td><td>{degrees[node]}</td><td>{cent:.3f}</td></tr>'
        html += '</table>'
        document.getElementById('network-stats').innerHTML = html
        document.getElementById('network-status').innerHTML = '<span class="status-ok">笨・螳御ｺ・/span>'
        
    except Exception as e:
        import traceback
        document.getElementById('network-status').innerHTML = f'<span class="status-err">笶・{str(e)}</span>'
        debugLog(traceback.format_exc())

# =====================================================
# MEGA - 繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝会ｼ・3-cloud菴ｿ逕ｨ・・# =====================================================
def show_wordcloud(event):
    """
    d3-cloud繧剃ｽｿ逕ｨ縺励◆譛ｬ譬ｼ逧・↑繝ｯ繝ｼ繝峨け繝ｩ繧ｦ繝峨ｒ逕滓・縺吶ｋ縲・    TF-IDF繧ｹ繧ｳ繧｢縺ｫ蝓ｺ縺･縺・※蜊倩ｪ槭・繧ｵ繧､繧ｺ縺ｨ驟咲ｽｮ繧呈ｱｺ螳壹・    """
    global g_tfidf_matrix, g_feature_names
    if g_tfidf_matrix is None:
        document.getElementById('wordcloud-chart').innerHTML = '<div class="status-warn">蜈医↓TF-IDF蛻・梵繧貞ｮ溯｡後＠縺ｦ縺上□縺輔＞</div>'
        return
    
    max_words = int(document.getElementById('wc-max-words').value)
    colorscheme = document.getElementById('wc-colorscheme').value
    
    # TF-IDF繧ｹ繧ｳ繧｢縺ｮ蜷郁ｨ医ｒ險育ｮ・    sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
    top_indices = np.argsort(sums)[::-1][:max_words]
    
    # 蜊倩ｪ槭ョ繝ｼ繧ｿ繧呈ｺ門ｙ・・3-cloud逕ｨ・・    word_data = []
    for i in top_indices:
        word_data.append({
            "text": g_feature_names[i],
            "score": float(sums[i])
        })
    
    # JavaScript蛛ｴ縺ｮdrawWordCloud髢｢謨ｰ繧貞他縺ｳ蜃ｺ縺・    js.drawWordCloud("wordcloud-chart", json.dumps(word_data), colorscheme)

# =====================================================
# MEGA - N-gram蛻・梵
# =====================================================
def show_ngram(event):
    global g_df_processed
    if not require_data(): return
    
    n = int(document.getElementById('ngram-size').value)
    top_n = int(document.getElementById('ngram-top').value)
    
    df = g_df_processed
    
    # N-gram繧呈歓蜃ｺ
    ngram_counter = Counter()
    for tokens in df['tokenized'].dropna():
        words = tokens.split()
        if len(words) >= n:
            for i in range(len(words) - n + 1):
                ngram = ' '.join(words[i:i+n])
                ngram_counter[ngram] += 1
    
    top_ngrams = ngram_counter.most_common(top_n)
    
    if not top_ngrams:
        document.getElementById('ngram-chart').innerHTML = '<div class="status-warn">N-gram縺瑚ｦ九▽縺九ｊ縺ｾ縺帙ｓ</div>'
        return
    
    # D3繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ譽偵げ繝ｩ繝慕畑縺ｮ繝・・繧ｿ貅門ｙ
    bar_data = [{"label": ng, "value": int(c)} for ng, c in top_ngrams]
    title = f"{'繝舌う' if n==2 else '繝医Λ繧､'}繧ｰ繝ｩ繝 TOP{top_n}"
    
    # D3.js縺ｧ繧｢繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ莉倥″譽偵げ繝ｩ繝輔ｒ謠冗判
    js.drawAnimatedBarChart("ngram-chart", json.dumps(bar_data), title, "warm")

# =====================================================
# MEGA - 蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ
# =====================================================
def show_cooccurrence(event):
    global g_df_processed, g_feature_names, g_tfidf_matrix
    if not require_data(): return
    if not ensure_networkx():
        document.getElementById('cooccur-chart').innerHTML = '<div class="status-warn">霑ｽ蜉繝｢繧ｸ繝･繝ｼ繝ｫ繧定ｪｭ縺ｿ霎ｼ縺ｿ荳ｭ縺ｧ縺吶ゅ＠縺ｰ繧峨￥蠕・▲縺ｦ蜀榊ｮ溯｡後＠縺ｦ縺上□縺輔＞縲・/div>'
        return
    
    n_nodes = int(document.getElementById('cooccur-nodes').value)
    min_cooccur = int(document.getElementById('cooccur-min').value)
    
    df = g_df_processed
    
    # 鬆ｻ蜃ｺ繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ謚ｽ蜃ｺ
    sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
    top_indices = np.argsort(sums)[::-1][:n_nodes]
    top_words = [g_feature_names[i] for i in top_indices]
    top_words_set = set(top_words)
    
    # 蜈ｱ襍ｷ繧ｫ繧ｦ繝ｳ繝・    cooccur = Counter()
    for tokens in df['tokenized'].dropna():
        words = [w for w in tokens.split() if w in top_words_set]
        words = list(set(words))
        if len(words) >= 2:
            for i in range(len(words)):
                for j in range(i+1, len(words)):
                    pair = tuple(sorted([words[i], words[j]]))
                    cooccur[pair] += 1
    
    # 繝阪ャ繝医Ρ繝ｼ繧ｯ讒狗ｯ・    G = nx.Graph()
    for (w1, w2), cnt in cooccur.items():
        if cnt >= min_cooccur:
            G.add_edge(w1, w2, weight=cnt)
    
    if len(G.nodes()) == 0:
        document.getElementById('cooccur-chart').innerHTML = '<div class="status-warn">蜈ｱ襍ｷ髢｢菫ゅ′縺ゅｊ縺ｾ縺帙ｓ・磯明蛟､繧剃ｸ九￡縺ｦ縺上□縺輔＞・・/div>'
        return
    
    degrees = dict(G.degree())
    max_deg = max(degrees.values()) if degrees else 1
    
    # D3 Force逕ｨ縺ｮ繝弱・繝峨ョ繝ｼ繧ｿ
    nodes_data = []
    for i, n in enumerate(G.nodes()):
        nodes_data.append({
            "id": n,
            "label": str(n),
            "size": 6 + 10 * (degrees[n] / max_deg),
            "degree": degrees[n],
            "centrality": degrees[n] / max_deg,
            "group": i % 10
        })
    
    # D3 Force逕ｨ縺ｮ繝ｪ繝ｳ繧ｯ繝・・繧ｿ
    links_data = []
    for edge in G.edges(data=True):
        links_data.append({
            "source": edge[0],
            "target": edge[1],
            "weight": edge[2].get('weight', 1)
        })
    
    title = f"繧ｭ繝ｼ繝ｯ繝ｼ繝牙・襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ・・len(G.nodes())}隱・ {len(G.edges())}繧ｨ繝・ず・・
    
    # D3.js縺ｧ繧､繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑蜈ｱ襍ｷ繝阪ャ繝医Ρ繝ｼ繧ｯ繧呈緒逕ｻ
    js.drawForceNetwork("cooccur-chart", json.dumps(nodes_data), json.dumps(links_data), title)

# =====================================================
# NOVA - 繧｢繝峨ヰ繝ｳ繧ｹ繝牙庄隕門喧・・yScript髯仙ｮ壽ｩ溯・・・# =====================================================

def show_sankey(event):
    """
    繧ｵ繝ｳ繧ｭ繝ｼ繝繧､繧｢繧ｰ繝ｩ繝繧堤函謌舌☆繧具ｼ・3.js迚茨ｼ峨・    蜃ｺ鬘倅ｺｺ縺ｨ謚陦灘・驥趣ｼ・PC/FI・峨・髢｢菫ゅｒ繝輔Ο繝ｼ蝗ｳ縺ｧ蜿ｯ隕門喧縲・    
    Parameters
    ----------
    event : Event
        繝懊ち繝ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・    """
    global g_df_processed
    if not require_data('sankey-chart', '繝・・繧ｿ繧定ｪｭ縺ｿ霎ｼ繧薙〒縺上□縺輔＞'):
        return
    
    n_applicants = int(document.getElementById('sankey-applicants').value)
    n_ipcs = int(document.getElementById('sankey-ipcs').value)
    color_scheme = document.getElementById('sankey-color').value
    
    df = g_df_processed.copy()
    
    # 蜃ｺ鬘倅ｺｺ縺ｨIPC/FI縺ｮ髮・ｨ茨ｼ・PC縺後↑縺代ｌ縺ｰFI繧剃ｽｿ逕ｨ・・    rows = []
    for _, row in df.iterrows():
        apps = row.get('applicant_list', [])
        # IPC繧貞━蜈医√↑縺代ｌ縺ｰFI繧剃ｽｿ逕ｨ
        ipcs = row.get('ipc_list', [])
        if not ipcs:
            ipcs = row.get('fi_list', [])
        if not apps or not ipcs:
            continue
        for app in apps[:2]:  # 譛螟ｧ2蜃ｺ鬘倅ｺｺ
            for ipc in ipcs[:2]:  # 譛螟ｧ2IPC/FI
                ipc_main = ipc[:4] if len(ipc) >= 4 else ipc
                rows.append({'applicant': app.strip(), 'ipc': ipc_main})
    
    if not rows:
        document.getElementById('sankey-chart').innerHTML = '<div class="status-warn">蜃ｺ鬘倅ｺｺ/IPC繝ｻFI繝・・繧ｿ縺御ｸ崎ｶｳ縺励※縺・∪縺・/div>'
        return
    
    flow_df = pd.DataFrame(rows)
    
    # 荳贋ｽ榊・鬘倅ｺｺ
    top_apps = flow_df['applicant'].value_counts().head(n_applicants).index.tolist()
    
    # 荳贋ｽ巧PC/FI
    top_ipcs = flow_df['ipc'].value_counts().head(n_ipcs).index.tolist()
    
    # 繝輔ぅ繝ｫ繧ｿ繝ｪ繝ｳ繧ｰ
    flow_df = flow_df[flow_df['applicant'].isin(top_apps) & flow_df['ipc'].isin(top_ipcs)]
    flow_counts = flow_df.groupby(['applicant', 'ipc']).size().reset_index(name='count')
    
    # 繧ｵ繝ｳ繧ｭ繝ｼ逕ｨ繝・・繧ｿ讒矩
    nodes = []
    node_map = {}
    
    for app in top_apps:
        node_map[f"app_{app}"] = len(nodes)
        nodes.append({"name": app})
    
    for ipc in top_ipcs:
        node_map[f"ipc_{ipc}"] = len(nodes)
        nodes.append({"name": ipc})
    
    links = []
    for _, row in flow_counts.iterrows():
        source_key = f"app_{row['applicant']}"
        target_key = f"ipc_{row['ipc']}"
        if source_key in node_map and target_key in node_map:
            links.append({
                "source": node_map[source_key],
                "target": node_map[target_key],
                "value": int(row['count'])
            })
    
    sankey_data = {"nodes": nodes, "links": links}
    
    # D3.js縺ｧ繧ｵ繝ｳ繧ｭ繝ｼ繝繧､繧｢繧ｰ繝ｩ繝繧呈緒逕ｻ
    js.drawSankeyDiagram("sankey-chart", json.dumps(sankey_data), color_scheme)

def show_bubble_race(event=None):
    """
    繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ繝√Ε繝ｼ繝医ｒ逕滓・繝ｻ蜀咲函縺吶ｋ縲・    蟷ｴ縺斐→縺ｮ蜃ｺ鬘倅ｺｺ繝ｩ繝ｳ繧ｭ繝ｳ繧ｰ繧偵い繝九Γ繝ｼ繧ｷ繝ｧ繝ｳ縺ｧ陦ｨ遉ｺ縲・    
    Parameters
    ----------
    event : Event
        繝懊ち繝ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・    """
    global g_df_processed
    if not require_data('race-chart', '繝・・繧ｿ繧定ｪｭ縺ｿ霎ｼ繧薙〒縺上□縺輔＞'):
        return
    
    n_companies = int(document.getElementById('race-companies').value)
    speed_val = document.getElementById('race-speed').value
    speed_map = {'slow': 1000, 'normal': 500, 'fast': 250, 'ultra': 100}
    speed = speed_map.get(speed_val, 250)
    
    df = g_df_processed.copy()
    
    # year蛻励′0繧・ｬ謳阪・繝・・繧ｿ繧帝勁螟・    df = df[df['year'] > 0].copy()
    
    if len(df) == 0:
        document.getElementById('race-chart').innerHTML = '<div class="status-warn">蟷ｴ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # explode繧剃ｽｿ縺｣縺ｦ蜃ｺ鬘倅ｺｺ繧貞ｱ暮幕
    exp = df.explode('applicant_list')
    exp = exp[exp['applicant_list'].notna()]
    exp['applicant_list'] = exp['applicant_list'].astype(str).str.strip()
    exp = exp[exp['applicant_list'] != '']
    
    if len(exp) == 0:
        document.getElementById('race-chart').innerHTML = '<div class="status-warn">蜃ｺ鬘倅ｺｺ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # 蟷ｴ縺斐→繝ｻ蜃ｺ鬘倅ｺｺ縺斐→縺ｮ莉ｶ謨ｰ髮・ｨ・    year_app_counts = exp.groupby(['year', 'applicant_list']).size().reset_index(name='count')
    
    # 繝・ヰ繝・げ
    debugLog(f"[BubbleRace] Total records: {len(year_app_counts)}, Years: {exp['year'].nunique()}, Applicants: {exp['applicant_list'].nunique()}")
    
    # 蟷ｴ縺斐→縺ｮ繝・・繧ｿ繧呈ｧ狗ｯ・    year_data = {}
    for _, row in year_app_counts.iterrows():
        year_int = int(row['year'])
        if year_int not in year_data:
            year_data[year_int] = {}
        year_data[year_int][row['applicant_list']] = int(row['count'])
    
    if not year_data:
        document.getElementById('race-chart').innerHTML = '<div class="status-warn">蟷ｴ谺｡繝・・繧ｿ縺御ｸ崎ｶｳ縺励※縺・∪縺・/div>'
        return
    
    # 繝・ヰ繝・げ: 蜷・ｹｴ縺ｮ蜃ｺ鬘倅ｺｺ謨ｰ繧堤｢ｺ隱・    for y in sorted(year_data.keys())[:3]:
        apps_in_year = year_data[y]
        debugLog(f"[BubbleRace] Year {y}: {len(apps_in_year)} applicants")
        top3 = sorted(apps_in_year.items(), key=lambda x: x[1], reverse=True)[:3]
        for name, cnt in top3:
            debugLog(f"  - {name[:30]}: {cnt}")
    
    # 邏ｯ遨阪ョ繝ｼ繧ｿ縺ｫ螟画鋤
    sorted_years = sorted(year_data.keys())
    cumulative = {}
    race_data = {}
    
    for year in sorted_years:
        for app, count in year_data[year].items():
            cumulative[app] = cumulative.get(app, 0) + count
        
        # 荳贋ｽ康遉ｾ
        sorted_apps = sorted(cumulative.items(), key=lambda x: x[1], reverse=True)[:n_companies]
        race_data[str(year)] = [{"name": a[0], "value": a[1]} for a in sorted_apps]
    
    debugLog(f"[BubbleRace] Years: {len(sorted_years)}, Total applicants: {len(cumulative)}")
    
    # D3.js縺ｧ繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ繧貞・譛溷喧
    js.drawBubbleRace("race-chart", json.dumps(race_data), speed)

def show_circle_packing(event):
    """
    繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｭ繝ｳ繧ｰ繧堤函謌舌☆繧九・    髫主ｱ､逧・↑繝・・繧ｿ讒矩繧偵う繝ｳ繧ｿ繝ｩ繧ｯ繝・ぅ繝悶↑蜀・〒陦ｨ遉ｺ縲・    
    Parameters
    ----------
    event : Event
        繝懊ち繝ｳ繧ｯ繝ｪ繝・け繧､繝吶Φ繝・    """
    global g_df_processed, g_col_map
    if not require_data('circle-chart', '繝・・繧ｿ繧定ｪｭ縺ｿ霎ｼ繧薙〒縺上□縺輔＞'):
        return
    
    hierarchy = document.getElementById('circle-hierarchy').value
    n_count = int(document.getElementById('circle-count').value)
    
    df = g_df_processed.copy()
    
    if hierarchy == 'applicant-ipc':
        # 蜃ｺ鬘倅ｺｺ 竊・IPC 髫主ｱ､
        parent_col = 'applicant_list'
        child_col = 'ipc_list'
    elif hierarchy == 'ipc-applicant':
        # IPC 竊・蜃ｺ鬘倅ｺｺ 髫主ｱ､
        parent_col = 'ipc_list'
        child_col = 'applicant_list'
    else:
        # 蟷ｴ 竊・蜃ｺ鬘倅ｺｺ 髫主ｱ､
        parent_col = 'year'
        child_col = 'applicant_list'
    
    # 繝・・繧ｿ髮・ｨ・    hierarchy_data = {}
    for _, row in df.iterrows():
        if parent_col == 'year':
            parents = [str(row.get('year', ''))]
        else:
            parents = row.get(parent_col, [])[:1]
        
        children = row.get(child_col, [])[:2] if child_col != 'year' else [str(row.get('year', ''))]
        
        if not parents or not children:
            continue
        
        for parent in parents:
            parent = str(parent).strip()
            if not parent:
                continue
            if parent not in hierarchy_data:
                hierarchy_data[parent] = {}
            
            for child in children:
                child = str(child).strip()[:20] if child_col == 'applicant_list' else str(child).strip()[:4]
                if not child:
                    continue
                hierarchy_data[parent][child] = hierarchy_data[parent].get(child, 0) + 1
    
    # 荳贋ｽ崎ｦｪ繧帝∈謚・    parent_totals = {p: sum(c.values()) for p, c in hierarchy_data.items()}
    top_parents = sorted(parent_totals.items(), key=lambda x: x[1], reverse=True)[:n_count]
    
    # 髫主ｱ､繝・・繧ｿ讒矩繧呈ｧ狗ｯ・    children_list = []
    for parent, total in top_parents:
        child_items = hierarchy_data.get(parent, {})
        # 荳贋ｽ榊ｭ占ｦ∫ｴ
        top_children = sorted(child_items.items(), key=lambda x: x[1], reverse=True)[:8]
        children_list.append({
            "name": parent[:15] if len(parent) > 15 else parent,
            "children": [{"name": c[0], "value": c[1]} for c in top_children]
        })
    
    root_data = {
        "name": "Patent Data",
        "children": children_list
    }
    
    # 譯井ｻｶ繝ｪ繧ｹ繝郁｡ｨ遉ｺ逕ｨ縺ｮ繝・・繧ｿ繧呈ｧ狗ｯ・    patent_data = {}
    app_col = g_col_map.get('applicant')
    title_col = g_col_map.get('title')
    appno_col = g_col_map.get('app_number')
    
    for parent, total in top_parents:
        parent_key = parent[:15] if len(parent) > 15 else parent
        parent_patents = []
        
        # 隕ｪ縺ｫ隧ｲ蠖薙☆繧区｡井ｻｶ繧呈歓蜃ｺ
        for _, row in df.iterrows():
            if parent_col == 'year':
                if str(row.get('year', '')) == parent:
                    parent_patents.append({
                        "app_number": str(row.get(appno_col, ''))[:20] if appno_col else '',
                        "title": str(row.get(title_col, ''))[:80] if title_col else '',
                        "year": str(row.get('year', '')),
                        "applicant": str(row.get(parent_col, [])[:1][0] if row.get(parent_col) else '')[:30]
                    })
            else:
                parents_in_row = row.get(parent_col, [])
                if parent in [str(p) for p in parents_in_row]:
                    applicant_str = ''
                    if app_col:
                        app_list = row.get('applicant_list', [])
                        applicant_str = app_list[0] if app_list else ''
                    parent_patents.append({
                        "app_number": str(row.get(appno_col, ''))[:20] if appno_col else '',
                        "title": str(row.get(title_col, ''))[:80] if title_col else '',
                        "year": str(row.get('year', '')),
                        "applicant": str(applicant_str)[:30]
                    })
        
        patent_data[parent_key] = parent_patents[:100]  # 譛螟ｧ100莉ｶ
        
        # 蟄舌ヮ繝ｼ繝臥畑縺ｮ繝・・繧ｿ繧りｿｽ蜉
        for child_name, child_count in hierarchy_data.get(parent, {}).items():
            child_key = child_name
            child_patents = []
            
            for _, row in df.iterrows():
                # 隕ｪ縺ｨ蟄舌・荳｡譁ｹ縺ｫ隧ｲ蠖薙☆繧区｡井ｻｶ
                if parent_col == 'year':
                    parent_match = str(row.get('year', '')) == parent
                else:
                    parent_match = parent in [str(p) for p in row.get(parent_col, [])]
                
                if child_col == 'year':
                    child_match = str(row.get('year', '')) == child_name
                else:
                    child_match = child_name in [str(c)[:20] if child_col == 'applicant_list' else str(c)[:4] for c in row.get(child_col, [])]
                
                if parent_match and child_match:
                    applicant_str = ''
                    if app_col:
                        app_list = row.get('applicant_list', [])
                        applicant_str = app_list[0] if app_list else ''
                    child_patents.append({
                        "app_number": str(row.get(appno_col, ''))[:20] if appno_col else '',
                        "title": str(row.get(title_col, ''))[:80] if title_col else '',
                        "year": str(row.get('year', '')),
                        "applicant": str(applicant_str)[:30]
                    })
            
            if child_patents:
                patent_data[child_key] = child_patents[:100]
    
    # JavaScript縺ｫ譯井ｻｶ繝・・繧ｿ繧呈ｸ｡縺・    js.window.circlePackPatents = js.JSON.parse(json.dumps(patent_data))
    
    # D3.js縺ｧ繧ｵ繝ｼ繧ｯ繝ｫ繝代ャ繧ｭ繝ｳ繧ｰ繧呈緒逕ｻ
    js.drawCirclePacking("circle-chart", json.dumps(root_data))

# =====================================================
# MEGA - TF-IDF隧ｳ邏ｰ
# =====================================================
def show_tfidf_detail(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data(): return
    
    company = document.getElementById('tfidf-company').value
    if not company or company == '(譛ｪ驕ｸ謚・':
        document.getElementById('tfidf-result').innerHTML = '<div class="status-warn">莨∵･ｭ繧帝∈謚槭＠縺ｦ縺上□縺輔＞</div>'
        return
    
    df = g_df_processed
    
    mask = df['applicant_list'].apply(lambda x: company in x if x else False)
    company_indices = np.where(mask)[0]
    
    if len(company_indices) == 0:
        document.getElementById('tfidf-result').innerHTML = '<div class="status-warn">隧ｲ蠖薙ョ繝ｼ繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # 莨∵･ｭ蜈ｨ菴薙・TF-IDF蟷ｳ蝮・    company_tfidf = g_tfidf_matrix[company_indices].mean(axis=0).A1
    
    # 蜈ｨ菴灘ｹｳ蝮・→縺ｮ蟾ｮ蛻・ｼ育音蠕ｴ隱樊歓蜃ｺ・・    overall_tfidf = np.array(g_tfidf_matrix.mean(axis=0)).flatten()
    diff = company_tfidf - overall_tfidf
    
    top_indices = np.argsort(diff)[::-1][:20]
    
    html = f'''
        <div class="status-ok">投 {company} 縺ｮ迚ｹ蠕ｴ隱槫・譫撰ｼ・len(company_indices)}莉ｶ・・/div>
        <table class="data-table" style="margin-top: 0.5rem;">
            <tr><th>繧ｭ繝ｼ繝ｯ繝ｼ繝・/th><th>繧ｹ繧ｳ繧｢</th><th>蜈ｨ菴捺ｯ・/th></tr>
    '''
    
    for i in top_indices:
        word = g_feature_names[i]
        score = float(company_tfidf[i])
        ratio = score / (overall_tfidf[i] + 0.0001)
        bar_width = min(100, ratio * 20)
        html += f'''<tr>
            <td>{word}</td>
            <td>{score:.3f}</td>
            <td><div style="background:#4fc3f7; height:8px; width:{bar_width}%; border-radius:3px;"></div> {ratio:.1f}x</td>
        </tr>'''
    
    html += '</table>'
    document.getElementById('tfidf-result').innerHTML = html

# =====================================================
# MEGA - 謌ｦ逡･繝槭ヨ繝ｪ繧ｯ繧ｹ (CAGRﾃ励す繧ｧ繧｢)
# =====================================================
def show_strategy_matrix(event):
    global g_df_processed
    if not require_data('strategy-chart', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ'):
        return
    
    df = g_df_processed
    n_companies = int(document.getElementById('strategy-companies').value)
    base_year = int(document.getElementById('strategy-base-year').value)
    size_mode = document.getElementById('strategy-size').value
    
    # 蜃ｺ鬘倅ｺｺ縺斐→縺ｮ蟷ｴ蛻･莉ｶ謨ｰ繧帝寔險・    exp = df.explode('applicant_list')
    exp = exp[exp['applicant_list'].notna() & (exp['applicant_list'] != '')]
    
    # TOP蜃ｺ鬘倅ｺｺ繧呈歓蜃ｺ
    top_apps = exp['applicant_list'].value_counts().head(n_companies).index.tolist()
    exp = exp[exp['applicant_list'].isin(top_apps)]
    
    # 蟷ｴ蛻･莉ｶ謨ｰ
    yearly = exp.groupby(['applicant_list', 'year']).size().reset_index(name='count')
    
    # 蜷・ｼ∵･ｭ縺ｮCAGR縺ｨ繧ｷ繧ｧ繧｢繧定ｨ育ｮ・    results = []
    total_count = len(df)
    max_year = int(df['year'].max())
    
    for app in top_apps:
        app_data = yearly[yearly['applicant_list'] == app]
        
        # 邱丈ｻｶ謨ｰ
        total = int(app_data['count'].sum())
        
        # 繧ｷ繧ｧ繧｢・・・・        share = (total / total_count) * 100
        
        # 逶ｴ霑・蟷ｴ莉ｶ謨ｰ
        recent = app_data[app_data['year'] >= max_year - 2]['count'].sum()
        
        # CAGR險育ｮ暦ｼ・ase_year莉･蜑・vs 莉･髯搾ｼ・        old_period = app_data[app_data['year'] < base_year]['count'].sum()
        new_period = app_data[app_data['year'] >= base_year]['count'].sum()
        
        if old_period > 0:
            years_diff = max_year - base_year + 1
            if years_diff > 0 and new_period > 0:
                cagr = ((new_period / old_period) ** (1 / years_diff) - 1) * 100
            else:
                cagr = -50  # 貂帛ｰ・        else:
            cagr = 100 if new_period > 0 else 0  # 譁ｰ隕丞盾蜈･
        
        # CAGR 繧・100縲・00縺ｫ蛻ｶ髯・        cagr = max(-100, min(200, cagr))
        
        results.append({
            'name': app,
            'share': share,
            'cagr': cagr,
            'total': total,
            'recent': int(recent)
        })
    
    if not results:
        document.getElementById('strategy-chart').innerHTML = '<div class="status-warn">繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # 繝舌ヶ繝ｫ繧ｵ繧､繧ｺ
    if size_mode == 'recent':
        sizes = [max(15, r['recent'] * 3) for r in results]
    else:
        sizes = [max(15, r['total'] * 0.5) for r in results]
    
    # 雎｡髯舌ｒ濶ｲ蛻・￠
    colors = []
    for r in results:
        if r['cagr'] > 0 and r['share'] > np.median([x['share'] for x in results]):
            colors.append('#81c784')  # 鬮俶・髟ｷ繝ｻ鬮倥す繧ｧ繧｢・域弌・・        elif r['cagr'] > 0:
            colors.append('#4fc3f7')  # 鬮俶・髟ｷ繝ｻ菴弱す繧ｧ繧｢・亥撫鬘悟・・・        elif r['share'] > np.median([x['share'] for x in results]):
            colors.append('#ffb74d')  # 菴取・髟ｷ繝ｻ鬮倥す繧ｧ繧｢・磯≡縺ｮ縺ｪ繧区惠・・        else:
            colors.append('#e57373')  # 菴取・髟ｷ繝ｻ菴弱す繧ｧ繧｢・郁ｲ縺醍堪・・    
    traces = [{
        "x": [r['share'] for r in results],
        "y": [r['cagr'] for r in results],
        "mode": "markers+text",
        "type": "scatter",
        "text": [truncate_applicant_name(r['name'], 15) for r in results],
        "textposition": "top center",
        "textfont": {"size": 10},
        "marker": {
            "size": sizes,
            "color": colors,
            "opacity": 0.7,
            "line": {"width": 1, "color": "#fff"}
        },
        "hovertemplate": "<b>%{text}</b><br>繧ｷ繧ｧ繧｢: %{x:.1f}%<br>謌宣聞邇・ %{y:.1f}%<extra></extra>"
    }]
    
    # 雎｡髯千ｷ・    med_share = np.median([r['share'] for r in results])
    shapes = [
        {"type": "line", "x0": med_share, "x1": med_share, "y0": -100, "y1": 200, 
         "line": {"color": "rgba(255,255,255,0.3)", "width": 1, "dash": "dot"}},
        {"type": "line", "x0": 0, "x1": max([r['share'] for r in results]) * 1.2, "y0": 0, "y1": 0, 
         "line": {"color": "rgba(255,255,255,0.3)", "width": 1, "dash": "dot"}}
    ]
    
    layout = ChartHelper.create_layout(
        title=f"謌ｦ逡･繝槭ヨ繝ｪ繧ｯ繧ｹ・・base_year}蟷ｴ莉･髯阪・CAGRﾃ励す繧ｧ繧｢・・,
        xaxis={"title": "繧ｷ繧ｧ繧｢ (%)", "rangemode": "tozero"},
        yaxis={"title": f"謌宣聞邇・CAGR (%) - {base_year}蟷ｴ蝓ｺ貅・, "zeroline": True},
        height=600,
        shapes=shapes,
        annotations=[
            {"x": 0.95, "y": 0.95, "xref": "paper", "yref": "paper", "text": "箝・繧ｹ繧ｿ繝ｼ", "showarrow": False, "font": {"color": "#81c784"}},
            {"x": 0.05, "y": 0.95, "xref": "paper", "yref": "paper", "text": "笶・蝠城｡悟・", "showarrow": False, "font": {"color": "#4fc3f7"}},
            {"x": 0.95, "y": 0.05, "xref": "paper", "yref": "paper", "text": "腸 驥代・縺ｪ繧区惠", "showarrow": False, "font": {"color": "#ffb74d"}},
            {"x": 0.05, "y": 0.05, "xref": "paper", "yref": "paper", "text": "枢 雋縺醍堪", "showarrow": False, "font": {"color": "#e57373"}}
        ]
    )
    
    ChartHelper.draw("strategy-chart", traces, layout)
    
    # 繧ｵ繝槭Μ繝ｼ
    html = '<h4>繝昴ず繧ｷ繝ｧ繝ｳ蛻・梵</h4><table class="data-table"><tr><th>蜃ｺ鬘倅ｺｺ</th><th>繧ｷ繧ｧ繧｢</th><th>謌宣聞邇・/th><th>繝昴ず繧ｷ繝ｧ繝ｳ</th></tr>'
    for r in results:
        if r['cagr'] > 0 and r['share'] > med_share:
            pos = '箝・繧ｹ繧ｿ繝ｼ'
        elif r['cagr'] > 0:
            pos = '笶・蝠城｡悟・'
        elif r['share'] > med_share:
            pos = '腸 驥代・縺ｪ繧区惠'
        else:
            pos = '枢 雋縺醍堪'
        html += f'<tr><td>{truncate_applicant_name(r["name"], 25)}</td><td>{r["share"]:.1f}%</td><td>{r["cagr"]:+.1f}%</td><td>{pos}</td></tr>'
    html += '</table>'
    document.getElementById('strategy-summary').innerHTML = html

# =====================================================
# 繝・Μ繝ｼ繝槭ャ繝・# =====================================================
def show_treemap(event):
    global g_df_processed
    if not require_data(): return
    
    df = g_df_processed
    level = document.getElementById('treemap-level').value
    colorscheme = document.getElementById('treemap-color').value
    
    # IPC蛻・｡槭ｒ蜿門ｾ・    ipc_list = df.explode('ipc_list')['ipc_list'].dropna()
    
    # 繝ｬ繝吶Ν縺ｫ蠢懊§縺ｦIPC繧貞・繧雁・縺・    if level == 'section':
        ipc_list = ipc_list.str[:1]  # A, B, C, ...
    elif level == 'class':
        ipc_list = ipc_list.str[:3]  # A01, G06, ...
    else:  # subclass
        ipc_list = ipc_list.str[:4]  # A01B, G06F, ...
    
    counts = ipc_list.value_counts().head(50)
    
    if len(counts) == 0:
        document.getElementById('treemap-chart').innerHTML = '<div class="status-warn">IPC蛻・｡槭′隕九▽縺九ｊ縺ｾ縺帙ｓ</div>'
        return
    
    # 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ諠・ｱ繧定ｿｽ蜉・磯嚴螻､讒矩逕ｨ・・    labels = list(counts.index)
    parents = []
    values = list(counts.values)
    
    if level != 'section':
        # 隕ｪ縺ｨ縺励※繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧定ｿｽ蜉
        sections = set([l[0] for l in labels])
        section_labels = list(sections)
        section_values = [0] * len(section_labels)  # 隕ｪ縺ｮ蛟､縺ｯ0
        section_parents = [''] * len(section_labels)  # 繝ｫ繝ｼ繝・        
        # 蜷・Λ繝吶Ν縺ｮ隕ｪ繧定ｨｭ螳・        for l in labels:
            parents.append(l[0])  # 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ縺瑚ｦｪ
        
        # 繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ繧貞・鬆ｭ縺ｫ霑ｽ蜉
        labels = section_labels + labels
        parents = section_parents + parents
        values = section_values + [int(v) for v in values]
    else:
        parents = [''] * len(labels)
        values = [int(v) for v in values]
    
    traces = [{
        "type": "treemap",
        "labels": labels,
        "parents": parents,
        "values": values,
        "textinfo": "label+value+percent parent",
        "marker": {
            "colors": values,
            "colorscale": colorscheme,
            "line": {"color": "#1b263b", "width": 2}
        },
        "textfont": {"color": "white", "size": 13},
        "hovertemplate": "<b>%{label}</b><br>莉ｶ謨ｰ: %{value}<br>蜑ｲ蜷・ %{percentParent:.1%}<extra></extra>"
    }]
    
    layout = ChartHelper.create_layout(
        title=f"IPC蛻・｡槭ヤ繝ｪ繝ｼ繝槭ャ繝暦ｼ・level.upper()}繝ｬ繝吶Ν・・,
        height=600,
        margin={"t": 50, "l": 10, "r": 10, "b": 10},
        paper_bgcolor="rgba(0,0,0,0)",
        plot_bgcolor="rgba(0,0,0,0)"
    )
    ChartHelper.draw("treemap-chart", traces, layout)

# =====================================================
# 繝ｬ繝ｼ繝繝ｼ繝√Ε繝ｼ繝・# =====================================================
def show_radar(event):
    global g_df_processed
    if not require_data(): return
    
    df = g_df_processed
    company1 = document.getElementById('radar-company1').value
    company2 = document.getElementById('radar-company2').value
    axis_type = document.getElementById('radar-axis').value
    
    if not company1:
        document.getElementById('radar-chart').innerHTML = '<div class="status-warn">莨∵･ｭ繧帝∈謚槭＠縺ｦ縺上□縺輔＞</div>'
        return
    
    # 蜷・ｼ∵･ｭ縺ｮIPC蛻・ｸ・ｒ險育ｮ・    def get_ipc_dist(company_name):
        mask = df['applicant_list'].apply(lambda x: company_name in x if x else False)
        subset = df[mask]
        if axis_type == 'section':
            ipcs = subset.explode('ipc_list')['ipc_list'].dropna().str[:1]
        else:
            ipcs = subset.explode('ipc_list')['ipc_list'].dropna().str[:3]
        return ipcs.value_counts()
    
    dist1 = get_ipc_dist(company1)
    
    # dist1縺檎ｩｺ縺ｮ蝣ｴ蜷医・繧ｨ繝ｩ繝ｼ蜃ｦ逅・    if dist1.empty:
        document.getElementById('radar-chart').innerHTML = '<div class="status-warn">驕ｸ謚槭＠縺滉ｼ∵･ｭ縺ｮIPC繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    if axis_type == 'section':
        # 縺吶∋縺ｦ縺ｮ繧ｻ繧ｯ繧ｷ繝ｧ繝ｳ (A-H)
        categories = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']
    else:
        # TOP10縺ｮIPC繧ｯ繝ｩ繧ｹ・井ｸ｡莨∵･ｭ縺ｮ蜷郁ｨ医°繧会ｼ・        if company2:
            dist2 = get_ipc_dist(company2)
            combined = (dist1.add(dist2, fill_value=0)).sort_values(ascending=False).head(10)
        else:
            combined = dist1.sort_values(ascending=False).head(10)
        categories = list(combined.index)
    
    # 繧ｫ繝・ざ繝ｪ縺檎ｩｺ縺ｮ蝣ｴ蜷医・繧ｨ繝ｩ繝ｼ蜃ｦ逅・    if not categories:
        document.getElementById('radar-chart').innerHTML = '<div class="status-warn">陦ｨ遉ｺ縺吶ｋ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ</div>'
        return
    
    # 豁｣隕丞喧・亥推莨∵･ｭ縺ｮ譛螟ｧ蛟､繧・00縺ｨ縺吶ｋ・・    values1 = [float(dist1.get(c, 0)) for c in categories]
    max1 = max(values1) if values1 and max(values1) > 0 else 1
    values1_norm = [v / max1 * 100 for v in values1]
    
    traces = [{
        "type": "scatterpolar",
        "r": values1_norm + [values1_norm[0]],  # 髢峨§繧九◆繧√↓譛蛻昴・蛟､繧定ｿｽ蜉
        "theta": categories + [categories[0]],
        "fill": "toself",
        "fillcolor": "rgba(79, 195, 247, 0.3)",
        "line": {"color": "#4fc3f7"},
        "name": truncate_applicant_name(company1, 20)
    }]
    
    if company2:
        dist2 = get_ipc_dist(company2)
        values2 = [float(dist2.get(c, 0)) for c in categories]
        max2 = max(values2) if max(values2) > 0 else 1
        values2_norm = [v / max2 * 100 for v in values2]
        
        traces.append({
            "type": "scatterpolar",
            "r": values2_norm + [values2_norm[0]],
            "theta": categories + [categories[0]],
            "fill": "toself",
            "fillcolor": "rgba(255, 183, 77, 0.3)",
            "line": {"color": "#ffb74d"},
            "name": truncate_applicant_name(company2, 20)
        })
    
    layout = ChartHelper.create_layout(
        title="謚陦薙・繝ｼ繝医ヵ繧ｩ繝ｪ繧ｪ豈碑ｼ・ｼ医Ξ繝ｼ繝繝ｼ繝√Ε繝ｼ繝茨ｼ・,
        height=600,
        polar={
            "radialaxis": {"visible": True, "range": [0, 100]},
            "bgcolor": "rgba(0,0,0,0.1)"
        },
        showlegend=True
    )
    
    ChartHelper.draw("radar-chart", traces, layout)

# =====================================================
# 譁ｰD3.js蜿ｯ隕門喧髢｢謨ｰ
# =====================================================

def show_sunburst(event):
    """繧ｵ繝ｳ繝舌・繧ｹ繝亥峙・・PC/FI髫主ｱ､讒矩・峨ｒ陦ｨ遉ｺ"""
    global g_df_processed
    if not require_data(): return
    
    df = g_df_processed
    source = document.getElementById('sunburst-source').value
    color_scheme = document.getElementById('sunburst-color').value
    
    # IPC/FI髫主ｱ､繝・・繧ｿ繧呈ｧ狗ｯ・    if source == 'fi' and 'fi_list' in df.columns:
        all_codes = df.explode('fi_list')['fi_list'].dropna()
    else:
        all_codes = df.explode('ipc_list')['ipc_list'].dropna()
    
    # 髫主ｱ､讒矩繧呈ｧ狗ｯ・    hierarchy = {"name": "IPC", "children": []}
    section_map = {}
    
    for code in all_codes:
        if len(code) < 4:
            continue
        section = code[0]  # A, B, C...
        cls = code[:3]     # A01, G06...
        subclass = code[:4] if len(code) >= 4 else cls  # A01B, G06F...
        
        if section not in section_map:
            section_map[section] = {"name": section, "children": []}
            hierarchy["children"].append(section_map[section])
        
        sec_children = section_map[section]["children"]
        cls_node = next((c for c in sec_children if c["name"] == cls), None)
        if cls_node is None:
            cls_node = {"name": cls, "children": []}
            sec_children.append(cls_node)
        
        sub_node = next((c for c in cls_node["children"] if c["name"] == subclass), None)
        if sub_node is None:
            sub_node = {"name": subclass, "value": 0}
            cls_node["children"].append(sub_node)
        sub_node["value"] = sub_node.get("value", 0) + 1
    
    # 遨ｺ縺ｮchildren繧呈戟縺､繝弱・繝峨ｒ菫ｮ豁｣
    def fix_empty_children(node):
        if "children" in node:
            if len(node["children"]) == 0:
                del node["children"]
                node["value"] = 1
            else:
                for child in node["children"]:
                    fix_empty_children(child)
    
    fix_empty_children(hierarchy)
    
    js.drawSunburst("sunburst-chart", json.dumps(hierarchy), color_scheme)

def show_chord(event):
    """繧ｳ繝ｼ繝牙峙・亥・蜷碁未菫ゑｼ峨ｒ陦ｨ遉ｺ"""
    global g_df_processed
    if not require_data(): return
    
    df = g_df_processed
    chord_type = document.getElementById('chord-type').value
    top_n = int(document.getElementById('chord-count').value)
    
    # 蟇ｾ雎｡繝ｪ繧ｹ繝亥叙蠕・    if chord_type == 'inventor':
        col = 'inventor_list'
    elif chord_type == 'ipc':
        col = 'ipc_list'
    else:
        col = 'applicant_list'
    
    # TOP N繧貞叙蠕・    all_items = df.explode(col)[col].dropna()
    top_items = all_items.value_counts().head(top_n).index.tolist()
    
    # 蜈ｱ襍ｷ繝槭ヨ繝ｪ繝・け繧ｹ繧呈ｧ狗ｯ・    n = len(top_items)
    item_to_idx = {item: i for i, item in enumerate(top_items)}
    matrix = [[0] * n for _ in range(n)]
    
    for _, row in df.iterrows():
        items = row.get(col, [])
        if not isinstance(items, list):
            continue
        filtered = [it for it in items if it in item_to_idx]
        for i in range(len(filtered)):
            for j in range(i + 1, len(filtered)):
                idx_i = item_to_idx[filtered[i]]
                idx_j = item_to_idx[filtered[j]]
                matrix[idx_i][idx_j] += 1
                matrix[idx_j][idx_i] += 1
    
    data = {"names": top_items, "matrix": matrix}
    js.drawChordDiagram("chord-chart", json.dumps(data))

def show_streamgraph(event):
    """繧ｹ繝医Μ繝ｼ繝繧ｰ繝ｩ繝輔ｒ陦ｨ遉ｺ"""
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data('stream-chart', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲ゅ∪縺壼燕蜃ｦ逅・ｒ螳溯｡後＠縺ｦ縺上□縺輔＞縲・):
        return
    
    df = g_df_processed
    stream_type = document.getElementById('stream-type').value
    top_n = int(document.getElementById('stream-count').value)
    
    # 蟷ｴ繧ｫ繝ｩ繝縺ｮ遒ｺ隱・    if 'year' not in df.columns:
        document.getElementById('stream-chart').innerHTML = '<div class="status-warn">蟷ｴ繧ｫ繝ｩ繝縺後≠繧翫∪縺帙ｓ縲ょ・鬘俶律繧ｫ繝ｩ繝繧定ｨｭ螳壹＠縺ｦ縺上□縺輔＞縲・/div>'
        return
    
    # 譛牙柑縺ｪ蟷ｴ繧貞叙蠕暦ｼ・繧医ｊ螟ｧ縺阪＞蟷ｴ縺ｮ縺ｿ・・    valid_years = sorted([y for y in df['year'].dropna().unique() if y > 0])
    if len(valid_years) == 0:
        document.getElementById('stream-chart').innerHTML = '<div class="status-warn">譛牙柑縺ｪ蟷ｴ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲・/div>'
        return
    
    # 繧ｭ繝ｼ繝ｯ繝ｼ繝牙・譫舌・蝣ｴ蜷医・TF-IDF繧剃ｽｿ逕ｨ
    if stream_type == 'keyword':
        if g_tfidf_matrix is None or g_feature_names is None or len(g_feature_names) == 0:
            document.getElementById('stream-chart').innerHTML = '<div class="status-warn">TF-IDF陦悟・縺後≠繧翫∪縺帙ｓ縲ょ燕蜃ｦ逅・ｒ螳溯｡後＠縺ｦ縺上□縺輔＞縲・/div>'
            return
        
        # 蜈ｨ菴薙〒縺ｮTOP N繧ｭ繝ｼ繝ｯ繝ｼ繝峨ｒ蜿門ｾ・        sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
        top_indices = np.argsort(sums)[::-1][:top_n]
        top_items = [g_feature_names[i] for i in top_indices]
        
        # 蟷ｴ蛻･髮・ｨ・        series = []
        for year in valid_years:
            year_mask = df['year'] == year
            row = {"year": int(year)}
            
            # 縺昴・蟷ｴ縺ｮ繝峨く繝･繝｡繝ｳ繝医・TF-IDF蛟､繧帝寔險・            year_indices = df[year_mask].index.tolist()
            if len(year_indices) > 0:
                # tokenized繧ｫ繝ｩ繝縺ｧ蜷・く繝ｼ繝ｯ繝ｼ繝峨・蜃ｺ迴ｾ繧偵き繧ｦ繝ｳ繝・                for kw in top_items:
                    count = 0
                    for idx in year_indices:
                        if idx < len(df):
                            text = str(df.iloc[idx].get('tokenized', ''))
                            if kw in text.split():
                                count += 1
                    row[kw] = count
            else:
                for kw in top_items:
                    row[kw] = 0
            series.append(row)
    else:
        # 蜃ｺ鬘倅ｺｺ縺ｾ縺溘・IPC縺ｮ蝣ｴ蜷・        col = 'applicant_list' if stream_type == 'applicant' else 'ipc_list'
        
        # 繧ｫ繝ｩ繝蟄伜惠繝√ぉ繝・け
        if col not in df.columns:
            document.getElementById('stream-chart').innerHTML = f'<div class="status-warn">繧ｫ繝ｩ繝縲鶏col}縲阪′隕九▽縺九ｊ縺ｾ縺帙ｓ縲・/div>'
            return
        
        # TOP N繧貞叙蠕・        try:
            all_items = df[col].explode().dropna()
            if len(all_items) == 0:
                document.getElementById('stream-chart').innerHTML = '<div class="status-warn">蛻・梵蟇ｾ雎｡縺ｮ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲・/div>'
                return
            top_items = all_items.value_counts().head(top_n).index.tolist()
        except Exception as e:
            document.getElementById('stream-chart').innerHTML = f'<div class="status-err">繝・・繧ｿ蜿門ｾ励お繝ｩ繝ｼ: {e}</div>'
            return
        
        # 蟷ｴ蛻･髮・ｨ・        series = []
        for year in valid_years:
            year_df = df[df['year'] == year]
            row = {"year": int(year)}
            # 蟷ｴ蛻･縺ｫexplode縺励※蜷・い繧､繝・Β縺ｮ繧ｫ繧ｦ繝ｳ繝医ｒ蜿門ｾ・            year_exploded = year_df[col].explode().dropna()
            year_counts = year_exploded.value_counts()
            for item in top_items:
                count = year_counts.get(item, 0)
                row[item] = int(count)
            series.append(row)
    
    # 遨ｺ繝・・繧ｿ繝√ぉ繝・け
    if len(series) == 0 or len(top_items) == 0:
        document.getElementById('stream-chart').innerHTML = '<div class="status-warn">陦ｨ遉ｺ縺吶ｋ繝・・繧ｿ縺後≠繧翫∪縺帙ｓ縲・/div>'
        return
    
    data = {"keys": top_items, "series": series}
    js.drawStreamgraph("stream-chart", json.dumps(data))

def show_dendrogram(event):
    """繝・Φ繝峨Ο繧ｰ繝ｩ繝・磯嚴螻､繧ｯ繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ・峨ｒ陦ｨ遉ｺ"""
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data(): return
    
    target = document.getElementById('dendro-target').value
    top_n = int(document.getElementById('dendro-count').value)
    method = document.getElementById('dendro-method').value
    
    df = g_df_processed
    
    # 蟇ｾ雎｡繝・・繧ｿ繧貞叙蠕・    if target == 'keyword':
        if g_tfidf_matrix is None:
            return
        # 繧ｭ繝ｼ繝ｯ繝ｼ繝峨・荳贋ｽ阪ｒ蜿門ｾ暦ｼ亥・襍ｷ繝代ち繝ｼ繝ｳ縺ｧ繧ｯ繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ・・        sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
        top_indices = np.argsort(sums)[::-1][:top_n]
        names = [g_feature_names[i] for i in top_indices]
        hierarchy = build_simple_hierarchy(names)
    else:
        # 蜃ｺ鬘倅ｺｺ繧呈橿陦薙・繝ｼ繝医ヵ繧ｩ繝ｪ繧ｪ縺ｮ鬘樔ｼｼ蠎ｦ縺ｧ繧ｯ繝ｩ繧ｹ繧ｿ繝ｪ繝ｳ繧ｰ
        top_items = df.explode('applicant_list')['applicant_list'].value_counts().head(top_n).index.tolist()
        hierarchy = build_simple_hierarchy(top_items)
    
    js.drawDendrogram("dendro-chart", json.dumps(hierarchy))

def build_simple_hierarchy(items):
    """繧｢繧､繝・Β繝ｪ繧ｹ繝医°繧臥ｰ｡譏鍋噪縺ｪ髫主ｱ､讒矩繧呈ｧ狗ｯ・""
    if len(items) <= 2:
        return {"name": "root", "children": [{"name": it} for it in items]}
    
    mid = len(items) // 2
    left_items = items[:mid]
    right_items = items[mid:]
    
    return {
        "name": "",
        "children": [
            build_simple_hierarchy(left_items) if len(left_items) > 1 else {"name": left_items[0]},
            build_simple_hierarchy(right_items) if len(right_items) > 1 else {"name": right_items[0]}
        ]
    }

# =====================================================
# 繧ｨ繧ｯ繧ｹ繝昴・繝域ｩ溯・
# =====================================================
def export_summary(event):
    global g_df_processed
    if not require_data('export-result', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ'):
        return
    
    df = g_df_processed
    
    summary = f"""=== ARTEMIS 蛻・梵繧ｵ繝槭Μ繝ｼ ===
邱丈ｻｶ謨ｰ: {len(df):,}
譛滄俣: {df['year'].min()} - {df['year'].max()}
蜃ｺ鬘倅ｺｺ謨ｰ: {df.explode('applicant_list')['applicant_list'].nunique():,}
IPC謨ｰ: {df.explode('ipc_list')['ipc_list'].nunique():,}
逋ｺ譏手・焚: {df.explode('inventor_list')['inventor_list'].nunique():,}

--- TOP5 蜃ｺ鬘倅ｺｺ ---
"""
    top_apps = df.explode('applicant_list')['applicant_list'].value_counts().head(5)
    for app, cnt in top_apps.items():
        summary += f"{app}: {cnt}莉ｶ\n"
    
    summary += "\n--- TOP5 IPC ---\n"
    top_ipcs = df.explode('ipc_list')['ipc_list'].value_counts().head(5)
    for ipc, cnt in top_ipcs.items():
        summary += f"{ipc}: {cnt}莉ｶ\n"
    
    # 繧ｯ繝ｪ繝・・繝懊・繝峨↓繧ｳ繝斐・
    from js import navigator
    navigator.clipboard.writeText(summary)
    
    document.getElementById('export-result').innerHTML = '<div class="status-ok">搭 繧ｯ繝ｪ繝・・繝懊・繝峨↓繧ｳ繝斐・縺励∪縺励◆</div>'

def export_keywords(event):
    global g_tfidf_matrix, g_feature_names
    if not require_tfidf('export-result'):
        return
    
    sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
    top_indices = np.argsort(sums)[::-1][:50]
    
    keyword_list = "=== TOP50 繧ｭ繝ｼ繝ｯ繝ｼ繝・===\n"
    for rank, i in enumerate(top_indices, 1):
        keyword_list += f"{rank}. {g_feature_names[i]} (繧ｹ繧ｳ繧｢: {sums[i]:.2f})\n"
    
    from js import navigator
    navigator.clipboard.writeText(keyword_list)
    
    document.getElementById('export-result').innerHTML = '<div class="status-ok">搭 繧ｭ繝ｼ繝ｯ繝ｼ繝峨Μ繧ｹ繝医ｒ繧ｳ繝斐・縺励∪縺励◆</div>'

# =====================================================
# VOYAGER - 閾ｪ蜍輔Ξ繝昴・繝育函謌・# =====================================================
def generate_report(event):
    global g_df_processed, g_tfidf_matrix, g_feature_names
    if not require_data('export-result', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ'):
        return
    
    df = g_df_processed
    
    # 蝓ｺ譛ｬ邨ｱ險・    total = len(df)
    year_min = int(df['year'].min()) if df['year'].min() > 0 else '荳肴・'
    year_max = int(df['year'].max()) if df['year'].max() > 0 else '荳肴・'
    
    # 蜃ｺ鬘倅ｺｺ蛻・梵
    exp_apps = df.explode('applicant_list')['applicant_list']
    n_applicants = exp_apps.nunique()
    top_apps = exp_apps.value_counts().head(10)
    
    # IPC蛻・梵
    exp_ipc = df.explode('ipc_list')['ipc_list']
    n_ipcs = exp_ipc.nunique()
    top_ipcs = exp_ipc.value_counts().head(5)
    
    # 逋ｺ譏手・・譫・    exp_inv = df.explode('inventor_list')['inventor_list']
    n_inventors = exp_inv.nunique()
    
    # 蟷ｴ蛻･繝医Ξ繝ｳ繝・    yearly = df['year'].value_counts().sort_index()
    yearly = yearly[yearly.index > 0]
    if len(yearly) >= 3:
        recent_3y = yearly.tail(3).sum()
        prev_3y = yearly.iloc[-6:-3].sum() if len(yearly) >= 6 else yearly.head(3).sum()
        trend_pct = ((recent_3y - prev_3y) / prev_3y * 100) if prev_3y > 0 else 0
        trend_text = f"蠅怜刈蛯ｾ蜷・(+{trend_pct:.0f}%)" if trend_pct > 10 else f"貂帛ｰ大だ蜷・({trend_pct:.0f}%)" if trend_pct < -10 else "讓ｪ縺ｰ縺・
    else:
        trend_text = "繝・・繧ｿ荳崎ｶｳ"
    
    # 繧ｭ繝ｼ繝ｯ繝ｼ繝・    if g_tfidf_matrix is not None and g_feature_names:
        sums = np.array(g_tfidf_matrix.sum(axis=0)).flatten()
        top_kw_idx = np.argsort(sums)[::-1][:10]
        top_keywords = [g_feature_names[i] for i in top_kw_idx]
    else:
        top_keywords = ['(譛ｪ蛻・梵)']
    
    # 繝ｬ繝昴・繝育函謌・    report = f"""笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊・                    ARTEMIS 迚ｹ險ｱ蛻・梵繝ｬ繝昴・繝・笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊・
笆 蛻・梵讎りｦ・笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
  蛻・梵蟇ｾ雎｡譛滄俣: {year_min} 蟷ｴ 縲・{year_max} 蟷ｴ
  邱丈ｻｶ謨ｰ: {total:,} 莉ｶ
  蜃ｺ鬘倅ｺｺ謨ｰ: {n_applicants:,} 遉ｾ
  逋ｺ譏手・焚: {n_inventors:,} 蜷・  IPC蛻・｡樊焚: {n_ipcs:,} 遞ｮ
  蜃ｺ鬘倥ヨ繝ｬ繝ｳ繝・ {trend_text}

笆 荳ｻ隕∝・鬘倅ｺｺ TOP10
笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
"""
    for i, (app, cnt) in enumerate(top_apps.items(), 1):
        share = (cnt / total) * 100
        report += f"  {i:2d}. {app[:35]:<35} {cnt:>5}莉ｶ ({share:>5.1f}%)\n"
    
    report += f"""
笆 謚陦灘・驥・(IPC TOP5)
笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
"""
    for i, (ipc, cnt) in enumerate(top_ipcs.items(), 1):
        report += f"  {i}. {ipc}: {cnt}莉ｶ\n"
    
    report += f"""
笆 豕ｨ逶ｮ繧ｭ繝ｼ繝ｯ繝ｼ繝・TOP10
笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
  {', '.join(top_keywords)}

笆 蟷ｴ蛻･蜃ｺ鬘俶耳遘ｻ
笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏笏
"""
    for year, cnt in yearly.tail(10).items():
        bar = '笆・ * min(50, int(cnt / yearly.max() * 50))
        report += f"  {int(year)}: {bar} {cnt}莉ｶ\n"
    
    report += f"""
笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊・  Generated by ARTEMIS (Apollo PyScript Edition)
  Analysis Date: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}
笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊絶武笊・"""
    
    document.getElementById('report-output').style.display = 'block'
    document.getElementById('report-text').value = report
    document.getElementById('export-result').innerHTML = '<div class="status-ok">統 繝ｬ繝昴・繝医ｒ逕滓・縺励∪縺励◆</div>'

def export_all_data(event):
    global g_df_processed
    if not require_data('export-result', '繝・・繧ｿ縺後≠繧翫∪縺帙ｓ'):
        return
    
    # CSV繝・・繧ｿ繧堤函謌・    csv_data = g_df_processed.to_csv(index=False)
    
    from js import navigator
    navigator.clipboard.writeText(csv_data)
    
    document.getElementById('export-result').innerHTML = '<div class="status-ok">逃 蜈ｨ繝・・繧ｿ繧偵け繝ｪ繝・・繝懊・繝峨↓繧ｳ繝斐・縺励∪縺励◆</div>'

def show_data_preview(event=None):
    global g_df_processed, g_col_map
    if not require_data(): return
    
    df = g_df_processed
    title_col = g_col_map.get('title', df.columns[0])
    if title_col == '(譛ｪ驕ｸ謚・': title_col = df.columns[0]
    
    html = '<table class="data-table"><tr><th>#</th><th>蟷ｴ</th><th>繧ｿ繧､繝医Ν</th><th>蜃ｺ鬘倅ｺｺ</th></tr>'
    for i, (_, row) in enumerate(df.head(20).iterrows(), 1):
        apps = row.get('applicant_list', [])
        app_str = apps[0][:20] if apps else '-'
        title = str(row.get(title_col, ''))[:40]
        html += f'<tr><td>{i}</td><td>{row.get("year", "-")}</td><td>{title}</td><td>{app_str}</td></tr>'
    html += '</table>'
    document.getElementById('data-preview').innerHTML = html

# =====================================================
# 繧､繝吶Φ繝育匳骭ｲ
# =====================================================
g_proxies.clear()
file_proxy = create_proxy(on_file_change)
launch_proxy = create_proxy(launch_engine)
atlas_proxy = create_proxy(draw_atlas)
core_search_proxy = create_proxy(core_search)
core_ai_proxy = create_proxy(core_ai_generate)
core_import_proxy = create_proxy(core_import_json)
core_run_proxy = create_proxy(core_run_classification)
core_reanalyze_proxy = create_proxy(core_reanalyze)
core_map_proxy = create_proxy(core_draw_map)
core_add_proxy = create_proxy(core_add_rule)
core_delete_proxy = create_proxy(core_delete_rule)
core_update_proxy = create_proxy(core_update_rule)
core_edit_proxy = create_proxy(core_edit_rule)
core_cancel_proxy = create_proxy(core_cancel_edit)
g_proxies.extend([file_proxy, launch_proxy, atlas_proxy, core_search_proxy, core_ai_proxy, core_import_proxy, core_run_proxy, core_reanalyze_proxy, core_map_proxy, core_add_proxy, core_delete_proxy, core_update_proxy, core_edit_proxy, core_cancel_proxy])

document.getElementById('file-input').addEventListener('change', file_proxy)
document.getElementById('btn-launch').addEventListener('click', launch_proxy)
document.getElementById('btn-atlas').addEventListener('click', atlas_proxy)
document.getElementById('use-status-breakdown').addEventListener('change', atlas_proxy)
document.getElementById('btn-core-search').addEventListener('click', core_search_proxy)
document.getElementById('btn-core-ai').addEventListener('click', core_ai_proxy)
document.getElementById('btn-core-import').addEventListener('click', core_import_proxy)
document.getElementById('btn-core-add').addEventListener('click', core_add_proxy)
document.getElementById('btn-core-update').addEventListener('click', core_update_proxy)
document.getElementById('btn-core-cancel').addEventListener('click', core_cancel_proxy)
document.getElementById('btn-core-run').addEventListener('click', core_run_proxy)
document.getElementById('btn-core-reanalyze').addEventListener('click', core_reanalyze_proxy)
document.getElementById('btn-core-map').addEventListener('click', core_map_proxy)

# JavaScript騾｣謳ｺ逕ｨ縺ｮ繧ｳ繝ｼ繝ｫ繝舌ャ繧ｯ繧堤匳骭ｲ
js.window.pyodide_globals.core_delete_rule = core_delete_proxy
js.window.pyodide_globals.core_edit_rule = core_edit_proxy
js.window.pyodide_globals.update_core_axis_selects = update_core_axis_selects
js.window.pyodide_globals.render_core_rules = render_core_rules
js.window.pyodide_globals.finish_heavy_init = finish_heavy_init

# 谿九ｊ縺ｮ繝｢繧ｸ繝･繝ｼ繝ｫ繧､繝吶Φ繝医ワ繝ｳ繝峨Λ繝ｼ繧堤匳骭ｲ
document.getElementById('btn-saturn').addEventListener('click', create_proxy(run_saturn))
document.getElementById('btn-keyword').addEventListener('click', create_proxy(show_keywords))
document.getElementById('btn-trend').addEventListener('click', create_proxy(show_trend))
document.getElementById('btn-compare').addEventListener('click', create_proxy(compare_companies))
document.getElementById('btn-heatmap').addEventListener('click', create_proxy(show_heatmap))
document.getElementById('btn-emerging').addEventListener('click', create_proxy(show_emerging))
document.getElementById('btn-kwic').addEventListener('click', create_proxy(kwic_search))
document.getElementById('btn-network').addEventListener('click', create_proxy(build_network))
document.getElementById('btn-wordcloud').addEventListener('click', create_proxy(show_wordcloud))
document.getElementById('btn-ngram').addEventListener('click', create_proxy(show_ngram))
document.getElementById('btn-cooccur').addEventListener('click', create_proxy(show_cooccurrence))
document.getElementById('btn-tfidf').addEventListener('click', create_proxy(show_tfidf_detail))
document.getElementById('btn-export-summary').addEventListener('click', create_proxy(export_summary))
document.getElementById('btn-export-keywords').addEventListener('click', create_proxy(export_keywords))
document.getElementById('btn-strategy').addEventListener('click', create_proxy(show_strategy_matrix))
document.getElementById('btn-generate-report').addEventListener('click', create_proxy(generate_report))
document.getElementById('btn-export-all').addEventListener('click', create_proxy(export_all_data))
document.getElementById('btn-treemap').addEventListener('click', create_proxy(show_treemap))
document.getElementById('btn-sankey').addEventListener('click', create_proxy(show_sankey))
document.getElementById('btn-radar').addEventListener('click', create_proxy(show_radar))
document.getElementById('btn-circle-pack').addEventListener('click', create_proxy(show_circle_packing))
document.getElementById('btn-sunburst').addEventListener('click', create_proxy(show_sunburst))
document.getElementById('btn-chord').addEventListener('click', create_proxy(show_chord))
document.getElementById('btn-stream').addEventListener('click', create_proxy(show_streamgraph))
document.getElementById('btn-dendro').addEventListener('click', create_proxy(show_dendrogram))

# 繝舌ヶ繝ｫ繝ｬ繝ｼ繧ｹ縺ｮPython髢｢謨ｰ繧谷avaScript縺九ｉ蜻ｼ縺ｳ蜃ｺ縺帙ｋ繧医≧縺ｫ逋ｻ骭ｲ
js.window.pyShowBubbleRace = create_proxy(show_bubble_race)


# ============================================================
# 蛻晄悄蛹門ｮ御ｺ・# ============================================================

# 隱ｭ縺ｿ霎ｼ縺ｿ繧ｪ繝ｼ繝舌・繝ｬ繧､繧帝撼陦ｨ遉ｺ縺ｫ縺吶ｋ
document.getElementById('init-overlay').style.display = 'none'
debugLog('[ARTEMIS] Python繧ｨ繝ｳ繧ｸ繝ｳ縺ｮ蛻晄悄蛹悶′螳御ｺ・＠縺ｾ縺励◆')

# JavaScript縺ｫPython縺ｮ貅門ｙ螳御ｺ・ｒ騾夂衍
try:
    import js
    js.window.setPyReady(True)
except Exception:
    pass
    </script>
</body>
</html>